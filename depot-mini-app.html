<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Depot Notes Mini-App + Transcript</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font:14px/1.4 system-ui,Segoe UI,Arial;margin:0;background:#f9f9f9;color:#111}
.wrap{max-width:1200px;margin:auto;padding:1rem}
.header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;position:sticky;top:0;background:#f9f9f9;padding:.5rem 0;border-bottom:1px solid #ddd;z-index:2}
.btn{border:1px solid #aaa;border-radius:6px;padding:.35rem .6rem;background:#f7f7f7;cursor:pointer}
.btn:active{transform:translateY(1px)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.card{background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:10px}
.card h3{margin:.2rem 0 .6rem;font-size:15px}
textarea{width:100%;min-height:120px;border:1px solid #ccc;border-radius:6px;padding:8px;resize:vertical;font:13px/1.35 ui-monospace,Menlo,Consolas,monospace;background:#fcfcfc}
.small{font-size:12px;opacity:.75}
.boxes{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.box{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff}
.box h4{margin:.2rem 0 .4rem;font-size:14px}
.row{display:flex;gap:6px;justify-content:flex-end;margin-top:6px}
kbd{background:#eee;border:1px solid #ccc;border-radius:4px;padding:0 4px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <strong>Depot Notes — Transcript → Core → 13 Copy Boxes</strong>
    <div>
      <button class="btn" id="btnCopyAll">Copy All</button>
      <button class="btn" id="btnCopyNext">Copy Next</button>
      <button class="btn" id="btnCopyJSON">Copy JSON</button>
      <button class="btn" id="btnDownloadJSON">Download JSON</button>
      <button class="btn" id="btnDemo">Demo Fill</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Paste Transcript</h3>
      <textarea id="txTranscript" placeholder="Speak/tag like:
obs: regular boiler in kitchen SE; flue horizontal
meas: gas run 14 m; main 22 mm; last leg 15 mm
risk: loft access limited
pref: quiet boiler; keep airing cupboard shelving
dec: boiler upgrade only; condensate to internal stack
loc: delivery pin set; w3w: index.home.raft
photo: front door
todo: customer to clear area"></textarea>
      <div class="row">
        <button class="btn" id="btnParse">Parse Transcript → Populate</button>
        <button class="btn" id="btnCopyCore">Copy Core JSON</button>
      </div>
      <p class="small">Tips: use tags <code>obs</code>, <code>meas</code>, <code>risk</code>, <code>pref</code>, <code>dec</code>, <code>todo</code>, <code>photo</code>, <code>loc</code>, <code>w3w</code>. One thought per line works best.</p>
    </div>

    <div class="card">
      <h3>Parsed Core Model (preview)</h3>
      <textarea id="txCore" readonly></textarea>
      <p class="small">This is the single source of truth your **Quote Tool** can also read.</p>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>13 Depot Sections (copy boxes)</h3>
    <div class="boxes" id="boxes"></div>
    <p class="small">Use short clauses separated by semicolons; press <kbd>Copy</kbd> on each, <kbd>Copy All</kbd>, or step with <kbd>Copy Next</kbd>.</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-ZqYp5cZtkj8i0xWaaStQVuK1RNG0NiCUNJ6JH2HNc8Fn9+rAi5fKJdAEvZkGZ7v8EHZmY/zrQwt5T5sRSvLz2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
/* ===== Utilities ===== */
const $=id=>document.getElementById(id);
const semis=arr=>(arr||[]).filter(Boolean).map(s=>String(s).trim()).filter(Boolean).join('; ');

/* ===== Section list (current Depot) ===== */
const SECTIONS=[
 'Needs','Working at heights','System characteristics','Components that require assistance',
 'Restrictions to work','External hazards','Delivery notes','Office notes',
 'New boiler and controls','Flue','Pipe work','Disruption','Customer actions'
];

/* ===== Build 13 copy boxes ===== */
(function buildUI(){
  const boxes=$('boxes');
  SECTIONS.forEach((t,i)=>{
    const el=document.createElement('div');el.className='box';
    el.innerHTML=`<h4>${i+1}. ${t}</h4>
      <textarea id="sec_${i+1}" placeholder="item one; item two; item three."></textarea>
      <div class="row"><button class="btn" data-copy="${i+1}">Copy</button></div>`;
    boxes.appendChild(el);
  });
  boxes.addEventListener('click',async e=>{
    const id=e.target?.dataset?.copy;if(!id)return;
    const ta=$('sec_'+id);ta.select();ta.setSelectionRange(0,ta.value.length);
    try{await navigator.clipboard.writeText(ta.value);e.target.textContent='Copied';setTimeout(()=>e.target.textContent='Copy',800);}catch{}
  });
  $('btnCopyAll').onclick=async()=>{
    const all=SECTIONS.map((t,i)=>`### ${i+1}. ${t}\n${$('sec_'+(i+1)).value}`).join('\n\n');
    await navigator.clipboard.writeText(all); alert('All sections copied');
  };
})();

/* ===== Transcript → Core Parser (lightweight) ===== */
function parseTranscript(text){
  const core={
    property:{}, assets:{boiler:{}, flue:{}, gas:{}, electrics:{}, cylinder:{}},
    measurements:[], risks:[], customer_preferences:[], decisions:[],
    locations:{}, photos:[], todos:[], recommendations:[]
  };
  const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  for(const raw of lines){
    const m=raw.match(/^([a-zA-Z]+)\s*:\s*(.*)$/);
    const tag=(m?m[1]: 'obs').toLowerCase();
    const body=(m?m[2]: raw);

    const pushMeas=(name,val,unit,notes)=>core.measurements.push({name,value:val,unit,notes});

    if(tag==='obs'){
      // quick cues: boiler type/position, flue type/orientation
      if(/boiler/i.test(body)){
        const type=(body.match(/system|regular|combi/i)||[])[0];
        if(type) core.assets.boiler.type=type.toLowerCase();
        const pos=(body.match(/kitchen|garage|loft|utility|airing cupboard|cupboard/i)||[])[0];
        if(pos) core.assets.boiler.position=pos;
      }
      if(/flue/i.test(body)){
        const type=(body.match(/horizontal|vertical|balanced/i)||[])[0];
        if(type) core.assets.flue.type=type.toLowerCase();
        const ori=(body.match(/rear|side|roof|direct rear/i)||[])[0];
        if(ori) core.assets.flue.orientation=ori;
      }
      if(/cylinder/i.test(body)){
        const ctype=(body.match(/vented|unvented|thermal store/i)||[])[0];
        if(ctype) core.assets.cylinder.type=ctype.toLowerCase();
      }
    }
    else if(tag==='meas'){
      // extract number + unit
      const parts=body.split(/[;,]/);
      for(const p of parts){
        const mm=p.match(/(\d+(?:\.\d+)?)\s*mm/i);
        const m=p.match(/(\d+(?:\.\d+)?)\s*m(?!m)/i);
        const bar=p.match(/(\d+(?:\.\d+)?)\s*bar/i);
        if(/gas run/i.test(p)&&m){ core.assets.gas.run_m=parseFloat(m[1]); pushMeas('gas_run',parseFloat(m[1]),'m',p.trim()); continue; }
        if(/last/i.test(p)&&mm){ core.assets.gas.last_leg_mm=parseFloat(mm[1]); pushMeas('last_leg',parseFloat(mm[1]),'mm',p.trim()); continue; }
        if(/main|start/i.test(p)&&mm){ core.assets.gas.main_mm=parseFloat(mm[1]); pushMeas('main',parseFloat(mm[1]),'mm',p.trim()); continue; }
        if(bar){ pushMeas('pressure',parseFloat(bar[1]),'bar',p.trim()); continue; }
        if(mm){ pushMeas('length',parseFloat(mm[1]),'mm',p.trim()); continue; }
        if(m){ pushMeas('length',parseFloat(m[1]),'m',p.trim()); continue; }
      }
    }
    else if(tag==='risk'){ core.risks.push(body); }
    else if(tag==='pref'){ core.customer_preferences.push(body); }
    else if(tag==='dec'){ core.decisions.push(body); }
    else if(tag==='todo'){ core.todos.push(body); }
    else if(tag==='photo'){ core.photos.push(body.toLowerCase().replace(/\s+/g,'_')+'.jpg'); }
    else if(tag==='loc'){
      const tgt=/parking/i.test(body)? 'parking' : 'delivery';
      core.locations[tgt]=core.locations[tgt]||{};
      const latlng=body.match(/(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
      if(latlng){ core.locations[tgt].lat=parseFloat(latlng[1]); core.locations[tgt].lng=parseFloat(latlng[2]);}
      const alt=body.match(/\b(\d+(?:\.\d+)?)\s*m\b/i); if(alt) core.locations[tgt].alt_m=parseFloat(alt[1]);
      core.locations[tgt].note=(core.locations[tgt].note? core.locations[tgt].note+'; ' : '')+body.replace(/\s*w3w:.*$/i,'').trim();
      const w=body.match(/w3w[:\s]+([a-z]+\.[a-z]+\.[a-z]+)/i); if(w){ core.locations[tgt].w3w=w[1].toLowerCase(); }
    }
    else if(tag==='w3w'){
      (core.locations.delivery ||= {}).w3w = body.trim().replace(/^\/{0,3}/,'').toLowerCase();
    }
    else {
      // fallback: treat as observation text
      core.recommendations.push(body);
    }
  }
  return core;
}

/* ===== Populate the 13 boxes from Core ===== */
function populateFromCore(core){
  window._lastCore=core;
  const A=core.assets||{},B=A.boiler||{},F=A.flue||{},G=A.gas||{},C=A.cylinder||{},E=A.electrics||{};
  const L=core.locations||{},R=core.risks||[],P=core.customer_preferences||[],D=core.decisions||[],
        Re=core.recommendations||[],T=core.todos||[],M=core.measurements||[],Ph=core.photos||[];

  $('sec_1').value=semis([...P,D.find(x=>/comfort|budget|brand/i.test(x))]);
  $('sec_2').value=semis([...R.filter(r=>/loft|height|roof|ladder|scaffold/i.test(r))]);
  $('sec_3').value=semis([`Boiler: ${B.type||'n/a'}`,B.position?`Position: ${B.position}`:null,C?.type?`Cylinder: ${C.type}`:null,
    ...M.filter(m=>/pressure|flow|delta/i.test(m.name)).map(m=>`${m.name.replace(/_/g,' ')}: ${isNaN(m.value)?'':m.value} ${m.unit}`)]);
  $('sec_4').value=semis([...R.filter(r=>/assist|two-?man|weight|stairs|tight/i.test(r)),E.consumer_unit_loc?`Isolate @ ${E.consumer_unit_loc}`:null]);
  $('sec_5').value=semis([...R.filter(r=>/access|time|permit|parking/i.test(r)),L.parking?.note||null]);
  $('sec_6').value=semis([...R.filter(r=>/asbestos|hazard|electrics?|structural|gas leak|vermin/i.test(r)),'None noted']);
  $('sec_7').value=semis([
    L.delivery?.w3w?`///${L.delivery.w3w}`:null,
    (Number.isFinite(L.delivery?.lat)&&Number.isFinite(L.delivery?.lng))?`${L.delivery.lat.toFixed(6)}, ${L.delivery.lng.toFixed(6)}${Number.isFinite(L.delivery.alt_m)?' +'+L.delivery.alt_m+'m':''}`:null,
    L.delivery?.note||null
  ]);
  $('sec_8').value=semis(['Paperwork: standard']);
  $('sec_9').value=semis([...Re.filter(r=>!/flue|condensate/i.test(r)),...D.filter(d=>/boiler|control|filter|trv|weather comp|flush/i.test(d)),
    B.brand?`Brand: ${B.brand}`:null,B.model?`Model: ${B.model}`:null]);
  $('sec_10').value=semis([`Type: ${F.type||'n/a'}`,F.orientation?`Orientation: ${F.orientation}`:null,
    Number.isFinite(F.length_m)?`Length: ${F.length_m} m`:null,...R.filter(r=>/flue|terminal|clearance/i.test(r))]);
  $('sec_11').value=semis([Number.isFinite(G.run_m)?`Gas run: ${G.run_m} m`:null,G.main_mm?`Main: ${G.main_mm} mm`:null,
    G.last_leg_mm?`Last leg: ${G.last_leg_mm} mm`:null,D.find(x=>/condensate/i.test(x))||null]);
  $('sec_12').value=semis([...R.filter(r=>/decor|making good|no heat|no water|noise|dust/i.test(r)),Ph.length?`Photos logged: ${Ph.length}`:null]);
  $('sec_13').value=semis([...T.filter(t=>/customer|clear|move|provide|arrange/i.test(t))]);
}

/* ===== JSON export ===== */
function buildDepotJSON(core=null){
  const sections=SECTIONS.map((t,i)=>({index:i+1,title:t,text:($('sec_'+(i+1))?.value||'').trim()}));
  return { schema:'depot.notes.v1', generated_at:new Date().toISOString(),
           sections, sections_plain:sections.map(s=>s.text), core_model:core||window._lastCore||null };
}
async function copyDepotJSON(core=null){ await navigator.clipboard.writeText(JSON.stringify(buildDepotJSON(core),null,2)); alert('Depot JSON copied'); }
function downloadDepotJSON(fname='depot_notes.json',core=null){
  const blob=new Blob([JSON.stringify(buildDepotJSON(core),null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fname;a.click();URL.revokeObjectURL(a.href);
}
let _cycleIdx=0; async function copyNextSection(){ _cycleIdx=(_cycleIdx%13)+1; await navigator.clipboard.writeText(($('sec_'+_cycleIdx).value||'').trim()); alert('Copied '+_cycleIdx+'. '+SECTIONS[_cycleIdx-1]); }

/* ===== Wire buttons ===== */
$('btnCopyJSON').onclick=()=>copyDepotJSON();
$('btnDownloadJSON').onclick=()=>downloadDepotJSON('depot_'+Date.now()+'.json');
$('btnCopyNext').onclick=()=>copyNextSection();
$('btnCopyCore').onclick=async()=>{
  const coreText=$('txCore').value||'';
  await navigator.clipboard.writeText(coreText);
  alert('Core JSON copied');
};

/* ===== Parse button ===== */
$('btnParse').onclick=()=>{
  const core=parseTranscript($('txTranscript').value);
  $('txCore').value=JSON.stringify(core,null,2);
  populateFromCore(core);
};

/* ===== Demo ===== */
$('btnDemo').onclick=()=>{
  $('txTranscript').value=`obs: Boiler regular in kitchen SE; flue horizontal rear
meas: gas run 14 m; main 22 mm; last leg 15 mm; pressure 1.6 bar
risk: loft access limited; external flue clearance borderline E/W fence
pref: quiet boiler; keep airing cupboard shelving
dec: boiler upgrade only; magnetic filter; condensate to internal stack
loc: delivery pin set; w3w: index.home.raft
photo: front door
todo: customer to clear area; move car from driveway`;
  $('btnParse').click();
};

/* ===== Public API (if you want to feed a Core from elsewhere) ===== */
window.DepotMini={populateFromCore,buildDepotJSON,copyDepotJSON,downloadDepotJSON,copyNextSection};

/* ===== Visit ZIP Builder ===== */
(function initZipMaker(){
  const wrap=document.querySelector('.wrap');
  if(!wrap) return;

  const area=document.createElement('div');
  area.style.marginTop='1rem';
  area.style.padding='.8rem';
  area.style.borderTop='1px solid #ccc';
  area.innerHTML=`
    <h3>Bundle Visit Files</h3>
    <input id="zipFiles" type="file" multiple
           accept=".txt,.json,.pdf,.jpg,.jpeg,.png,.heic,.usdz,.zip"
           style="margin:.5rem 0">
    <button class="btn" id="btnMakeZip">Zip Visit Files</button>
    <p class="small" id="zipStatus">Select all files for one visit (transcript, quote, photos, etc.).</p>`;
  wrap.appendChild(area);

  const input=area.querySelector('#zipFiles');
  const status=area.querySelector('#zipStatus');
  area.querySelector('#btnMakeZip').addEventListener('click', async()=>{
    const files=input.files;
    if(!files.length){ alert('No files selected'); return; }
    status.textContent='Building ZIP…';
    const zip=new JSZip();
    for(const f of files){
      const data=await f.arrayBuffer();
      zip.file(f.name,data);
    }
    const blob=await zip.generateAsync({type:'blob'});
    const dt=new Date();
    const stamp=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+
                 String(dt.getDate()).padStart(2,'0')+'_'+
                 String(dt.getHours()).padStart(2,'0')+'-'+
                 String(dt.getMinutes()).padStart(2,'0');
    const filename=`visit_${stamp}.zip`;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    a.click();
    URL.revokeObjectURL(a.href);
    status.textContent=`ZIP created → ${filename}`;
  });
})();
</script>
</body>
</html>
