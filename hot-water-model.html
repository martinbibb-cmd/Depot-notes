<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hot Water Model â€” SEDBUK Payback, Full Scope</title>
<style>
  :root{--fg:#111;--bg:#fff;--muted:#666;--b:#e5e7eb;--pri:#0b84ff;--hl:#fff7cc}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu;color:var(--fg);background:var(--bg)}
  header{padding:14px 16px;border-bottom:1px solid var(--b);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:16px;margin:0}
  .wrap{max-width:1150px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  label{font-weight:600;font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  select,input[type="number"],input[type="range"]{width:100%}
  input[type="number"],select{padding:8px 10px;border:1px solid var(--b);border-radius:8px;background:#fff}
  .card{border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:14px}
  .card h2{margin:0 0 8px;font-size:16px}
  .sub{color:var(--muted);font-size:12px;margin-top:-4px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  @media(max-width:560px){.kpi{grid-template-columns:1fr}}
  .pill{border:1px solid var(--b);border-radius:10px;padding:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:9px 12px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer}
  button.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .score{font:600 28px/1.1 system-ui;margin:4px 0}
  .muted{color:var(--muted)}
  .slrow{display:flex;align-items:center;gap:10px}
  .slrow output{min-width:3ch;text-align:right;font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--b);padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa}
  .right{text-align:right}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--b);border-radius:999px;font-size:12px;color:#444}
  .badge.warn{background:#fff4e5;border-color:#f59e0b;color:#92400e}
  .exist{background:var(--hl)}
  .nowrap{white-space:nowrap}
  .focus-cols{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:12px}
  @media(max-width:900px){.focus-cols{grid-template-columns:1fr}}
  .focus-col{border:1px solid var(--b);border-radius:10px;padding:12px;background:#fff}
  .focus-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .focus-title h3{margin:4px 0 0;font-size:16px}
  .focus-note{margin-top:6px;color:var(--muted);font-size:13px}
  .focus-warn{margin-top:4px;color:#92400e;font-size:13px}
  .focus-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
  .badge.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  @media print{
    header,.no-print{display:none!important}
    body{background:#fff}
    .wrap{padding:0}
    .card{border:none;margin:0 0 8mm 0;padding:0}
    .pill{border:1px solid #ddd}
    table,th,td{border:1px solid #999}
    .score{font-size:24px}
  }
</style>
</head>
<body>
<header class="no-print">
  <h1>Hot Water Model</h1>
  <span class="muted">Physics â€¢ Cost â€¢ Customer score â€¢ SEDBUK Payback â€¢ Printable</span>
  <div style="margin-left:auto" class="actions">
    <button onclick="window.print()">ğŸ–¨ï¸ Print</button>
  </div>
</header>

<div class="wrap">
  <div class="card no-print">
    <h2>Inputs</h2>
    <div class="grid">
      <div>
        <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Usage</label>
        <select id="usage">
          <option>Low (1â€“2 ppl)</option>
          <option selected>Med (3â€“4 ppl)</option>
          <option>High (5â€“6 ppl)</option>
        </select>
      </div>
      <div>
        <label>ğŸ—“ï¸ Season (UK mains temp)</label>
        <select id="mains">
          <option>Winter</option>
          <option selected>Spring/Autumn</option>
          <option>Summer</option>
        </select>
      </div>
      <div>
        <label>ğŸ§µ Pipe layout (waiting water)</label>
        <select id="layout">
          <option selected>Central</option>
          <option>Typical</option>
          <option>Remote</option>
        </select>
      </div>
      <div>
        <label>â›½ Gas price ( Â£ / kWh )</label>
        <input id="gas" type="number" step="0.001" value="0.07">
      </div>
      <div>
        <label>ğŸš¿ Water flow (L/min)</label>
        <input id="flow" type="number" step="0.5" value="14">
        <div class="sub">Estimate mains flow. Below 12 L/min we avoid combis.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div style="grid-column:1/-1">
        <label>ğŸ§° Existing system type</label>
        <select id="existing"></select>
      </div>
      <div class="slrow" title="SEDBUK seasonal efficiency of the CURRENT boiler">
        <label style="flex:1">ğŸ“Š Existing SEDBUK (%)</label>
        <input id="sedbuk" type="range" min="55" max="95" step="1" value="78" oninput="sedVal.value=this.value">
        <output id="sedVal">78</output>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>ğŸ—ï¸ Capex multiplier (Ã—)</label>
        <input id="capexMult" type="number" step="0.05" value="1.00">
        <div class="sub">Adjust installed costs (region/access).</div>
      </div>
      <div>
        <label>ğŸ§¾ Existing keep-cost (Â£)</label>
        <input id="capexKeep" type="number" step="50" value="0">
        <div class="sub">Repairs/upgrades to keep current system.</div>
      </div>
      <div>
        <label>ğŸ’· Finance rate (%)</label>
        <input id="financeRate" type="number" step="0.1" value="0">
        <div class="sub">If >0, we add annualised capex.</div>
      </div>
      <div>
        <label>Term (years)</label>
        <input id="financeYears" type="number" step="1" value="10">
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">Adjust what matters most:</div>
      <div class="grid" style="margin-top:8px">
        <div class="slrow"><label style="flex:1">ğŸ”‹ Energy</label><input id="wE" type="range" min="0" max="10" step="1" value="3" oninput="wEVal.value=this.value"><output id="wEVal">3</output></div>
        <div class="slrow"><label style="flex:1">ğŸ’· Cost</label><input id="wCost" type="range" min="0" max="10" step="1" value="5" oninput="wCostVal.value=this.value"><output id="wCostVal">5</output></div>
        <div class="slrow"><label style="flex:1">ğŸ› Comfort</label><input id="wC" type="range" min="0" max="10" step="1" value="4" oninput="wCVal.value=this.value"><output id="wCVal">4</output></div>
        <div class="slrow"><label style="flex:1">ğŸŒ± Future-proof</label><input id="wF" type="range" min="0" max="10" step="1" value="4" oninput="wFVal.value=this.value"><output id="wFVal">4</output></div>
        <div class="slrow"><label style="flex:1">ğŸ”§ Maintenance</label><input id="wM" type="range" min="0" max="10" step="1" value="2" oninput="wMVal.value=this.value"><output id="wMVal">2</output></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="presetBudget">ğŸ’° Budget-led</button>
        <button id="presetComfort">ğŸ› Comfort-led</button>
        <button id="presetFuture">ğŸŒ± Future-ready</button>
        <button id="presetReset">â™»ï¸ Reset</button>
        <button id="recalc" class="primary">Recalculate</button>
      </div>
    </div>
  </div>

  <!-- Focused view -->
  <div class="card" id="focusCard">
    <h2>Focused comparison</h2>
    <div class="sub">Top pick against your current system (SEDBUK-adjusted).</div>
    <div class="focus-cols">
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge primary" id="focusTag">Top pick</span>
            <h3 id="focusName">â€”</h3>
          </div>
          <div class="actions no-print">
            <button id="copy">Copy JSON (focused)</button>
          </div>
        </div>
        <div class="focus-note" id="focusEcho">â€”</div>
        <div class="focus-warn" id="focusWarn"></div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="focusKwhDay">â€”</b> kWh/day</div><small id="focusKwhYear">â€”</small></div>
          <div class="pill"><div class="muted">Running cost</div><div>Â£<b id="focusCostDay">â€”</b> / day</div><small id="focusCostYear">â€”</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="focusWasteL">â€”</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="focusScore">â€”</div>
            <small>ğŸ”‹ <span id="focusUE">â€”</span> â€¢ ğŸ’· <span id="focusUP">â€”</span> â€¢ ğŸ› <span id="focusUC">â€”</span> â€¢ ğŸŒ± <span id="focusUF">â€”</span> â€¢ ğŸ”§ <span id="focusUM">â€”</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="focusEUse">â€”</b> kWh/day</div>
            <div>Waiting <b id="focusEWait">â€”</b> kWh/day</div>
            <div>Standby <b id="focusStandby">â€”</b> kWh/day</div>
            <div>Î· <b id="focusEta">â€”</b> â€¢ Starts <b id="focusStarts">â€”</b></div>
            <div class="muted" style="margin-top:6px">Capex Â£<span id="focusCapex">â€”</span> â€¢ Payback <span id="focusPayback">â€”</span></div>
          </div>
        </div>
      </div>
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge" id="existTag">Existing (SEDBUK <span id="existSedbuk">â€”</span>%)</span>
            <h3 id="existName">â€”</h3>
          </div>
        </div>
        <div class="focus-note" id="existEcho">â€”</div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="existKwhDay">â€”</b> kWh/day</div><small id="existKwhYear">â€”</small></div>
          <div class="pill"><div class="muted">Running cost</div><div>Â£<b id="existCostDay">â€”</b> / day</div><small id="existCostYear">â€”</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="existWasteL">â€”</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="existScore">â€”</div>
            <small>ğŸ”‹ <span id="existUE">â€”</span> â€¢ ğŸ’· <span id="existUP">â€”</span> â€¢ ğŸ› <span id="existUC">â€”</span> â€¢ ğŸŒ± <span id="existUF">â€”</span> â€¢ ğŸ”§ <span id="existUM">â€”</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="existEUse">â€”</b> kWh/day</div>
            <div>Waiting <b id="existEWait">â€”</b> kWh/day</div>
            <div>Standby <b id="existStandby">â€”</b> kWh/day</div>
            <div>Î· <b id="existEta">â€”</b> â€¢ Starts <b id="existStarts">â€”</b></div>
            <div class="muted" style="margin-top:6px">Keep Â£<span id="existCapex">â€”</span> â€¢ Payback <span id="existPayback">â€”</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compare All Systems -->
  <div class="card" id="compareCard">
    <h2>Compare all systems</h2>
    <div class="sub">Sorted by Customer score. Click a row to focus. Existing is highlighted. Payback uses your SEDBUK baseline.</div>
    <div style="overflow:auto">
      <table id="compareTable">
        <thead>
          <tr>
            <th>System</th>
            <th class="right nowrap">kWh/day</th>
            <th class="right nowrap">Â£/day</th>
            <th class="right nowrap">Waste L/day</th>
            <th class="right nowrap">Score</th>
            <th class="right nowrap">Î·</th>
            <th class="right nowrap">Standby</th>
            <th class="right nowrap">Capex Â£</th>
            <th class="right nowrap">Run Â£/yr</th>
            <th class="right nowrap">Year-1 Â£</th>
            <th class="right nowrap">Payback (yrs)</th>
          </tr>
        </thead>
        <tbody id="compareBody"></tbody>
      </table>
    </div>
  </div>

  <footer class="muted">Â© Hot Water Model â€” SEDBUK payback build</footer>
</div>

<script type="module">
/* ==== CORE CONSTANTS & HELPERS ==== */
const CP=0.001163,cl=(v,a,b)=>Math.max(a,Math.min(b,v)),rd=(n,d=2)=>Math.round(n*10**d)/10**d;
const etaCurve=t=>t<=30?0.98:t>=55?0.88:0.98-0.004*(t-30);
const invU=(v,b)=>cl(100*(b/v),10,100);

/* ==== PRESETS ==== */
const PRE={
  usage:{"Low (1â€“2 ppl)":{Vd:80,dr:12},"Med (3â€“4 ppl)":{Vd:130,dr:18},"High (5â€“6 ppl)":{Vd:180,dr:24}},
  mains:{"Winter":8,"Spring/Autumn":12,"Summer":16},
  layout:{"Central":.35,"Typical":.7,"Remote":1.2}, // L per draw (waiting water)
  systems:{
    "Regular â€¢ Open CH + Open-vented cyl":      {t:"s", sb:1.8, cf:1.00, Tr:54, C:86, F:65, M:72, capex:4000},
    "Regular â€¢ Sealed CH + Open-vented cyl":    {t:"s", sb:1.7, cf:1.00, Tr:52, C:87, F:70, M:74, capex:4200},
    "Regular â€¢ Open CH + Unvented cyl":         {t:"s", sb:1.5, cf:1.00, Tr:52, C:88, F:82, M:80, capex:4600},
    "Regular â€¢ Sealed CH + Unvented cyl":       {t:"s", sb:1.4, cf:1.00, Tr:50, C:89, F:84, M:82, capex:4800},

    "System â€¢ Open-vented cyl":                 {t:"s", sb:1.6, cf:1.00, Tr:51, C:90, F:75, M:78, capex:4400},
    "System â€¢ Unvented cyl":                    {t:"s", sb:1.3, cf:1.00, Tr:49, C:91, F:86, M:84, capex:5000},

    "System â€¢ Mixergy Unvented (indirect)":     {t:"s", sb:1.0, cf:.95, Tr:48, C:92, F:95, M:85, capex:5500},
    "System â€¢ Mixergy Vented (open-vented)":    {t:"s", sb:1.1, cf:.96, Tr:49, C:91, F:88, M:83, capex:5200},

    "Combi â€¢ Standard":                         {t:"c", st:.012, sc:1.08, Tr:55, C:72, F:50, M:70, capex:3300, minFlow:12},
    "Combi â€¢ Premium (conditioned/central)":    {t:"c", st:.009, sc:1.02, Tr:52, C:78, F:55, M:78, capex:3800, minFlow:12},
  },
  Tuse:40,
  price:{ gas:.07, water:.0003 }
};

/* ==== THERMAL MODEL (NEW/PROPOSED OPTION) ==== */
function calcOption({sysKey, usageKey, mainsKey, layoutKey, prices}){
  const U=PRE.usage[usageKey], M=PRE.mains[mainsKey], L=PRE.layout[layoutKey], S=PRE.systems[sysKey];
  const Tu=PRE.Tuse, Tm=M, pgas=prices.gas, pw=prices.water;
  const Euse = U.Vd*CP*(Tu-Tm);
  const Vwait= L*U.dr;
  const Ewait= Vwait*CP*(Tu-Tm);
  const eta  = etaCurve(S.Tr);

  let E_kWh, cost_day, standby=0, starts=0;
  if(S.t==="s"){
    const Egas=((Euse+Ewait)/eta)*S.cf;
    standby=S.sb; E_kWh=Egas+standby;
    cost_day = E_kWh*pgas + Vwait*pw;
  }else{
    const etaEff=eta/(S.sc||1);
    starts=U.dr;
    const Eover = starts*(S.st||0.01);
    E_kWh=((Euse+Ewait)/etaEff)+Eover;
    cost_day = E_kWh*pgas + Vwait*pw;
  }

  return {
    sysKey, usageKey, mainsKey, layoutKey,
    kWh: rd(E_kWh,3),
    cost: rd(cost_day,2),
    kWh_year: Math.round(E_kWh*365),
    cost_year: Math.round(cost_day*365),
    wasteL: rd(Vwait,1),
    breakdown:{E_use:rd(Euse,3),E_wait:rd(Ewait,3),standby:rd(standby,3),eta:rd(eta,3),starts},
    capexBase: PRE.systems[sysKey].capex
  };
}

/* ==== EXISTING SYSTEM BASELINE USING SEDBUK ==== */
function calcExistingRun({existingKey, sedbukPct, usageKey, mainsKey, layoutKey, prices}){
  const U=PRE.usage[usageKey], M=PRE.mains[mainsKey], L=PRE.layout[layoutKey], S=PRE.systems[existingKey];
  const Tu=PRE.Tuse, Tm=M, pgas=prices.gas, pw=prices.water;
  const eff = cl((sedbukPct||75)/100, 0.40, 0.99);
  const Euse = U.Vd*CP*(Tu-Tm);
  const Vwait= L*U.dr;
  const Ewait= Vwait*CP*(Tu-Tm);

  let E_kWh, cost_day, standby=0, starts=0;
  if(S.t==="s"){
    standby = S.sb || 1.5;
    E_kWh = ((Euse+Ewait)/eff) + standby;
    cost_day = E_kWh*pgas + Vwait*pw;
  } else {
    starts = U.dr;
    const Eover = starts*(S.st||0.012);
    E_kWh = ((Euse+Ewait)/eff) + Eover;
    cost_day = E_kWh*pgas + Vwait*pw;
  }

  return {
    kWh_day: rd(E_kWh,3),
    kWh_year: Math.round(E_kWh*365),
    cost_day: rd(cost_day,2),
    cost_year: Math.round(cost_day*365),
    eta_effective: rd(eff,3),
    standby: rd(standby,3),
    starts,
    wasteL: rd(Vwait,1),
    breakdown:{
      E_use:rd(Euse,3),
      E_wait:rd(Ewait,3),
      standby:rd(standby,3),
      eta:rd(eff,3),
      starts
    }
  };
}

/* ==== SCORING (unchanged, best-of-two reference) ==== */
function baseUtilities(r, weights, bestKWh, bestGBP){
  const S=PRE.systems[r.sysKey];
  const pen=r.layoutKey==="Central"?0:r.layoutKey==="Typical"?6:12;
  const Ue=invU(r.kWh,bestKWh);
  const Up=invU(r.cost,bestGBP);
  const Uc=cl((S.C||75)-pen,10,100);
  const Uf=cl(S.F||60,10,100);
  const Um=cl(S.M||70,10,100);
  const W=weights;
  const scoreRaw=(W.e*Ue+W.c*Up+W.C*Uc+W.F*Uf+W.M*Um)/(W.e+W.c+W.C+W.F+W.M);
  return {Ue,Up,Uc,Uf,Um,scoreRaw};
}

function scoreAll(results, weights, ctx={}){
  const refKeys=["System â€¢ Mixergy Unvented (indirect)","Combi â€¢ Premium (conditioned/central)"];
  const refs=results.filter(r=>refKeys.includes(r.sysKey));
  const bestKWh=Math.min(...refs.map(r=>r.kWh));
  const bestGBP=Math.min(...refs.map(r=>r.cost));
  const flowLpm=Number.isFinite(ctx.flowLpm)?ctx.flowLpm:Infinity;

  return results.map(r=>{
    const S=PRE.systems[r.sysKey];
    const base=baseUtilities(r, weights, bestKWh, bestGBP);
    const minFlow=S.minFlow||0;
    const flowOk=flowLpm>=minFlow;
    let finalScore=base.scoreRaw;
    let flowWarning;
    if(!flowOk && minFlow>0){
      finalScore=0;
      flowWarning=`Requires â‰¥ ${minFlow} L/min (you have ${rd(flowLpm,1)} L/min)`;
    }
    return {
      ...r,
      utilities:{
        Ue:Math.round(base.Ue),
        Up:Math.round(base.Up),
        Uc:Math.round(base.Uc),
        Uf:Math.round(base.Uf),
        Um:Math.round(base.Um),
        score:Math.round(finalScore)
      },
      flowWarning:flowWarning||undefined,
      flowOk
    };
  });
}

/* ==== FINANCE ==== */
function annuityPayment(capex, ratePct, years){
  const r=(ratePct||0)/100; if(r<=0) return 0;
  const n=Math.max(1, years||1);
  const f=r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
  return capex*f;
}

/* ==== UI WIRING ==== */
const $=s=>document.querySelector(s);
const els={
  usage:$('#usage'), mains:$('#mains'), layout:$('#layout'), gas:$('#gas'), flow:$('#flow'),
  existing:$('#existing'), sedbuk:$('#sedbuk'),
  capexMult:$('#capexMult'), capexKeep:$('#capexKeep'),
  financeRate:$('#financeRate'), financeYears:$('#financeYears'),
  wE:$('#wE'), wCost:$('#wCost'), wC:$('#wC'), wF:$('#wF'), wM:$('#wM'),
  focusTag:$('#focusTag'), focusName:$('#focusName'),
  focusEcho:$('#focusEcho'), focusWarn:$('#focusWarn'),
  focusKwhDay:$('#focusKwhDay'), focusKwhYear:$('#focusKwhYear'),
  focusCostDay:$('#focusCostDay'), focusCostYear:$('#focusCostYear'),
  focusWasteL:$('#focusWasteL'), focusScore:$('#focusScore'),
  focusUE:$('#focusUE'), focusUP:$('#focusUP'), focusUC:$('#focusUC'), focusUF:$('#focusUF'), focusUM:$('#focusUM'),
  focusEUse:$('#focusEUse'), focusEWait:$('#focusEWait'), focusStandby:$('#focusStandby'), focusEta:$('#focusEta'), focusStarts:$('#focusStarts'),
  focusCapex:$('#focusCapex'), focusPayback:$('#focusPayback'),
  existName:$('#existName'), existSedbuk:$('#existSedbuk'), existEcho:$('#existEcho'),
  existKwhDay:$('#existKwhDay'), existKwhYear:$('#existKwhYear'),
  existCostDay:$('#existCostDay'), existCostYear:$('#existCostYear'),
  existWasteL:$('#existWasteL'), existScore:$('#existScore'),
  existUE:$('#existUE'), existUP:$('#existUP'), existUC:$('#existUC'), existUF:$('#existUF'), existUM:$('#existUM'),
  existEUse:$('#existEUse'), existEWait:$('#existEWait'), existStandby:$('#existStandby'), existEta:$('#existEta'), existStarts:$('#existStarts'),
  existCapex:$('#existCapex'), existPayback:$('#existPayback'),
  compareBody:$('#compareBody'),
  copyBtn:$('#copy'), recalcBtn:$('#recalc'),
  presetBudget:$('#presetBudget'), presetComfort:$('#presetComfort'),
  presetFuture:$('#presetFuture'), presetReset:$('#presetReset')
};

/* Populate selects */
(function populateExisting(){
  const keys=Object.keys(PRE.systems);
  els.existing.innerHTML=keys.map(k=>`<option ${k.includes('Combi â€¢ Standard')?'selected':''}>${k}</option>`).join('');
})();

function getState(){
  const flowVal=parseFloat(els.flow.value);
  const flowLpm=Number.isFinite(flowVal)?Math.max(0, flowVal):14;
  return {
    usageKey:els.usage.value, mainsKey:els.mains.value, layoutKey:els.layout.value,
    flowLpm,
    prices:{gas:parseFloat(els.gas.value||"0.07"), water:0.0003},
    existingKey:els.existing.value, sedbukPct:+els.sedbuk.value,
    weights:{e:+els.wE.value, c:+els.wCost.value, C:+els.wC.value, F:+els.wF.value, M:+els.wM.value},
    capexMult:parseFloat(els.capexMult.value||"1"), capexKeep:parseFloat(els.capexKeep.value||"0"),
    financeRate:parseFloat(els.financeRate.value||"0"), financeYears:parseInt(els.financeYears.value||"10",10)
  };
}

function runAll(){
  const st=getState();

  // Existing baseline using SEDBUK
  const existingRun=calcExistingRun({
    existingKey:st.existingKey, sedbukPct:st.sedbukPct,
    usageKey:st.usageKey, mainsKey:st.mainsKey, layoutKey:st.layoutKey, prices:st.prices
  });

  // All candidate options (new/proposed)
  const baseResults=Object.keys(PRE.systems).map(sysKey=>calcOption({
    sysKey, usageKey:st.usageKey, mainsKey:st.mainsKey, layoutKey:st.layoutKey, prices:st.prices
  }));

  // Attach capex + savings/payback vs existing
  const results=baseResults.map(r=>{
    const capex=(PRE.systems[r.sysKey].capex||0)*st.capexMult;
    const runYr=r.cost_year;
    const year1=capex+runYr;

    // Finance
    const annualised=annuityPayment(capex, st.financeRate, st.financeYears);
    const totalAnnualWithFinance=runYr+annualised;

    // Savings vs existing (SEDBUK baseline)
    const keepCost=st.capexKeep;
    const incrCapex=Math.max(0, capex - keepCost);
    const annualSaving=Math.max(0, existingRun.cost_year - runYr);
    const payback=annualSaving>0 ? (incrCapex/annualSaving) : Infinity;

    return {
      ...r,
      capex:Math.round(capex),
      runYr:Math.round(runYr),
      year1:Math.round(year1),
      annualised:Math.round(annualised),
      totalAnnualWithFinance:Math.round(totalAnnualWithFinance),
      annualSaving:Math.round(annualSaving),
      payback:(payback===Infinity?"â€”":(payback>99?"99+":payback.toFixed(1))),
      baseline:existingRun
    };
  }).map(r=>{
    if(r.sysKey!==st.existingKey) return r;
    const keepCost=Math.max(0, st.capexKeep);
    const capexKeep=Math.round(keepCost);
    const annualisedKeep=annuityPayment(keepCost, st.financeRate, st.financeYears);
    return {
      ...r,
      kWh: rd(existingRun.kWh_day,3),
      cost: rd(existingRun.cost_day,2),
      kWh_year: existingRun.kWh_year,
      cost_year: existingRun.cost_year,
      wasteL: existingRun.wasteL,
      breakdown: existingRun.breakdown,
      capex: capexKeep,
      runYr: Math.round(existingRun.cost_year),
      year1: Math.round(capexKeep + existingRun.cost_year),
      annualised: Math.round(annualisedKeep),
      totalAnnualWithFinance: Math.round(existingRun.cost_year + annualisedKeep),
      annualSaving: 0,
      payback: 'â€”',
      sedbuk: st.sedbukPct
    };
  });

  // Score & sort (by score)
  const scored=scoreAll(results, st.weights, {flowLpm:st.flowLpm}).sort((a,b)=>b.utilities.score - a.utilities.score);
  const existingScored=scored.find(x=>x.sysKey===st.existingKey) || null;
  const bestCandidate=scored.find(x=>x.sysKey!==st.existingKey) || scored[0];
  const bestKey=bestCandidate?.sysKey;

  // Render table
  els.compareBody.innerHTML=scored.map(r=>`
    <tr data-sys="${r.sysKey}" class="${r.sysKey===st.existingKey?'exist':''}">
      <td>${r.sysKey}${r.sysKey===st.existingKey?' <span class="badge">Existing</span>':''}${r.flowWarning?' <span class="badge warn">âš ï¸ Flow limit</span>':''}</td>
      <td class="right">${r.kWh}</td>
      <td class="right">Â£${r.cost.toFixed(2)}</td>
      <td class="right">${r.wasteL}</td>
      <td class="right"><b>${r.utilities.score}</b></td>
      <td class="right">${r.breakdown.eta}</td>
      <td class="right">${r.breakdown.standby}</td>
      <td class="right">Â£${r.capex.toLocaleString()}</td>
      <td class="right">Â£${r.runYr.toLocaleString()}</td>
      <td class="right">Â£${r.year1.toLocaleString()}</td>
      <td class="right">${r.payback}</td>
    </tr>
  `).join('');

  for(const tr of els.compareBody.querySelectorAll('tr')){
    tr.onclick=()=>focus(scored.find(x=>x.sysKey===tr.dataset.sys), st, existingScored, bestKey);
  }

  // Focus best option by default
  const defaultFocus=bestCandidate;
  focus(defaultFocus, st, existingScored, bestKey);
  return {scored, st, existingRun};
}

function focus(candidate, st, existing, bestKey){
  if(!candidate) return;
  const isExisting=candidate.sysKey===st.existingKey;
  const isBest=!isExisting && candidate.sysKey===bestKey;
  els.focusName.textContent=candidate.sysKey;
  els.focusTag.textContent=isExisting? 'Existing selection' : (isBest? 'Top pick' : 'Selected option');
  els.focusTag.classList.toggle('primary', !isExisting && isBest);
  els.focusKwhDay.textContent=candidate.kWh;
  els.focusKwhYear.textContent=`â‰ˆ ${candidate.kWh_year.toLocaleString()} kWh / yr`;
  els.focusCostDay.textContent=candidate.cost.toFixed(2);
  els.focusCostYear.textContent=`â‰ˆ Â£${candidate.cost_year.toLocaleString()} / yr`;
  els.focusWasteL.textContent=candidate.wasteL;
  els.focusScore.textContent=candidate.utilities.score;
  els.focusUE.textContent=candidate.utilities.Ue;
  els.focusUP.textContent=candidate.utilities.Up;
  els.focusUC.textContent=candidate.utilities.Uc;
  els.focusUF.textContent=candidate.utilities.Uf;
  els.focusUM.textContent=candidate.utilities.Um;
  els.focusEUse.textContent=candidate.breakdown.E_use;
  els.focusEWait.textContent=candidate.breakdown.E_wait;
  els.focusStandby.textContent=candidate.breakdown.standby;
  els.focusEta.textContent=candidate.breakdown.eta;
  els.focusStarts.textContent=candidate.breakdown.starts;
  els.focusCapex.textContent=candidate.capex.toLocaleString();
  els.focusPayback.textContent=(candidate.payback==='â€”' ? 'â€”' : `${candidate.payback} yrs`);
  const flowSummary=Number.isFinite(st.flowLpm)?`${rd(st.flowLpm,1)} L/min`:'â€”';
  els.focusEcho.textContent=`${candidate.usageKey} â€¢ ${candidate.mainsKey} â€¢ ${candidate.layoutKey} â€¢ Flow ${flowSummary}`;
  els.focusWarn.textContent=candidate.flowWarning?`âš ï¸ ${candidate.flowWarning}`:'';

  if(existing){
    els.existName.textContent=existing.sysKey;
    els.existSedbuk.textContent=existing.sedbuk||st.sedbukPct;
    els.existKwhDay.textContent=existing.kWh;
    els.existKwhYear.textContent=`â‰ˆ ${existing.kWh_year.toLocaleString()} kWh / yr`;
    els.existCostDay.textContent=existing.cost.toFixed(2);
    els.existCostYear.textContent=`â‰ˆ Â£${existing.cost_year.toLocaleString()} / yr`;
    els.existWasteL.textContent=existing.wasteL;
    els.existScore.textContent=existing.utilities.score;
    els.existUE.textContent=existing.utilities.Ue;
    els.existUP.textContent=existing.utilities.Up;
    els.existUC.textContent=existing.utilities.Uc;
    els.existUF.textContent=existing.utilities.Uf;
    els.existUM.textContent=existing.utilities.Um;
    els.existEUse.textContent=existing.breakdown.E_use;
    els.existEWait.textContent=existing.breakdown.E_wait;
    els.existStandby.textContent=existing.breakdown.standby;
    els.existEta.textContent=existing.breakdown.eta;
    els.existStarts.textContent=existing.breakdown.starts;
    els.existCapex.textContent=(existing.capex||0).toLocaleString();
    els.existPayback.textContent=(existing.payback==='â€”' ? 'â€”' : `${existing.payback} yrs`);
    els.existEcho.textContent=`${existing.usageKey} â€¢ ${existing.mainsKey} â€¢ ${existing.layoutKey} â€¢ Flow ${flowSummary} â€¢ SEDBUK ${(existing.sedbuk||st.sedbukPct)}%`;
  }

  els.copyBtn.onclick=()=>navigator.clipboard.writeText(JSON.stringify(candidate,null,2));
}

/* Presets */
els.presetBudget.onclick = ()=>{ els.wE.value=3; els.wCost.value=8; els.wC.value=2; els.wF.value=2; els.wM.value=2; runAll(); };
els.presetComfort.onclick= ()=>{ els.wE.value=3; els.wCost.value=3; els.wC.value=8; els.wF.value=3; els.wM.value=3; runAll(); };
els.presetFuture.onclick = ()=>{ els.wE.value=5; els.wCost.value=4; els.wC.value=3; els.wF.value=8; els.wM.value=2; runAll(); };
els.presetReset.onclick  = ()=>{ els.wE.value=3; els.wCost.value=5; els.wC.value=4; els.wF.value=4; els.wM.value=2; runAll(); };

els.recalcBtn.onclick=runAll;
for(const el of document.querySelectorAll('input,select')) el.addEventListener('change', runAll);

// init
(function initExisting(){
  const keys=Object.keys(PRE.systems);
  els.existing.innerHTML=keys.map(k=>`<option ${k.includes('Combi â€¢ Standard')?'selected':''}>${k}</option>`).join('');
})();
runAll();
</script>
</body>
</html>
