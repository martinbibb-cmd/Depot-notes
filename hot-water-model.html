<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hot Water Model — Full Scope + Capex & Payback</title>
<style>
  :root{--fg:#111;--bg:#fff;--muted:#666;--b:#e5e7eb;--pri:#0b84ff;--hl:#fff7cc}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu;color:var(--fg);background:var(--bg)}
  header{padding:14px 16px;border-bottom:1px solid var(--b);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:16px;margin:0}
  .wrap{max-width:1150px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  label{font-weight:600;font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  select,input[type="number"],input[type="range"]{width:100%}
  input[type="number"],select{padding:8px 10px;border:1px solid var(--b);border-radius:8px;background:#fff}
  .card{border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:14px}
  .card h2{margin:0 0 8px;font-size:16px}
  .sub{color:var(--muted);font-size:12px;margin-top:-4px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  @media(max-width:560px){.kpi{grid-template-columns:1fr}}
  .pill{border:1px solid var(--b);border-radius:10px;padding:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:9px 12px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer}
  button.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .score{font:600 28px/1.1 system-ui;margin:4px 0}
  .muted{color:var(--muted)}
  .slrow{display:flex;align-items:center;gap:10px}
  .slrow output{min-width:2ch;text-align:right;font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--b);padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa}
  .right{text-align:right}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--b);border-radius:999px;font-size:12px;color:#444}
  .exist{background:var(--hl)}
  .nowrap{white-space:nowrap}
  @media print{
    header,.no-print{display:none!important}
    body{background:#fff}
    .wrap{padding:0}
    .card{border:none;margin:0 0 8mm 0;padding:0}
    .pill{border:1px solid #ddd}
    table,th,td{border:1px solid #999}
    .score{font-size:24px}
  }
</style>
</head>
<body>
<header class="no-print">
  <h1>Hot Water Model</h1>
  <span class="muted">Physics • Cost • Customer-weighted score • Capex & Payback • Printable</span>
  <div style="margin-left:auto" class="actions">
    <button onclick="window.print()">🖨️ Print</button>
  </div>
</header>

<div class="wrap">
  <div class="card no-print">
    <h2>Inputs</h2>
    <div class="grid">
      <div>
        <label>👨‍👩‍👧 Usage</label>
        <select id="usage">
          <option>Low (1–2 ppl)</option>
          <option selected>Med (3–4 ppl)</option>
          <option>High (5–6 ppl)</option>
        </select>
      </div>
      <div>
        <label>🗓️ Season (UK mains temp)</label>
        <select id="mains">
          <option>Winter</option>
          <option selected>Spring/Autumn</option>
          <option>Summer</option>
        </select>
      </div>
      <div>
        <label>🧵 Pipe layout (waiting water)</label>
        <select id="layout">
          <option selected>Central</option>
          <option>Typical</option>
          <option>Remote</option>
        </select>
      </div>
      <div>
        <label>⛽ Gas price ( £ / kWh )</label>
        <input id="gas" type="number" step="0.001" value="0.07">
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div style="grid-column:1/-1">
        <label>🧰 Existing system (choose current setup)</label>
        <select id="existing"></select>
        <div class="sub">The selected system will be highlighted and used for payback calculations.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>🏗️ Capex multiplier (×)</label>
        <input id="capexMult" type="number" step="0.05" value="1.00">
        <div class="sub">Quickly adjust all installed costs (e.g. region, access).</div>
      </div>
      <div>
        <label>🧾 Existing keep-cost (£)</label>
        <input id="capexKeep" type="number" step="50" value="0">
        <div class="sub">Cost to keep the current system (repairs, upgrades). Defaults to 0.</div>
      </div>
      <div>
        <label>💷 Finance rate (%)</label>
        <input id="financeRate" type="number" step="0.1" value="0">
        <div class="sub">If >0, shows annualised cost (annuity) for capex too.</div>
      </div>
      <div>
        <label>Term (years)</label>
        <input id="financeYears" type="number" step="1" value="10">
        <div class="sub">Used only if finance rate > 0.</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">Adjust what matters most:</div>
      <div class="grid" style="margin-top:8px">
        <div class="slrow"><label style="flex:1">🔋 Energy</label><input id="wE" type="range" min="0" max="10" step="1" value="3" oninput="wEVal.value=this.value"><output id="wEVal">3</output></div>
        <div class="slrow"><label style="flex:1">💷 Cost</label><input id="wCost" type="range" min="0" max="10" step="1" value="5" oninput="wCostVal.value=this.value"><output id="wCostVal">5</output></div>
        <div class="slrow"><label style="flex:1">🛁 Comfort</label><input id="wC" type="range" min="0" max="10" step="1" value="4" oninput="wCVal.value=this.value"><output id="wCVal">4</output></div>
        <div class="slrow"><label style="flex:1">🌱 Future-proof</label><input id="wF" type="range" min="0" max="10" step="1" value="4" oninput="wFVal.value=this.value"><output id="wFVal">4</output></div>
        <div class="slrow"><label style="flex:1">🔧 Maintenance</label><input id="wM" type="range" min="0" max="10" step="1" value="2" oninput="wMVal.value=this.value"><output id="wMVal">2</output></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="presetBudget">💰 Budget-led</button>
        <button id="presetComfort">🛁 Comfort-led</button>
        <button id="presetFuture">🌱 Future-ready</button>
        <button id="presetReset">♻️ Reset</button>
        <button id="recalc" class="primary">Recalculate</button>
      </div>
    </div>
  </div>

  <!-- Focused view -->
  <div class="card" id="focusCard">
    <h2>Focused view <span id="focusName" class="badge"></span> <span id="existTag" class="badge" style="display:none">Existing</span></h2>
    <div class="kpi">
      <div class="pill"><div class="muted">Energy</div><div><b id="kwhDay">—</b> kWh/day</div><small id="kwhYear">—</small></div>
      <div class="pill"><div class="muted">Running cost</div><div>£<b id="costDay">—</b> / day</div><small id="costYear">—</small></div>
      <div class="pill"><div class="muted">Waiting water</div><div><b id="wasteL">—</b> L/day</div><small>layout + draws</small></div>
    </div>
    <div class="grid">
      <div class="pill">
        <div class="muted">Customer score</div>
        <div class="score" id="score">—</div>
        <small>🔋 <span id="uE">—</span> • 💷 <span id="uP">—</span> • 🛁 <span id="uC">—</span> • 🌱 <span id="uF">—</span> • 🔧 <span id="uM">—</span></small>
      </div>
      <div class="pill">
        <div class="muted">Breakdown</div>
        <div>Useful <b id="eUse">—</b> kWh/day</div>
        <div>Waiting <b id="eWait">—</b> kWh/day</div>
        <div>Standby <b id="standby">—</b> kWh/day</div>
        <div>η <b id="eta">—</b> • Starts <b id="starts">—</b></div>
        <div class="muted" style="margin-top:6px">Capex £<span id="capexFocus">—</span> • Payback <span id="paybackFocus">—</span></div>
      </div>
      <div class="pill">
        <div class="muted">Selections</div>
        <div id="echo">—</div>
        <div class="actions no-print" style="margin-top:8px">
          <button id="copy">Copy JSON (focused)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Compare All Systems -->
  <div class="card" id="compareCard">
    <h2>Compare all systems</h2>
    <div class="sub">Sorted by Customer score. Click a row to focus. Existing is highlighted.</div>
    <div style="overflow:auto">
      <table id="compareTable">
        <thead>
          <tr>
            <th>System</th>
            <th class="right nowrap">kWh/day</th>
            <th class="right nowrap">£/day</th>
            <th class="right nowrap">Waste L/day</th>
            <th class="right nowrap">Score</th>
            <th class="right nowrap">η</th>
            <th class="right nowrap">Standby</th>
            <th class="right nowrap">Capex £</th>
            <th class="right nowrap">Run £/yr</th>
            <th class="right nowrap">Year-1 £</th>
            <th class="right nowrap">Payback (yrs)</th>
          </tr>
        </thead>
        <tbody id="compareBody"></tbody>
      </table>
    </div>
  </div>

  <footer class="muted">© Hot Water Model — full scope + capex/payback, printable</footer>
</div>

<script type="module">
/* === MODEL CORE === */
const CP=0.001163,cl=(v,a,b)=>Math.max(a,Math.min(b,v)),rd=(n,d=2)=>Math.round(n*10**d)/10**d;
const eta=t=>t<=30?0.98:t>=55?0.88:0.98-0.004*(t-30),invU=(v,b)=>cl(100*(b/v),10,100);

/* Presets */
const PRE={
  usage:{"Low (1–2 ppl)":{Vd:80,dr:12},"Med (3–4 ppl)":{Vd:130,dr:18},"High (5–6 ppl)":{Vd:180,dr:24}},
  mains:{"Winter":8,"Spring/Autumn":12,"Summer":16},
  layout:{"Central":.35,"Typical":.7,"Remote":1.2},
  systems:{
    "Regular • Open CH + Open-vented cyl":      {t:"s", sb:1.8, cf:1.00, Tr:54, C:86, F:65, M:72, capex:2200},
    "Regular • Sealed CH + Open-vented cyl":    {t:"s", sb:1.7, cf:1.00, Tr:52, C:87, F:70, M:74, capex:2400},
    "Regular • Open CH + Unvented cyl":         {t:"s", sb:1.5, cf:1.00, Tr:52, C:88, F:82, M:80, capex:2800},
    "Regular • Sealed CH + Unvented cyl":       {t:"s", sb:1.4, cf:1.00, Tr:50, C:89, F:84, M:82, capex:3000},

    "System • Open-vented cyl":                 {t:"s", sb:1.6, cf:1.00, Tr:51, C:90, F:75, M:78, capex:2600},
    "System • Unvented cyl":                    {t:"s", sb:1.3, cf:1.00, Tr:49, C:91, F:86, M:84, capex:3200},

    "System • Mixergy Unvented (indirect)":     {t:"s", sb:1.0, cf:.95, Tr:48, C:92, F:95, M:85, capex:3800},
    "System • Mixergy Vented (open-vented)":    {t:"s", sb:1.1, cf:.96, Tr:49, C:91, F:88, M:83, capex:3500},

    "Combi • Standard":                         {t:"c", st:.01,  sc:1.05, Tr:55, C:72, F:50, M:70, capex:1800},
    "Combi • Premium (conditioned/central)":    {t:"c", st:.008, sc:1.00, Tr:52, C:78, F:55, M:78, capex:2300},
  },
  Tuse:40,
  price:{ gas:.07, water:.0003 }
};

/* Core calc */
function calcOne({sysKey, usageKey, mainsKey, layoutKey, prices}){
  const U=PRE.usage[usageKey], M=PRE.mains[mainsKey], L=PRE.layout[layoutKey], S=PRE.systems[sysKey];
  const Tu=PRE.Tuse, Tm=M, pgas=prices.gas, pw=prices.water;
  const Eu = U.Vd*CP*(Tu-Tm);
  const Vw = L*U.dr;
  const Ew = Vw*CP*(Tu-Tm);
  const etaVal  = eta(S.Tr);

  let E, GBP, standby=0, starts=0;
  if(S.t==="s"){
    const Egas=((Eu+Ew)/etaVal)*S.cf;
    standby=S.sb; E=Egas+standby;
    GBP = E*pgas + Vw*pw;
  }else{
    const etaEff=etaVal/(S.sc||1);
    starts = U.dr;
    const Eover = starts*(S.st||.01);
    E = ((Eu+Ew)/etaEff) + Eover;
    GBP = E*pgas + Vw*pw;
  }

  return {
    sysKey, usageKey, mainsKey, layoutKey,
    kWh: rd(E,3),
    cost: rd(GBP,2),
    kWh_year: Math.round(E*365),
    cost_year: Math.round(GBP*365),
    wasteL: rd(Vw,1),
    breakdown: { E_use: rd(Eu,3), E_wait: rd(Ew,3), standby: rd(standby,3), eta: rd(etaVal,3), starts },
    capexBase: realisticFitCost(sysKey, 'swap')
  };
}

/* Scoring */
function scoreAll(results, weights){
  const refKeys = ["System • Mixergy Unvented (indirect)", "Combi • Premium (conditioned/central)"];
  const refs = results.filter(r=>refKeys.includes(r.sysKey));
  const bestKWh = Math.min(...refs.map(r=>r.kWh));
  const bestGBP = Math.min(...refs.map(r=>r.cost));

  return results.map(r=>{
    const S=PRE.systems[r.sysKey];
    const pen = r.layoutKey==="Central"?0 : r.layoutKey==="Typical"?6 : 12;
    const Ue = invU(r.kWh, bestKWh);
    const Up = invU(r.cost, bestGBP);
    const Uc = cl((S.C||75)-pen,10,100);
    const Uf = cl(S.F||60,10,100);
    const Um = cl(S.M||70,10,100);
    const W  = weights;
    const score = (W.e*Ue + W.c*Up + W.C*Uc + W.F*Uf + W.M*Um) / (W.e+W.c+W.C+W.F+W.M);
    return {...r, utilities:{ Ue:Math.round(Ue), Up:Math.round(Up), Uc:Math.round(Uc), Uf:Math.round(Uf), Um:Math.round(Um), score:Math.round(score) }};
  });
}

/* Finance helpers */
function annuityPayment(capex, ratePct, years){
  const r = (ratePct||0)/100;
  if(r<=0) return 0;           // no financing cost included
  const n = Math.max(1, years||1);
  const f = r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1); // capital recovery factor
  return capex * f;
}

// Approximate installed cost for a given system. Scenario lets us nudge for conversions.
function realisticFitCost(sysKey, scenario="swap"){
  let cost = 4000; // baseline
  if(sysKey.includes("Combi • Standard")) cost = 3300;
  if(sysKey.includes("Combi • Premium")) cost = 3800;
  if(sysKey.includes("System • Unvented")) cost = 4600;
  if(sysKey.includes("Regular")) cost = 4000;
  if(sysKey.includes("Mixergy")) cost = 5500;

  if((scenario||"").includes("conversion")) cost += 1200;
  return cost;
}

// Describe the scenario (swap vs conversion) based on current vs target system families.
function scenarioLabel(existingKey="", targetKey=""){
  const parseType = key => (key.split('•')[0]||'').trim().toLowerCase();
  const existingType = parseType(existingKey);
  const targetType = parseType(targetKey);
  if(!existingType || !targetType) return 'swap';
  if(existingType === targetType) return 'swap';
  if(targetType === 'combi') return 'conversion-to-combi';
  return 'conversion';
}

/* ===== UI Wiring ===== */
const $=s=>document.querySelector(s);
const els={
  usage:$('#usage'), mains:$('#mains'), layout:$('#layout'), gas:$('#gas'),
  existing:$('#existing'),
  capexMult:$('#capexMult'), capexKeep:$('#capexKeep'),
  financeRate:$('#financeRate'), financeYears:$('#financeYears'),
  wE:$('#wE'), wCost:$('#wCost'), wC:$('#wC'), wF:$('#wF'), wM:$('#wM'),
  focusName:$('#focusName'), existTag:$('#existTag'),
  kwhDay:$('#kwhDay'), kwhYear:$('#kwhYear'),
  costDay:$('#costDay'), costYear:$('#costYear'),
  wasteL:$('#wasteL'), score:$('#score'),
  uE:$('#uE'), uP:$('#uP'), uC:$('#uC'), uF:$('#uF'), uM:$('#uM'),
  eUse:$('#eUse'), eWait:$('#eWait'), standby:$('#standby'), eta:$('#eta'), starts:$('#starts'),
  capexFocus:$('#capexFocus'), paybackFocus:$('#paybackFocus'),
  echo:$('#echo'),
  compareBody:$('#compareBody'),
  copyBtn:$('#copy'),
  recalcBtn:$('#recalc'),
  presetBudget:$('#presetBudget'),
  presetComfort:$('#presetComfort'),
  presetFuture:$('#presetFuture'),
  presetReset:$('#presetReset')
};

/* Populate existing-system select */
(function populateExisting(){
  const keys = Object.keys(PRE.systems);
  els.existing.innerHTML = keys.map((k,i)=>`<option ${k.includes('Combi • Standard')?'selected':''}>${k}</option>`).join('');
})();

function getState(){
  return {
    usageKey: els.usage.value,
    mainsKey: els.mains.value,
    layoutKey: els.layout.value,
    existingKey: els.existing.value,
    prices: { gas: parseFloat(els.gas.value||"0.07"), water: 0.0003 },
    weights: { e:+els.wE.value, c:+els.wCost.value, C:+els.wC.value, F:+els.wF.value, M:+els.wM.value },
    capexMult: parseFloat(els.capexMult.value||"1"),
    capexKeep: parseFloat(els.capexKeep.value||"0"),
    financeRate: parseFloat(els.financeRate.value||"0"),
    financeYears: parseInt(els.financeYears.value||"10",10)
  };
}

function runAll(){
  const st = getState();

  // Calculate baseline (existing) first for payback
  const existing = calcOne({
    sysKey: st.existingKey,
    usageKey: st.usageKey,
    mainsKey: st.mainsKey,
    layoutKey: st.layoutKey,
    prices: st.prices
  });
  const existingRunYr = existing.cost_year;
  const existingCapex = existing.capexBase * st.capexMult;
  const keepCost = st.capexKeep; // cost to keep existing (repairs/upgrades)
  const existingAnnualised = annuityPayment(existingCapex, st.financeRate, st.financeYears);

  // Compute all systems
  const resultsRaw = Object.keys(PRE.systems).map(sysKey => calcOne({
    sysKey, usageKey: st.usageKey, mainsKey: st.mainsKey, layoutKey: st.layoutKey, prices: st.prices
  }));

  // Add capex/payback to each
  const results = resultsRaw.map(r=>{
    const scenario = scenarioLabel(st.existingKey, r.sysKey);
    const fitCost = realisticFitCost(r.sysKey, scenario);
    const capex = fitCost * st.capexMult;
    const runYr = r.cost_year;
    const year1 = capex + runYr;
    const annualised = annuityPayment(capex, st.financeRate, st.financeYears);

    // Incremental capex vs existing: (new capex - keep existing cost)
    const incrCapex = Math.max(0, capex - keepCost);
    const annualSaving = Math.max(0, existingRunYr - runYr);
    const payback = annualSaving>0 ? (incrCapex/annualSaving) : Infinity;

    // Also report a "total annual cost" if finance used: runYr + annualised
    const totalAnnualWithFinance = runYr + annualised;

    return {
      ...r,
      scenario,
      fitCost: Math.round(fitCost),
      capex: Math.round(capex),
      year1: Math.round(year1),
      runYr: Math.round(runYr),
      payback: (payback===Infinity? "—" : (payback>99? "99+" : payback.toFixed(1))),
      annualised: Math.round(annualised),
      totalAnnualWithFinance: Math.round(totalAnnualWithFinance)
    };
  });

  // Score and sort
  const scored = scoreAll(results, st.weights).sort((a,b)=>b.utilities.score - a.utilities.score);

  // Render table
  els.compareBody.innerHTML = scored.map(r=>`
    <tr data-sys="${r.sysKey}" class="${r.sysKey===st.existingKey?'exist':''}">
      <td>${r.sysKey}${r.sysKey===st.existingKey?' <span class="badge">Existing</span>':''}</td>
      <td class="right">${r.kWh}</td>
      <td class="right">£${r.cost.toFixed(2)}</td>
      <td class="right">${r.wasteL}</td>
      <td class="right"><b>${r.utilities.score}</b></td>
      <td class="right">${r.breakdown.eta}</td>
      <td class="right">${r.breakdown.standby}</td>
      <td class="right">£${r.capex.toLocaleString()}</td>
      <td class="right">£${r.runYr.toLocaleString()}</td>
      <td class="right">£${r.year1.toLocaleString()}</td>
      <td class="right">${r.payback}</td>
    </tr>
  `).join('');

  for(const tr of els.compareBody.querySelectorAll('tr')){
    tr.onclick = ()=> focus(scored.find(x=>x.sysKey===tr.dataset.sys), st.existingKey);
  }

  // Focus existing by default
  const existingRow = scored.find(x=>x.sysKey===st.existingKey);
  focus(existingRow || scored[0], st.existingKey, st);
  return {scored, st};
}

function focus(r, existingKey, st){
  if(!r) return;
  els.focusName.textContent = r.sysKey;
  els.existTag.style.display = (r.sysKey===existingKey) ? '' : 'none';

  els.kwhDay.textContent    = r.kWh;
  els.kwhYear.textContent   = `≈ ${r.kWh_year} kWh / yr`;
  els.costDay.textContent   = r.cost.toFixed(2);
  els.costYear.textContent  = `≈ £${r.cost_year} / yr`;
  els.wasteL.textContent    = r.wasteL;
  els.score.textContent     = r.utilities.score;

  els.uE.textContent        = r.utilities.Ue;
  els.uP.textContent        = r.utilities.Up;
  els.uC.textContent        = r.utilities.Uc;
  els.uF.textContent        = r.utilities.Uf;
  els.uM.textContent        = r.utilities.Um;

  els.eUse.textContent      = r.breakdown.E_use;
  els.eWait.textContent     = r.breakdown.E_wait;
  els.standby.textContent   = r.breakdown.standby;
  els.eta.textContent       = r.breakdown.eta;
  els.starts.textContent    = r.breakdown.starts;

  els.capexFocus.textContent = r.capex.toLocaleString();
  const paybackLabel = (r.payback==="—"?"—" : `${r.payback} yrs`);
  els.paybackFocus.textContent = paybackLabel;

  els.echo.textContent      = `${r.usageKey} • ${r.mainsKey} • ${r.layoutKey}`;

  els.copyBtn.onclick = ()=> navigator.clipboard.writeText(JSON.stringify(r, null, 2));
}

// Presets (emoji)
els.presetBudget.onclick  = ()=>{ els.wE.value=3; els.wCost.value=8; els.wC.value=2; els.wF.value=2; els.wM.value=2; runAll(); };
els.presetComfort.onclick = ()=>{ els.wE.value=3; els.wCost.value=3; els.wC.value=8; els.wF.value=3; els.wM.value=3; runAll(); };
els.presetFuture.onclick  = ()=>{ els.wE.value=5; els.wCost.value=4; els.wC.value=3; els.wF.value=8; els.wM.value=2; runAll(); };
els.presetReset.onclick   = ()=>{ els.wE.value=3; els.wCost.value=5; els.wC.value=4; els.wF.value=4; els.wM.value=2; runAll(); };

els.recalcBtn.onclick = runAll;
for(const el of document.querySelectorAll('input,select')) el.addEventListener('change', runAll);

// Init
runAll();
</script>
</body>
</html>
