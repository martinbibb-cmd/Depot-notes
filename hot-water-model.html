<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hot Water Model — SEDBUK Payback, Full Scope</title>
<style>
  :root{--fg:#111;--bg:#fff;--muted:#666;--b:#e5e7eb;--pri:#0b84ff;--hl:#fff7cc}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu;color:var(--fg);background:var(--bg)}
  header{padding:14px 16px;border-bottom:1px solid var(--b);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:16px;margin:0}
  .wrap{max-width:1150px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  label{font-weight:600;font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  select,input[type="number"],input[type="range"]{width:100%}
  input[type="number"],select{padding:8px 10px;border:1px solid var(--b);border-radius:8px;background:#fff}
  .card{border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:14px}
  .card h2{margin:0 0 8px;font-size:16px}
  .sub{color:var(--muted);font-size:12px;margin-top:-4px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  @media(max-width:560px){.kpi{grid-template-columns:1fr}}
  .pill{border:1px solid var(--b);border-radius:10px;padding:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:9px 12px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer}
  button.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .score{font:600 28px/1.1 system-ui;margin:4px 0}
  .muted{color:var(--muted)}
  .slrow{display:flex;align-items:center;gap:10px}
  .slrow output{min-width:3ch;text-align:right;font-variant-numeric:tabular-nums}
  .usage-label{min-width:160px;text-align:left;font-weight:600;font-size:13px;color:var(--fg)}
  .field-check{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--fg)}
  .field-check input{width:auto;margin:0}
  .field-check span{flex:1}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--b);padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa}
  .right{text-align:right}
  .homecare-summary{font-size:12px;line-height:1.35;color:var(--muted)}
  .homecare-summary b{color:var(--fg)}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--b);border-radius:999px;font-size:12px;color:#444}
  .badge.warn{background:#fff4e5;border-color:#f59e0b;color:#92400e}
  .exist{background:var(--hl)}
  .nowrap{white-space:nowrap}
  .focus-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:12px}
  @media(max-width:1100px){.focus-cols{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}}
  @media(max-width:720px){.focus-cols{grid-template-columns:1fr}}
  .focus-col{border:1px solid var(--b);border-radius:10px;padding:12px;background:#fff}
  .focus-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .focus-title h3{margin:4px 0 0;font-size:16px}
  .focus-note{margin-top:6px;color:var(--muted);font-size:13px}
  .focus-warn{margin-top:4px;color:#92400e;font-size:13px}
  .focus-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
  .badge.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .preferred-control{display:flex;align-items:center;flex-wrap:wrap;gap:10px;margin:12px 0 0}
  .preferred-control label{font-weight:600;font-size:12px;color:var(--muted)}
  .preferred-control select{min-width:220px;max-width:320px}
  @media print{
    header,.no-print{display:none!important}
    body{background:#fff}
    .wrap{padding:0}
    .card{border:none;margin:0 0 8mm 0;padding:0}
    .pill{border:1px solid #ddd}
    table,th,td{border:1px solid #999}
    .score{font-size:24px}
  }
</style>
</head>
<body>
<header class="no-print">
  <h1>Hot Water Model</h1>
  <span class="muted">Physics • Cost • Customer score • SEDBUK Payback • Printable</span>
  <div style="margin-left:auto" class="actions">
    <button onclick="window.print()">🖨️ Print</button>
  </div>
</header>

<div class="wrap">
  <div class="card no-print">
    <h2>Inputs</h2>
    <div class="grid">
      <div>
        <label for="usage">👨‍👩‍👧 Usage</label>
        <div class="slrow">
          <input id="usage" type="range" min="1" max="8" step="1" value="4">
          <output id="usageLabel" class="usage-label">Average (4 people)</output>
        </div>
      </div>
      <div>
        <label>🗓️ Season (UK mains temp)</label>
        <select id="mains">
          <option>Winter</option>
          <option selected>Spring/Autumn</option>
          <option>Summer</option>
        </select>
      </div>
      <div>
        <label>🧵 Pipe layout (waiting water)</label>
        <select id="layout">
          <option selected>Central</option>
          <option>Typical</option>
          <option>Remote</option>
        </select>
      </div>
      <div>
        <label for="pipeScreed">🧱 Pipe work in screed</label>
        <div class="field-check">
          <input id="pipeScreed" type="checkbox">
          <span>Reduce suitability for system &amp; combi</span>
        </div>
        <div class="sub">Applies a penalty to system and combi options.</div>
      </div>
      <div>
        <label>⛽ Gas price ( £ / kWh )</label>
        <input id="gas" type="number" step="0.001" value="0.07">
      </div>
      <div>
        <label for="heating">🔥 Heating demand (kWh/yr)</label>
        <div class="slrow">
          <input id="heating" type="range" min="4000" max="30000" step="100" value="12000">
          <output id="heatingLabel" class="usage-label">Average (12,000 kWh/yr)</output>
        </div>
        <div class="sub">Annual space-heating load to include in running costs.</div>
      </div>
      <div>
        <label>🚿 Water flow (L/min)</label>
        <input id="flow" type="number" step="0.5" value="14">
        <div class="sub">Estimate mains flow. Below 12 L/min we avoid combis.</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div style="grid-column:1/-1">
        <label>🧰 Existing system type</label>
        <select id="existing"></select>
      </div>
      <div class="slrow" title="SEDBUK seasonal efficiency of the CURRENT boiler">
        <label style="flex:1">📊 Existing SEDBUK (%)</label>
        <input id="sedbuk" type="range" min="55" max="95" step="1" value="78" oninput="sedVal.value=this.value">
        <output id="sedVal">78</output>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>Combi warranty term</label>
        <select id="warrantyCombi">
          <option value="5">5 years</option>
          <option value="10" selected>10 years</option>
          <option value="12">12 years</option>
        </select>
      </div>
      <div>
        <label>System/regular warranty term</label>
        <select id="warrantySystem">
          <option value="5">5 years</option>
          <option value="10" selected>10 years</option>
          <option value="12">12 years</option>
        </select>
      </div>
      <div>
        <label>Homecare cover level</label>
        <select id="homecareCover">
          <option value="boiler-controls" selected>Boiler &amp; controls</option>
          <option value="system-excess">Full system (£60 excess)</option>
          <option value="system-no-excess">Full system (no excess)</option>
        </select>
      </div>
      <div>
        <label>Current Homecare cost ( £ / yr )</label>
        <input id="homecareCurrent" type="number" min="0" step="1" value="0">
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">Adjust what matters most:</div>
      <div class="grid" style="margin-top:8px">
        <div class="slrow"><label style="flex:1">🔋 Energy</label><input id="wE" type="range" min="0" max="10" step="1" value="3" oninput="wEVal.value=this.value"><output id="wEVal">3</output></div>
        <div class="slrow"><label style="flex:1">💷 Cost</label><input id="wCost" type="range" min="0" max="10" step="1" value="5" oninput="wCostVal.value=this.value"><output id="wCostVal">5</output></div>
        <div class="slrow"><label style="flex:1">🛁 Comfort</label><input id="wC" type="range" min="0" max="10" step="1" value="4" oninput="wCVal.value=this.value"><output id="wCVal">4</output></div>
        <div class="slrow"><label style="flex:1">🌱 Future-proof</label><input id="wF" type="range" min="0" max="10" step="1" value="4" oninput="wFVal.value=this.value"><output id="wFVal">4</output></div>
        <div class="slrow"><label style="flex:1">🔧 Maintenance</label><input id="wM" type="range" min="0" max="10" step="1" value="2" oninput="wMVal.value=this.value"><output id="wMVal">2</output></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="presetBudget">💰 Budget-led</button>
        <button id="presetComfort">🛁 Comfort-led</button>
        <button id="presetFuture">🌱 Future-ready</button>
        <button id="presetReset">♻️ Reset</button>
        <button id="recalc" class="primary">Recalculate</button>
      </div>
    </div>
  </div>

  <!-- Focused view -->
  <div class="card" id="focusCard">
    <h2>Focused comparison</h2>
    <div class="sub">Totals include hot water + heating demand. Click the table to change the best option. Use the selector to pin a preferred system.</div>
    <div class="preferred-control no-print">
      <label for="preferredSelect">Preferred option</label>
      <select id="preferredSelect">
        <option value="">— None selected —</option>
      </select>
    </div>
    <div class="focus-cols">
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge" id="existTag">Existing</span>
            <h3 id="existName">—</h3>
          </div>
        </div>
        <div class="focus-note" id="existEcho">—</div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="existKwhDay">—</b> kWh/day</div><small id="existKwhYear">—</small></div>
          <div class="pill"><div class="muted">Annual saving</div><div>£<b id="existSaving">—</b> / yr</div><small>vs current system</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="existWasteL">—</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="existScore">—</div>
            <small>🔋 <span id="existUE">—</span> • 💷 <span id="existUP">—</span> • 🛁 <span id="existUC">—</span> • 🌱 <span id="existUF">—</span> • 🔧 <span id="existUM">—</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="existEUse">—</b> kWh/day</div>
            <div>Waiting <b id="existEWait">—</b> kWh/day</div>
            <div>Standby <b id="existStandby">—</b> kWh/day</div>
            <div>Heating input <b id="existHeatInput">—</b> kWh/day</div>
            <div>Heating delivered <b id="existHeatDelivered">—</b> kWh/day</div>
            <div>η <b id="existEta">—</b> • Starts <b id="existStarts">—</b></div>
            <div class="muted" style="margin-top:6px">Payback <span id="existPayback">—</span></div>
          </div>
          <div class="pill" id="existHomecare" style="display:none">
            <div class="muted">Homecare savings</div>
            <div id="existHomecareCover">—</div>
            <div>Year 1: <b id="existHomecareYear1">—</b></div>
            <div>Years 2-<span id="existHomecareYearsLabel">—</span>: <b id="existHomecareYears">—</b></div>
            <div>Total: <b id="existHomecareTotal">—</b></div>
          </div>
        </div>
      </div>
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge" id="likeTag">Like for like</span>
            <h3 id="likeName">—</h3>
          </div>
        </div>
        <div class="focus-note" id="likeEcho">—</div>
        <div class="focus-warn" id="likeWarn"></div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="likeKwhDay">—</b> kWh/day</div><small id="likeKwhYear">—</small></div>
          <div class="pill"><div class="muted">Annual saving</div><div>£<b id="likeSaving">—</b> / yr</div><small>vs current system</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="likeWasteL">—</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="likeScore">—</div>
            <small>🔋 <span id="likeUE">—</span> • 💷 <span id="likeUP">—</span> • 🛁 <span id="likeUC">—</span> • 🌱 <span id="likeUF">—</span> • 🔧 <span id="likeUM">—</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="likeEUse">—</b> kWh/day</div>
            <div>Waiting <b id="likeEWait">—</b> kWh/day</div>
            <div>Standby <b id="likeStandby">—</b> kWh/day</div>
            <div>Heating input <b id="likeHeatInput">—</b> kWh/day</div>
            <div>Heating delivered <b id="likeHeatDelivered">—</b> kWh/day</div>
            <div>η <b id="likeEta">—</b> • Starts <b id="likeStarts">—</b></div>
            <div class="muted" style="margin-top:6px">Payback <span id="likePayback">—</span></div>
          </div>
          <div class="pill" id="likeHomecare" style="display:none">
            <div class="muted">Homecare savings</div>
            <div id="likeHomecareCover">—</div>
            <div>Year 1: <b id="likeHomecareYear1">—</b></div>
            <div>Years 2-<span id="likeHomecareYearsLabel">—</span>: <b id="likeHomecareYears">—</b></div>
            <div>Total: <b id="likeHomecareTotal">—</b></div>
          </div>
        </div>
      </div>
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge" id="preferredTag">Preferred option</span>
            <h3 id="preferredName">—</h3>
          </div>
        </div>
        <div class="focus-note" id="preferredEcho">—</div>
        <div class="focus-warn" id="preferredWarn"></div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="preferredKwhDay">—</b> kWh/day</div><small id="preferredKwhYear">—</small></div>
          <div class="pill"><div class="muted">Annual saving</div><div>£<b id="preferredSaving">—</b> / yr</div><small>vs current system</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="preferredWasteL">—</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="preferredScore">—</div>
            <small>🔋 <span id="preferredUE">—</span> • 💷 <span id="preferredUP">—</span> • 🛁 <span id="preferredUC">—</span> • 🌱 <span id="preferredUF">—</span> • 🔧 <span id="preferredUM">—</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="preferredEUse">—</b> kWh/day</div>
            <div>Waiting <b id="preferredEWait">—</b> kWh/day</div>
            <div>Standby <b id="preferredStandby">—</b> kWh/day</div>
            <div>Heating input <b id="preferredHeatInput">—</b> kWh/day</div>
            <div>Heating delivered <b id="preferredHeatDelivered">—</b> kWh/day</div>
            <div>η <b id="preferredEta">—</b> • Starts <b id="preferredStarts">—</b></div>
            <div class="muted" style="margin-top:6px">Payback <span id="preferredPayback">—</span></div>
          </div>
          <div class="pill" id="preferredHomecare" style="display:none">
            <div class="muted">Homecare savings</div>
            <div id="preferredHomecareCover">—</div>
            <div>Year 1: <b id="preferredHomecareYear1">—</b></div>
            <div>Years 2-<span id="preferredHomecareYearsLabel">—</span>: <b id="preferredHomecareYears">—</b></div>
            <div>Total: <b id="preferredHomecareTotal">—</b></div>
          </div>
        </div>
      </div>
      <div class="focus-col">
        <div class="focus-title">
          <div>
            <span class="badge primary" id="focusTag">Top pick</span>
            <h3 id="focusName">—</h3>
          </div>
          <div class="actions no-print">
            <button id="copy">Copy JSON (focused)</button>
          </div>
        </div>
        <div class="focus-note" id="focusEcho">—</div>
        <div class="focus-warn" id="focusWarn"></div>
        <div class="kpi">
          <div class="pill"><div class="muted">Energy</div><div><b id="focusKwhDay">—</b> kWh/day</div><small id="focusKwhYear">—</small></div>
          <div class="pill"><div class="muted">Annual saving</div><div>£<b id="focusSaving">—</b> / yr</div><small>vs current system</small></div>
          <div class="pill"><div class="muted">Waiting water</div><div><b id="focusWasteL">—</b> L/day</div><small>layout + draws</small></div>
        </div>
        <div class="focus-meta">
          <div class="pill">
            <div class="muted">Customer score</div>
            <div class="score" id="focusScore">—</div>
            <small>🔋 <span id="focusUE">—</span> • 💷 <span id="focusUP">—</span> • 🛁 <span id="focusUC">—</span> • 🌱 <span id="focusUF">—</span> • 🔧 <span id="focusUM">—</span></small>
          </div>
          <div class="pill">
            <div class="muted">Breakdown</div>
            <div>Useful <b id="focusEUse">—</b> kWh/day</div>
            <div>Waiting <b id="focusEWait">—</b> kWh/day</div>
            <div>Standby <b id="focusStandby">—</b> kWh/day</div>
            <div>Heating input <b id="focusHeatInput">—</b> kWh/day</div>
            <div>Heating delivered <b id="focusHeatDelivered">—</b> kWh/day</div>
            <div>η <b id="focusEta">—</b> • Starts <b id="focusStarts">—</b></div>
            <div class="muted" style="margin-top:6px">Payback <span id="focusPayback">—</span></div>
          </div>
          <div class="pill" id="focusHomecare" style="display:none">
            <div class="muted">Homecare savings</div>
            <div id="focusHomecareCover">—</div>
            <div>Year 1: <b id="focusHomecareYear1">—</b></div>
            <div>Years 2-<span id="focusHomecareYearsLabel">—</span>: <b id="focusHomecareYears">—</b></div>
            <div>Total: <b id="focusHomecareTotal">—</b></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compare All Systems -->
  <div class="card" id="compareCard">
    <h2>Compare all systems</h2>
    <div class="sub">Sorted by Customer score. Includes your current system and a modern like-for-like. Click a row to focus. Annual savings vs your current system include heating demand. Payback uses your SEDBUK baseline.</div>
    <div style="overflow:auto">
      <table id="compareTable">
        <thead>
          <tr>
            <th>System</th>
            <th class="right nowrap">kWh/day</th>
            <th class="right nowrap">Score</th>
            <th class="right nowrap">Annual saving £/yr</th>
            <th>Homecare savings</th>
          </tr>
        </thead>
        <tbody id="compareBody"></tbody>
      </table>
    </div>
  </div>

  <section id="hwc-caveat-banner" role="note" aria-live="polite" style="margin:1rem 0;border:1px solid #ddd;padding:0.75rem 1rem;border-radius:8px;background:#fafafa;">
    <strong>Important: illustration only</strong> — The figures shown are estimates based on user inputs and generic assumptions. This is <strong>not</strong> financial advice, insurance advice, or a personal recommendation. Actual outcomes vary with property characteristics, installation specifics, draw patterns, tariffs, and future price changes.
  </section>

  <details id="hwc-assumptions" open style="margin:1rem 0;">
    <summary style="cursor:pointer;font-weight:600;">Assumptions & Method</summary>
    <div style="padding:0.5rem 0 0 0; line-height:1.45;">
      <ul style="margin:0.25rem 1.25rem;">
        <li><strong>Energy prices:</strong> Calculations use the unit rates entered on this page. Any default values (where present) are placeholders and should be replaced with your tariff for accuracy.</li>
        <li><strong>Usage / hot-water demand:</strong> Estimates assume typical domestic draw patterns for a family household. Real usage can vary substantially by occupancy, shower/bath habits, flow rates, and seasonal behaviour.</li>
        <li><strong>Efficiencies (SEDBUK/ERP):</strong> Baseline and proposed system efficiencies are interpreted as steady-state seasonal averages. Actual performance varies with return temperatures, controls, and emitter sizing.</li>
        <li><strong>Payback concept:</strong> Any payback presented reflects the simple ratio of upfront cost difference to annualised running-cost difference under current assumptions. It is <em>not</em> a guarantee and excludes finance costs, major repairs, or tariff changes.</li>
        <li><strong>Maintenance / “Homecare” comparisons:</strong> If any maintenance or plan cost comparisons are displayed elsewhere on this page, they are <em>illustrative only</em> (not a quote or advice) and may not reflect eligibility, excesses, exclusions, or live prices.</li>
        <li><strong>Installation scope limits:</strong> Figures exclude atypical layouts, secondary returns (unless explicitly entered elsewhere on the page), pasteurisation/legionella cycles, pipework upsizing, mixing valve losses, and commissioning adjustments.</li>
        <li><strong>Water distribution realities (important):</strong> The model’s headline figures do <em>not</em> currently account for the extra water typically run to waste before stable hot water is delivered at outlets.
          <ul style="margin:0.25rem 1.25rem;">
            <li><strong>Combi systems:</strong> Each hot draw usually has two components of unavoidable waste before stable hot water arrives:
              <ul style="margin:0.2rem 1.25rem;">
                <li><em>Pipe “cold slug” volume:</em> the standing water in the pipe between the boiler and the tap/shower (e.g., ~1.0–2.0 L for ~8–12 m of 15&nbsp;mm pipe; more for longer runs or larger bore).</li>
                <li><em>Ignition/preheat stabilisation:</em> additional waste while the burner/plate exchanger ramps to a steady output (commonly ~0.8–2.2 L per draw, depending on appliance, flow, and inlet temperature).</li>
              </ul>
              <div style="opacity:0.85;">In practice this means a combi hot tap often wastes <strong>≈1.8–4.0&nbsp;L per draw</strong> before stable hot water, depending on run length and flow rate. This is a normal characteristic of instantaneous DHW and is <em>not</em> included in the current cost figures.</div>
            </li>
            <li><strong>System/regular (cylinder-fed):</strong> No burner ignition delay for DHW; typical waste is mainly the pipe “cold slug.” Where a <em>secondary return loop</em> is fitted and active, the effective waste at frequent-use outlets may be significantly reduced (at the expense of some standing heat loss from the loop).</li>
          </ul>
        </li>
        <li><strong>Uncertainty:</strong> All numbers should be viewed as <em>estimates</em>. Small changes in tariffs, flows, setpoints, pipe runs, and usage patterns can lead to materially different annual costs and payback.</li>
      </ul>

      <div style="margin-top:0.75rem; font-size:0.95rem; opacity:0.9;">
        <strong>Good practice:</strong> confirm actual tariffs; note approximate pipe run lengths and bores to key outlets; record presence/operation of any secondary return; and capture shower/bath frequency and typical flow rates for a more realistic comparison.
      </div>
    </div>
  </details>

  <!-- Optional small-print marker for printed exports (purely textual; no logic): -->
  <div id="hwc-print-note" style="margin:0.75rem 0 0 0; font-size:0.9rem; opacity:0.8;">
    Print/export note: values reflect inputs at the time of printing and generic assumptions above. Version/date: <span data-hwc="timestamp"></span>.
  </div>

  <footer class="muted">© Hot Water Model — SEDBUK payback build</footer>
</div>

<script type="module">
/* ==== CORE CONSTANTS & HELPERS ==== */
const CP=0.001163,cl=(v,a,b)=>Math.max(a,Math.min(b,v)),rd=(n,d=2)=>Math.round(n*10**d)/10**d;
const etaCurve=t=>t<=30?0.98:t>=55?0.88:0.98-0.004*(t-30);
const invU=(v,b)=>cl(100*(b/v),10,100);
const escapeHtml=str=>String(str??'').replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[ch]||ch);

/* === HWM combi wait-loss model (additive; safe defaults) === */
const HWM_WASTE={
  pipeIDm:{'10mm':0.008,'12mm':0.010,'15mm':0.013,'22mm':0.021},
  defaultRunMeters:8,
  defaultPipe:'15mm',
  combiIgnitionWasteL:{min:0.8,mid:1.4,max:2.2},
  deltaT:35,
  range:'mid'
};
function hwm_pipeID(pipe){
  return HWM_WASTE.pipeIDm[String(pipe||'').toLowerCase()]??HWM_WASTE.pipeIDm[HWM_WASTE.defaultPipe];
}
function hwm_coldSlugLitres(runMeters, pipeIDm){
  const r=(pipeIDm||hwm_pipeID())/2;
  const vol_m3=Math.PI*r*r*Math.max(0,runMeters??HWM_WASTE.defaultRunMeters);
  return vol_m3*1000;
}
function hwm_cylinderWasteLPerDraw(runMeters, pipe){
  return hwm_coldSlugLitres(runMeters, hwm_pipeID(pipe));
}
function hwm_combiWasteLPerDraw(runMeters, pipe, range=HWM_WASTE.range){
  const slug=hwm_coldSlugLitres(runMeters, hwm_pipeID(pipe));
  const ign=HWM_WASTE.combiIgnitionWasteL[range]??HWM_WASTE.combiIgnitionWasteL.mid;
  return slug+ign;
}
function hwm_kWhPerL(deltaT=HWM_WASTE.deltaT){
  return (4.186*deltaT)/3600;
}
function hwm_runMetersFromSlug(slugL, pipe){
  const pipeID=hwm_pipeID(pipe);
  if(!pipeID) return HWM_WASTE.defaultRunMeters;
  const area=Math.PI*(pipeID/2)**2;
  const vol_m3=Math.max(0, slugL||0)/1000;
  if(!area) return HWM_WASTE.defaultRunMeters;
  if(vol_m3<=0) return 0;
  const length=vol_m3/area;
  return Number.isFinite(length)&&length>0?length:HWM_WASTE.defaultRunMeters;
}

/* ==== USAGE LEVELS ==== */
const USAGE_LEVELS=[
  {value:1,key:"1 person",label:"1 person",Vd:55,dr:9},
  {value:2,key:"2 people",label:"2 people",Vd:80,dr:12},
  {value:3,key:"3 people",label:"3 people",Vd:105,dr:15},
  {value:4,key:"4 people",label:"Average (4 people)",Vd:130,dr:18},
  {value:5,key:"5 people",label:"5 people",Vd:155,dr:21},
  {value:6,key:"6 people",label:"6 people",Vd:180,dr:24},
  {value:7,key:"7 people",label:"7 people",Vd:205,dr:27},
  {value:8,key:"8 people",label:"8 people",Vd:230,dr:30}
];
const DEFAULT_USAGE_VALUE=4;
const USAGE_LEVEL_MAP=USAGE_LEVELS.reduce((acc,level)=>{acc[level.value]=level;return acc;},{});
const USAGE_KEY_MAP=USAGE_LEVELS.reduce((acc,level)=>{acc[level.key]=level;return acc;},{});
const DEFAULT_USAGE_SELECTION=USAGE_LEVEL_MAP[DEFAULT_USAGE_VALUE]||USAGE_LEVELS[0];

/* ==== PRESETS ==== */
const PRE={
  usage:Object.fromEntries(USAGE_LEVELS.map(({key,Vd,dr})=>[key,{Vd,dr}])),
  mains:{"Winter":8,"Spring/Autumn":12,"Summer":16},
  layout:{"Central":.35,"Typical":.7,"Remote":1.2}, // L per draw (waiting water)
  systems:{
    "Regular • Open CH + Open-vented cyl":      {t:"s", sb:1.8, cf:1.00, Tr:54, C:86, F:65, M:72, capex:4000, erp:.90},
    "Regular • Sealed CH + Open-vented cyl":    {t:"s", sb:1.7, cf:1.00, Tr:52, C:87, F:70, M:74, capex:4200, erp:.91},
    "Regular • Open CH + Unvented cyl":         {t:"s", sb:1.5, cf:1.00, Tr:52, C:88, F:82, M:80, capex:4600, erp:.92},
    "Regular • Sealed CH + Unvented cyl":       {t:"s", sb:1.4, cf:1.00, Tr:50, C:89, F:84, M:82, capex:4800, erp:.93},

    "System • Open-vented cyl":                 {t:"s", sb:1.6, cf:1.00, Tr:51, C:90, F:75, M:78, capex:4400, erp:.92},
    "System • Unvented cyl":                    {t:"s", sb:1.3, cf:1.00, Tr:49, C:91, F:86, M:84, capex:5000, erp:.94},

    "System • Mixergy Unvented (indirect)":     {t:"s", sb:1.0, cf:.95, Tr:48, C:92, F:95, M:85, capex:5500, erp:.96},
    "System • Mixergy Vented (open-vented)":    {t:"s", sb:1.1, cf:.96, Tr:49, C:91, F:88, M:83, capex:5200, erp:.94},

    "Combi • Standard":                         {t:"c", st:.012, sc:1.08, Tr:55, C:72, F:50, M:70, capex:3300, minFlow:12, erp:.92},
    "Combi • Premium (conditioned/central)":    {t:"c", st:.009, sc:1.02, Tr:52, C:78, F:55, M:78, capex:3800, minFlow:12, erp:.94},
  },
  Tuse:40,
  price:{ gas:.07, water:.0003 }
};

const HOMECARE_COVERS={
  "boiler-controls":{label:"Boiler & controls", year1:0, year2:rd(9.08*12,2)},
  "system-excess":{label:"Full system (£60 excess)", year1:rd(7*12,2), year2:rd(14.5*12,2)},
  "system-no-excess":{label:"Full system (no excess)", year1:rd(13*12,2), year2:rd(19*12,2)}
};
const DEFAULT_HOMECARE_COVER="boiler-controls";
const DEFAULT_WARRANTY_TERM=10;
const DEFAULT_CAPEX_MULT=1;
const DEFAULT_CAPEX_KEEP=0;
const DEFAULT_FINANCE_RATE=0;
const DEFAULT_FINANCE_YEARS=10;

const usageSelectionFromValue=value=>{
  const numeric=parseInt(value,10);
  if(Number.isNaN(numeric)) return DEFAULT_USAGE_SELECTION;
  return USAGE_LEVEL_MAP[numeric]||DEFAULT_USAGE_SELECTION;
};
const usageSelectionFromKey=key=>USAGE_KEY_MAP[key]||DEFAULT_USAGE_SELECTION;
const usageLabelFromKey=key=>usageSelectionFromKey(key).label;

const HEATING_MIN=4000;
const HEATING_MAX=30000;
const DEFAULT_HEATING_VALUE=12000;
const HEATING_LOW_MAX=9000;
const HEATING_HIGH_MIN=18000;
const heatingLabelForValue=value=>{
  const descriptor=value<=HEATING_LOW_MAX?'Low':value>=HEATING_HIGH_MIN?'High':'Average';
  return `${descriptor} (${Math.round(value).toLocaleString()} kWh/yr)`;
};

/* ==== THERMAL MODEL (NEW/PROPOSED OPTION) ==== */
function calcOption({sysKey, usageKey, mainsKey, layoutKey, prices, heatingYear}){
  const usagePreset=PRE.usage[usageKey]||PRE.usage[DEFAULT_USAGE_SELECTION.key];
  const U=usagePreset, M=PRE.mains[mainsKey], L=PRE.layout[layoutKey], S=PRE.systems[sysKey];
  const Tu=PRE.Tuse, Tm=M, pgas=prices.gas, pw=prices.water;
  const deltaT=Math.max(0, Tu-Tm);
  const perLDelivered=hwm_kWhPerL(deltaT);
  const drawsPerDay=Math.max(0, U?.dr||0);
  const layoutSlugPerDraw=Math.max(0, L||0);
  const pipeSizeKey=HWM_WASTE.defaultPipe;
  const runMeters=hwm_runMetersFromSlug(layoutSlugPerDraw, pipeSizeKey);
  const cylWastePerDraw=hwm_cylinderWasteLPerDraw(runMeters, pipeSizeKey);
  const combiWastePerDraw=hwm_combiWasteLPerDraw(runMeters, pipeSizeKey);
  const systemType=(S?.t||'').toLowerCase();
  const isCombi=systemType==='c';
  const extraWastePerDraw=Math.max(0, combiWastePerDraw-cylWastePerDraw);
  const extraWasteLPerDay=isCombi?drawsPerDay*extraWastePerDraw:0;
  const Euse = U.Vd*perLDelivered;
  const VwaitBase=layoutSlugPerDraw*drawsPerDay;
  let Vwait=VwaitBase;
  if(isCombi) Vwait+=extraWasteLPerDay;
  const EwaitBase=VwaitBase*perLDelivered;
  let Ewait=EwaitBase;
  if(isCombi) Ewait+=extraWasteLPerDay*perLDelivered;
  const eta  = etaCurve(S.Tr);
  const heatingYr=Math.max(0, heatingYear||0);
  const heatingDeliveredDay=heatingYr/365;
  const erpEff=cl(S.erp||0.92,0.6,0.99);
  const heatingInputDay=heatingDeliveredDay/erpEff;

  let E_kWh, cost_day, standby=0, starts=0, hwInput=0;
  if(S.t==="s"){
    hwInput=((Euse+Ewait)/eta)*S.cf;
    standby=S.sb;
    const totalInput=hwInput+standby+heatingInputDay;
    E_kWh=totalInput;
    cost_day = totalInput*pgas + Vwait*pw;
  }else{
    const etaEff=eta/(S.sc||1);
    starts=U.dr;
    const Eover = starts*(S.st||0.01);
    hwInput=((Euse+Ewait)/etaEff)+Eover;
    E_kWh=hwInput+heatingInputDay;
    cost_day = E_kWh*pgas + Vwait*pw;
  }

  return {
    sysKey, usageKey, mainsKey, layoutKey,
    usageLabel: usageLabelFromKey(usageKey),
    kWh: rd(E_kWh,3),
    cost: rd(cost_day,2),
    kWh_year: Math.round(E_kWh*365),
    cost_year: Math.round(cost_day*365),
    wasteL: rd(Vwait,1),
    breakdown:{
      E_use:rd(Euse,3),
      E_wait:rd(Ewait,3),
      standby:rd(standby,3),
      heating_input:rd(heatingInputDay,3),
      heating_delivered:rd(heatingDeliveredDay,3),
      eta:rd(eta,3),
      starts,
      hw_input:rd(hwInput,3)
    },
    erpPct: Math.round(erpEff*100),
    capexBase: PRE.systems[sysKey].capex
  };
}

/* ==== EXISTING SYSTEM BASELINE USING SEDBUK ==== */
function calcExistingRun({existingKey, sedbukPct, usageKey, mainsKey, layoutKey, prices, heatingYear}){
  const usagePreset=PRE.usage[usageKey]||PRE.usage[DEFAULT_USAGE_SELECTION.key];
  const U=usagePreset, M=PRE.mains[mainsKey], L=PRE.layout[layoutKey], S=PRE.systems[existingKey];
  const Tu=PRE.Tuse, Tm=M, pgas=prices.gas, pw=prices.water;
  const deltaT=Math.max(0, Tu-Tm);
  const perLDelivered=hwm_kWhPerL(deltaT);
  const eff = cl((sedbukPct||75)/100, 0.40, 0.99);
  const drawsPerDay=Math.max(0, U?.dr||0);
  const layoutSlugPerDraw=Math.max(0, L||0);
  const pipeSizeKey=HWM_WASTE.defaultPipe;
  const runMeters=hwm_runMetersFromSlug(layoutSlugPerDraw, pipeSizeKey);
  const cylWastePerDraw=hwm_cylinderWasteLPerDraw(runMeters, pipeSizeKey);
  const combiWastePerDraw=hwm_combiWasteLPerDraw(runMeters, pipeSizeKey);
  const systemType=(S?.t||'').toLowerCase();
  const isCombi=systemType==='c';
  const extraWastePerDraw=Math.max(0, combiWastePerDraw-cylWastePerDraw);
  const extraWasteLPerDay=isCombi?drawsPerDay*extraWastePerDraw:0;
  const Euse = U.Vd*perLDelivered;
  const VwaitBase=layoutSlugPerDraw*drawsPerDay;
  let Vwait=VwaitBase;
  if(isCombi) Vwait+=extraWasteLPerDay;
  const EwaitBase=VwaitBase*perLDelivered;
  let Ewait=EwaitBase;
  if(isCombi) Ewait+=extraWasteLPerDay*perLDelivered;
  const heatingYr=Math.max(0, heatingYear||0);
  const heatingDeliveredDay=heatingYr/365;
  const heatingInputDay=eff>0?(heatingDeliveredDay/eff):0;

  let E_kWh, cost_day, standby=0, starts=0, hwInput=0;
  if(S.t==="s"){
    standby = S.sb || 1.5;
    hwInput=((Euse+Ewait)/eff);
    const totalInput=hwInput+standby+heatingInputDay;
    E_kWh = totalInput;
    cost_day = totalInput*pgas + Vwait*pw;
  } else {
    starts = U.dr;
    const Eover = starts*(S.st||0.012);
    hwInput=((Euse+Ewait)/eff)+Eover;
    E_kWh = hwInput+heatingInputDay;
    cost_day = E_kWh*pgas + Vwait*pw;
  }

  return {
    kWh_day: rd(E_kWh,3),
    kWh_year: Math.round(E_kWh*365),
    cost_day: rd(cost_day,2),
    cost_year: Math.round(cost_day*365),
    eta_effective: rd(eff,3),
    standby: rd(standby,3),
    starts,
    wasteL: rd(Vwait,1),
    breakdown:{
      E_use:rd(Euse,3),
      E_wait:rd(Ewait,3),
      standby:rd(standby,3),
      heating_input:rd(heatingInputDay,3),
      heating_delivered:rd(heatingDeliveredDay,3),
      eta:rd(eff,3),
      starts,
      hw_input:rd(hwInput,3)
    }
  };
}

/* ==== SCORING (unchanged, best-of-two reference) ==== */
function baseUtilities(r, weights, bestKWh, bestGBP){
  const S=PRE.systems[r.sysKey];
  const pen=r.layoutKey==="Central"?0:r.layoutKey==="Typical"?6:12;
  const Ue=invU(r.kWh,bestKWh);
  const Up=invU(r.cost,bestGBP);
  const Uc=cl((S.C||75)-pen,10,100);
  const Uf=cl(S.F||60,10,100);
  const Um=cl(S.M||70,10,100);
  const W=weights;
  const scoreRaw=(W.e*Ue+W.c*Up+W.C*Uc+W.F*Uf+W.M*Um)/(W.e+W.c+W.C+W.F+W.M);
  return {Ue,Up,Uc,Uf,Um,scoreRaw};
}

function scoreAll(results, weights, ctx={}){
  const refKeys=["System • Mixergy Unvented (indirect)","Combi • Premium (conditioned/central)"];
  const refs=results.filter(r=>refKeys.includes(r.sysKey));
  const bestKWh=Math.min(...refs.map(r=>r.kWh));
  const bestGBP=Math.min(...refs.map(r=>r.cost));
  const flowLpm=Number.isFinite(ctx.flowLpm)?ctx.flowLpm:Infinity;
  const pipeInScreed=!!ctx.pipeScreed;

  return results.map(r=>{
    const sysKey=r.sysKey||'';
    const S=PRE.systems[sysKey]||{};
    const base=baseUtilities(r, weights, bestKWh, bestGBP);
    const minFlow=S.minFlow||0;
    const flowOk=flowLpm>=minFlow;
    const W=weights||{};
    const weightSum=Math.max(1,(W.e||0)+(W.c||0)+(W.C||0)+(W.F||0)+(W.M||0));
    let {Ue,Up,Uc,Uf,Um}=base;
    let finalScore=( (W.e||0)*Ue + (W.c||0)*Up + (W.C||0)*Uc + (W.F||0)*Uf + (W.M||0)*Um )/weightSum;
    let pipePenaltyApplied=false;
    let pipePenaltyNote;
    if(pipeInScreed && (sysKey.startsWith('System') || sysKey.startsWith('Combi'))){
      pipePenaltyApplied=true;
      Uc=cl(Uc-20,10,100);
      finalScore=( (W.e||0)*Ue + (W.c||0)*Up + (W.C||0)*Uc + (W.F||0)*Uf + (W.M||0)*Um )/weightSum;
      pipePenaltyNote='Pipe work in screed reduces suitability';
    }
    finalScore=Math.max(0, finalScore);
    let flowWarning;
    if(!flowOk && minFlow>0){
      finalScore=0;
      flowWarning=`Requires ≥ ${minFlow} L/min (you have ${rd(flowLpm,1)} L/min)`;
    }
    return {
      ...r,
      utilities:{
        Ue:Math.round(Ue),
        Up:Math.round(Up),
        Uc:Math.round(Uc),
        Uf:Math.round(Uf),
        Um:Math.round(Um),
        score:Math.round(finalScore)
      },
      flowWarning:flowWarning||undefined,
      flowOk,
      pipePenaltyApplied:pipePenaltyApplied||undefined,
      pipePenaltyNote:pipePenaltyApplied?pipePenaltyNote:undefined
    };
  });
}

/* ==== FINANCE ==== */
function annuityPayment(capex, ratePct, years){
  const r=(ratePct||0)/100; if(r<=0) return 0;
  const n=Math.max(1, years||1);
  const f=r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
  return capex*f;
}

function formatGBP(value){
  if(!Number.isFinite(value)) return "—";
  const rounded=Math.round(value*100)/100;
  const abs=Math.abs(rounded);
  const formatted=abs.toLocaleString(undefined, {
    minimumFractionDigits:Number.isInteger(abs)?0:2,
    maximumFractionDigits:2
  });
  return `${rounded<0?'-£':'£'}${formatted}`;
}

function warrantyTermForSystem(sysKey, st){
  const key=(sysKey||"").toLowerCase();
  const raw=key.includes("combi")?st.warrantyCombi:st.warrantySystem;
  const term=parseInt(raw,10);
  if(Number.isFinite(term) && term>0) return term;
  return DEFAULT_WARRANTY_TERM;
}

function computeHomecareSummary(sysKey, st){
  const current=st.homecareCurrent;
  const coverKey=st.homecareCover||DEFAULT_HOMECARE_COVER;
  const cover=HOMECARE_COVERS[coverKey]||HOMECARE_COVERS[DEFAULT_HOMECARE_COVER];
  if(!Number.isFinite(current) || current<=0) return null;
  if(!cover) return null;
  const term=warrantyTermForSystem(sysKey, st);
  if(!Number.isFinite(term) || term<=0) return null;
  const year1Cost=cover.year1;
  const year2Cost=cover.year2;
  const year1Saving=rd(current - year1Cost,2);
  const perYearSaving=rd(current - year2Cost,2);
  const years2Plus=Math.max(0, term-1);
  const year2Total=rd(perYearSaving*years2Plus,2);
  const total=rd(year1Saving + year2Total,2);
  return {
    coverLabel:cover.label,
    term,
    year1Saving,
    perYearSaving,
    years2Plus,
    year2Total,
    total
  };
}

/* ==== UI WIRING ==== */
const $=s=>document.querySelector(s);
const els={
  usage:$('#usage'), usageLabel:$('#usageLabel'), mains:$('#mains'), layout:$('#layout'), gas:$('#gas'), heating:$('#heating'), heatingLabel:$('#heatingLabel'), flow:$('#flow'),
  existing:$('#existing'), sedbuk:$('#sedbuk'),
  warrantyCombi:$('#warrantyCombi'), warrantySystem:$('#warrantySystem'),
  homecareCover:$('#homecareCover'), homecareCurrent:$('#homecareCurrent'),
  wE:$('#wE'), wCost:$('#wCost'), wC:$('#wC'), wF:$('#wF'), wM:$('#wM'),
  preferredSelect:$('#preferredSelect'),
  focusTag:$('#focusTag'), focusName:$('#focusName'),
  focusEcho:$('#focusEcho'), focusWarn:$('#focusWarn'),
  focusKwhDay:$('#focusKwhDay'), focusKwhYear:$('#focusKwhYear'),
  focusSaving:$('#focusSaving'),
  focusWasteL:$('#focusWasteL'), focusScore:$('#focusScore'),
  focusUE:$('#focusUE'), focusUP:$('#focusUP'), focusUC:$('#focusUC'), focusUF:$('#focusUF'), focusUM:$('#focusUM'),
  focusEUse:$('#focusEUse'), focusEWait:$('#focusEWait'), focusStandby:$('#focusStandby'), focusEta:$('#focusEta'), focusStarts:$('#focusStarts'),
  focusHeatInput:$('#focusHeatInput'), focusHeatDelivered:$('#focusHeatDelivered'),
  focusPayback:$('#focusPayback'),
  focusHomecare:$('#focusHomecare'), focusHomecareCover:$('#focusHomecareCover'),
  focusHomecareYear1:$('#focusHomecareYear1'), focusHomecareYearsLabel:$('#focusHomecareYearsLabel'),
  focusHomecareYears:$('#focusHomecareYears'), focusHomecareTotal:$('#focusHomecareTotal'),
  likeHomecare:$('#likeHomecare'), likeHomecareCover:$('#likeHomecareCover'),
  likeHomecareYear1:$('#likeHomecareYear1'), likeHomecareYearsLabel:$('#likeHomecareYearsLabel'),
  likeHomecareYears:$('#likeHomecareYears'), likeHomecareTotal:$('#likeHomecareTotal'),
  preferredTag:$('#preferredTag'), preferredName:$('#preferredName'), preferredEcho:$('#preferredEcho'), preferredWarn:$('#preferredWarn'),
  preferredKwhDay:$('#preferredKwhDay'), preferredKwhYear:$('#preferredKwhYear'), preferredSaving:$('#preferredSaving'),
  preferredWasteL:$('#preferredWasteL'), preferredScore:$('#preferredScore'),
  preferredUE:$('#preferredUE'), preferredUP:$('#preferredUP'), preferredUC:$('#preferredUC'), preferredUF:$('#preferredUF'), preferredUM:$('#preferredUM'),
  preferredEUse:$('#preferredEUse'), preferredEWait:$('#preferredEWait'), preferredStandby:$('#preferredStandby'), preferredEta:$('#preferredEta'), preferredStarts:$('#preferredStarts'),
  preferredHeatInput:$('#preferredHeatInput'), preferredHeatDelivered:$('#preferredHeatDelivered'),
  preferredPayback:$('#preferredPayback'),
  preferredHomecare:$('#preferredHomecare'), preferredHomecareCover:$('#preferredHomecareCover'),
  preferredHomecareYear1:$('#preferredHomecareYear1'), preferredHomecareYearsLabel:$('#preferredHomecareYearsLabel'),
  preferredHomecareYears:$('#preferredHomecareYears'), preferredHomecareTotal:$('#preferredHomecareTotal'),
  existName:$('#existName'), existEcho:$('#existEcho'),
  existKwhDay:$('#existKwhDay'), existKwhYear:$('#existKwhYear'),
  existSaving:$('#existSaving'),
  existWasteL:$('#existWasteL'), existScore:$('#existScore'),
  existUE:$('#existUE'), existUP:$('#existUP'), existUC:$('#existUC'), existUF:$('#existUF'), existUM:$('#existUM'),
  existEUse:$('#existEUse'), existEWait:$('#existEWait'), existStandby:$('#existStandby'), existEta:$('#existEta'), existStarts:$('#existStarts'),
  existHeatInput:$('#existHeatInput'), existHeatDelivered:$('#existHeatDelivered'),
  existPayback:$('#existPayback'),
  existHomecare:$('#existHomecare'), existHomecareCover:$('#existHomecareCover'),
  existHomecareYear1:$('#existHomecareYear1'), existHomecareYearsLabel:$('#existHomecareYearsLabel'),
  existHomecareYears:$('#existHomecareYears'), existHomecareTotal:$('#existHomecareTotal'),
  likeTag:$('#likeTag'), likeName:$('#likeName'), likeEcho:$('#likeEcho'), likeWarn:$('#likeWarn'),
  likeKwhDay:$('#likeKwhDay'), likeKwhYear:$('#likeKwhYear'), likeSaving:$('#likeSaving'),
  likeWasteL:$('#likeWasteL'), likeScore:$('#likeScore'),
  likeUE:$('#likeUE'), likeUP:$('#likeUP'), likeUC:$('#likeUC'), likeUF:$('#likeUF'), likeUM:$('#likeUM'),
  likeEUse:$('#likeEUse'), likeEWait:$('#likeEWait'), likeStandby:$('#likeStandby'), likeEta:$('#likeEta'), likeStarts:$('#likeStarts'),
  likeHeatInput:$('#likeHeatInput'), likeHeatDelivered:$('#likeHeatDelivered'),
  likePayback:$('#likePayback'),
  pipeScreed:$('#pipeScreed'),
  compareBody:$('#compareBody'),
  copyBtn:$('#copy'), recalcBtn:$('#recalc'),
  presetBudget:$('#presetBudget'), presetComfort:$('#presetComfort'),
  presetFuture:$('#presetFuture'), presetReset:$('#presetReset')
};

const focusColumns={
  best:{
    tag:els.focusTag,
    name:els.focusName,
    echo:els.focusEcho,
    warn:els.focusWarn,
    kWhDay:els.focusKwhDay,
    kWhYear:els.focusKwhYear,
    saving:els.focusSaving,
    waste:els.focusWasteL,
    score:els.focusScore,
    Ue:els.focusUE,
    Up:els.focusUP,
    Uc:els.focusUC,
    Uf:els.focusUF,
    Um:els.focusUM,
    EUse:els.focusEUse,
    EWait:els.focusEWait,
    Standby:els.focusStandby,
    Eta:els.focusEta,
    Starts:els.focusStarts,
    HeatInput:els.focusHeatInput,
    HeatDelivered:els.focusHeatDelivered,
    Payback:els.focusPayback,
    homecare:{
      pill:els.focusHomecare,
      cover:els.focusHomecareCover,
      year1:els.focusHomecareYear1,
      yearsLabel:els.focusHomecareYearsLabel,
      years:els.focusHomecareYears,
      total:els.focusHomecareTotal
    }
  },
  like:{
    tag:els.likeTag,
    name:els.likeName,
    echo:els.likeEcho,
    warn:els.likeWarn,
    kWhDay:els.likeKwhDay,
    kWhYear:els.likeKwhYear,
    saving:els.likeSaving,
    waste:els.likeWasteL,
    score:els.likeScore,
    Ue:els.likeUE,
    Up:els.likeUP,
    Uc:els.likeUC,
    Uf:els.likeUF,
    Um:els.likeUM,
    EUse:els.likeEUse,
    EWait:els.likeEWait,
    Standby:els.likeStandby,
    Eta:els.likeEta,
    Starts:els.likeStarts,
    HeatInput:els.likeHeatInput,
    HeatDelivered:els.likeHeatDelivered,
    Payback:els.likePayback,
    homecare:{
      pill:els.likeHomecare,
      cover:els.likeHomecareCover,
      year1:els.likeHomecareYear1,
      yearsLabel:els.likeHomecareYearsLabel,
      years:els.likeHomecareYears,
      total:els.likeHomecareTotal
    }
  },
  preferred:{
    tag:els.preferredTag,
    name:els.preferredName,
    echo:els.preferredEcho,
    warn:els.preferredWarn,
    kWhDay:els.preferredKwhDay,
    kWhYear:els.preferredKwhYear,
    saving:els.preferredSaving,
    waste:els.preferredWasteL,
    score:els.preferredScore,
    Ue:els.preferredUE,
    Up:els.preferredUP,
    Uc:els.preferredUC,
    Uf:els.preferredUF,
    Um:els.preferredUM,
    EUse:els.preferredEUse,
    EWait:els.preferredEWait,
    Standby:els.preferredStandby,
    Eta:els.preferredEta,
    Starts:els.preferredStarts,
    HeatInput:els.preferredHeatInput,
    HeatDelivered:els.preferredHeatDelivered,
    Payback:els.preferredPayback,
    homecare:{
      pill:els.preferredHomecare,
      cover:els.preferredHomecareCover,
      year1:els.preferredHomecareYear1,
      yearsLabel:els.preferredHomecareYearsLabel,
      years:els.preferredHomecareYears,
      total:els.preferredHomecareTotal
    }
  },
  existing:{
    tag:els.existTag,
    name:els.existName,
    echo:els.existEcho,
    warn:null,
    kWhDay:els.existKwhDay,
    kWhYear:els.existKwhYear,
    saving:els.existSaving,
    waste:els.existWasteL,
    score:els.existScore,
    Ue:els.existUE,
    Up:els.existUP,
    Uc:els.existUC,
    Uf:els.existUF,
    Um:els.existUM,
    EUse:els.existEUse,
    EWait:els.existEWait,
    Standby:els.existStandby,
    Eta:els.existEta,
    Starts:els.existStarts,
    HeatInput:els.existHeatInput,
    HeatDelivered:els.existHeatDelivered,
    Payback:els.existPayback,
    homecare:{
      pill:els.existHomecare,
      cover:els.existHomecareCover,
      year1:els.existHomecareYear1,
      yearsLabel:els.existHomecareYearsLabel,
      years:els.existHomecareYears,
      total:els.existHomecareTotal
    }
  }
};

let preferredSelectionId='';
let latestFocusContext=null;
let lastFocusedCandidateId=null;

function updateHomecareSection(section, data, st){
  if(!section || !section.pill) return;
  const {pill, cover, year1, yearsLabel, years, total}=section;
  const summary=data ? (data.homecare || computeHomecareSummary(data.sysKey, st||{})) : null;
  if(!summary){
    pill.style.display='none';
    if(cover) cover.textContent='—';
    if(year1) year1.textContent='—';
    if(yearsLabel) yearsLabel.textContent='—';
    if(years) years.textContent='—';
    if(total) total.textContent='—';
    return;
  }
  pill.style.display='';
  if(cover) cover.textContent=summary.coverLabel||'—';
  if(year1) year1.textContent=formatGBP(summary.year1Saving);
  if(yearsLabel) yearsLabel.textContent=summary.term>1?summary.term:'—';
  if(years) years.textContent=summary.term>1?formatGBP(summary.year2Total):'—';
  if(total) total.textContent=formatGBP(summary.total);
}

function fillFocusColumn(key, data, options={}, st){
  const col=focusColumns[key];
  if(!col) return;
  const placeholder='—';
  if(col.tag){
    col.tag.textContent=options.tagText||placeholder;
    if(col.tag.classList){
      col.tag.classList.toggle('primary', !!options.primaryTag);
    }
  }
  const setText=(el, value)=>{ if(!el) return; el.textContent=value; };
  if(!data){
    setText(col.name, placeholder);
    setText(col.echo, options.emptyEcho||placeholder);
    if(col.warn) setText(col.warn, '');
    setText(col.kWhDay, placeholder);
    setText(col.kWhYear, placeholder);
    setText(col.saving, placeholder);
    setText(col.waste, placeholder);
    setText(col.score, placeholder);
    setText(col.Ue, placeholder);
    setText(col.Up, placeholder);
    setText(col.Uc, placeholder);
    setText(col.Uf, placeholder);
    setText(col.Um, placeholder);
    setText(col.EUse, placeholder);
    setText(col.EWait, placeholder);
    setText(col.Standby, placeholder);
    setText(col.HeatInput, placeholder);
    setText(col.HeatDelivered, placeholder);
    setText(col.Eta, placeholder);
    setText(col.Starts, placeholder);
    setText(col.Payback, placeholder);
    updateHomecareSection(col.homecare, null, st);
    return;
  }

  const saving=Number.isFinite(data.annualSaving)?data.annualSaving.toLocaleString():placeholder;
  const kWhDay=Number.isFinite(data.kWh)?String(data.kWh):placeholder;
  const kWhYear=Number.isFinite(data.kWh_year)?`≈ ${data.kWh_year.toLocaleString()} kWh / yr`:placeholder;
  const waste=Number.isFinite(data.wasteL)?String(data.wasteL):placeholder;
  const utilities=data.utilities||{};
  const breakdown=data.breakdown||{};
  const paybackText=(data.payback==='—'||data.payback===undefined)?'—':`${data.payback} yrs`;
  const buildWarnText=()=>{
    const notes=[];
    if(data.flowWarning) notes.push(`⚠️ ${data.flowWarning}`);
    if(data.pipePenaltyApplied && data.pipePenaltyNote) notes.push(`⚠️ ${data.pipePenaltyNote}`);
    return notes.join(' ');
  };
  const warnText = options.warnText!==undefined?options.warnText:buildWarnText();

  setText(col.name, data.label||data.sysKey||placeholder);
  setText(col.echo, options.echoText||placeholder);
  if(col.warn) setText(col.warn, warnText);
  setText(col.kWhDay, kWhDay);
  setText(col.kWhYear, kWhYear);
  setText(col.saving, saving);
  setText(col.waste, waste);
  setText(col.score, utilities.score!==undefined?String(utilities.score):placeholder);
  setText(col.Ue, utilities.Ue!==undefined?String(utilities.Ue):placeholder);
  setText(col.Up, utilities.Up!==undefined?String(utilities.Up):placeholder);
  setText(col.Uc, utilities.Uc!==undefined?String(utilities.Uc):placeholder);
  setText(col.Uf, utilities.Uf!==undefined?String(utilities.Uf):placeholder);
  setText(col.Um, utilities.Um!==undefined?String(utilities.Um):placeholder);
  setText(col.EUse, breakdown.E_use!==undefined?String(breakdown.E_use):placeholder);
  setText(col.EWait, breakdown.E_wait!==undefined?String(breakdown.E_wait):placeholder);
  setText(col.Standby, breakdown.standby!==undefined?String(breakdown.standby):placeholder);
  setText(col.HeatInput, breakdown.heating_input!==undefined?String(breakdown.heating_input):placeholder);
  setText(col.HeatDelivered, breakdown.heating_delivered!==undefined?String(breakdown.heating_delivered):placeholder);
  setText(col.Eta, breakdown.eta!==undefined?String(breakdown.eta):placeholder);
  setText(col.Starts, breakdown.starts!==undefined?String(breakdown.starts):placeholder);
  setText(col.Payback, paybackText);
  updateHomecareSection(col.homecare, data, st);
}

/* Populate selects */
(function populateExisting(){
  const keys=Object.keys(PRE.systems);
  els.existing.innerHTML=keys.map(k=>`<option ${k.includes('Combi • Standard')?'selected':''}>${k}</option>`).join('');
})();

function getUsageSelection(){
  const sliderValue=parseInt(els.usage?.value||String(DEFAULT_USAGE_VALUE),10);
  const selection=usageSelectionFromValue(Number.isNaN(sliderValue)?DEFAULT_USAGE_VALUE:sliderValue);
  if(els.usage) els.usage.value=String(selection.value);
  return selection;
}

function refreshUsageLabel(){
  const selection=getUsageSelection();
  if(els.usageLabel) els.usageLabel.textContent=selection.label;
  return selection;
}

function refreshHeatingLabel(){
  if(!els.heating) return DEFAULT_HEATING_VALUE;
  const raw=parseFloat(els.heating.value||String(DEFAULT_HEATING_VALUE));
  const safe=Number.isFinite(raw)?cl(raw, HEATING_MIN, HEATING_MAX):DEFAULT_HEATING_VALUE;
  els.heating.value=String(safe);
  if(els.heatingLabel) els.heatingLabel.textContent=heatingLabelForValue(safe);
  return safe;
}

function getState(){
  const usageSelection=refreshUsageLabel();
  const heatingValue=refreshHeatingLabel();
  const flowVal=parseFloat(els.flow.value);
  const flowLpm=Number.isFinite(flowVal)?Math.max(0, flowVal):14;
  const combiTermRaw=parseInt(els.warrantyCombi?.value||String(DEFAULT_WARRANTY_TERM),10);
  const systemTermRaw=parseInt(els.warrantySystem?.value||String(DEFAULT_WARRANTY_TERM),10);
  const warrantyCombi=Number.isFinite(combiTermRaw)?Math.max(1, combiTermRaw):DEFAULT_WARRANTY_TERM;
  const warrantySystem=Number.isFinite(systemTermRaw)?Math.max(1, systemTermRaw):DEFAULT_WARRANTY_TERM;
  const homecareCover=els.homecareCover?.value||DEFAULT_HOMECARE_COVER;
  const homecareCurrentRaw=parseFloat(els.homecareCurrent?.value||"0");
  const homecareCurrent=Number.isFinite(homecareCurrentRaw)?Math.max(0, homecareCurrentRaw):NaN;
  return {
    usageKey:usageSelection.key, mainsKey:els.mains.value, layoutKey:els.layout.value,
    usageLabel:usageSelection.label,
    flowLpm,
    heatingYear:Math.max(0, heatingValue),
    prices:{gas:parseFloat(els.gas.value||"0.07"), water:0.0003},
    existingKey:els.existing.value, sedbukPct:+els.sedbuk.value,
    weights:{e:+els.wE.value, c:+els.wCost.value, C:+els.wC.value, F:+els.wF.value, M:+els.wM.value},
    capexMult:DEFAULT_CAPEX_MULT,
    capexKeep:DEFAULT_CAPEX_KEEP,
    financeRate:DEFAULT_FINANCE_RATE,
    financeYears:DEFAULT_FINANCE_YEARS,
    warrantyCombi,
    warrantySystem,
    homecareCover,
    homecareCurrent,
    pipeScreed:!!els.pipeScreed?.checked
  };
}

function runAll(){
  const st=getState();

  // Existing baseline using SEDBUK
  const existingRun=calcExistingRun({
    existingKey:st.existingKey, sedbukPct:st.sedbukPct,
    usageKey:st.usageKey, mainsKey:st.mainsKey, layoutKey:st.layoutKey, prices:st.prices,
    heatingYear:st.heatingYear
  });

  // All candidate options (new/proposed)
  const baseResults=Object.keys(PRE.systems).map(sysKey=>calcOption({
    sysKey, usageKey:st.usageKey, mainsKey:st.mainsKey, layoutKey:st.layoutKey, prices:st.prices,
    heatingYear:st.heatingYear
  }));

  // Attach capex + savings/payback vs existing
  const modernResults=baseResults.map(r=>{
    const capex=(PRE.systems[r.sysKey].capex||0)*st.capexMult;
    const runYr=r.cost_year;
    const year1=capex+runYr;

    // Finance
    const annualised=annuityPayment(capex, st.financeRate, st.financeYears);
    const totalAnnualWithFinance=runYr+annualised;

    // Savings vs existing (SEDBUK baseline)
    const keepCost=st.capexKeep;
    const incrCapex=Math.max(0, capex - keepCost);
    const annualSaving=Math.max(0, existingRun.cost_year - runYr);
    const payback=annualSaving>0 ? (incrCapex/annualSaving) : Infinity;

    const variant=r.sysKey===st.existingKey?'like':'modern';
    const label=variant==='like'?`${r.sysKey} (Modern ERP)`:r.sysKey;
    const homecare=computeHomecareSummary(r.sysKey, st);

    return {
      ...r,
      id:`${r.sysKey}::${variant}`,
      variant,
      label,
      capex:Math.round(capex),
      runYr:Math.round(runYr),
      year1:Math.round(year1),
      annualised:Math.round(annualised),
      totalAnnualWithFinance:Math.round(totalAnnualWithFinance),
      annualSaving:Math.round(annualSaving),
      payback:(payback===Infinity?"—":(payback>99?"99+":payback.toFixed(1))),
      baseline:existingRun,
      homecare
    };
  });

  const keepCost=Math.max(0, st.capexKeep);
  const annualisedKeep=annuityPayment(keepCost, st.financeRate, st.financeYears);
  const existingVariant={
    id:`${st.existingKey}::existing`,
    variant:'existing',
    label:`${st.existingKey} (Current)`,
    sysKey:st.existingKey,
    usageKey:st.usageKey,
    usageLabel: usageLabelFromKey(st.usageKey),
    mainsKey:st.mainsKey,
    layoutKey:st.layoutKey,
    kWh: rd(existingRun.kWh_day,3),
    cost: rd(existingRun.cost_day,2),
    kWh_year: existingRun.kWh_year,
    cost_year: existingRun.cost_year,
    wasteL: existingRun.wasteL,
    breakdown: existingRun.breakdown,
    capex: Math.round(keepCost),
    runYr: Math.round(existingRun.cost_year),
    year1: Math.round(keepCost + existingRun.cost_year),
    annualised: Math.round(annualisedKeep),
    totalAnnualWithFinance: Math.round(existingRun.cost_year + annualisedKeep),
    annualSaving: 0,
    payback: '—',
    baseline: existingRun,
    sedbuk: st.sedbukPct,
    homecare: computeHomecareSummary(st.existingKey, st)
  };

  const results=[...modernResults, existingVariant];

  // Score & sort (by score)
  const scored=scoreAll(results, st.weights, {flowLpm:st.flowLpm, pipeScreed:st.pipeScreed}).sort((a,b)=>b.utilities.score - a.utilities.score);
  const existingScored=scored.find(x=>x.variant==='existing') || null;
  const likeScored=scored.find(x=>x.variant==='like') || null;
  const bestCandidate=scored.find(x=>x.variant!=='existing') || scored[0];
  if(els.preferredSelect){
    const previous=preferredSelectionId;
    const options=["<option value=\"\">— None selected —</option>"].concat(
      scored.filter(x=>x.variant!=='existing').map(r=>{
        const badge=r.variant==='like'?" (like for like)":"";
        return `<option value="${escapeHtml(r.id)}">${escapeHtml(r.label)}${badge}</option>`;
      })
    );
    els.preferredSelect.innerHTML=options.join('');
    if(previous && scored.some(x=>x.id===previous)){
      els.preferredSelect.value=previous;
      preferredSelectionId=previous;
    }else{
      els.preferredSelect.value='';
      preferredSelectionId='';
    }
  }

  const preferredCandidate=preferredSelectionId?scored.find(x=>x.id===preferredSelectionId)||null:null;
  const focusCtx={existing:existingScored, like:likeScored, bestDefault:bestCandidate, preferred:preferredCandidate, st, scored};
  latestFocusContext=focusCtx;

  // Render table
  els.compareBody.innerHTML=scored.map(r=>{
    const badges=[
      r.variant==='existing'?'<span class="badge">Existing</span>':'',
      r.variant==='like'?`<span class="badge">Like for like</span>${Number.isFinite(r.erpPct)?` <span class="badge">ERP ${r.erpPct}%</span>`:''}`:'',
      r.flowWarning?'<span class="badge warn">⚠️ Flow limit</span>':'',
      r.pipePenaltyApplied?`<span class="badge warn" title="${r.pipePenaltyNote||'Pipe work in screed reduces suitability'}">⚠️ Screed</span>`:''
    ].filter(Boolean).join(' ');
    const homecareSummary=r.homecare;
    const homecareCell=homecareSummary?`
      <div class="homecare-summary">
        <div>${homecareSummary.coverLabel||'—'}</div>
        <div>Year 1: <b>${formatGBP(homecareSummary.year1Saving)}</b></div>
        <div>${homecareSummary.term>1?`Years 2-${homecareSummary.term}: <b>${formatGBP(homecareSummary.year2Total)}</b>`:'Years 2+: —'}</div>
        <div>Total: <b>${formatGBP(homecareSummary.total)}</b></div>
      </div>
    `:'—';
    return `
    <tr data-id="${r.id}" class="${r.variant==='existing'?'exist':''}">
      <td>${r.label}${badges?` ${badges}`:''}</td>
      <td class="right">${r.kWh}</td>
      <td class="right"><b>${r.utilities.score}</b></td>
      <td class="right">${Number.isFinite(r.annualSaving)?`£${r.annualSaving.toLocaleString()}`:'—'}</td>
      <td>${homecareCell}</td>
    </tr>
  `;}).join('');

  for(const tr of els.compareBody.querySelectorAll('tr')){
    tr.onclick=()=>{
      if(!latestFocusContext) return;
      const candidate=latestFocusContext.scored?.find(x=>x.id===tr.dataset.id);
      focus(candidate||null, latestFocusContext);
    };
  }

  // Focus best option by default
  focus(bestCandidate, latestFocusContext);
  return {scored, st, existingRun};
}

function focus(candidate, ctx){
  const {st, existing, like, bestDefault, preferred}=ctx||{};
  const preferredCandidate=preferred||null;
  const selected=candidate||bestDefault||preferredCandidate||existing||like||null;
  if(!selected){
    fillFocusColumn('best', null, {emptyEcho:'—'}, st);
    fillFocusColumn('preferred', preferredCandidate, {tagText:'Preferred option', emptyEcho:'Select a preferred option above to pin it here.'}, st);
    fillFocusColumn('existing', existing, {tagText:'Existing', emptyEcho:'—'}, st);
    fillFocusColumn('like', like, {tagText:'Like for like', emptyEcho:'—'}, st);
    return;
  }
  lastFocusedCandidateId=selected?.id||null;
  const flowSummary=Number.isFinite(st?.flowLpm)?`${rd(st.flowLpm,1)} L/min`:'—';
  const heatingSummary=Number.isFinite(st?.heatingYear)?`${Math.round(st.heatingYear).toLocaleString()} kWh/yr`:'—';
  const buildEcho=(data, extras=[])=>{
    if(!data) return '—';
    const usageDisplay=data.usageLabel||usageLabelFromKey(data.usageKey);
    const base=[usageDisplay||'—', data.mainsKey||'—', data.layoutKey||'—', `Flow ${flowSummary}`, `Heating ${heatingSummary}`];
    return base.concat(extras.filter(Boolean)).join(' • ');
  };

  const isExisting=selected.variant==='existing';
  const isLike=selected.variant==='like';
  const isDefaultBest=bestDefault && selected.id===bestDefault.id;

  let bestTag='Selected option';
  if(isExisting) bestTag='Existing (selected)';
  else if(isDefaultBest) bestTag=isLike?'Best overall (like for like)':'Best overall';
  else if(isLike) bestTag='Like-for-like selection';

  const screedNote=st?.pipeScreed?'Pipework in screed':null;

  fillFocusColumn('best', selected, {
    tagText:bestTag,
    primaryTag:!isExisting && isDefaultBest,
    echoText:buildEcho(selected, [Number.isFinite(selected.erpPct)?`ERP ${selected.erpPct}%`:null, screedNote])
  }, st);

  fillFocusColumn('preferred', preferredCandidate, {
    tagText:'Preferred option',
    echoText:buildEcho(preferredCandidate, [preferredCandidate&&Number.isFinite(preferredCandidate.erpPct)?`ERP ${preferredCandidate.erpPct}%`:null, screedNote]),
    emptyEcho:'Select a preferred option above to pin it here.'
  }, st);

  fillFocusColumn('existing', existing, {
    tagText:existing?`Existing (SEDBUK ${(existing.sedbuk||st?.sedbukPct)||'—'}%)`:'Existing',
    echoText:buildEcho(existing, [existing?`SEDBUK ${(existing.sedbuk||st?.sedbukPct)||'—'}%`:null, screedNote]),
  }, st);

  fillFocusColumn('like', like, {
    tagText:like?`Like for like${Number.isFinite(like.erpPct)?` (ERP ${like.erpPct}%)`:''}`:'Like for like',
    echoText:buildEcho(like, [like&&Number.isFinite(like.erpPct)?`ERP ${like.erpPct}%`:null, screedNote])
  }, st);

  const copyTarget=selected;
  if(copyTarget){
    els.copyBtn.onclick=()=>navigator.clipboard.writeText(JSON.stringify(copyTarget,null,2));
  }
}

/* Presets */
els.presetBudget.onclick = ()=>{ els.wE.value=3; els.wCost.value=8; els.wC.value=2; els.wF.value=2; els.wM.value=2; runAll(); };
els.presetComfort.onclick= ()=>{ els.wE.value=3; els.wCost.value=3; els.wC.value=8; els.wF.value=3; els.wM.value=3; runAll(); };
els.presetFuture.onclick = ()=>{ els.wE.value=5; els.wCost.value=4; els.wC.value=3; els.wF.value=8; els.wM.value=2; runAll(); };
els.presetReset.onclick  = ()=>{ els.wE.value=3; els.wCost.value=5; els.wC.value=4; els.wF.value=4; els.wM.value=2; runAll(); };

if(els.usage){
  els.usage.addEventListener('input', ()=>{ refreshUsageLabel(); runAll(); });
}

if(els.heating){
  els.heating.addEventListener('input', ()=>{ refreshHeatingLabel(); runAll(); });
}

els.recalcBtn.onclick=runAll;
for(const el of document.querySelectorAll('input,select')){
  if(el===els.preferredSelect) continue;
  el.addEventListener('change', runAll);
}
if(els.preferredSelect){
  els.preferredSelect.addEventListener('change', ()=>{
    preferredSelectionId=els.preferredSelect.value||'';
    if(!latestFocusContext) return;
    const preferred=preferredSelectionId?
      latestFocusContext.scored?.find(x=>x.id===preferredSelectionId)||null:
      null;
    latestFocusContext={...latestFocusContext, preferred};
    const candidate=latestFocusContext.scored?.find(x=>x.id===lastFocusedCandidateId)||latestFocusContext.bestDefault||preferred||latestFocusContext.existing||latestFocusContext.like||null;
    focus(candidate, latestFocusContext);
  });
}

// init
(function initExisting(){
  const keys=Object.keys(PRE.systems);
  els.existing.innerHTML=keys.map(k=>`<option ${k.includes('Combi • Standard')?'selected':''}>${k}</option>`).join('');
})();
refreshUsageLabel();
refreshHeatingLabel();
runAll();
</script>
</body>
</html>
