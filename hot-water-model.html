<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hot Water Model ‚Äî Full Scope & Printable (ASCII-safe)</title>
<style>
  :root{--fg:#111;--bg:#fff;--muted:#666;--b:#e5e7eb;--pri:#0b84ff}
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu;color:var(--fg);background:var(--bg)}
  header{padding:14px 16px;border-bottom:1px solid var(--b);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:16px;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1020px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  label{font-weight:600;font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  select,input[type="number"],input[type="range"]{width:100%}
  input[type="number"],select{padding:8px 10px;border:1px solid var(--b);border-radius:8px;background:#fff}
  .card{border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:14px}
  .card h2{margin:0 0 8px;font-size:16px}
  .sub{color:var(--muted);font-size:12px;margin-top:-4px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  @media(max-width:560px){.kpi{grid-template-columns:1fr}}
  .pill{border:1px solid var(--b);border-radius:10px;padding:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:9px 12px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer}
  button.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .score{font:600 28px/1.1 system-ui;margin:4px 0}
  .muted{color:var(--muted)}
  .slrow{display:flex;align-items:center;gap:10px}
  .slrow output{min-width:2ch;text-align:right;font-variant-numeric:tabular-nums}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--b);padding:8px 10px;text-align:left}
  th{background:#fafafa}
  .right{text-align:right}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--b);border-radius:999px;font-size:12px;color:#444}
  .errorbar{display:none;background:#fee;border:1px solid #fbb;color:#900;padding:8px;border-radius:8px;margin:12px 0}
  @media print{
    header,.no-print{display:none!important}
    body{background:#fff}
    .wrap{padding:0}
    .card{border:none;margin:0 0 8mm 0;padding:0}
    .pill{border:1px solid #ddd}
    table,th,td{border:1px solid #999}
    .score{font-size:24px}
  }
</style>
</head>
<body>
<header class="no-print">
  <h1>Hot Water Model ‚Äî Full Scope</h1>
  <span class="muted">Physics ‚Ä¢ Cost ‚Ä¢ Customer-weighted score ‚Ä¢ Printable</span>
  <div style="margin-left:auto" class="actions">
    <button onclick="window.location.href='welcome.html'">‚Üê Back to Welcome</button>
    <button onclick="window.print()">üñ®Ô∏è Print</button>
  </div>
</header>

<div class="wrap">
  <div id="errorbar" class="errorbar"></div>

  <div class="card no-print">
    <h2>Inputs</h2>
    <div class="grid">
      <div>
        <label>Usage</label>
        <select id="usage">
          <option>Low (1‚Äì2 ppl)</option>
          <option selected>Med (3‚Äì4 ppl)</option>
          <option>High (5‚Äì6 ppl)</option>
        </select>
      </div>
      <div>
        <label>Season (UK mains temp)</label>
        <select id="mains">
          <option>Winter</option>
          <option selected>Spring/Autumn</option>
          <option>Summer</option>
        </select>
      </div>
      <div>
        <label>Pipe layout (waiting water)</label>
        <select id="layout">
          <option selected>Central</option>
          <option>Typical</option>
          <option>Remote</option>
        </select>
      </div>
      <div>
        <label>Gas price ( ¬£ / kWh )</label>
        <input id="gas" type="number" step="0.001" value="0.07">
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">Adjust what matters most:</div>
      <div class="grid" style="margin-top:8px">
        <div class="slrow"><label style="flex:1">Energy</label><input id="wE" type="range" min="0" max="10" step="1" value="3" oninput="wEVal.value=this.value"><output id="wEVal">3</output></div>
        <div class="slrow"><label style="flex:1">Cost</label><input id="wCost" type="range" min="0" max="10" step="1" value="5" oninput="wCostVal.value=this.value"><output id="wCostVal">5</output></div>
        <div class="slrow"><label style="flex:1">Comfort</label><input id="wC" type="range" min="0" max="10" step="1" value="4" oninput="wCVal.value=this.value"><output id="wCVal">4</output></div>
        <div class="slrow"><label style="flex:1">Future-proof</label><input id="wF" type="range" min="0" max="10" step="1" value="4" oninput="wFVal.value=this.value"><output id="wFVal">4</output></div>
        <div class="slrow"><label style="flex:1">Maintenance</label><input id="wM" type="range" min="0" max="10" step="1" value="2" oninput="wMVal.value=this.value"><output id="wMVal">2</output></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="presetBudget">Budget-led</button>
        <button id="presetComfort">Comfort-led</button>
        <button id="presetFuture">Future-ready</button>
        <button id="presetReset">Reset</button>
        <button id="recalc" class="primary">Recalculate</button>
      </div>
    </div>
  </div>

  <div class="card" id="focusCard">
    <h2>Focused view <span id="focusName" class="badge"></span></h2>
    <div class="kpi">
      <div class="pill"><div class="muted">Energy</div><div><b id="kwhDay">‚Äî</b> kWh/day</div><small id="kwhYear">‚Äî</small></div>
      <div class="pill"><div class="muted">Running cost</div><div>¬£<b id="costDay">‚Äî</b> / day</div><small id="costYear">‚Äî</small></div>
      <div class="pill"><div class="muted">Waiting water</div><div><b id="wasteL">‚Äî</b> L/day</div><small>layout + draws</small></div>
    </div>
    <div class="grid">
      <div class="pill"><div class="muted">Customer score</div><div class="score" id="score">‚Äî</div>
        <small>Energy <span id="uE">‚Äî</span> ‚Ä¢ Cost <span id="uP">‚Äî</span> ‚Ä¢ Comfort <span id="uC">‚Äî</span> ‚Ä¢ Future <span id="uF">‚Äî</span> ‚Ä¢ Maint <span id="uM">‚Äî</span></small>
      </div>
      <div class="pill"><div class="muted">Breakdown</div>
        <div>Useful <b id="eUse">‚Äî</b> kWh/day</div>
        <div>Waiting <b id="eWait">‚Äî</b> kWh/day</div>
        <div>Standby <b id="standby">‚Äî</b> kWh/day</div>
        <div>Boiler eta <b id="eta">‚Äî</b> ‚Ä¢ Starts <b id="starts">‚Äî</b></div>
      </div>
      <div class="pill"><div class="muted">Selections</div>
        <div id="echo">‚Äî</div>
        <div class="actions no-print" style="margin-top:8px">
          <button id="copy">Copy JSON (focused)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="compareCard">
    <h2>Compare all systems</h2>
    <div class="sub">Sorted by Customer score (highest first). Click a row to focus.</div>
    <div style="overflow:auto">
      <table id="compareTable">
        <thead>
          <tr>
            <th>System</th>
            <th class="right">kWh/day</th>
            <th class="right">¬£/day</th>
            <th class="right">Waste L/day</th>
            <th class="right">Score</th>
            <th class="right">eta</th>
            <th class="right">Standby</th>
          </tr>
        </thead>
        <tbody id="compareBody"></tbody>
      </table>
    </div>
  </div>

  <footer class="muted">¬© Hot Water Model ‚Äî full-scope printable build</footer>
</div>

<script type="module">
/* === MODEL CORE (ASCII identifiers only) === */
const CP = 0.001163;
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const round = (n,d=2)=>Math.round(n*10**d)/10**d;
const etaFromReturn = t => (t<=30?0.98 : t>=55?0.88 : 0.98 - 0.004*(t-30));
const invUtility = (val,best)=>clamp(100*(best/val),10,100);

// Snap-to presets
const PRE = {
  usage: {
    "Low (1‚Äì2 ppl)": { Vd:80, draws:12 },
    "Med (3‚Äì4 ppl)": { Vd:130, draws:18 },
    "High (5‚Äì6 ppl)": { Vd:180, draws:24 }
  },
  mains: { "Winter":8, "Spring/Autumn":12, "Summer":16 },
  layout: { "Central":0.35, "Typical":0.7, "Remote":1.2 }, // L per draw
  systems: {
    // Regular + cylinder variants
    "Regular ‚Ä¢ Open CH + Open-vented cyl":      { kind:"stored", standby:1.8, ctrl:1.00, Tret:54, comfort:86, future:65, maint:72 },
    "Regular ‚Ä¢ Sealed CH + Open-vented cyl":    { kind:"stored", standby:1.7, ctrl:1.00, Tret:52, comfort:87, future:70, maint:74 },
    "Regular ‚Ä¢ Open CH + Unvented cyl":         { kind:"stored", standby:1.5, ctrl:1.00, Tret:52, comfort:88, future:82, maint:80 },
    "Regular ‚Ä¢ Sealed CH + Unvented cyl":       { kind:"stored", standby:1.4, ctrl:1.00, Tret:50, comfort:89, future:84, maint:82 },
    // System + cylinder variants
    "System ‚Ä¢ Open-vented cyl":                 { kind:"stored", standby:1.6, ctrl:1.00, Tret:51, comfort:90, future:75, maint:78 },
    "System ‚Ä¢ Unvented cyl":                    { kind:"stored", standby:1.3, ctrl:1.00, Tret:49, comfort:91, future:86, maint:84 },
    // Mixergy (both types)
    "System ‚Ä¢ Mixergy Unvented (indirect)":     { kind:"stored", standby:1.0, ctrl:0.95, Tret:48, comfort:92, future:95, maint:85 },
    "System ‚Ä¢ Mixergy Vented (open-vented)":    { kind:"stored", standby:1.1, ctrl:0.96, Tret:49, comfort:91, future:88, maint:83 },
    // Combi baselines (context)
    "Combi ‚Ä¢ Standard":                         { kind:"combi", start:0.01, scale:1.05, Tret:55, comfort:72, future:50, maint:70 },
    "Combi ‚Ä¢ Premium (conditioned/central)":    { kind:"combi", start:0.008, scale:1.00, Tret:52, comfort:78, future:55, maint:78 }
  },
  Tuse: 40,
  price: { gas:0.07, water:0.0003 },
  defaultWeights: { wE:3, wCost:5, wC:4, wF:4, wM:2 }
};

// Calculate one system
function calcOne({sysKey, usageKey, mainsKey, layoutKey, prices}){
  const U = PRE.usage[usageKey];
  const M = PRE.mains[mainsKey];
  const L = PRE.layout[layoutKey];
  const S = PRE.systems[sysKey];
  const Tuse = PRE.Tuse, Tmains = M;

  const E_use  = U.Vd * CP * (Tuse - Tmains);
  const V_wait = L * U.draws;
  const E_wait = V_wait * CP * (Tuse - Tmains);
  const etaVal = etaFromReturn(S.Tret);

  let E_total, GBP, standby = 0, starts = 0;
  if (S.kind === "stored"){
    const E_gas = ((E_use + E_wait) / etaVal) * S.ctrl;
    standby = S.standby;
    E_total = E_gas + standby;
    GBP = E_total * prices.gas + V_wait * prices.water;
  } else {
    const etaEff = etaVal / (S.scale || 1.0);
    starts = U.draws;
    const E_over = starts * (S.start || 0.01);
    E_total = ((E_use + E_wait) / etaEff) + E_over;
    GBP = E_total * prices.gas + V_wait * prices.water;
  }

  return {
    sysKey, usageKey, mainsKey, layoutKey,
    kWh: round(E_total,3),
    cost: round(GBP,2),
    kWh_year: Math.round(E_total*365),
    cost_year: Math.round(GBP*365),
    wasteL: round(V_wait,1),
    breakdown: {
      E_use: round(E_use,3),
      E_wait: round(E_wait,3),
      standby: round(standby,3),
      eta: round(etaVal,3),
      starts
    }
  };
}

// Score relative to reference baselines (best-of-two)
function scoreAll(results, weights){
  const refKeys = ["System ‚Ä¢ Mixergy Unvented (indirect)", "Combi ‚Ä¢ Premium (conditioned/central)"];
  const refs = results.filter(r => refKeys.includes(r.sysKey));
  const bestKWh = Math.min(...refs.map(r => r.kWh));
  const bestGBP = Math.min(...refs.map(r => r.cost));

  return results.map(r => {
    const S = PRE.systems[r.sysKey];
    const penalty = r.layoutKey==="Central" ? 0 : (r.layoutKey==="Typical" ? 6 : 12);
    const Ue = invUtility(r.kWh, bestKWh);
    const Up = invUtility(r.cost, bestGBP);
    const Uc = clamp((S.comfort||75) - penalty, 10, 100);
    const Uf = clamp(S.future||60, 10, 100);
    const Um = clamp(S.maint||70, 10, 100);
    const W  = weights;
    const score =
      (W.wE*Ue + W.wCost*Up + W.wC*Uc + W.wF*Uf + W.wM*Um) /
      (W.wE + W.wCost + W.wC + W.wF + W.wM);
    return { ...r, utilities: {
      Ue: Math.round(Ue), Up: Math.round(Up), Uc: Math.round(Uc),
      Uf: Math.round(Uf), Um: Math.round(Um), score: Math.round(score)
    }};
  });
}

/* === UI wiring & error guard === */
const $ = s => document.querySelector(s);
const els = {
  usage:$('#usage'), mains:$('#mains'), layout:$('#layout'), gas:$('#gas'),
  wE:$('#wE'), wCost:$('#wCost'), wC:$('#wC'), wF:$('#wF'), wM:$('#wM'),
  focusName:$('#focusName'),
  kwhDay:$('#kwhDay'), kwhYear:$('#kwhYear'),
  costDay:$('#costDay'), costYear:$('#costYear'),
  wasteL:$('#wasteL'), score:$('#score'),
  uE:$('#uE'), uP:$('#uP'), uC:$('#uC'), uF:$('#uF'), uM:$('#uM'),
  eUse:$('#eUse'), eWait:$('#eWait'), standby:$('#standby'), eta:$('#eta'), starts:$('#starts'),
  echo:$('#echo'), compareBody:$('#compareBody'), copyBtn:$('#copy'),
  recalcBtn:$('#recalc'), presetBudget:$('#presetBudget'),
  presetComfort:$('#presetComfort'), presetFuture:$('#presetFuture'), presetReset:$('#presetReset'),
  errorbar:$('#errorbar')
};

function showError(msg){
  els.errorbar.textContent = "Error: " + msg;
  els.errorbar.style.display = 'block';
}

function getState(){
  return {
    usageKey: els.usage.value,
    mainsKey: els.mains.value,
    layoutKey: els.layout.value,
    prices: { gas: parseFloat(els.gas.value||"0.07"), water: 0.0003 },
    weights: {
      wE:+els.wE.value, wCost:+els.wCost.value, wC:+els.wC.value, wF:+els.wF.value, wM:+els.wM.value
    }
  };
}

function runAll(){
  try{
    els.errorbar.style.display='none';
    const st = getState();
    const results = Object.keys(PRE.systems).map(sysKey => calcOne({sysKey, ...st}));
    const scored = scoreAll(results, st.weights).sort((a,b)=>b.utilities.score - a.utilities.score);

    // Fill table
    els.compareBody.innerHTML = scored.map(r=>`
      <tr data-sys="${r.sysKey}">
        <td>${r.sysKey}</td>
        <td class="right">${r.kWh}</td>
        <td class="right">¬£${r.cost.toFixed(2)}</td>
        <td class="right">${r.wasteL}</td>
        <td class="right"><b>${r.utilities.score}</b></td>
        <td class="right">${r.breakdown.eta}</td>
        <td class="right">${r.breakdown.standby}</td>
      </tr>
    `).join('');

    // Row click to focus
    for(const tr of els.compareBody.querySelectorAll('tr')){
      tr.onclick = ()=> focus(scored.find(x=>x.sysKey===tr.dataset.sys));
    }

    // Focus top result
    focus(scored[0]);
    return {scored, st};
  }catch(e){
    console.error(e);
    showError(e.message || String(e));
  }
}

function focus(r){
  if(!r) return;
  els.focusName.textContent = r.sysKey;
  els.kwhDay.textContent    = r.kWh;
  els.kwhYear.textContent   = "‚âà " + r.kWh_year + " kWh / yr";
  els.costDay.textContent   = r.cost.toFixed(2);
  els.costYear.textContent  = "‚âà ¬£" + r.cost_year + " / yr";
  els.wasteL.textContent    = r.wasteL;
  els.score.textContent     = r.utilities.score;
  els.uE.textContent        = r.utilities.Ue;
  els.uP.textContent        = r.utilities.Up;
  els.uC.textContent        = r.utilities.Uc;
  els.uF.textContent        = r.utilities.Uf;
  els.uM.textContent        = r.utilities.Um;
  els.eUse.textContent      = r.breakdown.E_use;
  els.eWait.textContent     = r.breakdown.E_wait;
  els.standby.textContent   = r.breakdown.standby;
  els.eta.textContent       = r.breakdown.eta;
  els.starts.textContent    = r.breakdown.starts;
  els.echo.textContent      = r.usageKey + " ‚Ä¢ " + r.mainsKey + " ‚Ä¢ " + r.layoutKey;

  els.copyBtn.onclick = ()=> navigator.clipboard.writeText(JSON.stringify(r, null, 2));
}

// Presets
els.presetBudget.onclick  = ()=>{ els.wE.value=3; els.wCost.value=8; els.wC.value=2; els.wF.value=2; els.wM.value=2; runAll(); };
els.presetComfort.onclick = ()=>{ els.wE.value=3; els.wCost.value=3; els.wC.value=8; els.wF.value=3; els.wM.value=3; runAll(); };
els.presetFuture.onclick  = ()=>{ els.wE.value=5; els.wCost.value=4; els.wC.value=3; els.wF.value=8; els.wM.value=2; runAll(); };
els.presetReset.onclick   = ()=>{ els.wE.value=3; els.wCost.value=5; els.wC.value=4; els.wF.value=4; els.wM.value=2; runAll(); };

// Live recalc
els.recalcBtn.onclick = runAll;
for(const el of document.querySelectorAll('input,select')) el.addEventListener('change', runAll);

// Init
runAll();
</script>
</body>
</html>
