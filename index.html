<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="light dark">
<title>Depot Notes ‚Äì Picker</title>
<style>
  /* ===== THEME VARIABLES ===== */
  :root {
    --bg: #0a0a0a;
    --fg: #f5f5f5;
    --muted: #bbb;
    --panel: #111;
    --line: #333;
    --accent: #3088ff;
    --accent-600: #1e6ad9;
    --accent-weak: #16243a;
  }
  :root[data-theme="light"] {
    color-scheme: light;
    --bg: #ffffff;
    --fg: #111111;
    --muted: #666;
    --panel: #ffffff;
    --line: #e3e7f2;
    --accent: #0a5cff;
    --accent-600: #084ad1;
    --accent-weak: #eef2ff;
  }
  :root[data-theme="dark"] {
    color-scheme: dark;
    --bg: #0a0a0a;
    --fg: #f5f5f5;
    --muted: #bbb;
    --panel: #111;
    --line: #333;
    --accent: #3088ff;
    --accent-600: #1e6ad9;
    --accent-weak: #16243a;
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
  }

  /* BANNERS */
  .banner{
    background:var(--accent);color:#fff;padding:14px 16px;
    border-bottom:1px solid var(--accent-600);position:sticky;top:0;z-index:5
  }
  .banner h1{margin:0;font-size:18px;letter-spacing:.2px}
  .header-actions{position:absolute;right:12px;top:10px;display:flex;gap:8px;align-items:center}
  .gear, .theme{
    background:#fff;color:var(--accent);border:1px solid var(--line);
    border-radius:8px;padding:6px 10px;cursor:pointer;font-size:16px
  }
  :root[data-theme="dark"] .gear, :root[data-theme="dark"] .theme { background:#222;color:#fff;border-color:#444 }
  .gear:hover, .theme:hover{filter:brightness(0.96)}

  .subbanner{
    background:var(--accent);color:#fff;padding:10px 16px;margin:16px 0 8px;border-radius:8px
  }
  .subbanner h2{margin:0;font-size:16px}

  /* LAYOUT */
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 360px;min-width:320px}
  .sticky{position:sticky;top:76px}

  /* FORMS */
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"], textarea, select{
    width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:var(--panel);color:var(--fg)
  }
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  button{
    padding:8px 10px;border:1px solid var(--line);
    background:var(--panel);border-radius:8px;color:var(--fg);cursor:pointer
  }
  button:hover{filter:brightness(0.96)}
  .pill{
    font-size:12px;padding:4px 10px;border-radius:999px;
    background:var(--accent-weak);color:var(--fg);border:1px solid var(--line)
  }
  .muted{color:var(--muted);font-size:13px}
  .out{
    width:100%;min-height:150px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    background:var(--panel);color:var(--fg);border:1px solid var(--line);border-radius:8px
  }
  .sep{height:1px;background:var(--line);margin:12px 0}

  /* EDITOR (collapsed) */
  details.editor-wrap{margin-top:16px}
  summary{
    list-style:none;cursor:pointer;display:flex;align-items:center;gap:.5rem;
    padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:var(--panel);color:var(--fg)
  }
  summary::marker{display:none}
  .editor{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--panel)}
  .editor .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){ .editor .grid{grid-template-columns:1fr} }
  .badge{background:#fff;color:var(--accent);border-radius:999px;padding:2px 8px;font-size:12px}
  :root[data-theme="dark"] .badge{background:#222;color:#fff;border:1px solid #444}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  /* CUSTOM LISTBOX (fixes iOS select issues) */
  .listbox{
    border:1px solid var(--line);border-radius:8px;background:var(--panel);color:var(--fg);
    min-height:460px;max-height:460px;overflow:auto;padding:4px
  }
  .list-item{
    display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;cursor:pointer;user-select:none
  }
  .list-item:hover{background:color-mix(in oklab, var(--panel), #fff 8%)}
  .list-item.selected{outline:2px solid var(--accent);background:var(--accent-weak)}
  .list-item.disabled{cursor:default;color:var(--muted);background:color-mix(in oklab, var(--panel), #fff 4%)}
  .list-item.sub{ /* per-depth padding set inline via JS */ }
  .bullet{width:11px;height:11px;border:2px solid var(--accent);border-radius:2px}
  .list-item.selected .bullet{background:var(--accent)}
</style>
</head>
<body>

<!-- Header -->
<div class="banner">
  <h1>Depot Notes ‚Äì Picker</h1>
  <div class="header-actions">
    <button id="btn-theme" class="theme" title="Toggle theme">üåô</button>
    <button id="btn-editor-toggle" class="gear" title="Open Editor">‚öôÔ∏è</button>
  </div>
</div>

<div class="container">
  <!-- Instructions -->
  <div class="subbanner"><h2>Instructions</h2></div>
  <ol class="muted" style="margin-top:8px">
    <li>Select a <strong>Section</strong>, filter if needed.</li>
    <li>Tap items to toggle them. Use <strong>Select all</strong> or <strong>Clear</strong> as needed.</li>
    <li>Click <strong>Copy</strong> to put the <code>;</code>-separated list on your clipboard.</li>
    <li>Use the <strong>‚öôÔ∏è Editor</strong> at the bottom to load/preview <span class="mono">Options.txt</span>. (Edits here do not auto-save to GitHub.)</li>
  </ol>

  <!-- Picker -->
  <div class="subbanner"><h2>Picker</h2></div>
  <div class="row">
    <div class="col sticky">
      <label for="section-select">Section</label>
      <select id="section-select"></select>

      <div class="controls">
        <input id="filter" type="text" placeholder="Filter visible options‚Ä¶" />
        <button id="btn-select-all" class="pill">Select all (visible)</button>
        <button id="btn-clear" class="pill">Clear</button>
      </div>

      <label for="options-list">Options</label>
      <div id="options-list" class="listbox" role="listbox" aria-multiselectable="true" tabindex="0" aria-label="Options list"></div>
      <div class="muted">Dividers not used. Multi-layer items are shown with increasing indent.</div>
    </div>

    <div class="col">
      <label for="output">Copy Box Output (; line breaks)</label>
      <textarea id="output" class="out" readonly></textarea>
      <div class="controls">
        <label class="muted"><input type="checkbox" id="include-headers" /> Include section headers</label>
        <button id="btn-rebuild">Rebuild</button>
        <button id="btn-copy">Copy</button>
      </div>
    </div>
  </div>

  <!-- Editor (collapsed) -->
  <div class="subbanner"><h2>Advanced ‚Äì Editor</h2></div>
  <details id="editor-panel" class="editor-wrap">
    <summary><span class="slabel">Show / Hide Editor</span> <span class="badge">‚öôÔ∏è</span></summary>
    <div class="editor" role="region" aria-label="Options Editor">
      <p class="muted">Load the live <span class="mono">Options.txt</span>, edit locally, and preview parsing. Use <em>Copy</em> or <em>Download</em> to update your repo manually.</p>
      <div class="grid">
        <div>
          <label for="txt-editor">Options.txt (local edit)</label>
          <textarea id="txt-editor" style="height:340px" placeholder="[needs]
NE01 | Better water pressure
NE02 | Faster hot water delivery"></textarea>
          <div class="controls">
            <button id="btn-load-remote">Load from Options.txt</button>
            <button id="btn-apply-local">Apply (Preview)</button>
            <button id="btn-download">Download Options.txt</button>
            <button id="btn-copy-txt">Copy Text</button>
          </div>
          <div class="muted" id="active-source">Source: (not loaded yet)</div>
        </div>
        <div>
          <label for="parsed-preview">Parsed (debug)</label>
          <textarea id="parsed-preview" class="out" style="height:340px" readonly></textarea>
          <div class="controls">
            <button id="btn-reset">Reset to remote</button>
          </div>
        </div>
      </div>
      <p class="muted"><strong>Note:</strong> This app does not push changes to GitHub automatically.</p>
    </div>
  </details>
</div>

<script>
/* ==============================
   Theme toggle (persisted)
================================= */
const THEME_KEY = 'depot.theme';
function applyTheme(theme){
  const t = theme || localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
  document.documentElement.setAttribute('data-theme', t);
  const btn = document.getElementById('btn-theme');
  if (btn) btn.textContent = (t === 'dark') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem(THEME_KEY, t);
}
document.getElementById('btn-theme').addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  applyTheme(cur === 'light' ? 'dark' : 'light');
});
applyTheme();

/* ==============================
   State
================================= */
const State = {
  sections: {}, order: [], current: null,
  rawTxt: '', sourceUrl: '',
  selectedBySection: {}  // { sectionName: Set<string> }
};
const $ = sel => document.querySelector(sel);
const setSourceLabel = url => $('#active-source').textContent = 'Source: ' + (url || '(fallback)');

/* ==============================
   Load Options.txt
================================= */
async function fetchFirstAvailable(urls){
  for (const url of urls){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if (res.ok){ State.sourceUrl = url; return await res.text(); }
    }catch(_){}
  }
  throw new Error('Unable to load Options.txt');
}
async function loadOptionsTxt(){
  const base = location.pathname.replace(/\/[^/]*$/, '/') || '/';
  const candidates = [
    'Options.txt', base+'Options.txt', './Options.txt',
    'options.txt', base+'options.txt', './options.txt',
    'https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/main/Options.txt',
    'https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/main/options.txt'
  ];
  const txt = await fetchFirstAvailable(candidates);
  setSourceLabel(State.sourceUrl);
  return txt;
}

/* ==============================
   INI-style parser with multi-layer levels
   [section]
   CODE | Level1 | Level2 | ... LevelN
================================= */
function parseOptionsText(txt){
  const db = {}; let section = null;
  for (const raw of txt.split(/\r?\n/)){
    const line = raw.trim();
    if (!line || line.startsWith('#') || line.startsWith(';') || line.startsWith('//')) continue;

    const sec = line.match(/^\[([^\]]+)\]$/);
    if (sec){
      section = sec[1].trim();
      if (!db[section]) db[section] = [];
      continue;
    }
    if (!section) continue;

    const parts = line.split('|').map(s => s.trim()).filter(Boolean);
    if (parts.length >= 2){
      const code = parts[0];
      const levels = parts.slice(1); // arbitrary depth
      db[section].push({
        type: 'item',
        code,
        levels,
        label: levels[0] || '' // legacy label for compatibility
      });
    }
  }
  return db;
}

/* ==============================
   Rendering (Sections + Custom Listbox)
================================= */
function populateSectionDropdown(){
  const sel = $('#section-select');
  sel.innerHTML = '';
  State.order = Object.keys(State.sections);
  State.order.forEach(name => {
    const o = document.createElement('option');
    o.value = name; o.textContent = name;
    sel.appendChild(o);
  });
  if (!State.current) State.current = State.order[0] || null;
  sel.value = State.current || '';
}

function getSelectedSet(section){
  if (!State.selectedBySection[section]) State.selectedBySection[section] = new Set();
  return State.selectedBySection[section];
}

function refreshOutput() {
  document.getElementById('output').value = selectedValuesToCopy();
}

function buildOptionsForCurrent(filterText=''){
  const box = document.getElementById('options-list');
  const items = State.sections[State.current] || [];
  const q = (filterText || '').toLowerCase();
  const selectedSet = getSelectedSet(State.current);
  box.innerHTML = '';

  function addRow({ idText, text, depth = 0 }){
    const div = document.createElement('div');
    div.className = 'list-item';
    if (depth > 0) div.classList.add('sub');
    div.style.paddingLeft = (10 + depth * 18) + 'px';   // progressive indent

    div.setAttribute('role', 'option');
    div.setAttribute('data-id', idText);
    div.setAttribute('aria-selected', selectedSet.has(idText) ? 'true' : 'false');

    const b = document.createElement('span'); b.className = 'bullet';
    const t = document.createElement('span'); t.textContent = text;
    div.appendChild(b); div.appendChild(t);

    if (selectedSet.has(idText)) div.classList.add('selected');

    div.addEventListener('click', () => {
      const now = div.classList.toggle('selected');
      div.setAttribute('aria-selected', now ? 'true' : 'false');
      if (now) selectedSet.add(idText); else selectedSet.delete(idText);
      refreshOutput();
    });

    box.appendChild(div);
  }

  // For each item, render Level1 then deeper paths ‚ÄúL1 ‚Äî L2 ‚Äî ‚Ä¶‚Äù
  items.forEach(it => {
    if (it.type !== 'item' || !Array.isArray(it.levels) || !it.levels.length) return;

    const level1 = it.levels[0];
    const m1 = !q || level1.toLowerCase().includes(q);
    if (m1) addRow({ idText: level1, text: level1, depth: 0 });

    for (let d = 1; d < it.levels.length; d++){
      const path = it.levels.slice(0, d + 1);
      const text = `‚Ü≥ ${path.join(' ‚Äî ')}`;
      const match = !q || text.toLowerCase().includes(q);
      if (match) addRow({ idText: text, text, depth: d });
    }
  });

  // Keyboard basics
  box.onkeydown = (e) => {
    const focusables = [...box.querySelectorAll('.list-item')];
    const idx = focusables.indexOf(document.activeElement.closest('.list-item'));
    if (e.key === 'ArrowDown'){ (focusables[idx+1]||focusables[0])?.focus(); e.preventDefault(); }
    if (e.key === 'ArrowUp'){ (focusables[idx-1]||focusables.at(-1))?.focus(); e.preventDefault(); }
    if (e.key === ' ' || e.key === 'Enter'){ document.activeElement.closest('.list-item')?.click(); e.preventDefault(); }
  };
  box.querySelectorAll('.list-item').forEach(li => li.tabIndex = 0);

  refreshOutput(); // keep copy box in sync after render/filter
}

function selectedValuesToCopy(){
  const set = getSelectedSet(State.current);
  const head = $('#include-headers').checked ? (State.current + ':') : null;
  const lines = [];
  if (head) lines.push(head);
  lines.push(...set);
  return lines.join(';\n');
}

/* ==============================
   Events
================================= */
$('#section-select').addEventListener('change', e => {
  State.current = e.target.value;
  getSelectedSet(State.current); // ensure set exists
  buildOptionsForCurrent($('#filter').value);
});

$('#filter').addEventListener('input', e => {
  buildOptionsForCurrent(e.target.value);
});

$('#btn-select-all').addEventListener('click', () => {
  const set = getSelectedSet(State.current);
  document.querySelectorAll('#options-list .list-item').forEach(div => {
    div.classList.add('selected');
    div.setAttribute('aria-selected','true');
    set.add(div.textContent.trim());
  });
  refreshOutput();
});

$('#btn-clear').addEventListener('click', () => {
  const set = getSelectedSet(State.current);
  set.clear();
  document.querySelectorAll('#options-list .list-item.selected').forEach(div => {
    div.classList.remove('selected');
    div.setAttribute('aria-selected','false');
  });
  refreshOutput();
});

$('#btn-rebuild').addEventListener('click', refreshOutput);

$('#btn-copy').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText($('#output').value || selectedValuesToCopy()); } catch {}
});

/* ==============================
   Editor controls
================================= */
const editorPanel = $('#editor-panel');
$('#btn-editor-toggle').addEventListener('click', () => {
  editorPanel.open = !editorPanel.open;
  if (editorPanel.open) editorPanel.scrollIntoView({behavior:'smooth',block:'start'});
});

async function fetchFirstAvailable(urls){
  for (const url of urls){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if (res.ok){ State.sourceUrl = url; return await res.text(); }
    }catch(_){}
  }
  throw new Error('Unable to load Options.txt');
}

$('#btn-load-remote').addEventListener('click', async () => {
  try {
    const txt = await loadOptionsTxt(); State.rawTxt = txt;
    $('#txt-editor').value = txt; setSourceLabel(State.sourceUrl);
  } catch (e) {
    $('#txt-editor').value = `Error: ${e.message}`;
  }
});

$('#btn-apply-local').addEventListener('click', () => {
  const local = $('#txt-editor').value || '';
  try {
    const parsed = parseOptionsText(local);
    State.sections = parsed;
    State.current = Object.keys(parsed)[0] || null;
    State.selectedBySection = {};
    populateSectionDropdown();
    buildOptionsForCurrent($('#filter').value);
    $('#parsed-preview').value = JSON.stringify(parsed, null, 2);
  } catch (e) {
    $('#parsed-preview').value = `Parse error: ${e.message}`;
  }
});

$('#btn-reset').addEventListener('click', async () => {
  await init();
  $('#txt-editor').value = State.rawTxt;
  $('#parsed-preview').value = '';
});

$('#btn-copy-txt').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText($('#txt-editor').value || ''); } catch {}
});

$('#btn-download').addEventListener('click', () => {
  const blob = new Blob([$('#txt-editor').value || ''], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Options.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ==============================
   Boot
================================= */
async function init(){
  let txt = '';
  try{
    txt = await loadOptionsTxt();
  }catch(e){
    console.warn(e);
    txt = `[needs]
NE01 | Better water pressure
NE02 | Faster hot water delivery`;
    State.sourceUrl = '(fallback)';
  }
  State.rawTxt = txt;
  State.sections = parseOptionsText(txt);
  State.current = Object.keys(State.sections)[0] || null;
  State.selectedBySection = {};
  populateSectionDropdown();
  buildOptionsForCurrent('');
  refreshOutput();
  setSourceLabel(State.sourceUrl);
}
init();
</script>
</body>
</html>