<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Depot Notes Picker</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    :root { --gap:12px; --radius:12px; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
                   "Apple Color Emoji","Segoe UI Emoji";
      margin:0; padding:0; background:#0b1220; color:#e6ecff;
    }
    header.app {
      position: sticky; top:0; z-index:20; backdrop-filter: blur(8px);
      background: rgba(11,18,32,0.85);
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:10px var(--gap);
    }
    h1 { font-size:18px; margin:4px 0; }
    .bar { display:flex; flex-wrap:wrap; gap:var(--gap); align-items:center }
    select, input[type="search"] {
      padding:10px 12px; border-radius:10px; background:#0f172a; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); outline:none;
    }
    .btn {
      border:1px solid rgba(255,255,255,0.14);
      background:#111827; color:#e5e7eb; padding:9px 12px; border-radius:10px;
      cursor:pointer; font-weight:600;
    }
    .btn:hover { background:#1f2937; }
    .container { display:grid; grid-template-columns:1fr; gap:var(--gap); padding:var(--gap) }
    @media (min-width: 980px) {
      .container { grid-template-columns: 1fr 420px; align-items:start }
    }
    .panel {
      border:1px solid rgba(255,255,255,0.12); background:#0f172a; border-radius: var(--radius);
      overflow:hidden;
    }
    .panel header { position:unset; background:transparent; border:none; padding:12px }
    .panel h2 { margin:0; font-size:16px }
    .list { display:flex; flex-direction:column; gap:8px; padding:12px; max-height:60vh; overflow:auto }
    .item { display:flex; gap:10px; padding:10px; border:1px solid rgba(255,255,255,0.08); background:#0b132a; border-radius:10px }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .meta { opacity:0.75; font-size:12px }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#1f2937; font-size:12px }
    textarea {
      width:100%; min-height:160px; max-height:280px; padding:12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.12); background:#0f172a; color:#e2e8f0;
    }
    .hint { font-size:12px; opacity:0.8 }
    a.help { color:#9ecbff; text-decoration:none }
  </style>
</head>
<body>

  <header class="app">
    <h1>Depot Notes Picker</h1>
    <div class="bar">
      <label class="hint">Section</label>
      <select id="sectionSelect" aria-label="Choose section"></select>
      <button class="btn" id="nextSectionBtn" title="Go to next section">Next section ➜</button>
      <input id="search" type="search" placeholder="Filter within section… (e.g., 'loft', 'N12')" />
      <button class="btn" id="selectAllVisible">Select all (visible)</button>
      <button class="btn" id="clearSection">Clear section</button>
      <span class="meta" id="countMeta">0 selected</span>
    </div>
  </header>

  <div class="container">
    <div class="panel" id="itemsPanel">
      <header>
        <div class="row">
          <h2 id="sectionTitle">Section</h2>
          <span class="pill" id="sectionPill">0 selected</span>
        </div>
      </header>
      <div class="list" id="itemsList"></div>
    </div>

    <div class="panel">
      <header><h2>Copy Box Output (; line breaks)</h2></header>
      <div class="list" style="max-height:none">
        <div class="row">
          <button class="btn" id="copySemiBtn">Copy ;-lines</button>
          <label class="row hint" style="gap:6px">
            <input type="checkbox" id="includeHeaders" checked />
            Include section headers
          </label>
        </div>
        <textarea id="semiOutput" placeholder="e.g., 'Needs: phrase ; phrase ; …'"></textarea>
        <div class="hint">Tip: Cmd/Ctrl + C inside this box also copies the output.</div>
      </div>
    </div>
  </div>

  <script>
    // Register service worker (PWA). sw.js already handles versioning + cache cleanup.
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }

    // --------------------------
    // Data & State
    // --------------------------

    // Minimal starter so the UI isn't empty even if the JSON fails to load.
    // You can extend or replace this with your full bank later.
    const PHRASE_BANK = {
      needs: [
        { code: "N01", text: "Customer wants improved hot water performance" },
        { code: "N02", text: "Customer requested quieter boiler operation" }
      ]
    };

    // Default section order (new sections from JSON will be unshifted to the front)
    const SECTION_ORDER = ["needs"];

    // Tracks selected codes by section
    const selections = {}; // { sectionKey: Set<string> }
    let currentSection = SECTION_ORDER[0];

    // --------------------------
    // Helpers
    // --------------------------

    function ensureBucket(section) {
      if (!selections[section]) selections[section] = new Set();
    }

    function labelOf(sectionKey) {
      // For now just title-case the key; you can map custom labels if you prefer.
      if (sectionKey === 'system_characteristics') return 'System Characteristics';
      return sectionKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function flattenSystemCharacteristics(cfg) {
  const root = cfg?.catalogs?.system_characteristics;
  if (!root || !Array.isArray(root.children)) return {};

  const sections = {}; // e.g. { 'system_characteristics__hot_water': [...] }

  // Each top-level group becomes its own section
  root.children.forEach(group => {
    if (group.type !== 'group') return;
    const baseKey = `system_characteristics__${group.label
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_|_$/g, '')}`;

    const items = [];

    function walk(node, path = []) {
      if (node.type === 'group' && Array.isArray(node.children)) {
        node.children.forEach(child => walk(child, path.concat(node.label)));
        return;
      }
      if (node.type === 'single' && Array.isArray(node.options)) {
        node.options.forEach(opt => {
          items.push({
            code: node.id || opt,
            text: `${node.label}: ${opt}`
          });
        });
      }
    }

    if (Array.isArray(group.children)) group.children.forEach(walk);
    if (items.length > 0) sections[baseKey] = items;
  });

  return sections;
}
      return items.filter(it => (it.code + ' ' + it.text).toLowerCase().includes(q));
    }

    function buildSemicolonText() {
      const includeHeaders = document.getElementById('includeHeaders').checked;
      let out = '';
      SECTION_ORDER.forEach(section => {
        const chosen = [...(selections[section] || [])];
        if (chosen.length === 0) return;
        const phrases = (PHRASE_BANK[section] || []).filter(it => chosen.includes(it.code));
        if (phrases.length === 0) return;

        if (includeHeaders) out += `${labelOf(section)}: `;
        out += phrases.map(p => p.text).join(' ; ');
        out += ' ;\n';
      });
      document.getElementById('semiOutput').value = out.trim();
      return out.trim();
    }

    function updateTotals() {
      const n = selections[currentSection]?.size || 0;
      document.getElementById('sectionPill').textContent = `${n} selected`;
      let total = 0; Object.values(selections).forEach(s => total += s.size);
      document.getElementById('countMeta').textContent = `${total} selected`;
    }

    // --------------------------
    // Rendering
    // --------------------------

    function populateSectionSelect() {
      const sel = document.getElementById('sectionSelect');
      sel.innerHTML = '';
      SECTION_ORDER.forEach(k => {
        if (!PHRASE_BANK[k]) return;
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = labelOf(k);
        sel.appendChild(opt);
      });
      sel.value = currentSection;
      document.getElementById('sectionTitle').textContent = labelOf(currentSection);
      renderSectionItems();
    }

    function renderSectionItems() {
      const wrap = document.getElementById('itemsList');
      wrap.innerHTML = '';
      const items = PHRASE_BANK[currentSection] || [];
      const q = document.getElementById('search').value;
      const visible = filterItems(items, q);

      visible.forEach(it => {
        const row = document.createElement('label');
        row.className = 'item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selections[currentSection]?.has(it.code) || false;
        cb.addEventListener('change', () => {
          ensureBucket(currentSection);
          if (cb.checked) selections[currentSection].add(it.code);
          else selections[currentSection].delete(it.code);
          updateTotals();
          buildSemicolonText();
        });
        const txt = document.createElement('div');
        txt.innerHTML = `<div><strong>${it.code}</strong> — ${it.text}</div>`;
        row.appendChild(cb);
        row.appendChild(txt);
        wrap.appendChild(row);
      });

      updateTotals();
      buildSemicolonText();
    }

    function nextSection() {
      const idx = SECTION_ORDER.indexOf(currentSection);
      const next = SECTION_ORDER[(idx + 1) % SECTION_ORDER.length];
      currentSection = next;
      document.getElementById('sectionSelect').value = next;
      document.getElementById('sectionTitle').textContent = labelOf(next);
      renderSectionItems();
      updateTotals();
    }

    // --------------------------
    // JSON loader for System Characteristics
    // --------------------------

    async function loadConfigJSON() {
      // sw.js already forces no-store for this path; we keep it here too for safety.
      const resp = await fetch('./App_config.json', { cache: 'no-store' });
      if (!resp.ok) throw new Error('Failed to load App_config.json');
      return resp.json();
    }

    function flattenSystemCharacteristics(cfg) {
      const root = cfg?.catalogs?.system_characteristics;
      if (!root || !Array.isArray(root.children)) return {};

      const sections = {}; // { sectionKey: [{code, text}] }

      function walk(node) {
        if (node.type === 'group' && Array.isArray(node.children)) {
          node.children.forEach(walk);
          return;
        }
        if (node.type === 'single' && Array.isArray(node.options)) {
          const key = 'system_characteristics'; // keep as a single section for now
          if (!sections[key]) sections[key] = [];
          node.options.forEach(opt => {
            sections[key].push({
              code: node.id || String(opt),
              text: `${node.label}: ${opt}`
            });
          });
        }
      }

      root.children.forEach(walk);
      return sections;
    }

    async function bootstrapSystemCharacteristics() {
  try {
    const cfg = await loadConfigJSON();
    const sysSections = flattenSystemCharacteristics(cfg);

    // Merge all separate group sections into PHRASE_BANK
    Object.assign(PHRASE_BANK, sysSections);

    // Add each new section key (in visible order)
    Object.keys(sysSections)
      .reverse() // reverse so they appear top-down in JSON order
      .forEach(key => {
        if (!SECTION_ORDER.includes(key)) SECTION_ORDER.unshift(key);
      });

    // Rebuild UI
    populateSectionSelect();
    renderSectionItems();

    console.log('System Characteristics groups loaded:', Object.keys(sysSections));
  } catch (err) {
    console.warn('App_config.json not loaded (using built-in phrases only):', err);
    populateSectionSelect();
    renderSectionItems();
  }
}
      }
    }

    // --------------------------
    // Events & init
    // --------------------------

    document.getElementById('search').addEventListener('input', renderSectionItems);
    document.getElementById('sectionSelect').addEventListener('change', (e) => {
      currentSection = e.target.value;
      document.getElementById('sectionTitle').textContent = labelOf(currentSection);
      renderSectionItems(); updateTotals();
    });
    document.getElementById('nextSectionBtn').addEventListener('click', nextSection);
    document.getElementById('selectAllVisible').addEventListener('click', () => {
      const q = document.getElementById('search').value;
      const items = filterItems(PHRASE_BANK[currentSection] || [], q);
      ensureBucket(currentSection);
      items.forEach(it => selections[currentSection].add(it.code));
      renderSectionItems(); updateTotals(); buildSemicolonText();
    });
    document.getElementById('clearSection').addEventListener('click', () => {
      ensureBucket(currentSection); selections[currentSection].clear();
      renderSectionItems(); updateTotals(); buildSemicolonText();
    });
    document.getElementById('copySemiBtn').addEventListener('click', async () => {
      const text = buildSemicolonText();
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback: select textarea and copy
          const ta = document.getElementById('semiOutput');
          ta.focus(); ta.select(); document.execCommand('copy');
        }
      } catch (e) { console.warn('Copy failed:', e); }
    });

    // Keyboard shortcuts: Cmd/Ctrl + → (next section), Cmd/Ctrl + C copies output
    document.addEventListener('keydown', (e) => {
      const mod = e.ctrlKey || e.metaKey;
      if (mod && e.key === 'ArrowRight') { e.preventDefault(); nextSection(); }
      if (mod && (e.key.toLowerCase() === 'c')) {
        e.preventDefault(); buildSemicolonText();
        const ta = document.getElementById('semiOutput');
        ta.focus(); ta.select(); document.execCommand('copy');
      }
    });

    // Boot
    // (We call bootstrap which will render even if JSON fails.)
    bootstrapSystemCharacteristics();
  </script>

  <!-- Optional hook for future update logic; add a tiny update.js to avoid 404 -->
  <script src="./update.js"></script>
</body>
</html>