<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Depot Notes – Plain Text</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    textarea{width:100%;min-height:96px;margin-top:8px}
    .btn{padding:8px 12px;border:1px solid #aaa;border-radius:8px;background:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <h1>Depot Notes Picker (Plain Text Export)</h1>

  <div id="app" class="muted">UI loads via JS…</div>

  <!-- All sections combined -->
  <h2>All sections (paste straight into Depot)</h2>
  <div class="row">
    <button class="btn" onclick="copyAllCompletedSections()">Copy ALL completed</button>
  </div>
  <textarea id="copy_box_all" spellcheck="false" placeholder="All sections will appear here as plain text…"></textarea>

  <script>
    // Minimal demo STATE so this page works standalone; your build can override/extend this
    const SECTION_TITLES = {
      needs: 'Needs',
      safety: 'Safety & Compliance',
      system_characteristics: 'System Characteristics'
    };
    const ORDERED_SECTIONS = Object.keys(SECTION_TITLES);

    // STATE.selected[sectionKey] -> array of strings
    // STATE.manualNotes[sectionKey] -> free text
    const STATE = {
      selected: {
        needs: [
          'Better water pressure',
          'Faster hot water delivery',
          'Lower running costs'
        ],
        safety: [],
        system_characteristics: []
      },
      manualNotes: {
        needs: '',
        safety: '',
        system_characteristics: ''
      }
    };

    // --- PLAIN TEXT EXPORT (no URI encoding) ---
    function buildSectionPlainText(sectionKey) {
      const picks = (STATE.selected[sectionKey] ?? []).slice();
      const manual = (STATE.manualNotes?.[sectionKey] ?? '').trim();

      if (manual) {
        manual.split('\n').map(s => s.trim()).filter(Boolean).forEach(s => picks.push(s));
      }

      // decode any accidental %XX, collapse whitespace, dedupe, and join with "; "
      const out = Array.from(new Set(
        picks.map(s =>
          s.replace(/\s+/g,' ')
           .replace(/%([0-9A-F]{2})/gi, (_,h)=>String.fromCharCode(parseInt(h,16)))
           .trim()
        ).filter(Boolean)
      )).join('; ');

      return out; // plain text
    }

    async function copySectionToClipboard(sectionKey) {
      const text = buildSectionPlainText(sectionKey);
      const ta = document.getElementById('copy_box_'+sectionKey);
      if (ta) ta.value = text;
      try { await navigator.clipboard.writeText(text); } catch {}
    }

    function copyAllCompletedSections() {
      const keys = ORDERED_SECTIONS.filter(k => (STATE.selected[k]?.length || (STATE.manualNotes?.[k]||'').trim()));
      const block = keys.map(k => `${SECTION_TITLES[k]}: ${buildSectionPlainText(k)}`).join('\n');
      const ta = document.getElementById('copy_box_all');
      if (ta) ta.value = block;
      navigator.clipboard.writeText(block).catch(()=>{});
    }

    // helper so options can be routed to any target section
    function addLineToSection(lineText, targetSectionKey) {
      if (!STATE.selected[targetSectionKey]) STATE.selected[targetSectionKey] = [];
      STATE.selected[targetSectionKey].push(lineText);
    }

    // Very light UI so you can test immediately
    function mountDemoUI(){
      const el = document.getElementById('app');
      el.classList.remove('muted');
      el.innerHTML = ORDERED_SECTIONS.map(k => `
        <section style="margin:16px 0;padding:12px;border:1px solid #ddd;border-radius:10px">
          <h2 style="margin:0 0 8px">${SECTION_TITLES[k]}</h2>
          <div class="row">
            <button class="btn" onclick="copySectionToClipboard('${k}')">Copy section</button>
          </div>
          <textarea id="copy_box_${k}" spellcheck="false" placeholder="Section output will appear here as plain text…"></textarea>
          <div style="margin-top:8px">
            <label><b>Manual notes</b></label>
            <textarea spellcheck="false"
              oninput="STATE.manualNotes['${k}']=this.value"
              placeholder="Free-typed notes for this section…"></textarea>
          </div>
        </section>
      `).join('');
    }

    document.addEventListener('DOMContentLoaded', mountDemoUI);
  </script>

  <!-- If you prefer to keep logic in a separate file, swap to update.js below -->
  <!-- <script src="./update.js"></script> -->
</body>
</html>