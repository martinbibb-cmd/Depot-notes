<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Depot Notes – Picker</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --ui:#f4f4f4; --line:#ddd; }
  * { box-sizing: border-box; }
  body { margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--fg); background:var(--bg); }
  header { padding:16px; border-bottom:1px solid var(--line); background:var(--ui); }
  h1 { margin:0 0 6px; font-size:18px; }
  .container { max-width:1100px; margin:0 auto; padding:16px; }
  .row { display:flex; gap:16px; flex-wrap:wrap; }
  .col { flex:1 1 360px; min-width:320px; }
  label { display:block; font-weight:600; margin:6px 0; }
  select, input[type="text"], textarea { width:100%; padding:8px; border:1px solid var(--line); border-radius:6px; background: #fff; }
  select[multiple] { height:440px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
  button { padding:8px 10px; border:1px solid var(--line); background:#fff; border-radius:6px; cursor:pointer; }
  button:hover { background:#f9f9f9; }
  .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#eee; border:1px solid var(--line); }
  .out { width:100%; min-height:140px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color:var(--muted); font-size:13px; }
  details { margin-top:28px; border-top:1px dashed var(--line); padding-top:12px; }
  summary { font-weight:700; cursor:pointer; }
  .divider { color:#999; }
  .sticky { position:sticky; top:12px; }
</style>
</head>
<body>
<header>
  <h1>Depot Notes – Picker</h1>
  <div class="muted">Fast picker for sections. Advanced editing is hidden below.</div>
</header>

<div class="container">

  <div class="row">
    <div class="col sticky">
      <label for="section-select">Section</label>
      <select id="section-select"></select>

      <div class="controls">
        <input id="filter" type="text" placeholder="Filter visible options…" />
        <button id="btn-select-all" class="pill" title="Select all visible">Select all (visible)</button>
        <button id="btn-clear" class="pill" title="Clear selection">Clear</button>
      </div>

      <label for="options-list">Options</label>
      <select id="options-list" multiple></select>
      <div class="muted">Tip: hold Ctrl/Cmd to select multiple items.</div>
    </div>

    <div class="col">
      <label for="output">Copy Box Output (; line breaks)</label>
      <textarea id="output" class="out" readonly></textarea>
      <div class="controls">
        <label><input type="checkbox" id="include-headers" /> Include section headers</label>
        <button id="btn-copy">Copy</button>
        <button id="btn-rebuild">Rebuild from selection</button>
      </div>

      <label for="json-output">JSON (current section)</label>
      <textarea id="json-output" class="out" readonly></textarea>
      <div class="controls">
        <button id="btn-json-copy">Copy JSON</button>
      </div>
      <div class="muted">Dividers are ignored in JSON. Sub-items are included under <code>subcategories</code>.</div>
    </div>
  </div>

  <!-- Advanced editor hidden by default -->
  <details>
    <summary>Advanced / Editor (hidden by default)</summary>
    <p class="muted">Paste/modify <code>options.txt</code> here to preview without touching the live file. Nothing is saved automatically.</p>
    <div class="row">
      <div class="col">
        <label for="txt-editor">options.txt (preview / local)</label>
        <textarea id="txt-editor" style="height:320px" placeholder="Customer Needs:\n[Water & Hot Water]\nCN01|Better water pressure\n..."></textarea>
        <div class="controls">
          <button id="btn-load-remote">Load from options.txt</button>
          <button id="btn-apply-local">Apply this text</button>
          <button id="btn-reset">Reset to remote</button>
        </div>
      </div>
      <div class="col">
        <label for="parsed-preview">Parsed (debug)</label>
        <textarea id="parsed-preview" class="out" style="height:320px" readonly></textarea>
      </div>
    </div>
  </details>

</div>

<script>
// ------------------------------
// Data loading & parsing
// ------------------------------
const State = {
  sections: {},        // { SectionName: [entries...] }
  order: [],           // section order as found
  current: null,       // current section name
  rawTxt: '',          // last loaded options.txt
};

async function fetchTxt(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('Failed to load options.txt');
  return await res.text();
}

// Parse options.txt format:
// "Section Name:"    -> start of section
// "[Category Name]"  -> divider line (non-selectable)
// "CODE|Label|Sub1|Sub2..." -> item with optional subcategories
function parseOptionsText(txt) {
  const db = {};
  let section = null;

  for (const raw of txt.split(/\r?\n/)) {
    const line = raw.trim();
    if (!line || line.startsWith('//') || line.startsWith(';')) continue;

    // Section: "Customer Needs:"
    const secColon = line.match(/^(.+?):$/);
    if (secColon) {
      section = secColon[1].trim();
      if (!db[section]) db[section] = [];
      continue;
    }
    if (!section) continue; // ignore junk before first section

    // Divider: "[Water & Hot Water]"
    const cat = line.match(/^\[([^\]]+)\]$/);
    if (cat) {
      db[section].push({ type: 'divider', label: cat[1].trim() });
      continue;
    }

    // Item: code|label|...extras
    const parts = line.split('|').map(s => s.trim());
    if (parts.length >= 2) {
      const code = parts[0];
      const label = parts[1] || '';
      const extras = parts.slice(2).filter(Boolean);
      if (code) {
        db[section].push({
          type: 'item',
          code,
          label,
          subcategories: extras.length ? extras : null
        });
      }
    }
  }
  return db;
}

// ------------------------------
// Rendering
// ------------------------------
function $(sel){ return document.querySelector(sel); }

function populateSectionDropdown() {
  const sel = $('#section-select');
  sel.innerHTML = '';
  State.order = Object.keys(State.sections);
  State.order.forEach(k => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });
  if (!State.current) State.current = State.order[0] || null;
  sel.value = State.current || '';
}

function buildOptionsForCurrent(filterText='') {
  const list = $('#options-list');
  const items = (State.sections[State.current] || []);
  const q = (filterText || '').toLowerCase();
  list.innerHTML = '';

  // Add options (parent + sub-items), dividers disabled
  const addOption = (value, text, disabled=false) => {
    const o = document.createElement('option');
    o.value = value;
    o.textContent = text;
    if (disabled) o.disabled = true;
    list.appendChild(o);
  };

  items.forEach(entry => {
    if (entry.type === 'divider') {
      const txt = `— ${entry.label} —`;
      if (!q || txt.toLowerCase().includes(q)) addOption('', txt, true);
      return;
    }
    if (entry.type === 'item') {
      const labelTxt = entry.label || entry.code;
      const parentMatches = !q || labelTxt.toLowerCase().includes(q);

      if (parentMatches) addOption(entry.code, labelTxt, false);

      if (Array.isArray(entry.subcategories) && entry.subcategories.length) {
        entry.subcategories.forEach(sub => {
          const subTxt = `↳ ${labelTxt} — ${sub}`;
          if (!q || subTxt.toLowerCase().includes(q)) {
            // keep same value for backward-compat; change to `${entry.code}:${sub}` if you want unique values
            addOption(entry.code, subTxt, false);
          }
        });
      }
    }
  });
}

function selectedValuesToCopy() {
  const list = $('#options-list');
  const selected = [...list.selectedOptions].map(o => o.textContent).filter(Boolean);
  const secHead = $('#include-headers').checked ? (State.current + ':') : null;
  const lines = [];
  if (secHead) lines.push(secHead);
  lines.push(...selected);
  return lines.join(';\n');
}

function exportSectionToJson(sectionName) {
  const items = (State.sections[sectionName] || []);
  const arr = items
    .filter(it => it && it.type === 'item' && it.code)
    .map(it => ({
      code: it.code,
      label: it.label,
      subcategories: it.subcategories || []
    }));
  return JSON.stringify(arr, null, 2);
}

// ------------------------------
// Events
// ------------------------------
$('#section-select').addEventListener('change', e => {
  State.current = e.target.value;
  buildOptionsForCurrent($('#filter').value);
  $('#json-output').value = exportSectionToJson(State.current);
});

$('#filter').addEventListener('input', e => {
  buildOptionsForCurrent(e.target.value);
});

$('#btn-select-all').addEventListener('click', () => {
  const list = $('#options-list');
  [...list.options].forEach(o => { if (!o.disabled) o.selected = true; });
  $('#output').value = selectedValuesToCopy();
});

$('#btn-clear').addEventListener('click', () => {
  const list = $('#options-list');
  [...list.options].forEach(o => o.selected = false);
  $('#output').value = '';
});

$('#btn-rebuild').addEventListener('click', () => {
  $('#output').value = selectedValuesToCopy();
});

$('#btn-copy').addEventListener('click', async () => {
  const text = $('#output').value || selectedValuesToCopy();
  try { await navigator.clipboard.writeText(text); } catch {}
});

$('#btn-json-copy').addEventListener('click', async () => {
  const text = $('#json-output').value;
  try { await navigator.clipboard.writeText(text); } catch {}
});

// Advanced/editor actions
$('#btn-load-remote').addEventListener('click', async () => {
  try {
    const txt = await fetchTxt('options.txt');
    $('#txt-editor').value = txt;
  } catch (e) {
    $('#txt-editor').value = `Error: ${e.message}`;
  }
});

$('#btn-apply-local').addEventListener('click', () => {
  const local = $('#txt-editor').value || '';
  try {
    const parsed = parseOptionsText(local);
    State.sections = parsed;
    State.current = Object.keys(parsed)[0] || null;
    populateSectionDropdown();
    buildOptionsForCurrent($('#filter').value);
    $('#json-output').value = exportSectionToJson(State.current);
    $('#parsed-preview').value = JSON.stringify(parsed, null, 2);
  } catch (e) {
    $('#parsed-preview').value = `Parse error: ${e.message}`;
  }
});

$('#btn-reset').addEventListener('click', async () => {
  await init(); // reload from remote
  $('#txt-editor').value = State.rawTxt;
  $('#parsed-preview').value = '';
});

// ------------------------------
// Boot
// ------------------------------
async function init() {
  const txt = await fetchTxt('options.txt').catch(()=>'');
  if (txt) {
    State.rawTxt = txt;
    State.sections = parseOptionsText(txt);
  } else {
    // Minimal fallback so the UI still loads
    const fallback = `Customer Needs:
[Water & Hot Water]
CN01|Better water pressure
CN02|Faster hot water delivery`;
    State.rawTxt = fallback;
    State.sections = parseOptionsText(fallback);
  }
  State.current = Object.keys(State.sections)[0] || null;
  populateSectionDropdown();
  buildOptionsForCurrent('');
  $('#json-output').value = exportSectionToJson(State.current);
}
init();
</script>
</body>
</html>