<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Depot Notes Picker — Rebuild</title>
<style>
  :root {
    --bg: #0f1115;
    --panel: #151823;
    --muted: #8b95a7;
    --text: #e6eaf2;
    --accent: #6aa7ff;
    --ok: #2bb673;
    --warn: #ffb84d;
    --danger: #ff6a6a;
    --border: #242a38;
    --chip: #1e2332;
    --input: #0f1320;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: linear-gradient(180deg, #0c0f16, #0f1115 140px);
    color: var(--text);
  }
  header {
    padding: 16px clamp(12px, 2vw, 24px);
    border-bottom: 1px solid var(--border);
    background: #0f1115a8;
    backdrop-filter: blur(6px);
    position: sticky; top: 0; z-index: 5;
  }
  header h1 {
    margin: 0 0 8px 0; font-size: 20px; letter-spacing: .2px;
  }
  header .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .pill {
    background: var(--chip); border: 1px solid var(--border);
    padding: 8px 10px; border-radius: 10px; color: var(--muted);
    font-size: 12px;
  }
  .wrap {
    display: grid;
    grid-template-columns: 1.08fr .92fr; /* left wider for 13 copy boxes */
    gap: 16px;
    padding: 16px clamp(12px, 2vw, 24px) 28px;
  }
  @media (max-width: 1100px){
    .wrap { grid-template-columns: 1fr; }
  }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
  }
  .panel h2 {
    margin: 2px 0 12px 0;
    font-size: 16px; color: #cfd6e6; letter-spacing: .2px;
  }
  .grid-left {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
  }
  @media (max-width: 1200px){ .grid-left { grid-template-columns: 1fr; } }
  .box {
    background: #0f121b;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    display: grid;
    grid-template-rows: auto auto 1fr auto;
    gap: 8px;
    min-height: 190px;
  }
  .box .title {
    font-size: 13px; font-weight: 600; color: #dfe7fb;
    display: flex; justify-content: space-between; align-items: center;
  }
  .mini {
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
  }
  .mini button, .mini select {
    background: var(--chip); color: var(--text);
    border: 1px solid var(--border); border-radius: 9px;
    padding: 6px 10px; font-size: 12px; cursor: pointer;
  }
  .mini button:hover { outline: 1px solid #2b3350; }
  textarea.copy {
    width: 100%; min-height: 110px; resize: vertical;
    background: var(--input); color: var(--text);
    border: 1px solid #21283a; border-radius: 10px;
    padding: 8px 10px; line-height: 1.45; font-size: 13px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  .right .toolbar {
    display: grid; gap: 10px;
    grid-template-columns: 1fr 1fr;
    margin-bottom: 12px;
  }
  .rowline { display: flex; gap: 10px; }
  input[type="text"], select, input[type="url"] {
    width: 100%; padding: 10px 12px; border-radius: 10px;
    border: 1px solid #21283a; background: var(--input); color: var(--text);
    font-size: 14px;
  }
  .btn {
    padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
    background: #172036; color: var(--text); cursor: pointer; font-weight: 600;
  }
  .btn.ok { background: #153222; border-color: #1f4b33; }
  .btn.warn { background: #3a2a12; border-color: #57421a; }
  .btn.danger { background: #3a1717; border-color: #5a2424; }
  .btn.accent { background: #162545; border-color: #23406e; }
  .btn:hover { filter: brightness(1.1); }
  .picker {
    background: #0f121b; border: 1px solid var(--border);
    border-radius: 12px; padding: 10px; max-height: 55vh; overflow: auto;
  }
  .item {
    display: grid; grid-template-columns: 24px 1fr; gap: 10px;
    align-items: start; padding: 8px; border-radius: 8px;
  }
  .item:hover { background: #12182a; }
  .item small { color: var(--muted); display: block; margin-top: 3px; }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip {
    font-size: 11px; padding: 3px 8px; border-radius: 100px;
    background: #1b2233; color: #c9d3ea; border: 1px solid #2a3450;
  }
  .footer {
    display: grid; gap: 10px; grid-template-columns: 1fr auto;
    margin-top: 12px; align-items: center;
  }
  .final-box textarea { min-height: 160px; }
  .hint { color: var(--muted); font-size: 12px; }
  .small { font-size: 12px; color: var(--muted); }
  .kbd {
    background: #0c1220; border: 1px solid #1e2843; border-bottom-color: #0a0e1a;
    padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    font-size: 12px; color: #cdd8f2;
  }
</style>
</head>
<body>
<header>
  <h1>Depot Notes Picker — Section Copy Boxes (Left) • Picker (Right)</h1>
  <div class="row">
    <span class="pill">Tip: filter (<span class="kbd">/</span>), add to current section (<span class="kbd">Enter</span>), copy section (<span class="kbd">⌘/Ctrl+C</span> in box)</span>
    <span class="pill">Autosaves to your browser (localStorage)</span>
    <span class="pill">Output uses <strong>semicolon+newline</strong> formatting</span>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: 13 per-section copy boxes -->
  <section class="panel">
    <h2>Section Copy Boxes</h2>
    <div id="boxes" class="grid-left"></div>
  </section>

  <!-- RIGHT: picker + controls -->
  <aside class="panel right">
    <h2>Picker & Controls</h2>
    <div class="toolbar">
      <div class="rowline">
        <select id="targetSection"></select>
        <button class="btn accent" id="btnAdd">Add selected → section</button>
      </div>
      <div class="rowline">
        <input id="search" type="text" placeholder="Search phrases… (press / to focus)" />
        <select id="category"></select>
      </div>
    </div>

    <div class="rowline" style="margin-bottom:10px;">
      <button class="btn" id="btnSelectVisible">Select all (visible)</button>
      <button class="btn" id="btnClearSelection">Clear selection</button>
      <button class="btn ok" id="btnQuickAdd">Quick-add custom line</button>
    </div>

    <div id="picker" class="picker" aria-label="Options Picker"></div>

    <div class="footer">
      <div class="small">Manage option source</div>
      <div class="rowline">
        <button class="btn" id="btnLoadBuiltin">Load built-in options</button>
        <button class="btn" id="btnPasteJSON">Paste JSON…</button>
        <input id="jsonUrl" type="url" placeholder="Load JSON from URL (GitHub raw, etc.)" />
        <button class="btn" id="btnFetchURL">Fetch</button>
      </div>
    </div>

    <div class="panel final-box" style="margin-top:14px;">
      <h2>Final Copy (All Sections → with LLM instruction)</h2>
      <div class="rowline" style="margin-bottom:8px;">
        <button class="btn ok" id="btnBuildFinal">Build Final</button>
        <button class="btn" id="btnCopyFinal">Copy Final</button>
        <button class="btn warn" id="btnClearAll">Clear ALL Sections</button>
      </div>
      <textarea id="finalOut" class="copy" placeholder="Click ‘Build Final’ to compile everything…"></textarea>
      <p class="hint">This compiles each section with headers and semicolon-separated lines, followed by a short instruction for an LLM to draft a readable customer summary letter (≤ 2 pages A4).</p>
    </div>

  </aside>
</div>

<script>
/* =========================
   CONFIG & SECTION SETUP
   ========================= */
const SECTION_LIST = [
  'Needs',
  'Working at heights',
  'System characteristics',
  'Components that require assistance',
  'Restrictions to work',
  'External hazards',
  'Delivery notes',
  'Office notes',
  'New boiler and controls',
  'Flue',
  'Pipe work',
  'Disruption',
  'Customer actions'
];

// localStorage keys
const LS_PREFIX = 'depotPickerV2';
const keyBox = s => `${LS_PREFIX}:box:${s}`;
const keyOptions = `${LS_PREFIX}:options`;
const keyTarget = `${LS_PREFIX}:target`;

// Default options (starter set). Structure: { items:[ {text, category, tags[]} ] }
const BUILTIN = {
  items: [
    // Needs
    { text: 'Customer requires reliable heating and hot water year-round', category: 'Needs', tags:['priority'] },
    { text: 'Minimise downtime during switchover', category: 'Needs' },
    { text: 'Keep system serviceable and compliant', category: 'Needs' },

    // WAH
    { text: 'Access to flue requires steps only (no ladders)', category: 'Working at heights', tags:['access'] },
    { text: 'Roof access not required', category: 'Working at heights' },
    { text: 'No scaffold required', category: 'Working at heights' },

    // System characteristics
    { text: 'Existing system: regular boiler with cylinder (open-vented)', category: 'System characteristics', tags:['existing'] },
    { text: 'Pressurisation to be sealed (expansion vessel)', category: 'System characteristics' },
    { text: 'Primary circuit fully pumped', category: 'System characteristics' },

    // Components require assistance
    { text: 'Double-handed delivery for boiler/cylinder', category: 'Components that require assistance', tags:['delivery'] },
    { text: 'Large cylinder manoeuvre assistance', category: 'Components that require assistance' },

    // Restrictions
    { text: 'Work areas to be cleared by customer prior to installation', category: 'Restrictions to work' },
    { text: 'Limited space around current boiler location', category: 'Restrictions to work' },

    // External hazards
    { text: 'No overhead power lines near roof work', category: 'External hazards' },
    { text: 'Pets on site; ensure doors/gates remain closed', category: 'External hazards' },

    // Delivery
    { text: 'Delivery to garage; stairs involved', category: 'Delivery notes' },
    { text: 'On-road parking available', category: 'Delivery notes' },

    // Office
    { text: 'Record model/serial numbers post-install', category: 'Office notes' },
    { text: 'Warranty registration required', category: 'Office notes', tags:['admin'] },

    // New boiler & controls
    { text: 'New boiler: Worcester 8000 (system) with Hive controls', category: 'New boiler and controls', tags:['controls'] },
    { text: 'Commission to manufacturer spec and Benchmark', category: 'New boiler and controls' },

    // Flue
    { text: 'Replace existing flue; ensure terminal clearances (include plume kit if needed)', category: 'Flue', tags:['mandatory'] },
    { text: 'Rear flue with plume kit to clear opening/conservatory', category: 'Flue' },

    // Pipe work
    { text: 'Gas run reviewed; size to meet maximum input', category: 'Pipe work' },
    { text: 'Primary pipework adjustments as required for sealing', category: 'Pipe work' },

    // Disruption
    { text: 'Protect floor coverings and work surfaces', category: 'Disruption' },
    { text: 'Water/gas off during switchover period', category: 'Disruption' },

    // Customer actions
    { text: 'Customer to clear working areas before arrival', category: 'Customer actions' },
    { text: 'Provide access on agreed date/time', category: 'Customer actions' }
  ]
};

/* =========================
   STATE
   ========================= */
let OPTIONS = loadOptions();
let SELECTION = new Set(); // ids of visible->selected
let FILTER = { q: '', cat: 'All' };

/* =========================
   DOM HOOKS
   ========================= */
const boxesEl = document.getElementById('boxes');
const pickerEl = document.getElementById('picker');
const targetSel = document.getElementById('targetSection');
const searchEl = document.getElementById('search');
const categoryEl = document.getElementById('category');
const btnAdd = document.getElementById('btnAdd');
const btnQuickAdd = document.getElementById('btnQuickAdd');
const btnSelectVisible = document.getElementById('btnSelectVisible');
const btnClearSelection = document.getElementById('btnClearSelection');
const btnLoadBuiltin = document.getElementById('btnLoadBuiltin');
const btnPasteJSON = document.getElementById('btnPasteJSON');
const jsonUrlEl = document.getElementById('jsonUrl');
const btnFetchURL = document.getElementById('btnFetchURL');
const btnBuildFinal = document.getElementById('btnBuildFinal');
const btnCopyFinal = document.getElementById('btnCopyFinal');
const btnClearAll = document.getElementById('btnClearAll');
const finalOut = document.getElementById('finalOut');

/* =========================
   INIT
   ========================= */
buildBoxes();
buildTargetSelector();
buildCategoryFilter();
renderPicker();
restoreTarget();

function buildBoxes(){
  boxesEl.innerHTML = '';
  SECTION_LIST.forEach(section => {
    const box = document.createElement('div');
    box.className = 'box';
    box.dataset.section = section;

    const title = document.createElement('div');
    title.className = 'title';
    title.innerHTML = `<span>${section}</span>`;
    box.appendChild(title);

    // mini controls
    const mini = document.createElement('div');
    mini.className = 'mini';
    mini.innerHTML = `
      <button data-act="copy">Copy</button>
      <button data-act="clear">Clear</button>
      <button data-act="addLine">+ Line</button>
      <span class="small" style="margin-left:auto;">Format: <span class="kbd">item;</span> one per line</span>
    `;
    box.appendChild(mini);

    // textarea
    const ta = document.createElement('textarea');
    ta.className = 'copy';
    ta.placeholder = `Add lines here… each ends with a semicolon (;) then newline`;
    ta.value = localStorage.getItem(keyBox(section)) || '';
    ta.addEventListener('input', () => {
      localStorage.setItem(keyBox(section), ta.value);
    });
    box.appendChild(ta);

    // footer: info
    const info = document.createElement('div');
    info.className = 'small';
    info.textContent = 'Tip: paste; lines here or use picker → target section to append';
    box.appendChild(info);

    // wire mini buttons
    mini.addEventListener('click', (e) => {
      const action = e.target?.dataset?.act;
      if(!action) return;
      if(action === 'copy'){
        ta.select();
        document.execCommand('copy');
      } else if (action === 'clear'){
        if(confirm(`Clear all lines in “${section}”?`)){
          ta.value = '';
          localStorage.removeItem(keyBox(section));
        }
      } else if (action === 'addLine'){
        const v = prompt('Add a line (semicolon will be added if missing):','');
        if(v && v.trim()){
          const line = ensureSemicolon(v.trim());
          appendToBox(section, line);
        }
      }
    });

    boxesEl.appendChild(box);
  });
}

function buildTargetSelector(){
  targetSel.innerHTML = '';
  SECTION_LIST.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    targetSel.appendChild(opt);
  });
  targetSel.addEventListener('change', () => {
    localStorage.setItem(keyTarget, targetSel.value);
  });
}

function restoreTarget(){
  const saved = localStorage.getItem(keyTarget);
  if(saved && SECTION_LIST.includes(saved)){
    targetSel.value = saved;
  }
}

function buildCategoryFilter(){
  const cats = ['All', ...new Set(OPTIONS.items.map(x => x.category).filter(Boolean))];
  categoryEl.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
  categoryEl.addEventListener('change', () => {
    FILTER.cat = categoryEl.value;
    renderPicker();
  });
}

/* =========================
   PICKER RENDER
   ========================= */
function renderPicker(){
  pickerEl.innerHTML = '';
  SELECTION.clear();

  const q = FILTER.q.toLowerCase();
  const cat = FILTER.cat;
  const filtered = OPTIONS.items
    .map((it, idx) => ({...it, _id: idx}))
    .filter(it => (cat === 'All' || it.category === cat))
    .filter(it => !q || (it.text.toLowerCase().includes(q) || (it.tags||[]).some(t => t.toLowerCase().includes(q))));

  if(filtered.length === 0){
    pickerEl.innerHTML = `<div class="small" style="padding:10px;">No items match your filter.</div>`;
    return;
  }

  filtered.forEach(it => {
    const row = document.createElement('label');
    row.className = 'item';
    row.innerHTML = `
      <input type="checkbox" data-id="${it._id}" />
      <div>
        <div>${escapeHTML(it.text)}</div>
        <small>
          <span class="chip">${it.category || 'Uncategorised'}</span>
          ${Array.isArray(it.tags)? it.tags.map(t => `<span class="chip">${escapeHTML(t)}</span>`).join('') : ''}
        </small>
      </div>
    `;
    const cb = row.querySelector('input[type=checkbox]');
    cb.addEventListener('change', () => {
      if(cb.checked) SELECTION.add(it._id); else SELECTION.delete(it._id);
    });
    pickerEl.appendChild(row);
  });
}

/* =========================
   EVENTS
   ========================= */
searchEl.addEventListener('input', () => {
  FILTER.q = searchEl.value.trim();
  renderPicker();
});
document.addEventListener('keydown', (e) => {
  if(e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)){
    e.preventDefault(); searchEl.focus();
  }
  if(e.key === 'Enter' && document.activeElement !== searchEl){
    e.preventDefault(); addSelectedToTarget();
  }
});

btnAdd.addEventListener('click', addSelectedToTarget);

btnSelectVisible.addEventListener('click', () => {
  const cbs = pickerEl.querySelectorAll('input[type=checkbox]');
  cbs.forEach(cb => { cb.checked = true; cb.dispatchEvent(new Event('change')); });
});

btnClearSelection.addEventListener('click', () => {
  const cbs = pickerEl.querySelectorAll('input[type=checkbox]');
  cbs.forEach(cb => { cb.checked = false; cb.dispatchEvent(new Event('change')); });
});

btnQuickAdd.addEventListener('click', () => {
  const v = prompt(`Quick-add to “${targetSel.value}”:\n(semicolon will be added if missing)`);
  if(v && v.trim()){
    appendToBox(targetSel.value, ensureSemicolon(v.trim()));
  }
});

btnLoadBuiltin.addEventListener('click', () => {
  if(!confirm('Replace current options with the built-in starter set?')) return;
  OPTIONS = JSON.parse(JSON.stringify(BUILTIN));
  persistOptions();
  buildCategoryFilter();
  renderPicker();
});

btnPasteJSON.addEventListener('click', () => {
  const v = prompt('Paste JSON with shape: { "items": [ { "text": "...", "category": "Flue", "tags": ["..."] }, ... ] }','');
  if(!v) return;
  try{
    const obj = JSON.parse(v);
    if(!obj || !Array.isArray(obj.items)) throw new Error('Missing items[]');
    OPTIONS = obj;
    persistOptions();
    buildCategoryFilter();
    renderPicker();
    alert('Options loaded.');
  } catch(err){
    alert('Invalid JSON: ' + err.message);
  }
});

btnFetchURL.addEventListener('click', async () => {
  const url = jsonUrlEl.value.trim();
  if(!url) { alert('Enter a JSON URL first.'); return; }
  try{
    const res = await fetch(url, {cache:'no-cache'});
    if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const obj = await res.json();
    if(!obj || !Array.isArray(obj.items)) throw new Error('JSON must include items[]');
    OPTIONS = obj;
    persistOptions();
    buildCategoryFilter();
    renderPicker();
    alert('Options fetched and loaded.');
  } catch(err){
    alert('Fetch failed: ' + err.message);
  }
});

btnBuildFinal.addEventListener('click', () => {
  const compiled = compileAllSections();
  finalOut.value = compiled;
  finalOut.focus();
  finalOut.select();
});

btnCopyFinal.addEventListener('click', () => {
  finalOut.focus(); finalOut.select(); document.execCommand('copy');
});

btnClearAll.addEventListener('click', () => {
  if(!confirm('Clear ALL section copy boxes? This cannot be undone.')) return;
  SECTION_LIST.forEach(s => localStorage.removeItem(keyBox(s)));
  buildBoxes();
});

/* =========================
   HELPERS
   ========================= */
function addSelectedToTarget(){
  const ids = [...SELECTION];
  if(ids.length === 0){ alert('Select some picker items first.'); return; }
  const lines = ids.map(id => OPTIONS.items[id]?.text).filter(Boolean).map(ensureSemicolon);
  appendToBox(targetSel.value, lines.join('\n'));
  // clear selection after add
  btnClearSelection.click();
}

function appendToBox(section, text){
  const ta = findBox(section);
  if(!ta) return;
  const cur = ta.value.trim();
  ta.value = (cur ? (cur + '\n') : '') + text;
  localStorage.setItem(keyBox(section), ta.value);
  // small visual nudge
  ta.style.outline = '2px solid #2b7bff';
  setTimeout(()=> ta.style.outline='none', 350);
}

function findBox(section){
  const box = boxesEl.querySelector(`.box[data-section="${cssEscape(section)}"]`);
  return box?.querySelector('textarea.copy') || null;
}

function ensureSemicolon(s){
  return s.endsWith(';') ? s : s + ';';
}

function compileAllSections(){
  const blocks = SECTION_LIST.map(sec => {
    const ta = findBox(sec);
    const raw = (ta?.value || '').trim();
    if(!raw) return null;
    const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const pretty = lines.join('\n');
    return `### ${sec}\n${pretty}`;
  }).filter(Boolean);

  const instruction = [
    '***',
    'INSTRUCTION FOR LLM:',
    'Using the notes above (by section), draft a customer-friendly summary letter in clear UK English.',
    'Keep it professional, warm, and concise. Explain the rationale for key works (e.g., flue replacement is mandatory, sealing the system, gas pipe sizing checks).',
    'Avoid boilerplate; remove internal jargon. Use headings sparingly. Do not exceed two A4 pages.',
    'If information is missing or uncertain, state this plainly and suggest how it will be confirmed.',
    '***'
  ].join('\n');

  return blocks.join('\n\n') + (blocks.length ? '\n\n' : '') + instruction + '\n';
}

function loadOptions(){
  try{
    const raw = localStorage.getItem(keyOptions);
    if(!raw) return JSON.parse(JSON.stringify(BUILTIN));
    const obj = JSON.parse(raw);
    if(!obj || !Array.isArray(obj.items)) throw 0;
    return obj;
  }catch{ return JSON.parse(JSON.stringify(BUILTIN)); }
}

function persistOptions(){
  localStorage.setItem(keyOptions, JSON.stringify(OPTIONS));
}

function escapeHTML(s){
  return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

// css.escape polyfill-ish (minimal)
function cssEscape(s){ return s.replace(/["\\]/g, '\\$&'); }
</script>
</body>
</html>