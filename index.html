<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Depot Notes Picker (Dynamic)</title>
<style>
  :root { --gap: 10px; --pad: 12px; --radius: 10px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#f6f7fb; color:#1f2937;}
  header { display:flex; gap:var(--gap); align-items:center; padding:16px var(--pad); background:#fff; position:sticky; top:0; z-index:5; border-bottom:1px solid #e5e7eb;}
  .badge { background:#eef2ff; color:#4338ca; padding:2px 8px; border-radius:999px; font-size:12px; }
  main { display:grid; grid-template-columns: 1.2fr 1fr; gap:var(--gap); padding:var(--pad); }
  @media (max-width: 980px){ main { grid-template-columns: 1fr; } }
  section { background:#fff; border-radius:var(--radius); padding:var(--pad); box-shadow:0 1px 2px rgba(0,0,0,.05); }
  h2 { margin:0 0 6px 0; font-size:18px; }
  .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
  select, input[type="text"], textarea, button {
    font: inherit; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;
  }
  select, input[type="text"] { min-height:40px; }
  button { background:#e5e7eb; cursor:pointer; border-color:#c8ccd1; }
  button.primary { background:#2563eb; color:#fff; border-color:#1d4ed8; }
  button.ghost { background:#fff; }
  button:disabled{opacity:.5; cursor:not-allowed;}
  .pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#374151; }
  .toolbar { display:flex; gap:var(--gap); align-items:center; margin:var(--gap) 0; flex-wrap:wrap;}
  .list { display:grid; gap:6px; max-height:55vh; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px;}
  .item { display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:start; padding:6px; border-radius:8px; }
  .item:hover{ background:#f9fafb; }
  .muted{ color:#6b7280; }
  .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .space { flex:1; }
  textarea { width:100%; min-height:160px; }
  .hint { font-size:12px; color:#6b7280; }
  .divider { height:1px; background:#e5e7eb; margin:8px 0; }
</style>
</head>
<body>
  <header>
    <strong>Depot Notes Picker</strong>
    <span class="badge" id="buildTag">dynamic</span>
    <span class="hint" id="metaInfo"></span>
    <span class="space"></span>
    <button class="ghost" id="resetBtn">Reset (clear storage)</button>
  </header>

  <main>
    <!-- LEFT: Picker -->
    <section>
      <h2>Picker & Controls</h2>

      <div class="toolbar">
        <label>Section</label>
        <select id="sectionSelect"></select>

        <input type="text" id="filterBox" placeholder="Filter (press / to focus)" />
        <button id="selectVisibleBtn">Select all (visible)</button>
        <button id="clearSelectionBtn">Clear selection</button>
      </div>

      <div id="itemsList" class="list" aria-label="items list"></div>

      <div class="divider"></div>

      <div class="row">
        <input type="text" id="quickAddText" placeholder="Quick-add custom line" style="flex:1">
        <button id="quickAddBtn" class="ghost">Add</button>
      </div>
    </section>

    <!-- RIGHT: Output -->
    <section>
      <h2>Final Copy (All Sections → with LLM)</h2>
      <div class="row">
        <span class="pill" id="countBadge">0 selected</span>
        <span class="space"></span>
        <button id="copyBtn" class="primary">Copy ;-lines</button>
      </div>
      <textarea id="copyBox" readonly placeholder="Your selected lines will appear here…"></textarea>

      <h3>Selected (live)</h3>
      <div id="selectedList" class="list"></div>
      <div class="hint">Output format: <code>semicolon + newline</code></div>
    </section>
  </main>

<script>
/* ========= Options Loader (robust, dynamic sections) ========= */

const STORAGE_KEY = 'dnp_state_v1';
const OPTIONS_URL = './Options.txt';

const state = {
  sections: {},         // { SectionName: [ {code,category,text,section} ] }
  selected: [],         // array of items
  filter: '',
  currentSection: 'All'
};

function saveState(){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({
    selected: state.selected
  })); } catch(e){}
}
function loadState(){
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    state.selected = Array.isArray(s.selected) ? s.selected : [];
  } catch(e){}
}

function normaliseText(s){
  return (s || '').replace(/[–—]/g,'-').trim();
}

function parseOptionsText(text){
  let t = text.replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
  const lines = t.split('\n');

  const sections = {};
  let current = null;
  const headerRe = /^\s*\[([^\]]+)\]\s*$/;

  for (const raw of lines){
    const line = normaliseText(raw);
    if (!line) continue;
    if (line.startsWith('#') || line.startsWith('//')) continue;

    const hm = line.match(headerRe);
    if (hm){
      // Canonicalize header label (keep user’s text)
      current = hm[1].trim();
      if (!sections[current]) sections[current] = [];
      continue;
    }

    if (!current) continue; // ignore until first [header]

    // Expect: CODE | Category | Description   (tolerate 2 parts)
    const parts = line.split('|').map(s => s.trim());
    if (!parts.length) continue;

    let code='', category='', textOut='';
    if (parts.length === 1){
      textOut = parts[0];
    } else if (parts.length === 2){
      code = parts[0]; textOut = parts[1];
    } else {
      code = parts[0]; category = parts[1]; textOut = parts.slice(2).join(' | ');
    }

    if (textOut){
      sections[current].push({ code, category, text: textOut, section: current });
    }
  }
  return sections;
}

async function loadOptions(url){
  const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'nocache=' + Date.now());
  const raw = await res.text();
  return parseOptionsText(raw);
}

/* ========= UI Renderers ========= */

function populateSectionDropdown(){
  const sel = document.getElementById('sectionSelect');
  sel.innerHTML = '';

  const optAll = document.createElement('option');
  optAll.value = 'All'; optAll.textContent = 'All';
  sel.appendChild(optAll);

  Object.keys(state.sections).sort((a,b)=>a.localeCompare(b)).forEach(name=>{
    const o = document.createElement('option');
    o.value = name; o.textContent = name;
    sel.appendChild(o);
  });

  sel.value = state.currentSection;
}

function renderItems(){
  const list = document.getElementById('itemsList');
  list.innerHTML = '';

  const filter = state.filter.toLowerCase();
  let items = [];

  if (state.currentSection === 'All'){
    for (const k of Object.keys(state.sections)) items = items.concat(state.sections[k]);
  } else {
    items = state.sections[state.currentSection] || [];
  }

  const visible = items.filter(it=>{
    if (!filter) return true;
    const s = `${it.code} ${it.category} ${it.text} ${it.section}`.toLowerCase();
    return s.includes(filter);
  });

  if (!visible.length){
    const empty = document.createElement('div');
    empty.className = 'hint';
    empty.style.padding = '8px';
    empty.textContent = 'No items match your filter.';
    list.appendChild(empty);
    return;
  }

  for (const it of visible){
    const row = document.createElement('div'); row.className = 'item';
    const cb = document.createElement('input'); cb.type = 'checkbox';
    cb.checked = state.selected.some(s => s.code===it.code && s.text===it.text && s.section===it.section);
    cb.addEventListener('change', e=>{
      if (e.target.checked){
        state.selected.push(it);
      } else {
        const idx = state.selected.findIndex(s => s.code===it.code && s.text===it.text && s.section===it.section);
        if (idx>-1) state.selected.splice(idx,1);
      }
      updateSelected();
    });

    const label = document.createElement('div');
    label.innerHTML = `<div><strong>${it.text}</strong></div>
                       <div class="muted">${it.section}${it.category? ' • '+it.category:''}${it.code? ' • '+it.code:''}</div>`;

    row.appendChild(cb); row.appendChild(label);
    list.appendChild(row);
  }
}

function updateSelected(){
  // update list
  const wrap = document.getElementById('selectedList');
  wrap.innerHTML = '';
  state.selected.forEach((it,i)=>{
    const row = document.createElement('div'); row.className='item';
    const del = document.createElement('button'); del.className='ghost'; del.textContent='×';
    del.addEventListener('click', ()=>{
      state.selected.splice(i,1);
      updateSelected();
      renderItems();
    });
    const label = document.createElement('div');
    label.innerHTML = `<div><strong>${it.text}</strong></div><div class="muted">${it.section}${it.category? ' • '+it.category:''}${it.code? ' • '+it.code:''}</div>`;
    row.appendChild(del); row.appendChild(label); wrap.appendChild(row);
  });

  // update copy box (semicolon + newline)
  const lines = state.selected.map(it => it.text.trim().replace(/\s+/g,' ')).filter(Boolean);
  document.getElementById('copyBox').value = lines.map(s => s + ';').join('\n');

  // badge
  document.getElementById('countBadge').textContent = `${state.selected.length} selected`;

  saveState();
}

/* ========= Boot ========= */

async function boot(){
  loadState();
  const sections = await loadOptions(OPTIONS_URL);
  state.sections = sections;

  const total = Object.values(sections).reduce((n,arr)=>n+arr.length,0);
  const cats = Object.keys(sections).join(', ');
  document.getElementById('metaInfo').textContent = `Loaded ${total} items · ${Object.keys(sections).length} sections`;

  // default section
  state.currentSection = 'All';

  populateSectionDropdown();
  renderItems();
  updateSelected();

  // events
  document.getElementById('sectionSelect').addEventListener('change', e=>{
    state.currentSection = e.target.value;
    renderItems();
  });
  document.getElementById('filterBox').addEventListener('input', e=>{
    state.filter = e.target.value || '';
    renderItems();
  });
  // focus filter with /
  window.addEventListener('keydown', e=>{
    if (e.key === '/'){
      e.preventDefault(); document.getElementById('filterBox').focus();
    }
  });

  document.getElementById('selectVisibleBtn').addEventListener('click', ()=>{
    // add all currently visible
    const filter = state.filter.toLowerCase();
    let items = [];
    if (state.currentSection === 'All'){
      for (const k of Object.keys(state.sections)) items = items.concat(state.sections[k]);
    } else {
      items = state.sections[state.currentSection] || [];
    }
    const visible = items.filter(it=>{
      if (!filter) return true;
      const s = `${it.code} ${it.category} ${it.text} ${it.section}`.toLowerCase();
      return s.includes(filter);
    });
    // push unique
    visible.forEach(it=>{
      if (!state.selected.some(s => s.code===it.code && s.text===it.text && s.section===it.section)){
        state.selected.push(it);
      }
    });
    updateSelected(); renderItems();
  });

  document.getElementById('clearSelectionBtn').addEventListener('click', ()=>{
    state.selected = []; updateSelected(); renderItems();
  });

  document.getElementById('quickAddBtn').addEventListener('click', ()=>{
    const v = normaliseText(document.getElementById('quickAddText').value);
    if (!v) return;
    const it = { code:'', category:'Custom', text:v, section:'Custom' };
    state.selected.push(it); document.getElementById('quickAddText').value='';
    updateSelected();
  });

  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    const ta = document.getElementById('copyBox');
    ta.select(); ta.setSelectionRange(0, 99999);
    try { await navigator.clipboard.writeText(ta.value); } catch(e){}
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    localStorage.removeItem(STORAGE_KEY);
    location.href = location.pathname + '?reset=' + Date.now();
  });
}

boot();
</script>
</body>
</html>