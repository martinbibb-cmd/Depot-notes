<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Depot Notes — Options Picker</title>
  <style>
    :root { --bg:#0f172a; --panel:#0b1222; --muted:#93a4c8; --text:#e6ecff; --chip:#1f2b46; --accent:#9ec1ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:var(--panel);border:1px solid #1b2440;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row > *{flex:0 0 auto}
    select,input[type="text"],textarea{background:#0f1a33;border:1px solid #22305b;color:var(--text);border-radius:10px;padding:10px}
    select{min-width:240px}
    textarea{width:100%;min-height:140px;resize:vertical}
    button{background:#1a2650;border:1px solid #2a3c7a;color:#eaf1ff;padding:10px 12px;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .btn-accent{background:#21407c;border-color:#3b63b3}
    .muted{color:var(--muted);font-size:13px}
    .pill{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .list label{display:block;background:#0e1a35;border:1px solid #1e2b55;border-radius:12px;margin:6px 0;padding:10px 12px;cursor:pointer}
    .list input{transform:translateY(1px)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .grow{flex:1 1 200px}
    .titlebar{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    code{background:#0f1a33;border:1px solid #22305b;padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Depot Notes — Options loader & picker</h1>

    <!-- IMPORT: plain text (options.txt) -->
    <div class="card">
      <div class="titlebar">
        <strong>Import from plain text (Options.txt)</strong>
        <span class="muted">Format: <code>[section_key]</code> then lines like <code>CODE | Label</code>. Lines starting with <code>#</code> are comments.</span>
      </div>
      <textarea id="options-src" placeholder="[system_type]
ST-COMBI | Combi boiler
ST-SYSTEM | System (with cylinder)"></textarea>
      <div class="toolbar">
        <button id="btn-parse" class="btn-accent">Parse text → JSON</button>
        <input id="file-open" type="file" accept=".txt,text/plain" style="display:none">
        <button id="btn-open">Open .txt file…</button>
        <button id="btn-load">Load Options.txt (auto)</button>
        <span id="load-status" class="muted"></span>
      </div>
      <div class="muted">Tip: keep your master list in <strong>Options.txt</strong> (same folder as this page), or paste it above and hit “Parse”.</div>
    </div>

    <!-- PICKER -->
    <div class="card">
      <h2 style="margin:0 0 8px">Depot Notes Picker</h2>
      <div class="toolbar">
        <label class="muted">Section</label>
        <select id="section-select"></select>
        <button id="btn-next">Next section ➜</button>
        <input id="filter" class="grow" type="text" placeholder="Filter within section… (e.g., plume)">
      </div>

      <div class="toolbar">
        <button id="btn-all">Select all (visible)</button>
        <button id="btn-clear">Clear section</button>
        <span id="sel-count" class="pill">0 selected</span>
      </div>

      <div id="section-title" class="muted" style="margin:4px 0 6px"></div>
      <div id="items-list" class="list"></div>
    </div>

    <!-- COPY BOX -->
    <div class="card">
      <h3 style="margin:0 0 8px">Copy Box Output (; line breaks)</h3>
      <div class="toolbar">
        <button id="btn-copy" class="btn-accent">Copy ;-lines</button>
        <label><input id="inc-headers" type="checkbox" checked> Include section headers</label>
      </div>
      <textarea id="copy-out" placeholder="e.g., 'Needs: phrase ; phrase ; …'"></textarea>
    </div>
  </div>

  <script>
    // ---------- tiny utils ----------
    const $ = sel => document.querySelector(sel);
    function niceTitle(key){ return key.replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); }

    // ---------- state ----------
    const State = {
      db: {},                 // { section: [{code,label}] }
      order: [],              // section order
      idx: 0,                 // current section index
      selected: new Map(),    // section -> Set of code strings
    };

    // ---------- parser ----------
    function parseOptionsTxt(txt){
      const db = {}; let section = null;
      for (const raw of txt.split(/\r?\n/)){
        const line = raw.trim();
        if (!line || line.startsWith('#')) continue;
        const sec = line.match(/^\[([^\]]+)\]$/);
        if (sec){ section = sec[1].trim(); db[section] = []; continue; }
        if (!section) continue;
        const parts = line.split('|').map(s => s.trim());
if (parts.length >= 2) {
  const code = parts[0];
  const label = parts[1] || '';
  const subcategories = parts.slice(2).filter(Boolean); // NEW

  if (code) {
    db[section].push({
      code,
      label,
      subcategories: subcategories.length ? subcategories : null // NEW
    });
  }
}
      }
      return db;
    }

    // ---------- rendering ----------
    function populateSectionDropdown(){
      const sel = $('#section-select');
      sel.innerHTML = '';
      State.order.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = k;
        sel.appendChild(opt);
      });
      sel.value = State.order[State.idx] || '';
    }

    function applyFilter(text){
      $('#filter').value = text || '';
      renderCurrentSection();
    }

    function getVisibleItems(items, filterText){
      if (!filterText) return items;
      const q = filterText.trim().toLowerCase();
      return items.filter(it => it.label.toLowerCase().includes(q) || it.code.toLowerCase().includes(q));
    }

    function updateSelectedChip(){
      const key = State.order[State.idx];
      const set = State.selected.get(key) || new Set();
      $('#sel-count').textContent = `${set.size} selected`;
    }
// Render an <option> list with optional sub-items (backward compatible)
function addOptionsWithSubcategories(selectEl, items) {
  // clear existing
  while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);

  // placeholder
  const ph = document.createElement('option');
  ph.value = '';
  ph.disabled = true;
  ph.selected = true;
  ph.textContent = 'Select…';
  selectEl.appendChild(ph);

addOptionsWithSubcategories(sel, items);

    // subcategories (NEW)
    if (Array.isArray(it.subcategories) && it.subcategories.length) {
      it.subcategories.forEach(sub => {
        const subOpt = document.createElement('option');
        subOpt.value = it.code; // or `${it.code}:${sub}` for unique IDs
        subOpt.textContent = `↳ ${it.label} — ${sub}`;
        selectEl.appendChild(subOpt);
      });
    }
  });
}
    function renderCurrentSection(){
      const key = State.order[State.idx];
      const container = $('#items-list');
      const title = $('#section-title');
      title.textContent = niceTitle(key || '');

      container.innerHTML = '';
      if (!key) return;

      const items = State.db[key] || [];
      const filtered = getVisibleItems(items, $('#filter').value);

      const selectedSet = State.selected.get(key) || new Set();

      filtered.forEach(({code, label})=>{
        const row = document.createElement('label');
        row.style.display = 'block';
        row.style.margin = '6px 0';
        row.style.padding = '8px 10px';
        row.style.borderRadius = '10px';
        row.style.background = 'rgba(255,255,255,.04)';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedSet.has(code);
        cb.addEventListener('change', ()=>{
          const set = State.selected.get(key) || new Set();
          if (cb.checked) set.add(code); else set.delete(code);
          State.selected.set(key, set);
          updateSelectedChip();
          buildCopyBox(); // keep output live
        });

        const span = document.createElement('span');
        span.textContent = ' ' + label;

        row.appendChild(cb);
        row.appendChild(span);
        container.appendChild(row);
      });

      updateSelectedChip();
    }

    // ---------- copy box ----------
    function buildCopyBox(){
      const includeHeaders = $('#inc-headers').checked;
      const chunks = [];

      State.order.forEach(sec=>{
        const set = State.selected.get(sec);
        if (!set || set.size === 0) return;

        const labels = (State.db[sec]||[])
          .filter(it => set.has(it.code))
          .map(it => it.label);

        if (labels.length === 0) return;

        if (includeHeaders){
          chunks.push(`${niceTitle(sec)}: ${labels.join(' ; ')}`);
        } else {
          chunks.push(labels.join(' ; '));
        }
      });

      $('#copy-out').value = chunks.join('\n');
    }

    async function copyToClipboard(){
      buildCopyBox();
      const text = $('#copy-out').value;
      try {
        await navigator.clipboard.writeText(text);
        $('#btn-copy').textContent = 'Copied ✓';
        setTimeout(()=>{$('#btn-copy').textContent='Copy ;-lines';}, 1200);
      } catch {
        // iOS fallback: select + prompt user
        $('#copy-out').focus();
        $('#copy-out').select();
      }
    }

    // ---------- load helpers ----------
    async function fetchOptionsTxtAuto(){
      const status = $('#load-status');
      const candidates = [
        './Options.txt?v=' + Date.now(),
        './data/Options.txt?v=' + Date.now(),
        './config/Options.txt?v=' + Date.now()
      ];
      let lastErr;
      for (const url of candidates){
        try{
          status.textContent = `Trying ${url.replace(/\?.*/,'')} …`;
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const txt = await res.text();
          if (!/\[[^\]]+\]/.test(txt)) throw new Error('File does not look like Options.txt format');
          status.textContent = `Loaded from ${url.replace(/\?.*/,'')}`;
          return txt;
        }catch(e){ lastErr = e; }
      }
      status.textContent = '';
      throw lastErr || new Error('Could not find Options.txt');
    }

    function applyDatabase(db){
      State.db = db;
      State.order = Object.keys(db);
      State.idx = 0;
      State.selected = new Map(); // reset selections
      populateSectionDropdown();
      renderCurrentSection();
      buildCopyBox();
    }

    // ---------- wire UI ----------
    function wireUI(){
      $('#btn-parse').addEventListener('click', ()=>{
        const txt = $('#options-src').value || '';
        const db = parseOptionsTxt(txt);
        applyDatabase(db);
      });

      $('#btn-open').addEventListener('click', ()=>$('#file-open').click());
      $('#file-open').addEventListener('change', async (e)=>{
        const f = e.target.files[0];
        if (!f) return;
        const txt = await f.text();
        $('#options-src').value = txt;
        const db = parseOptionsTxt(txt);
        applyDatabase(db);
      });

      $('#btn-load').addEventListener('click', async ()=>{
        try{
          const txt = await fetchOptionsTxtAuto();
          $('#options-src').value = txt;      // keep a visible copy
          const db = parseOptionsTxt(txt);
          applyDatabase(db);
        }catch(e){
          alert('Could not load Options.txt — check it is next to index.html (case-sensitive). ' + e);
        }
      });

      $('#section-select').addEventListener('change', (e)=>{
        const val = e.target.value;
        const idx = State.order.indexOf(val);
        if (idx >= 0) State.idx = idx;
        renderCurrentSection();
      });

      $('#btn-next').addEventListener('click', (e)=>{
        e.preventDefault?.();
        if (State.order.length === 0) return;
        State.idx = (State.idx + 1) % State.order.length;
        $('#section-select').value = State.order[State.idx];
        renderCurrentSection();
      });

      $('#filter').addEventListener('input', ()=>renderCurrentSection());

      $('#btn-all').addEventListener('click', ()=>{
        const key = State.order[State.idx];
        const items = State.db[key] || [];
        const visible = getVisibleItems(items, $('#filter').value);
        const set = State.selected.get(key) || new Set();
        visible.forEach(({code})=> set.add(code));
        State.selected.set(key, set);
        renderCurrentSection();
        buildCopyBox();
      });

      $('#btn-clear').addEventListener('click', ()=>{
        const key = State.order[State.idx];
        State.selected.set(key, new Set());
        renderCurrentSection();
        buildCopyBox();
      });

      $('#inc-headers').addEventListener('change', buildCopyBox);
      $('#btn-copy').addEventListener('click', copyToClipboard);
    }

    // ---------- boot ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      wireUI();
      // Try to auto-load Options.txt on first load; if it fails the user can paste or open a file
      try{
        const txt = await fetchOptionsTxtAuto();
        $('#options-src').value = txt;
        applyDatabase(parseOptionsTxt(txt));
      }catch(_e){
        // silent; user can paste and press Parse
      }
    });
  </script>
</body>
</html>