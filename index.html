<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quote Tool – Inline</title>
  <style>/* Minimal UI (inline) */
:root{
  --bg:#0b0d10; --panel:#151a1f; --ink:#e9eef5; --muted:#9fb0c2; --accent:#4aa3ff; --ok:#3ecf8e; --warn:#ffc247; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1f2630;background:linear-gradient(0deg,#0b0d10,#0e1116)}
h1{margin:0;font-size:18px;}
.tag{font-size:12px;color:var(--muted);margin-left:8px;border:1px solid #243041;padding:2px 6px;border-radius:8px}
nav#steps{display:flex;gap:8px;flex-wrap:wrap}
.step{padding:6px 10px;border-radius:10px;background:#0f141a;border:1px solid #202a36;color:var(--muted);cursor:pointer}
.step.active{color:var(--ink);border-color:#2a3b50;background:#121a22}
main#view{padding:16px}
.card{background:var(--panel);border:1px solid #1f2630;border-radius:14px;padding:16px;margin-bottom:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-weight:600;margin-bottom:6px;color:#cfe0f3}
input,select,textarea{width:100%;background:#0f141a;border:1px solid #283241;color:var(--ink);padding:10px;border-radius:10px}
small.hint{color:var(--muted);display:block;margin-top:6px}
footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #1f2630;background:#0e1217;position:sticky;bottom:0}
button{background:var(--accent);border:none;color:#081018;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
button.ghost{background:transparent;color:var(--ink);border:1px solid #2a3b50}
button.copy{margin-top:8px}
.outputs{padding:16px;border-top:1px solid #1f2630}
.outputs.hidden{display:none}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid .full{grid-column:1/-1}
.kv{display:grid;grid-template-columns:200px 1fr;gap:6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #283241;color:var(--muted);margin-left:6px}
.status-pass{border-color:#2e684a;color:#88e0b1}
.status-warn{border-color:#665a2e;color:#ffd47a}
.status-fail{border-color:#6b2e2e;color:#ff9f9f}
.list{display:grid;gap:8px}
.opt{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #253043;border-radius:10px;background:#0f141a;cursor:pointer}
.opt input{width:auto}
hr{border:0;border-top:1px solid #1f2630;margin:14px 0}
.svg-wrap{background:#0f141a;border:1px solid #253043;border-radius:12px;padding:8px}
svg{width:100%;height:auto;display:block}
</style>
</head>
<body>
  <header>
    <h1>Quote Tool <span class="tag">v1</span></h1>
    <nav id="steps"></nav>
  </header>

  <main id="view"></main>

  <footer>
    <button id="prevBtn" class="ghost">◀ Back</button>
    <button id="nextBtn">Next ▶</button>
  </footer>

  <section id="outputs" class="outputs hidden">
    <h2>Outputs</h2>
    <div class="grid">
      <div>
        <label>Customer Summary</label>
        <textarea id="customerSummary" rows="10"></textarea>
        <button class="copy" data-copy="customerSummary">Copy</button>
      </div>
      <div>
        <label>Installation Notes (semicolon lines)</label>
        <textarea id="installNotes" rows="10"></textarea>
        <button class="copy" data-copy="installNotes">Copy</button>
      </div>
      <div class="full">
        <label>Skill Hours (JSON)</label>
        <textarea id="skillHours" rows="8"></textarea>
        <button class="copy" data-copy="skillHours">Copy</button>
      </div>
    </div>
  </section>

  <script>
  
const RULES = {
  boiler: {"worcester": {"4000": {"4000 24 System": {"case": {"w": 390, "h": 724, "d": 310}, "clearances": {"install": {"top": 170, "bottom": 186, "sides": 5, "front": 5}, "service": {"top": 170, "bottom": 186, "sides": 5, "front": 450}}, "rules": {"reduced_front": {"front": 450, "above": 170, "below": 186, "sides": 5}}}}, "8000": {"8000 30 System": {"case": {"w": 440, "h": 780, "d": 365}, "clearances": {"install": {"top": 200, "bottom": 200, "sides": 5, "front": 5}, "service": {"top": 200, "bottom": 200, "sides": 5, "front": 600}}, "rules": {}}}}, "vaillant": {"ecoFIT pure": {"ecoFIT pure 415": {"case": {"w": 375, "h": 602, "d": 295}, "clearances": {"install": {"top": 200, "bottom": 200, "sides": 5, "front": 5}, "service": {"top": 200, "bottom": 200, "sides": 5, "front": 600}}, "rules": {}}}}, "ideal": {"Logic System": {"Logic S24": {"case": {"w": 395, "h": 700, "d": 278}, "clearances": {"install": {"top": 150, "bottom": 150, "sides": 5, "front": 5}, "service": {"top": 150, "bottom": 150, "sides": 5, "front": 600}}, "rules": {}}}}},
  flue: {"defaults": {"horizontal": {"to_opening_mm": 300, "to_boundary_mm": 600}, "vertical": {"to_roof_mm": 300, "min_height_above_roof_mm": 300}, "rear": {"to_opening_mm": 300}, "plume": {"extra_to_opening_mm": 300, "note": "direct away from openings/pathways"}}, "equivalent_lengths": {"default_elbow_90": 1.5, "default_elbow_45": 0.75}},
  gas: {"hints": [{"kw_up_to": 24, "run_m": 10, "likely": "22 mm OK"}, {"kw_up_to": 30, "run_m": 15, "likely": "28 mm advised"}, {"kw_up_to": 35, "run_m": 30, "likely": "35 mm may be needed"}], "meters": ["U6", "U16", "MP"]}
};
// Quote Tool – thin slice
const State = {
  quote: {
    quote_id: "",
    customer: { salesforce_id:"", name:"", address:"", contact:{phone:"", email:""} },
    survey: {
      present_system: "",
      new_system: "",
      house_map: { current_location:"", new_location:"" },
      measurements_mm: { opening_width:0, opening_height:0, opening_depth:0, front_clearance:0, above_case:0, below_case:0, left_clearance:0, right_clearance:0 },
      pressures: { standing_bar:0, working_bar:0 },
      flow_test: { lpm_at_1bar:0 },
      gas: { meter_type:"", route_len_m:0, other_appliances_kw:0 },
      earthing: "",
      wah: { ladder_ok:true, flat_roof:false, scaffold_required:false },
      safety: { asbestos_present:false, notes:"" },
      photos: []
    },
    packs: { base_A:"", base_B:"", components:["boiler","flue","gas","condensate"] },
    selections: {
      boiler: { brand:"", range:"", model:"", fuel:"NG" },
      flue: { type:"", kit_codes:[] },
      gas: { pipe_diameters:{ near_boiler_mm:22 }, route:"" },
      condensate: { route:"", protection:"" },
      controls: { type:"" },
      cylinder: { type:"none", size_l:0 },
      services: []
    },
    rules: { clearance_checks:[], flue_checks:[], gas_checks:[] },
    pricing: { base_packs:[], materials:[], labour_hours:{survey:0.5, install_core:0, extras:0}, totals:{materials:0,labour:0,vat:0,grand:0} },
    outputs: { customer_summary:"", installation_notes:"", skill_hours_breakdown:[] }
  },
  rules: { boiler:null, flue:null, gas:null },
  stepIndex: 0
};

const Steps = [
  "Customer",
  "Present System",
  "Photos & Obs",
  "New System",
  "House Map",
  "Boiler",
  "Flue",
  "Gas",
  "Condensate",
  "Components",
  "Review"
];

async function boot(){
  await loadRules();
  renderSteps();
  render();
  wireNav();
  wireCopy();
}

async function loadRules(){
  const [boiler, flue, gas] = await Promise.all([
    fetch("data/rules/boiler_clearances.models.json").then(r=>r.json()),
    fetch("data/rules/flue_rules.json").then(r=>r.json()),
    fetch("data/rules/gas_rules.json").then(r=>r.json())
  ]);
  State.rules.boiler = boiler;
  State.rules.flue = flue;
  State.rules.gas = gas;
}

function renderSteps(){
  const nav = document.getElementById("steps");
  nav.innerHTML = Steps.map((s,i)=>`<span class="step ${i===State.stepIndex?'active':''}">${i+1}. ${s}</span>`).join("");
}

function render(){
  const v = document.getElementById("view");
  const i = State.stepIndex;
  renderSteps();
  document.getElementById("prevBtn").disabled = i===0;
  document.getElementById("nextBtn").textContent = i===Steps.length-1 ? "Generate ▶" : "Next ▶";

  const Q = State.quote;
  switch(Steps[i]){
    case "Customer":
      v.innerHTML = `
      <div class="card">
        <h2>Customer</h2>
        <div class="row">
          <div><label>Salesforce ID</label><input id="sfid" value="${Q.customer.salesforce_id}"></div>
          <div><label>Quote ID</label><input id="qid" value="${Q.quote_id}"></div>
          <div><label>Name</label><input id="cname" value="${Q.customer.name}"></div>
          <div><label>Email</label><input id="cemail" value="${Q.customer.contact.email}"></div>
          <div class="full"><label>Address</label><input id="caddr" value="${Q.customer.address}"></div>
        </div>
        <small class="hint">Later: wire to Salesforce search.</small>
      </div>`;
      break;
    case "Present System":
      v.innerHTML = `
      <div class="card">
        <h2>Present boiler/system</h2>
        <div class="list">
          ${["regular","system","combi","warm_air","storage_combi","none"].map(val => optRadio("present_system", val, Q.survey.present_system)).join("")}
        </div>
        <small class="hint">Selecting sets Base Pack A.</small>
      </div>`;
      break;
    case "Photos & Obs":
      v.innerHTML = `
      <div class="card">
        <h2>Photos & Observations</h2>
        <div class="row">
          <div><label>Standing pressure (bar)</label><input id="standing_bar" type="number" step="0.1" value="${Q.survey.pressures.standing_bar}"></div>
          <div><label>Working pressure (bar)</label><input id="working_bar" type="number" step="0.1" value="${Q.survey.pressures.working_bar}"></div>
          <div><label>Flow test @ 1 bar (L/min)</label><input id="flow_lpm" type="number" step="0.1" value="${Q.survey.flow_test.lpm_at_1bar}"></div>
          <div><label>Earthing</label><select id="earthing">
            ${["","TN-S","TN-C-S","TT","unknown"].map(v=>`<option ${sel(v,Q.survey.earthing)}>${v}</option>`).join("")}
          </select></div>
          <div class="full"><label>Safety notes</label><input id="safety_notes" value="${Q.survey.safety.notes}"></div>
        </div>
      </div>`;
      break;
    case "New System":
      v.innerHTML = `
      <div class="card">
        <h2>New system</h2>
        <div class="list">
          ${["regular","system","combi"].map(val => optRadio("new_system", val, Q.survey.new_system)).join("")}
        </div>
        <small class="hint">Selecting sets Base Pack B.</small>
      </div>`;
      break;
    case "House Map":
      v.innerHTML = `
      <div class="card">
        <h2>House locations</h2>
        <div class="row">
          <div>
            <label>Current location</label>
            <select id="loc_cur">${locOpts(Q.survey.house_map.current_location)}</select>
          </div>
          <div>
            <label>New location</label>
            <select id="loc_new">${locOpts(Q.survey.house_map.new_location)}</select>
          </div>
        </div>
        <hr/>
        <div class="row">
          <div><label>Front clearance (mm)</label><input id="front_clearance" type="number" value="${Q.survey.measurements_mm.front_clearance}"></div>
          <div><label>Above case (mm)</label><input id="above_case" type="number" value="${Q.survey.measurements_mm.above_case}"></div>
          <div><label>Below case (mm)</label><input id="below_case" type="number" value="${Q.survey.measurements_mm.below_case}"></div>
          <div><label>Left clearance (mm)</label><input id="left_clr" type="number" value="${Q.survey.measurements_mm.left_clearance}"></div>
          <div><label>Right clearance (mm)</label><input id="right_clr" type="number" value="${Q.survey.measurements_mm.right_clearance}"></div>
        </div>
        <small class="hint">Later: interactive SVG with hotspots.</small>
      </div>`;
      break;
    case "Boiler":
      v.innerHTML = `
      <div class="card">
        <h2>Boiler selection</h2>
        <div class="row">
          <div><label>Brand</label><select id="b_brand">${brandOpts(Q.selections.boiler.brand)}</select></div>
          <div><label>Range</label><select id="b_range">${rangeOpts(Q.selections.boiler.brand,Q.selections.boiler.range)}</select></div>
          <div class="full"><label>Model</label><select id="b_model">${modelOpts(Q.selections.boiler.brand,Q.selections.boiler.range,Q.selections.boiler.model)}</select></div>
        </div>
        <div id="clearancePanel"></div>
      </div>`;
      setTimeout(()=>showClearances(),0);
      break;
    case "Flue":
      v.innerHTML = `
      <div class="card">
        <h2>Flue</h2>
        <div class="row">
          <div><label>Type</label>
            <select id="flue_type">
              ${["","horizontal","vertical","rear","plume"].map(v=>`<option ${sel(v,Q.selections.flue.type)}>${v}</option>`).join("")}
            </select>
          </div>
          <div class="full"><small class="hint">Heat-map overlay to come; rules evaluated from DTG defaults + brand specifics.</small></div>
        </div>
        <div id="fluePanel"></div>
      </div>`;
      setTimeout(()=>showFlueRules(),0);
      break;
    case "Gas":
      v.innerHTML = `
      <div class="card">
        <h2>Gas</h2>
        <div class="row">
          <div><label>Meter type</label><select id="meter">
            ${["","U6","U16","MP"].map(v=>`<option ${sel(v,Q.survey.gas.meter_type)}>${v}</option>`).join("")}
          </select></div>
          <div><label>Route length (m)</label><input id="route_m" type="number" step="0.1" value="${Q.survey.gas.route_len_m}"></div>
          <div><label>Other appliances (kW)</label><input id="other_kw" type="number" step="0.1" value="${Q.survey.gas.other_appliances_kw}"></div>
        </div>
        <div id="gasPanel"></div>
      </div>`;
      setTimeout(()=>showGasRules(),0);
      break;
    case "Condensate":
      v.innerHTML = `
      <div class="card">
        <h2>Condensate</h2>
        <div class="row">
          <div><label>Route</label><select id="cond_route">
            ${["","internal","external"].map(v=>`<option ${sel(v,Q.selections.condensate.route)}>${v}</option>`).join("")}
          </select></div>
          <div><label>Frost protection</label><select id="cond_prot">
            ${["","yes","no"].map(v=>`<option ${sel(v,Q.selections.condensate.protection)}>${v}</option>`).join("")}
          </select></div>
        </div>
        <small class="hint">DTG external protection rules to be enforced in evaluator.</small>
      </div>`;
      break;
    case "Components":
      v.innerHTML = `
      <div class="card">
        <h2>Components & Services</h2>
        <div class="list">
          ${["powerflush","filter_install","controls_hive","controls_onboard","cylinder_unvented","cylinder_vented"].map(k=>optCheck("svc_",k, Q.selections.services.includes(k))).join("")}
        </div>
      </div>`;
      break;
    case "Review":
      v.innerHTML = `
      <div class="card">
        <h2>Review & Submit</h2>
        <div class="kv">
          <div>Present system</div><div>${Q.survey.present_system || "-"}</div>
          <div>New system</div><div>${Q.survey.new_system || "-"}</div>
          <div>Boiler</div><div>${[Q.selections.boiler.brand,Q.selections.boiler.range,Q.selections.boiler.model].filter(Boolean).join(" / ") || "-"}</div>
          <div>Flue</div><div>${Q.selections.flue.type || "-"}</div>
          <div>Gas meter</div><div>${Q.survey.gas.meter_type || "-"}</div>
          <div>Condensate</div><div>${Q.selections.condensate.route || "-"}</div>
        </div>
        <button id="generate">Generate outputs</button>
      </div>`;
      setTimeout(()=>{
        document.getElementById("generate").addEventListener("click", generateOutputs);
      },0);
      break;
  }
  wireInputs();
}

function optRadio(name, val, current){
  return `<label class="opt"><input type="radio" name="${name}" value="${val}" ${current===val?"checked":""}> ${val}</label>`;
}
function optCheck(prefix, val, checked){
  return `<label class="opt"><input type="checkbox" data-k="${prefix+val}" ${checked?"checked":""}> ${val}</label>`;
}
function sel(v,c){ return v===c ? "selected":""; }
function locOpts(cur){
  const opts=["","garage","kitchen","loft","cupboard","other"];
  return opts.map(v=>`<option ${sel(v,cur)}>${v}</option>`).join("");
}
function brandOpts(cur){
  const brands=["","worcester","vaillant","ideal"];
  return brands.map(v=>`<option ${sel(v,cur)}>${v}</option>`).join("");
}
function rangeOpts(brand, cur){
  const data = State.rules.boiler || {};
  const ranges = Object.keys((data[brand]||{}));
  return ["",...ranges].map(v=>`<option ${sel(v,cur)}>${v}</option>`).join("");
}
function modelOpts(brand, range, cur){
  const data = State.rules.boiler || {};
  const models = Object.keys(((data[brand]||{})[range]||{}));
  return ["",...models].map(v=>`<option ${sel(v,cur)}>${v}</option>`).join("");
}

function wireInputs(){
  const v = document.getElementById("view");
  v.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("change", ()=>{
      const Q = State.quote;
      switch(el.id){
        case "sfid": Q.customer.salesforce_id = el.value.trim(); break;
        case "qid": Q.quote_id = el.value.trim(); break;
        case "cname": Q.customer.name = el.value.trim(); break;
        case "cemail": Q.customer.contact.email = el.value.trim(); break;
        case "caddr": Q.customer.address = el.value.trim(); break;
        case "standing_bar": Q.survey.pressures.standing_bar = +el.value; break;
        case "working_bar": Q.survey.pressures.working_bar = +el.value; break;
        case "flow_lpm": Q.survey.flow_test.lpm_at_1bar = +el.value; break;
        case "earthing": Q.survey.earthing = el.value; break;
        case "safety_notes": Q.survey.safety.notes = el.value; break;
        case "loc_cur": Q.survey.house_map.current_location = el.value; break;
        case "loc_new": Q.survey.house_map.new_location = el.value; break;
        case "front_clearance": Q.survey.measurements_mm.front_clearance = +el.value; break;
        case "above_case": Q.survey.measurements_mm.above_case = +el.value; break;
        case "below_case": Q.survey.measurements_mm.below_case = +el.value; break;
        case "left_clr": Q.survey.measurements_mm.left_clearance = +el.value; break;
        case "right_clr": Q.survey.measurements_mm.right_clearance = +el.value; break;
        case "b_brand": Q.selections.boiler.brand = el.value; Q.selections.boiler.range=""; Q.selections.boiler.model=""; render(); break;
        case "b_range": Q.selections.boiler.range = el.value; Q.selections.boiler.model=""; render(); break;
        case "b_model": Q.selections.boiler.model = el.value; showClearances(); break;
        case "flue_type": Q.selections.flue.type = el.value; showFlueRules(); break;
        case "meter": Q.survey.gas.meter_type = el.value; showGasRules(); break;
        case "route_m": Q.survey.gas.route_len_m = +el.value; showGasRules(); break;
        case "other_kw": Q.survey.gas.other_appliances_kw = +el.value; showGasRules(); break;
        case "cond_route": Q.selections.condensate.route = el.value; break;
        case "cond_prot": Q.selections.condensate.protection = el.value; break;
      }
    });
  });
  // radios
  v.querySelectorAll('input[type="radio"]').forEach(el=>{
    el.addEventListener("change", ()=>{
      const Q = State.quote;
      if(el.name==="present_system"){ Q.survey.present_system = el.value; Q.packs.base_A = el.value; }
      if(el.name==="new_system"){ Q.survey.new_system = el.value; Q.packs.base_B = el.value; }
    });
  });
  // component services checkboxes
  v.querySelectorAll('input[type="checkbox"][data-k^="svc_"]').forEach(el=>{
    el.addEventListener("change", ()=>{
      const key = el.getAttribute("data-k").replace("svc_","");
      const arr = State.quote.selections.services;
      if(el.checked && !arr.includes(key)) arr.push(key);
      if(!el.checked) State.quote.selections.services = arr.filter(x=>x!==key);
    });
  });
}

function wireNav(){
  document.getElementById("prevBtn").addEventListener("click", ()=>{
    if(State.stepIndex>0){ State.stepIndex--; render(); }
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    if(State.stepIndex < Steps.length-1){ State.stepIndex++; render(); }
    else { generateOutputs(); }
  });
}

function wireCopy(){
  document.body.addEventListener("click", (e)=>{
    const btn = e.target.closest("button.copy");
    if(!btn) return;
    const id = btn.getAttribute("data-copy");
    const ta = document.getElementById(id);
    ta.select(); document.execCommand("copy");
    btn.textContent = "Copied ✔";
    setTimeout(()=>btn.textContent="Copy",1000);
  });
}

function showClearances(){
  const Q = State.quote;
  const panel = document.getElementById("clearancePanel");
  if(!panel) return;
  const model = lookupModel(Q.selections.boiler);
  if(!model){ panel.innerHTML = `<small class="hint">Pick brand, range, and model.</small>`; return; }
  const m = model;
  const dims = `<div class="badge">Case ${m.case.w}×${m.case.h}×${m.case.d} mm</div>`;
  const inst = m.clearances.install;
  const serv = m.clearances.service;
  const checks = evalClearances(m, Q.survey.measurements_mm);
  panel.innerHTML = `
    <hr/>
    <div>Install: top ${inst.top} / bottom ${inst.bottom} / sides ${inst.sides} / front ${inst.front} mm ${dims}</div>
    <div>Service: top ${serv.top} / bottom ${serv.bottom} / sides ${serv.sides} / front ${serv.front} mm</div>
    <div>Reduced front rule: ${m.rules?.reduced_front ? "available" : "n/a"}</div>
    <div class="list">${checks.map(c=>`<span class="badge status-${c.status}">${c.rule_id} → ${c.status}</span>`).join(" ")}</div>
  `;
  State.quote.rules.clearance_checks = checks;
}

function showFlueRules(){
  const Q = State.quote;
  const p = document.getElementById("fluePanel");
  if(!p) return;
  const rules = State.rules.flue;
  if(!Q.selections.flue.type){ p.innerHTML = `<small class="hint">Select a flue type.</small>`; return; }
  const r = rules.defaults[Q.selections.flue.type] || {};
  p.innerHTML = `
    <hr/>
    <div>Terminal to opening: ${r.to_opening_mm ?? "-"} mm</div>
    <div>Terminal to boundary: ${r.to_boundary_mm ?? "-"} mm</div>
    <div>Verticals: roof penetration rules loaded.</div>
    <small class="hint">Brand-specific overrides can be added per model.</small>
  `;
  State.quote.rules.flue_checks = [{rule_id:"FLUE_DEFAULTS", status:"pass"}];
}

function showGasRules(){
  const Q = State.quote;
  const p = document.getElementById("gasPanel");
  if(!p) return;
  const gr = State.rules.gas;
  const route = Q.survey.gas.route_len_m || 0;
  // naive hint using thresholds
  let hint = "22 mm likely OK";
  if(route>15) hint = "28 mm likely required";
  if(route>30) hint = "35 mm may be needed";
  p.innerHTML = `<hr/><div>Route length: ${route} m → <b>${hint}</b></div>`;
  State.quote.rules.gas_checks = [{rule_id:"GAS_ROUTE_HINT", status: route>30?"warn": "pass", details: hint}];
}

function evalClearances(model, meas){
  const out = [];
  const I = model.clearances.install;
  const S = model.clearances.service;
  const m = (v)=>Number(v||0);

  function check(rule_id, cond){ out.push({rule_id, status: cond?"pass":"fail"}); }
  check("INSTALL_TOP", m(meas.above_case) >= I.top);
  check("INSTALL_BOTTOM", m(meas.below_case) >= I.bottom);
  check("INSTALL_SIDES", m(meas.left_clearance) >= I.sides && m(meas.right_clearance) >= I.sides);
  // service front check: allow reduced-front path if present and criteria met
  const reduced = model.rules?.reduced_front;
  let serviceOK = m(meas.front_clearance) >= S.front;
  if(!serviceOK && reduced){
    const meetsReduced = m(meas.front_clearance) >= reduced.front &&
                         m(meas.above_case) >= reduced.above &&
                         m(meas.below_case) >= reduced.below &&
                         m(meas.left_clearance) >= reduced.sides &&
                         m(meas.right_clearance) >= reduced.sides;
    serviceOK = meetsReduced;
    out.push({rule_id:"SERVICE_FRONT_REDUCED_PATH", status: meetsReduced?"pass":"fail"});
  } else {
    out.push({rule_id:"SERVICE_FRONT", status: serviceOK?"pass":"fail"});
  }
  return out;
}

function lookupModel(sel){
  const data = State.rules.boiler;
  if(!sel.brand || !sel.range || !sel.model) return null;
  return (((data[sel.brand]||{})[sel.range]||{})[sel.model]||null);
}

function generateOutputs(){
  // Customer Summary (plain English)
  const q = State.quote;
  const parts = [];
  parts.push(`We will replace your ${q.survey.present_system||"current"} system with a ${q.survey.new_system||"new"} boiler.`);
  if(q.selections.boiler.brand) parts.push(`Selected boiler: ${[q.selections.boiler.brand,q.selections.boiler.range,q.selections.boiler.model].filter(Boolean).join(" ")}.`);
  if(q.selections.flue.type) parts.push(`Flue: ${q.selections.flue.type}.`);
  if(q.survey.house_map.current_location || q.survey.house_map.new_location){
    parts.push(`Location: from ${q.survey.house_map.current_location||"current"} to ${q.survey.house_map.new_location||"same"}.`);
  }
  if(q.selections.services.length) parts.push(`Additional services: ${q.selections.services.join(", ")}.`);
  const summary = parts.join(" ");

  // Installation Notes (semicolon lines)
  const notes = [
    `Present system: ${q.survey.present_system}`,
    `New system: ${q.survey.new_system}`,
    `Boiler: ${[q.selections.boiler.brand,q.selections.boiler.range,q.selections.boiler.model].filter(Boolean).join(" / ")}`,
    `Flue: ${q.selections.flue.type}`,
    `Gas meter: ${q.survey.gas.meter_type}`,
    `Condensate: ${q.selections.condensate.route} (frost: ${q.selections.condensate.protection})`,
    `Locations: ${q.survey.house_map.current_location} → ${q.survey.house_map.new_location}`
  ].filter(Boolean).map(s=>s+";").join("\n");

  // Skill hours stub
  const hours = [
    {code:"PACK-A-"+(q.survey.present_system||"NA").toUpperCase(), hours:2.0},
    {code:"PACK-B-"+(q.survey.new_system||"NA").toUpperCase(), hours:3.0}
  ];

  State.quote.outputs.customer_summary = summary;
  State.quote.outputs.installation_notes = notes;
  State.quote.outputs.skill_hours_breakdown = hours;

  document.getElementById("customerSummary").value = summary;
  document.getElementById("installNotes").value = notes;
  document.getElementById("skillHours").value = JSON.stringify(hours, null, 2);
  document.getElementById("outputs").classList.remove("hidden");
  // jump to bottom
  window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
}

// --- helpers
window.addEventListener("keydown", (e)=>{
  if(e.key==="ArrowLeft" && State.stepIndex>0){ State.stepIndex--; render(); }
  if(e.key==="ArrowRight" && State.stepIndex<Steps.length-1){ State.stepIndex++; render(); }
});

// boot
boot();


  
const origRender = render;
render = function(){
  origRender();
  if(Steps[State.stepIndex]==="House Map"){
    const svgWrap = document.createElement('div');
    svgWrap.className = 'svg-wrap card';
    svgWrap.innerHTML = `<h3>Simple House Diagram</h3>
    <svg viewBox="0 0 300 180">
      <rect x="10" y="60" width="280" height="110" fill="#121a22" stroke="#2a3b50"/>
      <polygon points="10,60 150,10 290,60" fill="#0f141a" stroke="#2a3b50"/>
      <g id="hotspots" font-size="10" fill="#cfe0f3">
        <circle cx="70" cy="110" r="8" stroke="#4aa3ff" fill="none"></circle>
        <text x="60" y="130">Kitchen</text>
        <circle cx="230" cy="110" r="8" stroke="#4aa3ff" fill="none"></circle>
        <text x="215" y="130">Garage</text>
        <circle cx="150" cy="40" r="8" stroke="#4aa3ff" fill="none"></circle>
        <text x="135" y="25">Loft</text>
      </g>
    </svg>
    <small class="hint">Tap a hotspot to set current/new location quickly.</small>`;
    document.getElementById('view').appendChild(svgWrap);
    const setLoc = (field,val)=>{{ State.quote.survey.house_map[field]=val; render(); }};
    svgWrap.querySelectorAll('circle').forEach((c,i)=>{{
      const map = ['kitchen','garage','loft'];
      c.style.cursor='pointer';
      c.addEventListener('click',()=>{{
        if(!State.quote.survey.house_map.current_location) setLoc('current_location', map[i]);
        else setLoc('new_location', map[i]);
      }});
    }});
  }
};

  </script>
</body>
</html>
