<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Depot Notes Picker</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    :root { --gap:12px; --radius:12px; }
    * { box-sizing:border-box }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
                   "Apple Color Emoji","Segoe UI Emoji";
      margin:0; padding:0; background:#0b1220; color:#e6ecff;
    }
    header.app{
      position:sticky; top:0; z-index:20; backdrop-filter: blur(8px);
      background:rgba(11,18,32,0.85);
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:10px var(--gap);
    }
    h1{ font-size:18px; margin:4px 0 }
    .bar{ display:flex; flex-wrap:wrap; gap:var(--gap); align-items:center }
    select, input[type="search"]{
      padding:10px 12px; border-radius:10px; background:#0f172a; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); outline:none;
    }
    .btn{
      border:1px solid rgba(255,255,255,0.14);
      background:#111827; color:#e5e7eb; padding:9px 12px; border-radius:10px;
      cursor:pointer; font-weight:600;
    }
    .btn:hover{ background:#1f2937 }
    .container{ display:grid; grid-template-columns:1fr; gap:var(--gap); padding:var(--gap) }
    @media (min-width:980px){ .container{ grid-template-columns:1fr 420px; align-items:start } }
    .panel{
      border:1px solid rgba(255,255,255,0.12); background:#0f172a; border-radius:var(--radius);
      overflow:hidden;
    }
    .panel header{ position:unset; background:transparent; border:none; padding:12px }
    .panel h2{ margin:0; font-size:16px }
    .list{ display:flex; flex-direction:column; gap:8px; padding:12px; max-height:60vh; overflow:auto }
    .item{ display:flex; gap:10px; padding:10px; border:1px solid rgba(255,255,255,0.08); background:#0b132a; border-radius:10px }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .meta{ opacity:0.75; font-size:12px }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#1f2937; font-size:12px }
    textarea{
      width:100%; min-height:160px; max-height:280px; padding:12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.12); background:#0f172a; color:#e2e8f0;
    }
    .hint{ font-size:12px; opacity:0.8 }
  </style>
</head>
<body>

  <header class="app">
    <h1>Depot Notes Picker</h1>
    <div class="bar">
      <label class="hint">Section</label>
      <select id="sectionSelect" aria-label="Choose section"></select>
      <button class="btn" id="nextSectionBtn" title="Go to next section">Next section ➜</button>
      <input id="search" type="search" placeholder="Filter within section… (e.g., 'loft', 'N12')" />
      <button class="btn" id="selectAllVisible">Select all (visible)</button>
      <button class="btn" id="clearSection">Clear section</button>
      <span class="meta" id="countMeta">0 selected</span>
    </div>
  </header>

  <div class="container">
    <div class="panel" id="itemsPanel">
      <header>
        <div class="row">
          <h2 id="sectionTitle">Section</h2>
          <span class="pill" id="sectionPill">0 selected</span>
        </div>
      </header>
      <div class="list" id="itemsList"></div>
    </div>

    <div class="panel">
      <header><h2>Copy Box Output (; line breaks)</h2></header>
      <div class="list" style="max-height:none">
        <div class="row">
          <button class="btn" id="copySemiBtn">Copy ;-lines</button>
          <label class="row hint" style="gap:6px">
            <input type="checkbox" id="includeHeaders" checked />
            Include section headers
          </label>
        </div>
        <textarea id="semiOutput" placeholder="e.g., 'Needs: phrase ; phrase ; …'"></textarea>
      </div>
    </div>
  </div>

  <script>
    // Register service worker (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    // ========= Data & State =========
    // Starter bank so UI isn't empty if JSON fails
    const PHRASE_BANK = {
      needs: [
        { code: 'N01', text: 'Customer wants improved hot water performance' },
        { code: 'N02', text: 'Customer requested quieter boiler operation' }
      ]
    };
    const SECTION_ORDER = ['needs']; // JSON sections will be unshifted in front
    const selections = {};           // { sectionKey: Set<string> }
    let currentSection = SECTION_ORDER[0];

    // ========= Helpers =========
    function ensureBucket(section){ if(!selections[section]) selections[section] = new Set(); }
    function toTitle(s){ return String(s).replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }

    function labelOf(sectionKey){
      if (!sectionKey) return 'Section';
      if (sectionKey.startsWith('system_characteristics__')) {
        const tail = sectionKey.slice('system_characteristics__'.length);
        return toTitle(tail); // Show just the subgroup name
      }
      if (sectionKey === 'system_characteristics') return 'System Characteristics';
      return toTitle(sectionKey);
    }

    function filterItems(items, q){
      if(!q) return items;
      const s = q.trim().toLowerCase();
      return items.filter(it => (it.code + ' ' + it.text).toLowerCase().includes(s));
    }

    function buildSemicolonText(){
      const includeHeaders = document.getElementById('includeHeaders').checked;
      let out = '';
      SECTION_ORDER.forEach(section => {
        const chosen = [...(selections[section] || [])];
        if (chosen.length === 0) return;
        const phrases = (PHRASE_BANK[section] || []).filter(it => chosen.includes(it.code));
        if (phrases.length === 0) return;
        if (includeHeaders) out += `${labelOf(section)}: `;
        out += phrases.map(p => p.text).join(' ; ');
        out += ' ;\n';
      });
      document.getElementById('semiOutput').value = out.trim();
      return out.trim();
    }

    function updateTotals(){
      const n = selections[currentSection]?.size || 0;
      document.getElementById('sectionPill').textContent = `${n} selected`;
      let total = 0; Object.values(selections).forEach(s => total += s.size);
      document.getElementById('countMeta').textContent = `${total} selected`;
    }

    // ========= Rendering =========
    function populateSectionSelect(){
      const sel = document.getElementById('sectionSelect');

      // If SECTION_ORDER empty, rebuild from PHRASE_BANK keys
      if (!Array.isArray(SECTION_ORDER) || SECTION_ORDER.length === 0) {
        Object.keys(PHRASE_BANK).forEach(k => SECTION_ORDER.push(k));
      }

      // Ensure currentSection is valid
      if (!PHRASE_BANK[currentSection]) {
        currentSection = SECTION_ORDER.find(k => PHRASE_BANK[k]) || SECTION_ORDER[0];
      }

      sel.innerHTML = '';
      SECTION_ORDER.forEach(k => {
        if (!PHRASE_BANK[k] || PHRASE_BANK[k].length === 0) return;
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = labelOf(k);
        sel.appendChild(opt);
      });

      if (!sel.options.length) {
        document.getElementById('itemsList').innerHTML =
          '<div class="meta">No sections available. Check console for errors.</div>';
        console.warn('populateSectionSelect: no sections', { PHRASE_BANK, SECTION_ORDER });
        return;
      }

      if (!currentSection || !PHRASE_BANK[currentSection]) {
        currentSection = sel.options[0].value;
      }
      sel.value = currentSection;
      document.getElementById('sectionTitle').textContent = labelOf(currentSection);
      renderSectionItems();
    }

    function renderSectionItems(){
      const wrap = document.getElementById('itemsList');
      wrap.innerHTML = '';
      const items = PHRASE_BANK[currentSection] || [];
      const q = document.getElementById('search').value;
      const visible = filterItems(items, q);

      visible.forEach(it => {
        const row = document.createElement('label');
        row.className = 'item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selections[currentSection]?.has(it.code) || false;
        cb.addEventListener('change', () => {
          ensureBucket(currentSection);
          if (cb.checked) selections[currentSection].add(it.code);
          else selections[currentSection].delete(it.code);
          updateTotals();
          buildSemicolonText();
        });
        const txt = document.createElement('div');
        txt.innerHTML = `<div><strong>${it.code}</strong> — ${it.text}</div>`;
        row.appendChild(cb); row.appendChild(txt);
        wrap.appendChild(row);
      });

      updateTotals();
      buildSemicolonText();
    }

    function nextSection(){
      const idx = SECTION_ORDER.indexOf(currentSection);
      const next = SECTION_ORDER[(idx + 1) % SECTION_ORDER.length];
      currentSection = next;
      document.getElementById('sectionSelect').value = next;
      document.getElementById('sectionTitle').textContent = labelOf(next);
      renderSectionItems(); updateTotals();
    }

    async function loadConfigJSON(){
  // First check for a local override saved by editor.html
  const OVERRIDE_KEY = 'depot_notes_config_override_v1';
  const raw = localStorage.getItem(OVERRIDE_KEY);

  if (raw) {
    try {
      const obj = JSON.parse(raw);
      console.log('Loaded local override from JSON editor');
      return obj; // use local override if valid
    } catch (e) {
      console.warn('Local override invalid, falling back to network');
    }
  }

  // Otherwise, fetch the live App_config.json from GitHub Pages
  const resp = await fetch('./App_config.json', { cache: 'no-store' });
  if (!resp.ok) throw new Error('Failed to load App_config.json');
  return resp.json();
}

    function slugifyLabel(label){
      return String(label).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
    }

    // Each top-level group in App_config.json becomes its own section
    function flattenSystemCharacteristics(cfg){
      const root = cfg?.catalogs?.system_characteristics;
      if (!root || !Array.isArray(root.children)) {
        console.warn('flattenSystemCharacteristics: missing system_characteristics root');
        return {};
      }

      const sections = {}; // { 'system_characteristics__hot_water': [{code,text},...] }

      root.children.forEach(group => {
        if (!group || group.type !== 'group') return;

        const baseKey = `system_characteristics__${slugifyLabel(group.label || 'group')}`;
        const items = [];

        function walk(node){
          if (!node) return;
          if (node.type === 'group' && Array.isArray(node.children)) {
            node.children.forEach(walk); return;
          }
          if (node.type === 'single' && Array.isArray(node.options)) {
            const nodeLabel = node.label || 'Option';
            node.options.forEach(opt => {
              items.push({ code: node.id || String(opt), text: `${nodeLabel}: ${opt}` });
            });
          }
        }

        if (Array.isArray(group.children)) group.children.forEach(walk);
        if (items.length) sections[baseKey] = items;
      });

      // Fallback: if no groups produced items, flatten everything into one section
      if (Object.keys(sections).length === 0) {
        const flat = [];
        function walkAll(node){
          if (!node) return;
          if (node.type === 'group' && Array.isArray(node.children)) { node.children.forEach(walkAll); return; }
          if (node.type === 'single' && Array.isArray(node.options)) {
            const nodeLabel = node.label || 'Option';
            node.options.forEach(opt => flat.push({ code: node.id || String(opt), text: `${nodeLabel}: ${opt}` }));
          }
        }
        root.children.forEach(walkAll);
        if (flat.length) sections['system_characteristics'] = flat;
      }

      return sections;
    }

    async function bootstrapSystemCharacteristics(){
      try{
        const cfg = await loadConfigJSON();
        const sysSections = flattenSystemCharacteristics(cfg);
        const keys = Object.keys(sysSections);

        // Merge into PHRASE_BANK
        Object.assign(PHRASE_BANK, sysSections);

        // Insert new sections at the front in JSON order
        keys.slice().reverse().forEach(k => {
          if (!SECTION_ORDER.includes(k)) SECTION_ORDER.unshift(k);
        });

        // Ensure a valid currentSection
        if (!currentSection || !PHRASE_BANK[currentSection]) {
          currentSection = keys[0] || SECTION_ORDER.find(k => PHRASE_BANK[k]) || SECTION_ORDER[0];
        }

        populateSectionSelect();
        renderSectionItems();
        console.log('Loaded sections:', Object.keys(PHRASE_BANK));
      }catch(err){
        console.error('bootstrapSystemCharacteristics failed:', err);
        populateSectionSelect();
        renderSectionItems();
      }
    }

    // ========= Events & boot =========
    document.getElementById('search').addEventListener('input', renderSectionItems);
    document.getElementById('sectionSelect').addEventListener('change', (e) => {
      currentSection = e.target.value;
      document.getElementById('sectionTitle').textContent = labelOf(currentSection);
      renderSectionItems(); updateTotals();
    });
    document.getElementById('nextSectionBtn').addEventListener('click', nextSection);
    document.getElementById('selectAllVisible').addEventListener('click', () => {
      const q = document.getElementById('search').value;
      const items = filterItems(PHRASE_BANK[currentSection] || [], q);
      ensureBucket(currentSection);
      items.forEach(it => selections[currentSection].add(it.code));
      renderSectionItems(); updateTotals(); buildSemicolonText();
    });
    document.getElementById('clearSection').addEventListener('click', () => {
      ensureBucket(currentSection); selections[currentSection].clear();
      renderSectionItems(); updateTotals(); buildSemicolonText();
    });
    document.getElementById('copySemiBtn').addEventListener('click', async () => {
      const text = buildSemicolonText();
      try{
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.getElementById('semiOutput');
          ta.focus(); ta.select(); document.execCommand('copy');
        }
      }catch(e){ console.warn('Copy failed:', e); }
    });

    document.addEventListener('keydown', (e) => {
      const mod = e.ctrlKey || e.metaKey;
      if (mod && e.key === 'ArrowRight') { e.preventDefault(); nextSection(); }
      if (mod && e.key.toLowerCase() === 'c') {
        e.preventDefault(); buildSemicolonText();
        const ta = document.getElementById('semiOutput');
        ta.focus(); ta.select(); document.execCommand('copy');
      }
    });

    // Boot once definitions are in place
    bootstrapSystemCharacteristics();
  </script>

  <!-- Optional hook so you can add update UI later (create update.js to avoid 404) -->
  <script src="./update.js"></script>
</body>
</html>