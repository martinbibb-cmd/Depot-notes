<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0d10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Depot Notes ‚Äì Stepper v3</title>
  <style>
    :root{
      /* DARK THEME DEFAULTS */
      --bg:#0b0d10;--panel:#151a1f;--ink:#e9eef5;--muted:#9fb0c2;--accent:#4aa3ff;--border:#1f2630;--banner:#0f3c80;--bannerText:#e9eef5;
      --copyBtn:#4aa3ff;--copyInk:#081018;
    }
    html[data-theme="light"]{
      --bg:#f6f9fc;--panel:#ffffff;--ink:#0b0d10;--muted:#5a6b7d;--accent:#246bff;--border:#dde6f0;--banner:#e8f1ff;--bannerText:#113366;
      --copyBtn:#246bff;--copyInk:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:18px}
    .tag{font-size:12px;color:var(--muted);margin-left:8px;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
    .right{display:flex;align-items:center;gap:8px}
    .btn{background:var(--accent);border:none;color:var(--copyInk);padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    .btn.small{padding:6px 10px;font-weight:600}
    .switch{display:flex;align-items:center;gap:6px}
    .switch input{accent-color:var(--accent)}

    .banner{background:var(--banner);color:var(--bannerText);padding:10px 12px;border-radius:12px;border:1px solid var(--border)}

    nav#steps{display:flex;gap:8px;flex-wrap:wrap;margin:12px 16px}
    .step{padding:6px 10px;border-radius:10px;background:var(--panel);border:1px solid var(--border);color:var(--muted);cursor:pointer}
    .step.active{color:var(--ink);border-color:#2a3b50;background:linear-gradient(0deg, rgba(74,163,255,.12), rgba(74,163,255,0))}

    main#view{padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row thirds{grid-template-columns:1fr 1fr 1fr}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--ink)}
    input,select,textarea{width:100%;background:transparent;border:1px solid var(--border);color:var(--ink);padding:10px;border-radius:10px}
    textarea.tall{min-height:120px}
    .list{display:grid;gap:8px}
    .opt{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;cursor:pointer}
    .opt input{width:auto}

    footer.page{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--border);background:var(--panel);position:sticky;bottom:0;z-index:5}

    .outputs{padding:16px;border-top:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid .full{grid-column:1/-1}
    .copybox{display:flex;flex-direction:column;gap:8px}
    .copybox-head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .copybox-head label{font-weight:600;color:var(--ink)}
    .copybox-head.natural label{color:var(--muted)}
    .copybox-actions{display:flex;gap:6px;flex-wrap:wrap}
    .copybox textarea[readonly]{background:var(--panel);color:var(--ink);border-style:dashed}

    .credit{color:var(--muted);font-size:12px;margin-left:auto}
  </style>
  <noscript><div style="background:#ffb4b4;color:#300;padding:12px">This page needs JavaScript. Open in a browser (not Files preview) and ensure JS is enabled.</div></noscript>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <h1>Depot Notes</h1>
      <span class="tag" id="jsStatus">JS‚Ä¶</span>
    </div>
    <div class="right">
      <a href="welcome.html" class="btn ghost">üè† Welcome</a>
      <div class="switch"><input type="checkbox" id="themeToggle"><label for="themeToggle">Light mode</label></div>
      <button id="prevBtn" class="btn ghost">‚óÄ Back</button>
      <button id="nextBtn" class="btn">Next ‚ñ∂</button>
    </div>
  </header>

  <div class="banner" style="margin:12px 16px">Quick stepper to fill your Depot sections. Use the blue buttons to copy each section when you‚Äôre done.</div>

  <nav id="steps"></nav>

  <main id="view"></main>

  <footer class="page">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <button id="genCustomer" class="btn small">Generate Customer Summary</button>
      <button id="genEngineer" class="btn small ghost">Generate Engineer Summary</button>
    </div>
    <div class="credit">Depot Notes v3 ‚Äî Form Logic Redesign by Martin Bibb üí°</div>
  </footer>

  <section id="outputs" class="outputs">
    <h2>Depot Copy Boxes (exact names)</h2>
    <div class="grid" id="copyBoxes"></div>
    <div class="grid" style="margin-top:12px">
      <div class="copybox">
        <div class="copybox-head">
          <label for="customerSummary">Customer Summary</label>
          <div class="copybox-actions">
            <button class="btn small ghost" data-speak="customerSummary">üîä Speak</button>
            <button class="btn small" data-copy="customerSummary">Copy Customer Summary</button>
          </div>
        </div>
        <textarea id="customerSummary" class="tall" rows="8"></textarea>
      </div>
      <div class="copybox">
        <div class="copybox-head">
          <label for="engineerSummary">Engineer Summary</label>
          <div class="copybox-actions">
            <button class="btn small ghost" data-speak="engineerSummary">üîä Speak</button>
            <button class="btn small" data-copy="engineerSummary">Copy Engineer Summary</button>
          </div>
        </div>
        <textarea id="engineerSummary" class="tall" rows="8"></textarea>
      </div>
    </div>
  </section>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch((err) => {
          console.error('Service worker registration failed:', err);
        });
      });
    }
  </script>
  <script>
    // THEME
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(){
      const pref = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', pref);
      themeToggle.checked = (pref==='light');
    }
    themeToggle.addEventListener('change',()=>{
      const next = themeToggle.checked ? 'light' : 'dark';
      localStorage.setItem('theme', next); applyTheme();
    });
    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='l'){ themeToggle.checked=!themeToggle.checked; themeToggle.dispatchEvent(new Event('change')); }});
    applyTheme();

    // STATUS
    const jsTag = document.getElementById('jsStatus');
    if (jsTag) jsTag.textContent = 'Loading options‚Ä¶';

    // Options fallback (used if Options.txt fails to load)
    const OPTIONS_FALLBACK = `
[Needs]
NE01 | Need | Better water pressure
NE02 | Need | Faster hot water delivery
NE03 | Need | More usable space
NE04 | Need | Lower running costs
NE05 | Need | Easier controls
NE06 | Need | Quieter operation
NE07 | Need | Future-ready system

[Working at heights]
WAH01 | Access | Ladder access required
WAH02A | Scaffold | Tower ‚Äì standard
WAH02B | Scaffold | Tower ‚Äì bridging
WAH02C | Scaffold | Cantilever
WAH03 | Roof access | Permit required
WAH04A | Loft access | Boarded
WAH04B | Loft access | Unboarded
WAH05 | Access | MEWP required
WAH06 | Flat roof | Specialist builder to make good
WAH50 | Ladder | 1:4 angle (‚âà75¬∞) ‚Äì ~250 mm out per metre rise; secure footing
WAH51 | Reach | Max practical ladder reach ‚âà6 m; >2 storeys or >45¬∞ roof = scaffold
WAH52 | Roof | Flat roof work requires edge protection or 2 m exclusion from edge
WAH53 | Loft | Boiler weight ‚â§‚âà35 kg for safe loft handling; use two-person lift if needed
WAH54 | Access | Fixed loft ladder and permanent lighting required for service access

[System characteristics]
SE00 | Existing system
SE01 | System type | Regular (open-vented with F&E tank)
SE02 | System type | Regular (sealed system kit present)
SE03 | Hot water | System boiler ‚Äì open-vented
SE04 | Hot water | System boiler ‚Äì unvented
SE05 | Configuration | Y-plan (3-port valve)
SE06 | Configuration | S-plan (2-port valves)
SE07 | Configuration | Gravity primaries
SE08 | Legacy install | Combi present
SE09 | Pipework | Microbore
SE10 | System pressure | Low
SE11 | Controls | Mechanical timer / room stat
SE12 | Controls | Hard-wired only
SN00 | New boiler
SN01 | System type | Combi boiler
SN02 | System type | System boiler with unvented cylinder
SN03 | System type | System boiler with Mixergy cylinder
SN04 | System type | Regular boiler with open-vented hot water
SN05 | System type | Regular boiler with unvented hot water
SN06 | Heating circuit | Open-vented
SN07 | Heating circuit | Sealed / pressurised
SN08 | Heating zones | TRVs on all radiators
SN09 | Heating zones | Additional zone(s) via 2-port valves
SN10 | Heating zones | Existing Y-plan retained
SN11 | Controls compatibility | Hive
SN12 | Controls compatibility | Hive Mini
SN13 | Controls preference | Simple / manual
SC50 | System Type | Combi ‚Äì instantaneous DHW; no tanks
SC51 | System Type | System ‚Äì sealed with cylinder; built-in pump/expansion vessel
SC52 | System Type | Regular ‚Äì open-vented with F&E tank
SC53 | System Pressure | Sealed system may expose latent leaks ‚Äì advise & record disclaimer
SC54 | Pipework | One-pipe system not suitable for modern boilers ‚Äì recommend re-pipe
SC55 | Pipework | Galvanised/steel pipework ‚Äì replace rather than flush
SC56 | Water Softeners | Worcester allows softened water through primary HX
SC57 | Water Softeners | Vaillant/Ideal ‚Äì bypass or hard-fill only (no softened water through HX)
SC58 | Location | Loft installs require boarded area (‚âà1.5 m radius), fixed ladder & lighting
SC60 | Condensate | External condensate must be insulated/frost-protected

[Arse_cover_notes]
ARS01 | System | Sealing an old system may expose hidden leaks
ARS02 | System | Existing radiators and valves may leak once pressurised
ARS03 | System | Old vented pipework and joints not designed for pressure
ARS04 | System | System converted from open vent to sealed ‚Äî pressure relief valve fitted for safety
ARS05 | System | Pressure drops after installation may indicate existing weeps or hidden leaks
ARS06 | System | Customer advised to monitor pressure during initial days of use
ARS07 | System | No liability for existing system weaknesses or pre-existing faults
ARS08 | Combi | Combination boilers supply one outlet at a time ‚Äî flow reduces with multiple use
ARS09 | Combi | Flow rate limited by mains water supply ‚Äî cannot exceed incoming pressure or flow
ARS10 | Combi | Large households or multiple bathrooms may experience reduced performance
ARS11 | Combi | Cold mains restrictions may affect shower performance
ARS12 | Combi | Hot water temperature varies slightly with flow rate
ARS13 | Combi | Not suitable for power showers with pump ‚Äî pump must be removed
ARS14 | Combi | Shower performance dependent on incoming cold main flow and pressure
ARS15 | Hot water | Stored cylinder water may take time to reheat
ARS16 | Hot water | Mixergy or unvented cylinders require periodic servicing for safety
ARS17 | Hot water | Unvented cylinder discharge tested and compliant at time of install only
ARS18 | Hot water | Hot water recovery times vary depending on usage pattern
ARS19 | Hot water | No liability for customer-supplied fixtures not designed for mains pressure
ARS20 | Condensate | Condensate routes external ‚Äî insulated to reduce freezing risk, not guaranteed
ARS21 | Condensate | External soakaway provided only where suitable drainage available
ARS22 | Condensate | Customer responsible for maintaining condensate route clear and free-flowing
ARS23 | Condensate | No responsibility for freezing if installation complies with manufacturer MI
ARS24 | Controls | Controls installed in accordance with manufacturer‚Äôs instructions
ARS25 | Controls | Hive system can operate without Wi-Fi; only remote app access requires router connection and USB power
ARS26 | Controls | Smart controls may require network access for optional app features
ARS27 | Controls | No responsibility for internet connectivity or app integration issues
ARS28 | Controls | Room stat location based on best judgement at time of survey
ARS29 | Flue | Flue termination checked for clearance at time of install ‚Äî future obstructions not covered
ARS30 | Flue | Brickwork and render made good to reasonable standard, not decorative finish
ARS31 | Flue | Flue sealing and flashings weatherproof only ‚Äî not decorative
ARS32 | Flue | Existing holes or redundant flues made safe and sealed where practical
ARS33 | Access | Safe access provided for installation only ‚Äî permanent access is customer responsibility
ARS34 | Access | Loft must be boarded, lit, and safe before works commence
ARS35 | Access | Working at height precautions apply ‚Äî scaffold or tower may be required
ARS36 | Access | No work above safe height without suitable equipment
ARS37 | Customer | Customer to clear working area and ensure safe access
ARS38 | Customer | Pets to be contained during works
ARS39 | Customer | Noise, dust, and disruption unavoidable during installation
ARS40 | Customer | Water and heating supply may be temporarily unavailable during works
ARS41 | Customer | Customer responsible for redecorating or boxing in after completion
ARS42 | General | All works carried out to Gas Safe and Building Regs at time of install
ARS43 | General | Manufacturer warranty subject to annual service
ARS44 | General | No liability for pre-existing faults or unrelated plumbing issues
ARS45 | General | Installation performance depends on system design and existing pipework
ARS46 | General | Recommendations given in good faith based on visible inspection

[Components that require assistance]
CS01 | Cylinder | Removal required
CS02 | Cylinder | Replacement required
CS03 | CWS tank | Removal required
CS04 | Boiler | Double-handed lift required
CS05 | heavy radiators 

[Restrictions to work]
SR01 | Access | No loft access
SR02 | Clearance | Restricted clearance
SR03 | Parking | Limited / permit required
SR04 | Hours | Working hours restricted
SR05 | Pets | On site
SR06 | Occupant | Vulnerable person present
SR07 | Noise | Restrictions in place
SR08 | Drainage | Septic tank ‚Äì not suitable for condensate
SR09 | Building | Listed ‚Äì consent required
SR10 | Building | Listed ‚Äì permission required
SR11 | Property type | Flats ‚Äì management permission required

[External hazards]
EH01 | Asbestos | Suspected
EH02 | Roof | Fragile tiles / material
EH03 | Environment | Flood risk / standing water
EH04 | Insects | Wasps nesting
EH05 | Insects | Bees nesting
EH06 | Lighting | Poor / no power
EH07 | Site | Pet mess present
EH08 | Animals | Dog(s) present
EH09 | Animals | Other potentially dangerous
ASB50 | Asbestos | Visual check each visit; stop work if suspected ACM is damaged/friable
ASB51 | Asbestos | Non-notifiable tasks only (e.g., cement flue, textured coatings) within limits
ASB52 | Asbestos | Typical fixings limit: up to 5√ó20 mm or 4√ó28 mm holes if unavoidable ‚Äì record
HAZ50 | Electrical | Overhead cables within 3 m ‚Äì escalate/liaise with DNO; control measures required
HAZ51 | Site | Customer to clear working areas; protect fragile roofs/greenhouses

[Delivery notes]
DL01 | Slot | Preferred AM
DL02 | Slot | Preferred PM
DL03 | Access | Large vehicle suitable
DL04 | Access | Large vehicle restricted
DL05 | Delivery | To garage
DL06 | Delivery | To room within property
DL07 | Contact | Call ahead on arrival
DL08 | Handling | Double-handed lift
DL09 | Handling | Stairs / no lift

[Office notes]
OA01 | Labour | Direct labour required
OA02 | Specialist works | Asbestos removal
OA03 | Specialist works | Specialist builder
OA04 | Specialist works | Scaffolding
OA05 | Assistance | Double-handed required

[New boiler and controls]
BLC00 | location
BLC01 | Location | Kitchen ‚Äì not in cupboard
BLC02 | Location | Kitchen ‚Äì within cupboard
BLC03 | Location | Kitchen ‚Äì cupboard to be removed
BLC04 | Location | Utility room
BLC05 | Location | Loft
BLC06 | Location | Garage
BLC07 | Location | Bedroom
BLC08 | Location | Airing cupboard
BLC09 | Location | Other internal
BLC10 | Location | See photos / floor plan
BLC11 | Location | Adjacent wall
BLC12 | Location | Minor move to gain clearances

BT00 | boiler type
BT01 | Boiler type | Regular / heat-only / conventional
BT02 | Boiler type | System
BT03 | Boiler type | Combi

[Flue]
|Old flue
FMG01 | Make good | Old balanced flue
FMG02 | Make good | Old fanned flue
FMG03 | Make good | Old roof terminal
FMG04 | Make good | Brick up old flue opening

|flue_new
FN01 | New flue | Use same hole ‚Äì minor change
FN02 | New flue | New hole ‚Äì same wall
FN03 | New flue | New hole ‚Äì alternative wall
FN04 | Orientation | Horizontal
FN05 | Orientation | Vertical
FN06 | Sealing | Seal brickwork to flue
FN07 | Sealing | Vertical flashing kit
FN08 | Sealing | Flat roof flashing by specialist builder
FN09 | Add-on | Plume kit required
FN10 | Add-on | Flue extension
FN11 | Safety | Terminal guard required
FN12 | Orientation | Front aspect
FN13 | Orientation | Rear aspect
FLU50 | Flue | Minimum 300 mm from any opening (window/door/vent)
FLU51 | Flue | Minimum 150 mm from eaves/soffits/building fabric (site-dependent)
FLU52 | Flue | ‚â•600 mm to a facing surface/boundary to avoid nuisance pluming
FLU53 | Flue | Voids require inspection hatches at every joint/change of direction
FLU54 | Flue | Maintain 26‚Äì50 mm per metre fall back to boiler on extended runs
FLU55 | Flue | High-rise (‚â•18 m England/Wales; ‚â•11 m Scotland): fire-rated flue only
FLU56 | Flue | Rear flue possible on many models ‚Äì requires new hole (no reuse of old)
FLU57 | Plume | Plume management 0.5‚Äì11.5 m typical; allow 0.5 m internal flue reduction per metre/plume elbow

[Pipe work]
|discharge
DS01 | PRV discharge | Pipework to outside
DS02 | Tundish | Visible and compliant
DS03 | Route | Under floor to outside
DS04 | Route | Direct to outside
DS05 | Route | Behind cupboards
DS06 | Route | Through cupboards

|water_services
WS01 | Mains | Increase pressure / flow
WS02 | Valve | Pressure reducing valve required
WS03 | Return | Secondary return present
WS04 | Filter | Scale filter required
WS05 | Isolation | Stop tap / service valve access
WS06 | Route | To under-counter
WS07 | Route | To airing cupboard

[Disruption]
primaries_filtration
PF01 | Cleaning | Powerflush required
PF02 | Cleaning | Chemical clean and inhibit
PF03 | Filter | Magnetic ‚Äì Fernox TF1 (brass)
PF04 | Filter | Magnetic ‚Äì other
PF05 | Primaries | Pipework alterations required
PF06 | Primaries | Pipe size upgrade required
PF50 | Powerflush | Mandatory before fitting a new boiler to an old/dirty system
PF51 | Powerflush | Do not powerflush galvanised/steel pipework ‚Äì re-pipe recommended
PF52 | Filter | Fit magnetic filter (e.g., Fernox TF1 Omega) to protect HX/rads
PF53 | Inhibitor | Dose with corrosion inhibitor after flush/refill
PF54 | Benefit | Improved circulation & faster warm-up; helps maintain efficiency
CE50 | Combi DHW | Combi hot water is not truly ‚Äúinstant‚Äù ‚Äì pre-heat & draw-off needed
CE51 | Flow Limits | Performance depends on mains pressure & flow; demo with flow cup
CE52 | Single Use | With combi, best to use one high-flow outlet at a time
CE53 | Sealed Risk | Sealing an old system can expose weeps at valves/rads/pipe joints
CE54 | Shared Mains | New combi installations not recommended on shared water mains
CE55 | Frost | External condensate requires insulation & trace/frost protection where exposed
CE56 | Access | Loft installs need safe access (fixed ladder, light, boarding) for warranty service

|radiators
RD01 | Radiators | Replace radiator(s)
RD02 | Radiators | Install additional radiator(s)
RD03 | Radiators | Fit TRVs / lockshields
RD04 | Radiators | Balance system on completion
RD05 | Radiators | Replace towel rail
RD06 | Radiators | Cap redundant pipework
RD07 | Radiators | Old / mixed condition
RD08 | Constraint | Prevents flushing

|disruption
DI01 | Disruption | Minimal
DI02 | Disruption | Moderate ‚Äì carpets lifted
DI03 | Disruption | High ‚Äì floors lifted
DI04 | Preparation | Customer to clear areas/routes
DI05 | Protection | Dust protection required

[Customer actions]
CA01 | Customer | Clear working areas
CA02 | Customer | Gain permission where required
CA03 | Customer | Ensure animals are kept safely
CA04 | Customer | Remove cupboard
CA05 | Customer | Rebuild cupboard
CA06 | Customer | Remove old flue & weather seal
CA07 | Customer | Supply specified items
`;

    function parseOptions(txt){
      const lines = txt.split(/\r?\n/);
      const data = {}; let current=null; let sub=null;
      for(const raw of lines){
        const line = raw.trim(); if(!line) continue;
        if(line.startsWith('[') && line.endsWith(']')){ current = line.slice(1,-1); data[current] = { items: [], subs: {} }; sub=null; continue; }
        if(line.startsWith('|')){ sub=line.slice(1).trim(); if(!data[current].subs[sub]) data[current].subs[sub]=[]; continue; }
        const parts=line.split('|').map(s=>s.trim()); const desc=parts[parts.length-1];
        if(sub){ data[current].subs[sub].push(desc); } else { data[current].items.push(desc); }
      }
      return data;
    }
    let OPTIONS = {};
    let OPTIONS_READY = false;

    async function loadOptions(){
      try {
        const res = await fetch('./Options.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error('Options.txt not found');
        const txt = await res.text();
        OPTIONS = parseOptions(txt);
        if (jsTag) jsTag.textContent = 'Options ‚úì';
      } catch (err) {
        console.warn('Failed loading Options.txt ‚Äî using embedded fallback', err);
        OPTIONS = parseOptions(OPTIONS_FALLBACK);
        if (jsTag) jsTag.textContent = 'Fallback ‚úì';
      }
      OPTIONS_READY = true;
      render();
    }

    // State
    const State = { stepIndex:0, selections:{
      safety_wah:[], restrictions:[], hazards:[], safety:{notes:""},
      existing_boiler:"", rooms:[], needs:[], new_boiler:"", system_advice:[],
      old_flue:[], new_flue:[],
      ac_free:"", ac_discharge:[], ac_waters:[],
      uc_uc:[], uc_sc:[], uc_cb:[],
      radiators:[], pf:[], disruption:[],
      assistance:[], delivery:[], office:[],
      customer_actions:[], additional:[],
      advice_to_disruption:false
    }};

    // Steps
    const Steps = [
      "Safety","Existing Boiler Type","House Rooms","Customer Needs","New Boiler Type",
      "Old Flue","New Flue","Airing Cupboard","User Controls","Radiators",
      "Sealing & Making Good","Disruption","Customer Actions","Assistance","Restrictions","Hazards","Delivery","Office","Additional","Review"
    ];

    function renderSteps(){
      const nav=document.getElementById('steps');
      nav.innerHTML = Steps.map((s,i)=>`<span class="step ${i===State.stepIndex?'active':''}" data-i="${i}">${i+1}. ${s}</span>`).join('');
      nav.querySelectorAll('.step').forEach(el=>el.addEventListener('click',()=>{ State.stepIndex=+el.dataset.i; render();
  // Live outputs from the start
  updateOutputs(); }));
    }

    function listToGroup(group, arr){ const S=State.selections; return `<div class="list">`+arr.map(v=>`<label class="opt"><input type="checkbox" data-group="${group}" value="${v}" ${Array.isArray(S[group])&&S[group].includes(v)?'checked':''}> ${v}</label>`).join('')+`</div>`; }

    function render(){
      renderSteps();
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const v=document.getElementById('view');

      if (!OPTIONS_READY) {
        if (prevBtn) prevBtn.disabled = true;
        if (nextBtn) {
          nextBtn.disabled = true;
          nextBtn.textContent = 'Next ‚ñ∂';
        }
        v.innerHTML = `<div class="card"><h2>Loading options‚Ä¶</h2><p>Fetching Options.txt</p></div>`;
        return;
      }

      if (prevBtn) prevBtn.disabled = State.stepIndex===0;
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.textContent = State.stepIndex===Steps.length-1? 'Generate ‚ñ∂':'Next ‚ñ∂';
      }

      const O=OPTIONS; const S=State.selections;

      switch(Steps[State.stepIndex]){
        case 'Safety':{
          v.innerHTML = `<div class="card">
            <h2>Safety</h2>
            <label>Working at Height</label>${listToGroup('safety_wah', O["Working at heights"].items)}
            <label>Restrictions to work</label>${listToGroup('restrictions', O["Restrictions to work"].items)}
            <label>External hazards</label>${listToGroup('hazards', O["External hazards"].items)}
            <label>Other safety notes</label><textarea id="safety_notes" rows="3">${S.safety.notes||''}</textarea>
          </div>`; break;
        }
        case 'Existing Boiler Type':{
          const opts=[
            "Regular (open-vented with F&E tank)","Regular (sealed system kit present)","System boiler ‚Äì open-vented","System boiler ‚Äì unvented",
            "Combi present","Warm air","Back boiler unit (BBU)","Storage combi","Electric"
          ];
          v.innerHTML = `<div class="card"><h2>Existing Boiler/System</h2>
            <div class="list">${opts.map(val=>`<label class="opt"><input type=\"radio\" name=\"existing_boiler\" value=\"${val}\" ${S.existing_boiler===val?'checked':''}> ${val}</label>`).join('')}</div></div>`; break;
        }
        case 'House Rooms':{
          const rooms=["Kitchen ‚Äì not in cupboard","Kitchen ‚Äì within cupboard","Kitchen ‚Äì cupboard to be removed","Utility room","Loft","Garage","Bedroom","Airing cupboard","Other internal","See photos / floor plan","Adjacent wall","Minor move to gain clearances"];
          v.innerHTML = `<div class="card"><h2>House Locations / Rooms</h2>${listToGroup('rooms', rooms)}</div>`; break;
        }
        case 'Customer Needs':{ v.innerHTML=`<div class="card"><h2>Customer Needs</h2>${listToGroup('needs', O['Needs'].items)}</div>`; break; }
        case 'New Boiler Type':{
          const types=["Regular / heat-only / conventional","System","Combi"]; const adv=[
            "Sealed system may expose latent leaks ‚Äì advise & record disclaimer",
            "One-pipe system not suitable for modern boilers ‚Äì recommend re-pipe",
            "Galvanised/steel pipework ‚Äì replace rather than flush",
            "Loft installs require boarded area (‚âà1.5 m radius), fixed ladder & lighting",
            "External condensate must be insulated/frost-protected"
          ];
          v.innerHTML=`<div class=card><h2>New Boiler Type</h2>
            <div class=list>${types.map(val=>`<label class=opt><input type=radio name=new_boiler value="${val}" ${S.new_boiler===val?'checked':''}> ${val}</label>`).join('')}</div>
            <hr/><label>Advisories (System characteristics)</label>${listToGroup('system_advice', adv)}
          </div>`; break;
        }
        case 'Old Flue':{ v.innerHTML=`<div class=card><h2>Old Flue (make good)</h2>${listToGroup('old_flue', O['Flue'].subs['Old flue'])}</div>`; break; }
        case 'New Flue':{ v.innerHTML=`<div class=card><h2>New Flue</h2>${listToGroup('new_flue', O['Flue'].subs['flue_new'])}</div>`; break; }
        case 'Airing Cupboard':{
          v.innerHTML=`<div class=card>
            <h2>Airing Cupboard</h2>
            <label>Notes (cylinder / pumps / valves)</label><textarea id=ac_free rows=3>${S.ac_free||''}</textarea>
            <label>PRV / discharge route</label>${listToGroup('ac_discharge', O['Pipe work'].subs['discharge'])}
            <label>Water services</label>${listToGroup('ac_waters', O['Pipe work'].subs['water_services'])}
            <small class=banner style="display:block;margin-top:8px">Plan type (Y/S/Gravity) should be selected in <b>User Controls</b> under System controls if needed.</small>
          </div>`; break;
        }
        case 'User Controls':{
          const uc=["Hive","Hive Mini","Programmable thermostat","Programmer ‚Äì mechanical","Room stat ‚Äì wireless","Programmer ‚Äì 2 channel","Programmer - single channel"];
          const sc=["S-plan ‚Äì additional zone","Y-plan","Room stat and TRVs","Load compensation","New wiring centre required","Room stat relocation required"];
          const cb=["Not within a cupboard","Fits ‚Äì modification required","Customer to remove cupboard","Customer to modify cupboard","Engineer to remove cupboard","Engineer to modify cupboard"];
          v.innerHTML=`<div class=card><h2>User Controls & Cupboard</h2>
            <label>User controls</label>${listToGroup('uc_uc', uc)}
            <label>System controls / wiring</label>${listToGroup('uc_sc', sc)}
            <label>Cupboard</label>${listToGroup('uc_cb', cb)}
          </div>`; break;
        }
        case 'Radiators':{ v.innerHTML=`<div class=card><h2>Radiators</h2>${listToGroup('radiators', O['Disruption'].subs['radiators'])}</div>`; break; }
        case 'Sealing & Making Good':{
          const sealing=["Seal brickwork to flue","Vertical flashing kit","Flat roof flashing by specialist builder","Brickwork and render made good to reasonable standard, not decorative finish","Flue sealing and flashings weatherproof only ‚Äî not decorative"];
          v.innerHTML=`<div class=card><h2>Sealing & Making Good</h2>${listToGroup('new_flue', sealing)}</div>`; break; // goes into Flue box as well
        }
        case 'Disruption':{
          v.innerHTML=`<div class=card><h2>Disruption</h2>
            <label>Primaries / filtration</label>${listToGroup('pf', O['Disruption'].subs['primaries_filtration'])}
            <label>General disruption</label>${listToGroup('disruption', O['Disruption'].subs['disruption'])}
          </div>`; break;
        }
        case 'Customer Actions':{ v.innerHTML=`<div class=card><h2>Customer Actions</h2>${listToGroup('customer_actions', O['Customer actions'].items)}</div>`; break; }
        case 'Assistance':{ v.innerHTML=`<div class=card><h2>Components that require assistance</h2>${listToGroup('assistance', O['Components that require assistance'].items)}</div>`; break; }
        case 'Restrictions':{ v.innerHTML=`<div class=card><h2>Restrictions to work</h2>${listToGroup('restrictions', O['Restrictions to work'].items)}</div>`; break; }
        case 'Hazards':{ v.innerHTML=`<div class=card><h2>External Hazards</h2>${listToGroup('hazards', O['External hazards'].items)}</div>`; break; }
        case 'Delivery':{ v.innerHTML=`<div class=card><h2>Delivery notes</h2>${listToGroup('delivery', O['Delivery notes'].items)}</div>`; break; }
        case 'Office':{ v.innerHTML=`<div class=card><h2>Office notes</h2>${listToGroup('office', O['Office notes'].items)}</div>`; break; }
        case 'Additional':{ v.innerHTML=`<div class=card><h2>Additional (Advice / Why's)</h2>${listToGroup('additional', O['Arse_cover_notes'].items)}</div>`; break; }
        case 'Review':{
          v.innerHTML=`<div class=card><h2>Review & Generate</h2>
            <p>Click <b>Generate</b> to fill the copy boxes (semicolon lines, no codes). Then copy & paste to Depot.</p>
            <button id=generate class="btn">Generate</button>
          </div>`;
          document.getElementById('generate').addEventListener('click', generateOutputs);
          break;
        }
      }

      // bind text inputs
      const sn=v.querySelector('#safety_notes'); if(sn){ sn.addEventListener('input',()=>State.selections.safety.notes=sn.value); }
      const ac=v.querySelector('#ac_free'); if(ac){ ac.addEventListener('input',()=>State.selections.ac_free=ac.value); }
      // radios
      v.querySelectorAll('input[type="radio"][name="existing_boiler"]').forEach(el=>el.addEventListener('change',()=>State.selections.existing_boiler=el.value));
      v.querySelectorAll('input[type="radio"][name="new_boiler"]').forEach(el=>el.addEventListener('change',()=>State.selections.new_boiler=el.value));
      // checkboxes
      v.querySelectorAll('input[type="checkbox"][data-group]').forEach(el=>{
        el.addEventListener('change',()=>{
          const g=el.getAttribute('data-group'); const arr=State.selections[g]||(State.selections[g]=[]);
          if(el.checked){ if(!arr.includes(el.value)) arr.push(el.value); } else { const i=arr.indexOf(el.value); if(i>-1) arr.splice(i,1); }
        });
      });
    }

    function stripCodePrefix(str){
      const text = String(str || '').trim();
      if (!text) return '';
      const cleaned = text.replace(/^[A-Z]{2,}\d{1,}(?:\s*[-‚Äì‚Äî:|]\s*|\s+)/i, '').trim();
      return cleaned || text;
    }

    function lines(arr){
      return (arr||[])
        .map(stripCodePrefix)
        .filter(Boolean)
        .map(x=>x+';')
        .join('\n');
    }

    function generateOutputs(){
      if (!OPTIONS_READY) return;
      const S=State.selections; const out={};
      // Need
      out['Need']=lines(S.needs||[]);
      // Working at heights
      const wah=[...(S.safety_wah||[])]; if(S.safety?.notes) wah.push(S.safety.notes); out['Working at heights']=lines(wah);
      // System characteristics
      const sys=[]; if(S.existing_boiler) sys.push(S.existing_boiler); if(S.new_boiler) sys.push(S.new_boiler); if(S.system_advice?.length) sys.push(...S.system_advice);
      // Also push plan types selected in User Controls (S uc_sc contains Y-plan/S-plan)
      if(S.uc_sc?.length) sys.push(...S.uc_sc);
      out['System characteristics']=lines(sys);
      // Assistance / Restrictions / Hazards / Delivery / Office
      out['Assistance']=lines(S.assistance||[]);
      out['Restrictions']=lines(S.restrictions||[]);
      out['Hazards']=lines(S.hazards||[]);
      out['Delivery']=lines(S.delivery||[]);
      out['Office']=lines(S.office||[]);
      // Boiler/controls
      const bc=[]; if(S.rooms?.length) bc.push(...S.rooms); if(S.uc_uc?.length) bc.push(...S.uc_uc); if(S.uc_cb?.length) bc.push(...S.uc_cb);
      out['Boiler/controls']=lines(bc);
      // Flue (combine old+new + sealing/mg we placed into new_flue group earlier)
      const flue=[...(S.old_flue||[]), ...(S.new_flue||[])]; out['Flue']=lines(flue);
      // Pipework (AC discharge + water services + free text)
      const pipe=[...(S.ac_discharge||[]), ...(S.ac_waters||[])]; if(S.ac_free) pipe.push(S.ac_free); out['Pipework']=lines(pipe);
      // Disruption (PF + radiators + DI)
      const dis=[...(S.pf||[]), ...(S.radiators||[]), ...(S.disruption||[])]; out['Disruption']=lines(dis);
      // Customer action
      out['Customer action']=lines(S.customer_actions||[]);
      // Additional (Advice ARS only, per your rule)
      out['Additional']=lines(S.additional||[]);

      // Render copy boxes in exact order
      const ORDER=['Need','Working at heights','System characteristics','Assistance','Restrictions','Hazards','Delivery','Office','Boiler/controls','Flue','Pipework','Disruption','Customer action','Additional'];
      const grid=document.getElementById('copyBoxes');
      const naturalOut={};
      ORDER.forEach(key=>{ naturalOut[key]=toNaturalLanguage(out[key]||''); });
      grid.innerHTML = ORDER.map(key=>{
        const slug = key.replace(/[^a-z0-9]+/gi,'_');
        const baseId = `box_${slug}`;
        const naturalId = `${baseId}_natural`;
        return `<div class="copybox">
          <div class="copybox-head">
            <label for="${baseId}">${key}</label>
            <div class="copybox-actions">
              <button class="btn small ghost" data-speak="${baseId}">üîä Speak</button>
              <button class="btn small" data-copy="${baseId}">Copy ${key}</button>
            </div>
          </div>
          <textarea class="tall" id="${baseId}" rows="8">${out[key]||''}</textarea>
          <div class="copybox-head natural">
            <label for="${naturalId}">${key} ‚Äî natural language</label>
            <div class="copybox-actions">
              <button class="btn small ghost" data-speak="${naturalId}">üîä Speak</button>
              <button class="btn small ghost" data-copy="${naturalId}">Copy natural</button>
            </div>
          </div>
          <textarea class="tall" id="${naturalId}" rows="6" readonly>${naturalOut[key]||''}</textarea>
        </div>`;
      }).join('');
      ORDER.forEach(key => {
        const slug = key.replace(/[^a-z0-9]+/gi,'_');
        const baseId = `box_${slug}`;
        const naturalId = `${baseId}_natural`;
        const raw = document.getElementById(baseId);
        const naturalBox = document.getElementById(naturalId);
        if (raw && naturalBox) {
          raw.addEventListener('input', () => {
            naturalBox.value = toNaturalLanguage(raw.value);
          });
        }
      });
      document.getElementById('outputs').classList.remove('hidden');
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});

      // Wire copy buttons
      setupCopyAndSpeakHandlers();

      // Generate summaries
      document.getElementById('genCustomer').onclick = ()=>{
        const t = buildCustomerSummary(out);
        document.getElementById('customerSummary').value = t;
      };
      document.getElementById('genEngineer').onclick = ()=>{
        const t = buildEngineerSummary(out);
        document.getElementById('engineerSummary').value = t;
      };
    }

    function brief(list){ return list ? list.split('\n').filter(Boolean).map(s=>s.replace(/;$/,'')).join(', ') : ''; }

    function buildCustomerSummary(out){
      const parts=[];
      const needs=brief(out['Need']); if(needs) parts.push(`What you asked for: ${needs}.`);
      const bc=brief(out['Boiler/controls']); if(bc) parts.push(`Boiler & controls: ${bc}.`);
      const sys=brief(out['System characteristics']); if(sys) parts.push(`System setup: ${sys}.`);
      const flue=brief(out['Flue']); if(flue) parts.push(`Flue changes: ${flue}.`);
      const pipe=brief(out['Pipework']); if(pipe) parts.push(`Pipework: ${pipe}.`);
      const dis=brief(out['Disruption']); if(dis) parts.push(`During the work: ${dis}.`);
      const actions=brief(out['Customer action']); if(actions) parts.push(`What we need from you: ${actions}.`);
      const add=brief(out['Additional']); if(add) parts.push(`Good to know: ${add}.`);
      return parts.join('\n');
    }

    function buildEngineerSummary(out){
      const parts=[];
      const safetyW=brief(out['Working at heights']); if(safetyW) parts.push(`Safety/WAH: ${safetyW}.`);
      const restr=brief(out['Restrictions']); if(restr) parts.push(`Restrictions: ${restr}.`);
      const haz=brief(out['Hazards']); if(haz) parts.push(`Hazards: ${haz}.`);
      const sys=brief(out['System characteristics']); if(sys) parts.push(`System: ${sys}.`);
      const bc=brief(out['Boiler/controls']); if(bc) parts.push(`Boiler/controls: ${bc}.`);
      const flue=brief(out['Flue']); if(flue) parts.push(`Flue: ${flue}.`);
      const pipe=brief(out['Pipework']); if(pipe) parts.push(`Pipework: ${pipe}.`);
      const dis=brief(out['Disruption']); if(dis) parts.push(`Disruption/works: ${dis}.`);
      const assist=brief(out['Assistance']); if(assist) parts.push(`Assistance: ${assist}.`);
      const del=brief(out['Delivery']); if(del) parts.push(`Delivery: ${del}.`);
      const off=brief(out['Office']); if(off) parts.push(`Office: ${off}.`);
      const cust=brief(out['Customer action']); if(cust) parts.push(`Customer actions: ${cust}.`);
      return parts.join('\n');
    }

    function toNaturalLanguage(text){
      return normalizeNewlines(String(text || ''))
        .split('\n')
        .map(line => line.replace(/^\s*(?:‚úÖ|‚ÜòÔ∏è)?\s*/, '').replace(/\s*;\s*$/, '').trim())
        .filter(Boolean)
        .map(sentence => {
          let clean = sentence.replace(/\s+/g,' ').trim();
          if (!clean) return '';
          clean = clean.charAt(0).toUpperCase() + clean.slice(1);
          if (!/[.!?]$/.test(clean)) clean += '.';
          return clean;
        })
        .filter(Boolean)
        .join(' ');
    }

    function setupCopyAndSpeakHandlers(){
      document.querySelectorAll('button[data-copy]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-copy');
          copyFromTextarea(id, btn);
        };
      });
      document.querySelectorAll('button[data-speak]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-speak');
          speakTextArea(id);
        };
      });
    }

    function copyFromTextarea(id, btn){
      const ta = document.getElementById(id);
      if (!ta) return;
      const text = ta.value;
      const attemptWrite = navigator.clipboard && navigator.clipboard.writeText
        ? navigator.clipboard.writeText(text)
        : Promise.reject(new Error('Clipboard API unavailable'));
      attemptWrite
        .catch(() => {
          const wasReadOnly = ta.readOnly;
          if (wasReadOnly) ta.readOnly = false;
          ta.focus();
          ta.select();
          try { document.execCommand('copy'); }
          catch (err) { console.warn('Copy fallback failed', err); }
          if (wasReadOnly) ta.readOnly = true;
        })
        .finally(() => {
          showCopied(btn);
        });
    }

    function showCopied(btn){
      if (!btn) return;
      const original = btn.dataset.originalLabel || btn.textContent;
      btn.dataset.originalLabel = original;
      btn.textContent = 'Copied ‚úì';
      setTimeout(() => { btn.textContent = btn.dataset.originalLabel || original; }, 900);
    }

    function speakTextArea(id){
      const ta = document.getElementById(id);
      if (!ta) return;
      const isNatural = ta.hasAttribute('readonly');
      const base = isNatural ? ta.value : toNaturalLanguage(ta.value);
      speakText(base || ta.placeholder || '');
    }

    function speakText(text){
      const content = String(text || '').trim();
      if (!content) return;
      if (!('speechSynthesis' in window)) {
        alert('Text to speech is not supported in this browser.');
        return;
      }
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(content);
      window.speechSynthesis.speak(utterance);
    }

    // Nav controls
    document.getElementById('prevBtn').addEventListener('click',()=>{ if(!OPTIONS_READY) return; if(State.stepIndex>0){ State.stepIndex--; render(); }});
    document.getElementById('nextBtn').addEventListener('click',()=>{ if(!OPTIONS_READY) return; if(State.stepIndex<Steps.length-1){ State.stepIndex++; render(); } else { generateOutputs(); }});
    window.addEventListener('keydown',(e)=>{ if(!OPTIONS_READY) return; if(e.key==='ArrowLeft'&&State.stepIndex>0){State.stepIndex--; render();} if(e.key==='ArrowRight'&&State.stepIndex<Steps.length-1){State.stepIndex++; render();} });

    // First render
    render();
    loadOptions();
    setupCopyAndSpeakHandlers();
  </script>
  <!-- üî• HOT WATER MODEL ADD-ON (FAST-SURVEY / DEPOT / QUOTE TOOL) -->
  <!-- Paste anywhere inside <body>. Creates window.FastSurveyHotWater for global use. -->
  <div id="hw-demo"></div>
  <script type="module">
  /* ============================================================
     HOT WATER MODEL SNAP-TO ‚Äî physics, cost & customer weighting
     v1.0 ‚Äî works in Fast-Survey / Depot / Quote Tool
     ============================================================ */
  const CP_KWH_PER_LK = 0.001163; // specific heat of water in kWh/L¬∑K

  const HW_PRESETS = {
    usage: {
      "Low (1‚Äì2 ppl)": { Vd:80, draws:12 },
      "Med (3‚Äì4 ppl)": { Vd:130, draws:18 },
      "High (5‚Äì6 ppl)":{ Vd:180, draws:24 },
    },
    mains: {
      "Winter":8, "Spring/Autumn":12, "Summer":16
    },
    layout: {
      "Central":0.35, "Typical":0.7, "Remote":1.2 // L waiting water per draw
    },
    system: {
      "Stored Gold (Worcester+Mixergy)":{
        type:"stored", standby:1.0, ctrl:0.95, Tret:48,
        comfort:92,future:95,maint:85
      },
      "Stored Standard":{
        type:"stored", standby:1.4, ctrl:1.0, Tret:52,
        comfort:88,future:80,maint:82
      },
      "Combi Standard":{
        type:"combi", start:0.01, scale:1.05, Tret:55,
        comfort:72,future:50,maint:70
      },
      "Combi Premium":{
        type:"combi", start:0.008, scale:1.0, Tret:52,
        comfort:78,future:55,maint:78
      }
    },
    price:{ gas:0.07, elec:0.22, water:0.0003 }, // ¬£/kWh, ¬£/L
    weight:{ energy:3,cost:5,comfort:4,future:4,maint:2 },
    Tuse:40
  };

  // --- helpers ---
  function etaFromReturn(T){return T<=30?0.98:T>=55?0.88:0.98-0.004*(T-30);}
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const invU=(val,best)=>clamp(100*(best/val),10,100);
  const rnd=(n,d=2)=>Math.round(n*10**d)/10**d;

  function energyCost(U,M,L,S){
    const Tu = HW_PRESETS.Tuse;
    const Vd = U.Vd;
    const Euse = Vd*CP_KWH_PER_LK*(Tu-M);
    const Vwait = L*U.draws;
    const Ewait = Vwait*CP_KWH_PER_LK*(Tu-M);
    const eta = etaFromReturn(S.Tret);
    let EkWh, pounds;
    if (S.type === "stored") {
      const Egas = ((Euse+Ewait)/eta)*S.ctrl;
      EkWh = Egas + S.standby;
      pounds = (EkWh*HW_PRESETS.price.gas)+(Vwait*HW_PRESETS.price.water);
    } else {
      const etaEff = eta/(S.scale || 1);
      const Eover = U.draws*(S.start || 0.01);
      EkWh = ((Euse+Ewait)/etaEff)+Eover;
      pounds = (EkWh*HW_PRESETS.price.gas)+(Vwait*HW_PRESETS.price.water);
    }
    return {
      raw:{kWh:EkWh,cost:pounds,wasteL:Vwait,eta},
      view:{kWh:rnd(EkWh,3),cost:rnd(pounds,2),wasteL:rnd(Vwait,1),eta:rnd(eta,3)}
    };
  }

  // --- core compute ---
  function hwCompute({usage="Med (3‚Äì4 ppl)",mains="Spring/Autumn",layout="Central",system="Stored Gold (Worcester+Mixergy)"}={}){
    const U = HW_PRESETS.usage[usage] || HW_PRESETS.usage["Med (3‚Äì4 ppl)"];
    const M = HW_PRESETS.mains[mains];
    const L = HW_PRESETS.layout[layout];
    const S = HW_PRESETS.system[system] || HW_PRESETS.system["Stored Gold (Worcester+Mixergy)"];
    if (typeof M === "undefined" || typeof L === "undefined") {
      throw new Error("Unknown mains temperature or layout preset");
    }

    const base = energyCost(U,M,L,S);
    const gold = system === "Stored Gold (Worcester+Mixergy)"
      ? base
      : energyCost(U,M,L,HW_PRESETS.system["Stored Gold (Worcester+Mixergy)"]);
    const combi = system === "Combi Premium"
      ? base
      : energyCost(U,M,L,HW_PRESETS.system["Combi Premium"]);

    const bestkWh = Math.min(gold.raw.kWh, combi.raw.kWh);
    const bestCost = Math.min(gold.raw.cost, combi.raw.cost);
    const Ue = invU(base.raw.kWh, bestkWh);
    const Uc = invU(base.raw.cost, bestCost);
    const Up = clamp(S.comfort-(layout==="Central"?0:layout==="Typical"?6:12),10,100);
    const Uf = clamp(S.future,10,100);
    const Um = clamp(S.maint,10,100);
    const W = HW_PRESETS.weight;
    const score=(W.energy*Ue+W.cost*Uc+W.comfort*Up+W.future*Uf+W.maint*Um)/
                (W.energy+W.cost+W.comfort+W.future+W.maint);

    return {
      usage,mains,layout,system,
      kWh:base.view.kWh, cost:base.view.cost,
      wasteL:base.view.wasteL,
      utilities:{energy:Ue,cost:Uc,comfort:Up,future:Uf,maint:Um,score:rnd(score,0)},
      Œ∑:base.view.eta
    };
  }

  // --- quick render card ---
  window.FastSurveyHotWater={
    compute:hwCompute,
    render:(div,opts={})=>{
      if(!div) return null;
      const r=hwCompute(opts);
      div.innerHTML=`<div class="hw-card">
        <strong>${r.system}</strong><br>
        ${r.usage} ‚Ä¢ ${r.mains} ‚Ä¢ ${r.layout}<hr>
        <b>${r.kWh}</b> kWh/day (¬£${r.cost}/day)<br>
        <small>‚âà${Math.round(r.kWh*365)} kWh/yr ‚Ä¢ ¬£${Math.round(r.cost*365)} /yr</small><br>
        Wasted water ${r.wasteL} L/day<br>
        <b>Customer score ${r.utilities.score}/100</b><br>
        <small>Œ∑ ${r.Œ∑}</small>
      </div>`;
      return r;
    }
  };
  const css=document.createElement('style');
  css.textContent=`.hw-card{border:1px solid #ccc;padding:10px;border-radius:8px;font:14px/1.4 -apple-system,Segoe UI,Roboto;}
  .hw-card hr{border:none;border-top:1px solid #eee;margin:6px 0}`;
  document.head.appendChild(css);

  // optional live demo card
  const demoTarget=document.getElementById('hw-demo');
  if(demoTarget){
    window.FastSurveyHotWater.render(
      demoTarget,
      {usage:"Med (3‚Äì4 ppl)",mains:"Spring/Autumn",layout:"Central",system:"Stored Gold (Worcester+Mixergy)"}
    );
  }
  </script>
  <!-- üî• END HOT WATER MODEL ADD-ON -->
</body>
</html>
