<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Depot Notes Picker — Rebuild</title>
<style>
  :root{--gap:10px;--pad:12px;--radius:10px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb;color:#1f2937}
  header{display:flex;gap:var(--gap);align-items:center;padding:16px var(--pad);background:#fff;position:sticky;top:0;z-index:5;border-bottom:1px solid #e5e7eb}
  .badge{background:#eef2ff;color:#4338ca;padding:2px 8px;border-radius:999px;font-size:12px}
  .hint{font-size:12px;color:#6b7280}
  .space{flex:1}
  main{display:grid;grid-template-columns:1.1fr 1fr;gap:var(--gap);padding:var(--pad)}
  @media (max-width:1100px){main{grid-template-columns:1fr}}
  section{background:#fff;border-radius:var(--radius);padding:var(--pad);box-shadow:0 1px 2px rgba(0,0,0,.05)}
  h2{margin:0 0 6px 0;font-size:18px}
  h3{margin:10px 0 6px 0;font-size:16px}
  .row{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap}
  select,input[type=text],textarea,button{font:inherit;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff}
  textarea{width:100%;min-height:120px}
  button{background:#e5e7eb;border-color:#c8ccd1;cursor:pointer}
  button.primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
  button.ghost{background:#fff}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#374151}
  .toolbar{display:flex;gap:var(--gap);align-items:center;margin:var(--gap) 0;flex-wrap:wrap}
  .list{display:grid;gap:6px;max-height:50vh;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:6px;border-radius:8px}
  .item:hover{background:#f9fafb}
  .muted{color:#6b7280}
  .divider{height:1px;background:#e5e7eb;margin:8px 0}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  @media (max-width:920px){.cols{grid-template-columns:1fr}}
  .error{background:#FEF2F2;color:#991B1B;border:1px solid #FCA5A5;padding:8px;border-radius:8px}
  .success{background:#ECFDF5;color:#065F46;border:1px solid #A7F3D0;padding:8px;border-radius:8px}
  details>summary{cursor:pointer;padding:6px;border-radius:8px;background:#f9fafb}
  .fieldhead{display:flex;gap:8px;align-items:center;justify-content:space-between}
</style>
</head>
<body>
<header>
  <strong>Depot Notes Picker</strong>
  <span class="badge">v2.6 · rebuild</span>
  <span class="hint" id="metaInfo">Loading…</span>
  <span class="space"></span>
  <button class="ghost" id="resetBtn">Reset</button>
</header>

<main>
  <!-- LEFT: Source + Picker -->
  <section>
    <h2>Source</h2>
    <div class="row" style="margin-top:6px">
      <button id="reloadBtn">Reload ./Options.txt</button>
      <input id="urlInput" type="text" placeholder="https://raw.githubusercontent.com/.../Options.txt" style="flex:1">
      <button id="loadUrlBtn" class="ghost">Load URL</button>
      <input id="fileInput" type="file" accept=".txt,.csv,.md,.conf" style="display:none">
      <button id="loadFileBtn" class="ghost">Upload file…</button>
      <button id="loadPasteBtn" class="ghost">Paste text…</button>
    </div>
    <div id="alert" style="margin-top:8px"></div>

    <div class="divider"></div>

    <h3>Picker</h3>
    <div class="toolbar">
      <label>Section</label>
      <select id="sectionSelect"></select>
      <input id="filterBox" type="text" placeholder="Filter (press / to focus)">
      <button id="selectVisibleBtn">Check all (visible)</button>
      <button id="clearSelectionBtn">Uncheck all</button>
    </div>
    <div id="itemsList" class="list" aria-label="items list"></div>

    <div class="divider"></div>
    <div class="cols">
      <div>
        <div class="row">
          <input id="quickAddText" type="text" placeholder="Quick-add custom line" style="flex:1">
          <button id="quickAddBtn" class="ghost">Add</button>
        </div>
      </div>
      <div>
        <div class="row">
          <label>Output target (optional)</label>
          <select id="outputSectionSelect"></select>
        </div>
        <div class="row">
          <button id="addCheckedTargetBtn" class="ghost">Add checked → target</button>
          <button id="addCheckedPreserveBtn" class="primary">Add checked (preserve sections)</button>
        </div>
        <div class="row">
          <button id="addVisibleTargetBtn" class="ghost">Add visible → target</button>
          <button id="addVisiblePreserveBtn" class="primary">Add visible (preserve sections)</button>
        </div>
      </div>
    </div>

    <div class="divider"></div>
    <h3>Staged (per section)</h3>
    <div id="stagingWrap" class="list"></div>

    <div class="divider"></div>
    <h3>Copy / Prompt</h3>
    <div class="row">
      <span class="pill" id="countBadge">0 lines</span>
      <label style="display:flex;align-items:center;gap:6px;margin-left:12px;">
        <input type="checkbox" id="includeHeaders" checked> Include section headers
      </label>
      <span class="space"></span>
      <button id="copyBtn" class="primary">Copy ;-lines</button>
      <button id="copyFullBtn">Copy Full Package</button>
    </div>
    <textarea id="copyBox" readonly placeholder="Your staged lines will appear here…"></textarea>
    <div class="row" style="margin-top:6px">
      <select id="promptPreset">
        <option value="customer">Customer summary (plain-English)</option>
        <option value="engineer">Depot Notes (engineer)</option>
        <option value="both" selected>Both (customer + engineer)</option>
        <option value="custom">Custom…</option>
      </select>
      <button id="buildPromptBtn">Build preview</button>
      <button id="sendToGptBtn" class="primary">Send to GPT</button>
    </div>
    <textarea id="promptBox" placeholder="Built prompt will appear here; copied before opening ChatGPT…"></textarea>
  </section>

  <!-- RIGHT: 14 Free-text fields -->
  <section>
    <h2>Free-text Notes</h2>

    <div class="fieldhead"><strong>Needs</strong><button class="ghost" data-pull="Needs">Append from staged</button></div>
    <textarea id="f_needs" placeholder="e.g. Faster hot water delivery; Quieter operation"></textarea>

    <div class="fieldhead"><strong>Describe any work involving safe access at height</strong><button class="ghost" data-pull="Restrictions to work">Append from staged</button></div>
    <textarea id="f_heights" placeholder="e.g. Ladder access; Scaffold tower – standard"></textarea>

    <div class="fieldhead"><strong>System characteristics notes</strong><button class="ghost" data-pull="System characteristics">Append from staged</button></div>
    <textarea id="f_system" placeholder="e.g. Regular boiler, gravity primaries, microbore"></textarea>

    <div class="fieldhead"><strong>Are there any components that may require assistance for removal?</strong><button class="ghost" data-pull="Components that require assistance">Append from staged</button></div>
    <textarea id="f_assistance" placeholder="e.g. Cylinder removal; Boiler double-handed lift"></textarea>

    <div class="fieldhead"><strong>List any restrictions to work areas or specific access permission required?</strong><button class="ghost" data-pull="Restrictions to work">Append from staged</button></div>
    <textarea id="f_restrictions" placeholder="e.g. Permit parking; Listed building consent"></textarea>

    <div class="fieldhead"><strong>Are there any external work areas that may prove potentially hazardous… Specific hazards?</strong><button class="ghost" data-pull="External hazards">Append from staged</button></div>
    <textarea id="f_externalhaz" placeholder="e.g. Fragile roof; Wasps; Flood risk"></textarea>

    <div class="fieldhead"><strong>Additional delivery notes</strong><button class="ghost" data-pull="Delivery notes">Append from staged</button></div>
    <textarea id="f_delivery" placeholder="e.g. Call ahead; Stairs/no lift"></textarea>

    <div class="fieldhead"><strong>Office notes</strong><button class="ghost" data-pull="Office notes">Append from staged</button></div>
    <textarea id="f_office" placeholder="e.g. Asbestos survey booking; Direct labour"></textarea>

    <div class="fieldhead"><strong>Installer notes - boiler/controls</strong><button class="ghost" data-pull="Installer notes - boiler/controls">Append from staged</button></div>
    <textarea id="f_inst_boiler" placeholder="e.g. Hive Mini; new wiring centre; location change"></textarea>

    <div class="fieldhead"><strong>Installer notes - flue</strong><button class="ghost" data-pull="Flue">Append from staged</button></div>
    <textarea id="f_inst_flue" placeholder="e.g. New hole same wall; plume kit; terminal guard"></textarea>

    <div class="fieldhead"><strong>Installer notes - gas/water</strong><button class="ghost" data-pull="Gas / Water">Append from staged</button></div>
    <textarea id="f_inst_gw" placeholder="e.g. Upsize to 22 mm; PRV; neutraliser"></textarea>

    <div class="fieldhead"><strong>Installer notes - disruption</strong><button class="ghost" data-pull="Disruption">Append from staged</button></div>
    <textarea id="f_inst_disrupt" placeholder="e.g. Floors lifted; protection required"></textarea>

    <div class="fieldhead"><strong>Installer notes - customer agreed actions</strong><button class="ghost" data-pull="Customer actions">Append from staged</button></div>
    <textarea id="f_inst_customer" placeholder="e.g. Clear areas; keep pets secure"></textarea>

    <div class="fieldhead"><strong>Installer notes - special customer requirements (incl. planned home improvements)</strong><button class="ghost" data-pull="Special requirements">Append from staged</button></div>
    <textarea id="f_inst_special" placeholder="e.g. Kitchen refit planned; retain existing TRVs"></textarea>
  </section>
</main>

<script>
/* ---------- Never-empty demo set ---------- */
const DEMO_TEXT = `
[Needs]
NE01 | Need | Better water pressure
NE02 | Need | Quieter operation

[Restrictions to work]
WAH01 | Access | Ladder access required
SR03  | Parking | Permit required

[External hazards]
EH02 | Roof | Fragile tiles

[Delivery notes]
DL07 | Contact | Call ahead on arrival

[Flue]
FN02 | New flue | New hole - same wall
FN09 | Add-on | Plume kit required

[Customer actions]
CA01 | Customer | Clear working areas
`;

/* ---------- Config & State ---------- */
const STORAGE_KEY = 'dnp_rebuild_v26';
const CANDIDATES = ['./Options.txt', './options.txt']; // tries both names
const state = { sections:{}, filter:'', currentSection:'All', output:{}, fields:{} };

/* ---------- Helpers ---------- */
const norm = s => (s||'').replace(/[–—]/g,'-').trim();
const byName = (a,b)=>a.localeCompare(b);
const setAlert = (html, cls='')=>{ const a=document.getElementById('alert'); a.className=cls; a.innerHTML=html||''; };
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({output:state.output, fields:getFieldsSnapshot()})); }catch(e){} }
function load(){ try{ const j=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); state.output=j.output||{}; if(j.fields) setFieldsFromSnapshot(j.fields);}catch(e){} }
function titleCase(s){ return s.replace(/[_\-]+/g,' ').replace(/\s+/g,' ').trim().toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()); }

/* ---------- Header aliasing to friendly buckets ---------- */
const HEADER_ALIASES = {
  // access / restrictions
  'working_at_heights':'Restrictions to work',
  'site_restrictions':'Restrictions to work',
  'restrictions_to_work':'Restrictions to work',

  // system notes
  'system_existing':'System characteristics',
  'system_characteristics':'System characteristics',

  // components assistance
  'components_specialist':'Components that require assistance',
  'components_spe-cialist':'Components that require assistance',
  'components_that_require_assistance':'Components that require assistance',

  // office/admin
  'office_admin':'Office notes',

  // installer – boiler/controls
  'boiler_location_controls':'Installer notes - boiler/controls',
  'boiler_location_-controls':'Installer notes - boiler/controls',
  'boiler_type':'Installer notes - boiler/controls',
  'user_controls':'Installer notes - boiler/controls',
  'system_config':'Installer notes - boiler/controls',
  'cupboards':'Installer notes - boiler/controls',
  'system_new':'Installer notes - boiler/controls',
  'boiler_location_/_controls':'Installer notes - boiler/controls',

  // flue
  'flue_make_good':'Flue',
  'flue_new':'Flue',
  'flue':'Flue',

  // gas / water family
  'gas_run':'Gas / Water',
  'water_services':'Gas / Water',
  'condensate':'Gas / Water',
  'discharge':'Gas / Water',
  'primaries_filtration':'Gas / Water',
  'primaries & filtration':'Gas / Water',
  'primaries':'Gas / Water',
  'gas_/_water':'Gas / Water',

  // tidy standard labels
  'delivery_logistics':'Delivery notes',
  'external_hazards':'External hazards',
  'customer_actions':'Customer actions',
  'disruption':'Disruption',
  'needs':'Needs'
};
function bucketizeHeader(raw){
  const key = raw.trim().toLowerCase().replace(/\s+/g,'_');
  return HEADER_ALIASES[key] || titleCase(raw);
}

/* ---------- Parser ---------- */
function parseOptionsText(text){
  let t=text.replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n');
  const lines=t.split('\n'); const out={}; let current=null; const hdr=/^\s*\[([^\]]+)\]\s*$/;
  for(const raw of lines){
    const line=norm(raw);
    if(!line || line.startsWith('#') || line.startsWith('//')) continue;

    const m=line.match(hdr);
    if(m){ current=bucketizeHeader(m[1].trim()); if(!out[current]) out[current]=[]; continue; }
    if(!current) continue;

    const parts=line.split('|').map(s=>s.trim());
    let code='', category='', textOut='';
    if(parts.length===1){ textOut=parts[0]; }
    else if(parts.length===2){ code=parts[0]; textOut=parts[1]; }
    else { code=parts[0]; category=parts[1]; textOut=parts.slice(2).join(' | '); }
    if(textOut){ out[current].push({code,category,text:textOut,section:current}); }
  }
  return out;
}

/* ---------- Loaders (tries both names) ---------- */
async function loadDefault(){
  setAlert('Looking for Options.txt …','hint');
  let lastErr=null;
  for(const url of CANDIDATES){
    try{
      const res=await fetch(url+(url.includes('?')?'&':'?')+'nocache='+Date.now());
      if(!res.ok) throw new Error('HTTP '+res.status);
      const raw=await res.text();
      const secs=parseOptionsText(raw);
      if(!Object.keys(secs).length) throw new Error('Parsed 0 sections');
      setSections(secs, `Loaded ${Object.values(secs).reduce((n,a)=>n+a.length,0)} items from ${url}`, false);
      return;
    }catch(e){ lastErr=e; }
  }
  const secs=parseOptionsText(DEMO_TEXT);
  setSections(secs, `Could not fetch Options.txt (${lastErr?.message||'unknown'}). Using demo set.`, true);
}
async function loadFromUrl(url){
  setAlert('Loading…','hint');
  try{
    const res=await fetch(url+(url.includes('?')?'&':'?')+'nocache='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw=await res.text();
    const secs=parseOptionsText(raw);
    if(!Object.keys(secs).length) throw new Error('Parsed 0 sections');
    setSections(secs, `Loaded ${Object.values(secs).reduce((n,a)=>n+a.length,0)} items from URL.`, false);
  }catch(err){ setAlert(`Failed to load from URL: <code>${url}</code><br>${err.message}`,'error'); }
}
function loadFromFile(file){
  const r=new FileReader();
  r.onload=()=>{ try{
    const secs=parseOptionsText(String(r.result||'')); if(!Object.keys(secs).length) throw new Error('Parsed 0 sections');
    setSections(secs, `Loaded ${Object.values(secs).reduce((n,a)=>n+a.length,0)} items from file.`, false);
  }catch(e){ setAlert('File parse error: '+e.message,'error'); } };
  r.readAsText(file);
}
function loadFromPaste(){
  const t=prompt('Paste your Options.txt content:'); if(!t) return;
  try{
    const secs=parseOptionsText(t); if(!Object.keys(secs).length) throw new Error('Parsed 0 sections');
    setSections(secs, `Loaded ${Object.values(secs).reduce((n,a)=>n+a.length,0)} items from pasted text.`, false);
  }catch(e){ setAlert('Paste parse error: '+e.message,'error'); }
}
function setSections(sections, msg, warn){
  state.sections=sections; state.currentSection='All';
  populateDropdowns(); renderItems(); renderStaging(); renderCopy();
  document.getElementById('metaInfo').textContent =
    `Sections: ${Object.keys(sections).length} · Items: ${Object.values(sections).reduce((n,a)=>n+a.length,0)}`;
  setAlert(msg, warn?'error':'success');
}

/* ---------- Picker UI ---------- */
function populateDropdowns(){
  const sel=document.getElementById('sectionSelect'); sel.innerHTML='';
  const all=document.createElement('option'); all.value='All'; all.textContent='All'; sel.appendChild(all);
  Object.keys(state.sections).sort(byName).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
  sel.value='All';
  const outSel=document.getElementById('outputSectionSelect'); outSel.innerHTML='';
  Object.keys(state.sections).sort(byName).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; outSel.appendChild(o); });
}
function visibleItems(){
  const filter=(state.filter||'').toLowerCase(); let items=[];
  if(state.currentSection==='All'){ for(const k of Object.keys(state.sections)) items=items.concat(state.sections[k]); }
  else items=state.sections[state.currentSection]||[];
  return items.filter(it=>{
    if(!filter) return true;
    return (`${it.code} ${it.category} ${it.text} ${it.section}`.toLowerCase()).includes(filter);
  });
}
function renderItems(){
  const box=document.getElementById('itemsList'); box.innerHTML='';
  const vis=visibleItems();
  if(!vis.length){ const e=document.createElement('div'); e.className='hint'; e.style.padding='8px'; e.textContent='No items match your filter.'; box.appendChild(e); return; }
  vis.forEach(it=>{
    const row=document.createElement('div'); row.className='item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.payload=JSON.stringify(it);
    const label=document.createElement('div');
    label.innerHTML=`<div><strong>${it.text}</strong></div><div class="muted">${it.section}${it.category?' • '+it.category:''}${it.code?' • '+it.code:''}</div>`;
    const plus=document.createElement('button'); plus.className='ghost'; plus.textContent='＋';
    plus.onclick=()=>{ pushToOutput(it.section, it); renderStaging(); renderCopy(); };
    row.appendChild(cb); row.appendChild(label); row.appendChild(plus); box.appendChild(row);
  });
}

/* ---------- Output staging ---------- */
function pushToOutput(section, it){
  if(!state.output[section]) state.output[section]=[];
  if(!state.output[section].some(x=>x.text===it.text&&x.code===it.code&&x.category===it.category))
    state.output[section].push({text:it.text, code:it.code||'', category:it.category||''});
  save();
}
function pushManyPreserve(items){ items.forEach(it=> pushToOutput(it.section, it)); }
function pushManyTarget(items,target){ items.forEach(it=> pushToOutput(target, it)); }
function move(section, idx, dir){
  const a=state.output[section]; const j=idx+dir; if(!a||j<0||j>=a.length) return; [a[idx],a[j]]=[a[j],a[idx]]; save();
}
function removeItem(section, idx){
  const a=state.output[section]; if(!a) return; a.splice(idx,1); if(!a.length) delete state.output[section]; save();
}
function renderStaging(){
  const wrap=document.getElementById('stagingWrap'); wrap.innerHTML='';
  const names=Object.keys(state.output).sort(byName);
  if(!names.length){ const e=document.createElement('div'); e.className='hint'; e.style.padding='8px'; e.textContent='Nothing staged yet.'; wrap.appendChild(e); return; }
  names.forEach(name=>{
    const head=document.createElement('div'); head.className='row'; head.style.margin='4px 0'; head.innerHTML=`<strong>${name}</strong> <span class="pill">${(state.output[name]||[]).length}</span>`;
    wrap.appendChild(head);
    (state.output[name]||[]).forEach((it,i)=>{
      const row=document.createElement('div'); row.className='item';
      row.appendChild(document.createElement('div'));
      const label=document.createElement('div');
      label.innerHTML=`<div><strong>${it.text}</strong></div><div class="muted">${it.category?it.category+' • ':''}${it.code||''}</div>`;
      const actions=document.createElement('div');
      const up=document.createElement('button'); up.textContent='↑'; up.onclick=()=>{move(name,i,-1); renderStaging(); renderCopy();};
      const down=document.createElement('button'); down.textContent='↓'; down.onclick=()=>{move(name,i,1); renderStaging(); renderCopy();};
      const del=document.createElement('button'); del.textContent='×'; del.onclick=()=>{removeItem(name,i); renderStaging(); renderCopy();};
      actions.appendChild(up); actions.appendChild(down); actions.appendChild(del);
      row.appendChild(label); row.appendChild(actions); wrap.appendChild(row);
    });
  });
}

/* ---------- Copy builders ---------- */
function renderCopy(){
  const includeHeaders=document.getElementById('includeHeaders').checked;
  let lines=[]; const names=Object.keys(state.output).sort(byName);
  names.forEach(name=>{
    const items=state.output[name]||[]; if(!items.length) return;
    if(includeHeaders) lines.push(`${name}:`);
    items.forEach(it=>lines.push(`${it.text};`));
    if(includeHeaders) lines.push('');
  });
  document.getElementById('copyBox').value=lines.join('\n');
  const total=names.reduce((n,k)=>n+(state.output[k]?.length||0),0);
  document.getElementById('countBadge').textContent=`${total} line${total===1?'':'s'}`;
}
function buildFullPackage(){
  const base=document.getElementById('copyBox').value.trim();
  const F=getFieldsSnapshot();
  const blocks=[
    base,'','--- Free-text fields ---',
    `Needs:\n${F.f_needs||''}`,
    `Safe access at height:\n${F.f_heights||''}`,
    `System characteristics notes:\n${F.f_system||''}`,
    `Assistance for removal:\n${F.f_assistance||''}`,
    `Restrictions / permissions:\n${F.f_restrictions||''}`,
    `External hazards:\n${F.f_externalhaz||''}`,
    `Additional delivery notes:\n${F.f_delivery||''}`,
    `Office notes:\n${F.f_office||''}`,
    `Installer notes - boiler/controls:\n${F.f_inst_boiler||''}`,
    `Installer notes - flue:\n${F.f_inst_flue||''}`,
    `Installer notes - gas/water:\n${F.f_inst_gw||''}`,
    `Installer notes - disruption:\n${F.f_inst_disrupt||''}`,
    `Installer notes - customer agreed actions:\n${F.f_inst_customer||''}`,
    `Installer notes - special requirements:\n${F.f_inst_special||''}`,
  ];
  return blocks.join('\n');
}

/* ---------- Prompt Builder + Send to GPT ---------- */
function notesGrouped(){
  return Object.keys(state.output).sort(byName).map(sec=>{
    const lines=(state.output[sec]||[]).map(it=>`- ${it.text}`).join('\n');
    return `${sec}:\n${lines}`;
  }).join('\n\n');
}
function fieldsBlock(){
  const F=getFieldsSnapshot();
  const map=[
    ['Needs',F.f_needs],
    ['Safe access at height',F.f_heights],
    ['System characteristics notes',F.f_system],
    ['Assistance for removal',F.f_assistance],
    ['Restrictions / permissions',F.f_restrictions],
    ['External hazards',F.f_externalhaz],
    ['Additional delivery notes',F.f_delivery],
    ['Office notes',F.f_office],
    ['Installer notes - boiler/controls',F.f_inst_boiler],
    ['Installer notes - flue',F.f_inst_flue],
    ['Installer notes - gas/water',F.f_inst_gw],
    ['Installer notes - disruption',F.f_inst_disrupt],
    ['Installer notes - customer agreed actions',F.f_inst_customer],
    ['Installer notes - special requirements',F.f_inst_special],
  ];
  return map.map(([k,v])=>`${k}:\n${v||''}`).join('\n\n');
}
function buildPrompt(preset){
  const grouped = notesGrouped() || '(no staged selections)';
  const freeForm = fieldsBlock();
  const baseCustomer =
`Turn these boiler survey notes + free-text into a concise customer summary (plain English bullets; no jargon; call out safety and permissions clearly).
Selections:
${grouped}

Free-text:
${freeForm}`;
  const baseEngineer =
`Turn these inputs into semicolon-separated Depot Notes grouped by section. Preserve technical specifics (flue clearances, gas upgrades, PRV/condensate) and include safety/access.
Output only semicolon lines for the notes; ignore headings.
Selections:
${grouped}

Free-text (fold into appropriate sections):
${freeForm}`;
  const baseBoth =
`Produce two parts from these inputs:

1) CUSTOMER SUMMARY — plain-English bullets; no jargon; highlight safety/permissions.
2) DEPOT NOTES — semicolon-separated lines grouped by section; technical detail preserved.

Selections:
${grouped}

Free-text (fold into relevant sections):
${freeForm}`;
  switch(preset){
    case 'customer': return baseCustomer;
    case 'engineer': return baseEngineer;
    case 'both':     return baseBoth;
    default:         return document.getElementById('promptBox').value || baseBoth;
  }
}
async function sendToGPT(){
  const preset=document.getElementById('promptPreset').value;
  const prompt=buildPrompt(preset);
  const box=document.getElementById('promptBox'); box.value=prompt;
  try{ await navigator.clipboard.writeText(prompt); }catch(e){
    const ta=document.createElement('textarea'); ta.value=prompt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }
  window.open('https://chat.openai.com/', '_blank', 'noopener');
  setAlert('Prompt copied to clipboard. ChatGPT opened — paste (Cmd/Ctrl+V).','success');
}

/* ---------- Fields & Append-from-staged ---------- */
const FIELD_IDS=['f_needs','f_heights','f_system','f_assistance','f_restrictions','f_externalhaz','f_delivery','f_office','f_inst_boiler','f_inst_flue','f_inst_gw','f_inst_disrupt','f_inst_customer','f_inst_special'];
function getFieldsSnapshot(){ const o={}; FIELD_IDS.forEach(id=> o[id]=document.getElementById(id).value); return o; }
function setFieldsFromSnapshot(snap){ FIELD_IDS.forEach(id=>{ if(id in snap){ const el=document.getElementById(id); if(el) el.value=snap[id]; } }); }
function appendText(id, text){ const el=document.getElementById(id); if(!el) return; el.value=(el.value?el.value.trim()+'\n':'')+text.trim(); }
const PULL_MAP = new Map([
  ['Needs','f_needs'],
  ['Restrictions to work','f_heights'],
  ['External hazards','f_externalhaz'],
  ['Delivery notes','f_delivery'],
  ['Office notes','f_office'],
  ['Installer notes - boiler/controls','f_inst_boiler'],
  ['Flue','f_inst_flue'],
  ['Gas / Water','f_inst_gw'], // virtual merge handled below
  ['Disruption','f_inst_disrupt'],
  ['Customer actions','f_inst_customer'],
  ['Special requirements','f_inst_special'],
  ['System characteristics','f_system'],
  ['Components that require assistance','f_assistance'],
]);

/* ---------- Boot & Events ---------- */
async function boot(){
  load();
  await loadDefault();
  wireUI();
}
function wireUI(){
  // loaders
  document.getElementById('reloadBtn').onclick=()=>loadDefault();
  document.getElementById('loadUrlBtn').onclick=()=>{ const u=document.getElementById('urlInput').value.trim(); if(u) loadFromUrl(u); };
  document.getElementById('loadFileBtn').onclick=()=>document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange=e=>{ const f=e.target.files?.[0]; if(f) loadFromFile(f); e.target.value=''; };
  document.getElementById('loadPasteBtn').onclick=()=>loadFromPaste();

  // picker
  document.getElementById('sectionSelect').onchange=e=>{ state.currentSection=e.target.value; renderItems(); };
  document.getElementById('filterBox').oninput=e=>{ state.filter=e.target.value||''; renderItems(); };
  window.addEventListener('keydown',e=>{ if(e.key==='/'){ e.preventDefault(); document.getElementById('filterBox').focus(); } });
  document.getElementById('selectVisibleBtn').onclick=()=>{ Array.from(document.querySelectorAll('#itemsList input[type=checkbox]')).forEach(cb=>cb.checked=true); };
  document.getElementById('clearSelectionBtn').onclick=()=>{ Array.from(document.querySelectorAll('#itemsList input[type=checkbox]')).forEach(cb=>cb.checked=false); };

  // add flows
  document.getElementById('addCheckedTargetBtn').onclick=()=>{
    const target=document.getElementById('outputSectionSelect').value||'General';
    const cbs=Array.from(document.querySelectorAll('#itemsList input[type=checkbox]:checked'));
    if(!cbs.length) return;
    pushManyTarget(cbs.map(cb=>JSON.parse(cb.dataset.payload)), target);
    cbs.forEach(cb=>cb.checked=false);
    renderStaging(); renderCopy(); save();
  };
  document.getElementById('addCheckedPreserveBtn').onclick=()=>{
    const cbs=Array.from(document.querySelectorAll('#itemsList input[type=checkbox]:checked'));
    if(!cbs.length) return;
    pushManyPreserve(cbs.map(cb=>JSON.parse(cb.dataset.payload)));
    cbs.forEach(cb=>cb.checked=false);
    renderStaging(); renderCopy(); save();
  };
  document.getElementById('addVisibleTargetBtn').onclick=()=>{
    const items=visibleItems(); if(!items.length) return;
    const target=document.getElementById('outputSectionSelect').value||'General';
    pushManyTarget(items, target);
    renderStaging(); renderCopy(); save();
  };
  document.getElementById('addVisiblePreserveBtn').onclick=()=>{
    const items=visibleItems(); if(!items.length) return;
    pushManyPreserve(items);
    renderStaging(); renderCopy(); save();
  };
  document.getElementById('quickAddBtn').onclick=()=>{
    const v=norm(document.getElementById('quickAddText').value); if(!v) return;
    if(!state.output.Custom) state.output.Custom=[]; state.output.Custom.push({text:v,code:'',category:'Custom'});
    document.getElementById('quickAddText').value=''; save(); renderStaging(); renderCopy();
  };

  // copy & prompt
  document.getElementById('includeHeaders').onchange=()=>renderCopy();
  document.getElementById('copyBtn').onclick=()=>{
    const ta=document.getElementById('copyBox'); ta.select(); ta.setSelectionRange(0,999999);
    try{ navigator.clipboard.writeText(ta.value); }catch(e){ document.execCommand('copy'); }
  };
  document.getElementById('copyFullBtn').onclick=()=>{
    const full=buildFullPackage();
    const ta=document.createElement('textarea'); ta.value=full; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    setAlert('Full package copied (semicolon lines + all free-text fields).','success');
  };
  document.getElementById('promptPreset').onchange=()=>{ if(document.getElementById('promptPreset').value!=='custom') document.getElementById('promptBox').value=''; };
  document.getElementById('buildPromptBtn').onclick=()=>{ document.getElementById('promptBox').value = buildPrompt(document.getElementById('promptPreset').value); };
  document.getElementById('sendToGptBtn').onclick=()=>sendToGPT();

  // reset
  document.getElementById('resetBtn').onclick=()=>{ localStorage.removeItem(STORAGE_KEY); location.href = location.pathname+'?reset='+Date.now(); };

  // append-from-staged
  document.querySelectorAll('button[data-pull]').forEach(btn=>{
    btn.onclick=()=>{
      const src=btn.getAttribute('data-pull');
      // special merge for Gas / Water
      if(src==='Gas / Water'){
        const mergeNames=['Gas / Water','Gas run','Water services','Condensate','Discharge','Primaries & Filtration','Primaries','Primaries & filtration'];
        const merged=[];
        mergeNames.forEach(n=>{ const arr=state.output[n]||state.output[n.replace('&','and')]||[]; merged.push(...arr); });
        const text = merged.map(it=>it.text+';').join('\n');
        appendText('f_inst_gw', text); save(); return;
      }
      const targetId = PULL_MAP.get(src);
      const items=(state.output[src]||[]).map(it=>it.text+';').join('\n');
      if(!targetId){ setAlert(`No staged section named “${src}” to pull.`, 'error'); return; }
      appendText(targetId, items); save();
    };
  });

  // persist fields
  FIELD_IDS.forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input', ()=>save()); });
}

boot();
</script>
</body>
</html>