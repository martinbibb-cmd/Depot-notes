<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0d10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Depot Notes ‚Äì Quick Survey</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #151a1f;
      --ink: #e9eef5;
      --muted: #9fb0c2;
      --accent: #4aa3ff;
      --border: #1f2630;
      --banner: #0f3c80;
      --bannerText: #e9eef5;
      --copyBtn: #4aa3ff;
      --copyInk: #081018;
    }
    html[data-theme="light"] {
      --bg: #f6f9fc;
      --panel: #ffffff;
      --ink: #0b0d10;
      --muted: #5a6b7d;
      --accent: #246bff;
      --border: #dde6f0;
      --banner: #e8f1ff;
      --bannerText: #113366;
      --copyBtn: #246bff;
      --copyInk: #ffffff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 15px/1.45 ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px clamp(12px,4vw,24px);
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 5;
      flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 18px; }
    .tag {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: var(--accent);
      border: none;
      color: var(--copyInk);
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn.ghost { background: transparent; color: var(--ink); border: 1px solid var(--border); }
    .btn.small { padding: 6px 10px; font-weight: 600; }
    .switch { display: flex; align-items: center; gap: 6px; }
    .switch input { accent-color: var(--accent); }
    nav#steps {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0 auto 12px;
      width: clamp(280px, 96%, 960px);
      overflow-x: auto;
      padding: 0 clamp(12px,4vw,24px) 6px;
    }
    nav#steps::-webkit-scrollbar { height: 6px; }
    nav#steps::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }
    .step {
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
    }
    .step.active {
      color: var(--ink);
      border-color: #2a3b50;
      background: linear-gradient(0deg, rgba(74,163,255,0.12), rgba(74,163,255,0));
    }
    main#view {
      padding: 16px clamp(12px,4vw,24px);
      flex: 1;
      width: clamp(280px, 96%, 960px);
      margin: 0 auto 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }
    label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); }
    .list { display: grid; gap: 8px; }
    .opt {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: transparent;
      cursor: pointer;
    }
    .opt input { width: auto; }
    footer.page {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      padding: 12px clamp(12px,4vw,24px);
      border-top: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      bottom: 0;
      z-index: 5;
    }
    .info { color: var(--muted); font-size: 13px; }
    .outputs { padding: 16px clamp(12px,4vw,24px); border-top: 1px solid var(--border); width: clamp(280px,96%,960px); margin: 0 auto 32px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap: 16px; }
    .copybox { display: flex; flex-direction: column; gap: 8px; }
    textarea {
      width: 100%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--ink);
      padding: 10px;
      border-radius: 10px;
      min-height: 110px;
      resize: vertical;
    }
    .hidden { display: none !important; }
    @media (max-width: 960px) {
      header { justify-content: flex-start; }
      .right { width: 100%; justify-content: flex-start; }
      footer.page { flex-direction: column; align-items: flex-start; }
    }
    @media (max-width: 640px) {
      header { position: static; }
      footer.page { position: static; }
      main#view { padding-block: 12px; }
    }
  </style>
  <noscript><div style="background:#ffb4b4;color:#300;padding:12px">This page needs JavaScript. Open in a browser and ensure JS is enabled.</div></noscript>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <h1>Depot Notes</h1>
      <span class="tag">Quick Survey</span>
      <span class="info">Rapid capture for boiler surveys</span>
    </div>
    <div class="right">
      <a href="welcome.html" class="btn ghost">üè† Welcome</a>
      <div class="switch"><input type="checkbox" id="themeToggle"><label for="themeToggle">Light mode</label></div>
      <button id="prevBtn" class="btn ghost">‚óÄ Back</button>
      <button id="nextBtn" class="btn">Next ‚ñ∂</button>
    </div>
  </header>

  <nav id="steps"></nav>
  <main id="view"></main>

  <footer class="page">
    <div class="info">Selections auto-fill the copy boxes. Go to Summary to copy into Depot.</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="jumpSummary" class="btn ghost">Skip to Summary</button>
    </div>
  </footer>

  <section id="outputs" class="outputs hidden">
    <h2>Depot Copy Boxes</h2>
    <div class="grid" id="copyBoxes"></div>
  </section>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch((err) => {
          console.error('Service worker registration failed:', err);
        });
      });
    }
  </script>
  <script>
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme() {
      const pref = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', pref);
      themeToggle.checked = (pref === 'light');
    }
    themeToggle.addEventListener('change', () => {
      const next = themeToggle.checked ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme();
    });
    applyTheme();

    const Steps = [
      { id: 'currentBoiler', title: 'Current Boiler Type', options: [
        'Regular', 'System', 'Combi', 'Storage combi', 'Warm air', 'Multi point'
      ]},
      { id: 'currentFlue', title: 'Current Flue', options: [
        'Balanced', 'Fanned', 'Side', 'Chimney', 'Extended', 'Horizontal', 'Vertical / pitched / flat', 'Rear', 'None'
      ]},
      { id: 'currentCylinder', title: 'Current Cylinder', options: [
        'Open vented', 'Unvented', 'Thermal store', 'Combi cylinder', 'Fortic', 'None'
      ]},
      { id: 'systemIssues', title: 'System Issues', options: [
        'Micro bore', 'Under floor heating', '1 pipe', 'Passivated'
      ]},
      { id: 'newBoiler', title: 'New Boiler', options: [
        'Regular', 'System', 'Combi'
      ]},
      { id: 'newFlue', title: 'New Flue', options: [
        'Turret side', 'Turret rear', 'Direct rear', 'Extended', 'Vertical pitched / flat', 'Plume kit'
      ]},
      { id: 'newCylinder', title: 'New Cylinder', options: [
        'Open vented', 'Open vented Mixergy', 'Unvented', 'Unvented Mixergy', 'Existing', 'N/A'
      ]},
      { id: 'safety', title: 'Safety & Site Considerations', options: [
        'Ladders', 'Roof', 'Scaffolding', 'Pets', 'Clutter', 'Hygiene'
      ]},
      { id: 'summary', title: 'Summary' }
    ];

    const OUTPUTS = [
      { id: 'currentBoiler', label: 'Current Boiler Type' },
      { id: 'currentFlue', label: 'Current Flue' },
      { id: 'currentCylinder', label: 'Current Cylinder' },
      { id: 'systemIssues', label: 'System Issues' },
      { id: 'newBoiler', label: 'New Boiler' },
      { id: 'newFlue', label: 'New Flue' },
      { id: 'newCylinder', label: 'New Cylinder' },
      { id: 'safety', label: 'Safety' }
    ];

    const State = {
      stepIndex: 0,
      selections: OUTPUTS.reduce((acc, item) => { acc[item.id] = []; return acc; }, {})
    };

    const stepNav = document.getElementById('steps');
    const view = document.getElementById('view');
    const outputsSection = document.getElementById('outputs');
    const copyGrid = document.getElementById('copyBoxes');

    copyGrid.innerHTML = OUTPUTS.map(({ id, label }) => {
      const safeId = 'copy_' + id;
      return `<div class="copybox">`+
        `<label for="${safeId}">${label}</label>`+
        `<textarea id="${safeId}" data-out="${id}" rows="6"></textarea>`+
        `<button class="btn small" data-copy="${safeId}">Copy ${label}</button>`+
      `</div>`;
    }).join('');

    function toLines(list) {
      return (list || []).map(v => v + ';').join('\n');
    }

    function enforceNoneRule(groupId, changedValue, checked) {
      const arr = State.selections[groupId];
      const noneValues = ['None', 'N/A'];
      if (noneValues.includes(changedValue)) {
        if (checked) {
          State.selections[groupId] = [changedValue];
          return true;
        }
        return false;
      }
      if (checked) {
        let mutated = false;
        const idx = arr.indexOf('None');
        if (idx > -1) { arr.splice(idx, 1); mutated = true; }
        const idxNA = arr.indexOf('N/A');
        if (idxNA > -1) { arr.splice(idxNA, 1); mutated = true; }
        return mutated;
      }
      return false;
    }

    function updateOutputs() {
      OUTPUTS.forEach(({ id }) => {
        const textarea = document.querySelector(`textarea[data-out="${id}"]`);
        if (textarea) textarea.value = toLines(State.selections[id]);
      });
    }

    function renderSteps() {
      stepNav.innerHTML = Steps.map((step, index) => {
        const active = index === State.stepIndex ? 'active' : '';
        return `<span class="step ${active}" data-index="${index}">${index + 1}. ${step.title}</span>`;
      }).join('');
      stepNav.querySelectorAll('.step').forEach(el => {
        el.addEventListener('click', () => {
          State.stepIndex = Number(el.dataset.index);
          render();
        });
      });
    }

    function render() {
      renderSteps();
      const step = Steps[State.stepIndex];
      document.getElementById('prevBtn').disabled = State.stepIndex === 0;
      document.getElementById('nextBtn').textContent = State.stepIndex === Steps.length - 1 ? 'Finish' : 'Next ‚ñ∂';

      if (step.id === 'summary') {
        view.innerHTML = `<div class="card"><h2>Summary</h2><p class="info">Review your selections and use the copy buttons below to paste into Depot.</p></div>`;
        outputsSection.classList.remove('hidden');
        updateOutputs();
      } else {
        outputsSection.classList.add('hidden');
        view.innerHTML = `<div class="card"><h2>${step.title}</h2>${renderOptions(step)}</div>`;
        bindCheckboxes(step.id);
      }
    }

    function renderOptions(step) {
      return `<div class="list">${step.options.map(option => {
        const checked = State.selections[step.id].includes(option) ? 'checked' : '';
        const inputId = `${step.id}_${option.replace(/[^a-z0-9]+/gi, '').toLowerCase()}`;
        return `<label class="opt" for="${inputId}"><input id="${inputId}" type="checkbox" value="${option}" data-group="${step.id}" ${checked}> ${option}</label>`;
      }).join('')}</div>`;
    }

    function bindCheckboxes(groupId) {
      view.querySelectorAll('input[type="checkbox"][data-group="' + groupId + '"]').forEach(input => {
        input.addEventListener('change', (event) => {
          const value = event.target.value;
          const checked = event.target.checked;
          const needsRefresh = enforceNoneRule(groupId, value, checked);
          if (!Array.isArray(State.selections[groupId])) {
            State.selections[groupId] = [];
          }
          if (checked) {
            const list = State.selections[groupId];
            if (!list.includes(value)) list.push(value);
          } else {
            const list = State.selections[groupId];
            const index = list.indexOf(value);
            if (index > -1) list.splice(index, 1);
          }
          updateOutputs();
          if (needsRefresh) {
            render();
          }
        });
      });
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (State.stepIndex > 0) {
        State.stepIndex--;
        render();
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (State.stepIndex < Steps.length - 1) {
        State.stepIndex++;
        render();
      } else {
        outputsSection.classList.remove('hidden');
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }
    });

    document.getElementById('jumpSummary').addEventListener('click', () => {
      State.stepIndex = Steps.length - 1;
      render();
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    document.querySelectorAll('button[data-copy]').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.getAttribute('data-copy');
        const textarea = document.getElementById(id);
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        try {
          document.execCommand('copy');
          const original = button.textContent;
          button.textContent = 'Copied ‚úì';
          setTimeout(() => button.textContent = original, 900);
        } catch (err) {
          console.error('Copy failed', err);
        }
      });
    });

    updateOutputs();
    render();
  </script>
</body>
</html>
