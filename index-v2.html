<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0d10" />
<link rel="manifest" href="manifest.webmanifest" />
<title>Depot Notes Picker ‚Äì Clean Copy</title>
<style>
  :root { --bg:#0b0d10; --panel:#151a1f; --ink:#e9eef5; --muted:#98a5b3; --accent:#4aa3ff; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:14px 16px;border-bottom:1px solid #1f2630;background:#0e1318;display:flex;gap:12px;align-items:center}
  h1{font-size:16px;margin:0 8px 0 0;font-weight:600}
  main{display:grid;grid-template-columns: 320px 1fr 420px;gap:14px;padding:14px;height:calc(100% - 58px);grid-auto-rows:minmax(0,auto)}
  .card{background:var(--panel);border:1px solid #1f2630;border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2630;font-size:14px;font-weight:600}
  .pad{padding:12px 14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,input,button,textarea{border-radius:10px;border:1px solid #2a3644;background:#0f141a;color:var(--ink);padding:8px 10px;font:inherit}
  button{background:#152233;border-color:#2d4156;cursor:pointer}
  button:hover{background:#1b2a3b}
  button.accent{background:var(--accent);border-color:#2a73cc;color:#081019}
  small{color:var(--muted)}
  .list{overflow:auto}
  ul.checks{list-style:none;margin:0;padding:0}
  ul.checks li{padding:8px 10px;border-bottom:1px solid #1f2630;display:flex;gap:8px}
  .split{display:grid;grid-template-columns: 1fr;gap:10px}
  .outbox{display:flex;flex-direction:column;gap:8px;height:100%;overflow:auto}
  .out{display:flex;flex-direction:column;gap:10px;border:1px solid #243041;border-radius:12px;padding:10px;background:#0e141a}
  .out header{display:flex;justify-content:space-between;align-items:center;background:transparent;border:0;padding:0}
  .out textarea{width:100%;min-height:120px;resize:vertical;background:#0a0f14;border:1px solid #1d2834;border-radius:8px;padding:8px;color:var(--ink);white-space:pre-wrap}
  .out .alt{display:flex;flex-direction:column;gap:6px}
  .out .alt-head{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
  .out .alt-head strong{color:var(--ink);font-size:13px}
  .out .alt textarea{background:#0b1016;color:var(--ink)}
  .out .actions{display:flex;gap:6px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
  .pill{padding:4px 8px;border:1px solid #2d3a49;border-radius:999px;background:#0c1117;color:#var(--muted);font-size:12px}
  .sticky{position:sticky;top:0;background:var(--panel);z-index:1}
  .full{grid-column:1 / -1} /* full-width card spanning all columns */
  .footrow{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  a.link{color:#b8d7ff;text-decoration:none}
  a.home-link{margin-left:auto;display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid #2d3644;background:transparent;color:var(--ink);font-weight:600;text-decoration:none}
  a.home-link:hover{background:#152233;border-color:#355074}
  /* Let child flex items actually shrink inside grid/flex parents */
  main, .card, .pad { min-height: 0; }

  /* Make ‚Äúsplit‚Äù columns stack and allow the list to take remaining height */
  .split { display: flex; flex-direction: column; gap: 10px; min-height: 0; }

  /* The checkbox list becomes a flex-grow area with its own scrollbar */
  .list {
    flex: 1;                /* take remaining space */
    min-height: 0;          /* allow shrinking */
    overflow: auto;         /* enable scrolling */
    -webkit-overflow-scrolling: touch; /* smooth iOS scrolling */
  }

  /* Optional: tiny right padding so the scrollbar doesn‚Äôt cover labels */
  ul.checks { padding-right: 6px; }

  .hw-panel{display:flex;flex-direction:column;gap:12px}
  .hw-panel p{margin:0;color:var(--muted);font-size:13px}
  .hw-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
  .hw-controls label{display:flex;flex-direction:column;gap:6px;font-weight:600;color:var(--ink)}
  .hw-controls select{background:#0f141a;border:1px solid #2a3644;color:var(--ink);padding:8px;border-radius:10px;font:inherit}
  .hw-summary{color:var(--muted);font-size:13px}
  .hw-summary strong{color:var(--ink)}
  .hw-footnote{color:var(--muted);font-size:12px;margin:0}
  .hw-preview .hw-card{background:#0e141a;border-color:#243041;color:var(--ink)}
  .hw-preview .hw-card small{color:var(--muted)}
  .col3{grid-column:3}
  .refined-water{display:flex;flex-direction:column;gap:12px}
  .refined-water p{margin:0;color:var(--muted);font-size:13px}
  .refined-water strong{color:var(--ink)}
  .rw-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .rw-controls label{display:flex;flex-direction:column;gap:6px;font-weight:600;color:var(--ink)}
  .rw-controls select{background:#0f141a;border:1px solid #2a3644;color:var(--ink);padding:8px;border-radius:10px;font:inherit}
  .rw-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .rw-card{border:1px solid #243041;border-radius:12px;padding:12px;background:#0e141a;display:flex;flex-direction:column;gap:10px}
  .rw-card.best{border-color:var(--accent);box-shadow:0 0 0 1px rgba(74,163,255,0.35)}
  .rw-card-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .rw-score{font:700 20px/1.1 ui-sans-serif;color:var(--accent)}
  .rw-meta{color:var(--muted);font-size:12px}
  .rw-stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin:0;padding:0}
  .rw-stats div{border:1px solid #1f2630;border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:4px;background:#0b1016}
  .rw-stats dt{margin:0;font-weight:600;font-size:12px;color:var(--muted)}
  .rw-stats dd{margin:0;font-weight:600;color:var(--ink);font-size:14px}
  .rw-chips{display:flex;flex-wrap:wrap;gap:6px}
  .rw-chip{padding:4px 8px;border:1px solid #1f2630;border-radius:999px;background:#0b1016;color:var(--muted);font-size:12px}
  .rw-chip strong{color:var(--ink);font-weight:600}
  .rw-summary{color:var(--muted);font-size:13px}
  .rw-footnote{color:var(--muted);font-size:12px;margin:0}
</style>
</head>
<body>
<header>
  <h1>Depot Notes Picker ‚Äî Clean Copy</h1>
  <span class="pill">Spaces/newlines are copied as plain text (no %20)</span>
  <a class="home-link" href="welcome.html">üè† Back to welcome</a>
</header>

<main>
  <!-- LEFT: Source & Filters -->
  <section class="card">
    <h2 class="sticky">Source & Filters</h2>
    <div class="pad split">
      <div class="row">
        <button id="reloadBtn">Reload Options.txt</button>
        <small id="loadStatus">Waiting to load‚Ä¶</small>
      </div>
      <label class="row" style="align-items:stretch;gap:8px">
        <span class="pill">Section</span>
        <select id="srcSection" style="flex:1"></select>
      </label>
      <label class="row" style="align-items:stretch;gap:8px">
        <span class="pill">Search</span>
        <input id="filter" placeholder="Type to filter‚Ä¶" />
      </label>
      <div class="list">
        <ul id="items" class="checks"></ul>
      </div>
      <div class="row">
        <button id="selectAll">Select visible</button>
        <button id="clearAll">Clear</button>
      </div>
    </div>
  </section>

  <!-- MIDDLE: Send selections -->
  <section class="card">
    <h2 class="sticky">Send selection to Depot section</h2>
    <div class="pad">
      <div class="row">
        <select id="destSection"></select>
        <button class="accent" id="send">‚ûï Add selected to section</button>
      </div>
      <small>Tip: You can add to any section. Each line will be prefixed with <strong>‚úÖ</strong> and end with a <strong>;</strong> automatically.</small>
      <hr style="border:0;border-top:1px solid #1f2630;margin:12px 0">
      <div class="grid2">
        <button id="addNote">Add manual note to chosen section</button>
        <button id="removeDupes">Clean duplicates in chosen section</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: Outputs -->
  <section class="card">
    <h2 class="sticky">Depot Sections ‚Äî Copy as Plain Text</h2>
    <div class="pad outbox" id="outputs"></div>
  </section>

  <section class="card col3">
    <h2 class="sticky">Hot water model quick compare</h2>
    <div class="pad hw-panel" data-hot-water-widget>
      <p>Combine typical usage, mains temperature, pipe layout and boiler type to see cost, wasted water and customer score.</p>
      <div class="hw-controls">
        <label>Usage<select data-hw-control="usage"></select></label>
        <label>Mains temperature<select data-hw-control="mains"></select></label>
        <label>Layout<select data-hw-control="layout"></select></label>
        <label>System<select data-hw-control="system"></select></label>
      </div>
      <div class="hw-preview" data-hw-preview></div>
      <div class="hw-summary" data-hw-summary></div>
      <p class="hw-footnote">Fast Survey and Quote Tool use the same physics-backed defaults for parity.</p>
    </div>
  </section>

  <!-- FULL-WIDTH: Customer Summary via GPT -->
  <section class="card full">
    <h2 class="sticky">Customer Summary (GPT)</h2>
    <div class="pad" style="display:flex;flex-direction:column;gap:10px">
      <div class="footrow">
        <div class="row" style="gap:8px">
          <button class="accent" id="genSummary">‚ú® Generate summary with GPT</button>
          <button id="copySummary">Copy (plain text)</button>
          <button id="speakSummary">üîä Speak</button>
        </div>
        <small class="muted" id="summaryStatus">Ready</small>
      </div>
      <textarea id="summaryBox" placeholder="Click ‚ÄúGenerate summary with GPT‚Äù to create a clean, customer-friendly summary."></textarea>
    </div>
  </section>
  <section class="card full">
    <h2 class="sticky">Refined hot water model</h2>
    <div class="pad refined-water" data-refined-water>
      <p>Compare every hot water system family with the same physics-backed defaults used across Depot, Fast Survey and the full model.</p>
      <div class="rw-controls">
        <label>Usage<select data-rw-control="usage"></select></label>
        <label>Mains temperature<select data-rw-control="mains"></select></label>
        <label>Layout<select data-rw-control="layout"></select></label>
      </div>
      <div class="rw-cards" data-rw-cards></div>
      <div class="rw-summary" data-rw-summary></div>
      <p class="rw-footnote">Scores combine energy, running cost, comfort, future readiness and maintenance weighting.</p>
    </div>
  </section>
</main>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch((err) => {
      console.error('Service worker registration failed:', err);
    });
  });
}
</script>
<script>
/* -------------------- Config for GPT summary call --------------------
   Point this to your Cloudflare Worker / API that wraps OpenAI.
   Expected response: JSON containing { summary: "..." } or { text: "..." }.
   If the call fails, we fall back to a basic local stitch.
--------------------------------------------------------------------- */
const CONFIG = {
  SUMMARY_URL: 'https://survey-brain-api.martinbibb.workers.dev/api/recommend', // ‚Üê adjust if needed
  MAX_WORDS: 220
};

/* -------------------- Driven by Options.txt -------------------- */
let OPTIONS = {};        // { sectionTitle: [{code, label, note, line}] }
let SECTION_ORDER = [];  // preserves order seen in Options.txt

/* -------------------- UI refs -------------------- */
const els = {
  srcSection: document.getElementById('srcSection'),
  destSection: document.getElementById('destSection'),
  items: document.getElementById('items'),
  filter: document.getElementById('filter'),
  send: document.getElementById('send'),
  outputs: document.getElementById('outputs'),
  reloadBtn: document.getElementById('reloadBtn'),
  selectAll: document.getElementById('selectAll'),
  clearAll: document.getElementById('clearAll'),
  addNote: document.getElementById('addNote'),
  removeDupes: document.getElementById('removeDupes'),
  loadStatus: document.getElementById('loadStatus'),
  // summary
  genSummary: document.getElementById('genSummary'),
  copySummary: document.getElementById('copySummary'),
  speakSummary: document.getElementById('speakSummary'),
  summaryBox: document.getElementById('summaryBox'),
  summaryStatus: document.getElementById('summaryStatus'),
};
function setStatus(s){ els.loadStatus.textContent = s; }
function setSummaryStatus(s){ els.summaryStatus.textContent = s; }

/* -------------------- Load & parse Options.txt -------------------- */
async function loadOptionsTxt() {
  setStatus("Loading Options.txt‚Ä¶");
  OPTIONS = {}; SECTION_ORDER = [];
  try {
    const res = await fetch('./Options.txt', { cache: "no-store" });
    if (!res.ok) throw new Error("Options.txt not found");
    const txt = await res.text();
    parseOptions(txt);
    setStatus("Loaded Options.txt");
  } catch (err) {
    console.warn("Failed loading Options.txt ‚Äî using minimal fallback", err);
    const fallback = `
[Overview of proposed work]
OV01 | Overview | Example item
[Boiler and controls]
BL01 | Boiler | Example boiler item
[Notes]
NOTE | Example free text
`;
    parseOptions(fallback);
    setStatus("Fallback loaded (Options.txt missing)");
  }
  populateFromOptions();
}

function parseOptions(text) {
  let current = "General";
  ensureSection(current);
  text.split(/\r?\n/).forEach(raw => {
    const line = raw.trim();
    if (!line) return;
    const sectMatch = line.match(/^\[(.+)\]$/i);
    if (sectMatch) {
      current = sectMatch[1].trim();
      ensureSection(current);
      return;
    }
    let code="", body="";
    if (line.includes("|")) {
      const parts = line.split("|").map(s => s.trim());
      if (parts.length >= 2) {
        code = parts[0];
        body = parts.slice(1).join(" | ");
      } else {
        body = line;
      }
    } else {
      body = line;
    }
    const cleanBody = body.replace(/\s+/g, " ").trim();
    const labelText = (code ? `${code} ‚Äî ${cleanBody}` : cleanBody);
    OPTIONS[current].push({
      code,
      label: labelText,
      note: cleanBody,
      line
    });
  });
}

function ensureSection(title){
  if (!(title in OPTIONS)) {
    OPTIONS[title] = [];
    SECTION_ORDER.push(title);
  } else if (!SECTION_ORDER.includes(title)) {
    SECTION_ORDER.push(title);
  }
}

/* -------------------- Build UI from OPTIONS -------------------- */
function populateFromOptions() {
  els.srcSection.innerHTML = "";
  SECTION_ORDER.forEach(s => els.srcSection.add(new Option(s, s)));
  els.destSection.innerHTML = "";
  SECTION_ORDER.forEach(s => els.destSection.add(new Option(s, s)));
  renderOutputs();
  renderItemList();
}

function renderItemList() {
  const sect = els.srcSection.value || SECTION_ORDER[0];
  const query = (els.filter.value || '').toLowerCase();
  const list = OPTIONS[sect] || [];
  const filtered = list.filter(x => {
    if (!query) return true;
    const haystack = [x.label, x.code, x.note]
      .filter(Boolean)
      .join(" \u2022 ")
      .toLowerCase();
    return haystack.includes(query);
  });
  els.items.innerHTML = filtered.map((x, i) => `
    <li>
      <input type="checkbox" id="chk_${i}" data-text="${htmlAttr(x.note)}" data-code="${htmlAttr(x.code || '')}" />
      <label for="chk_${i}">${escapeHtml(x.label)}</label>
    </li>
  `).join("");
}

function renderOutputs() {
  els.outputs.innerHTML = SECTION_ORDER.map(name => outTemplate(name)).join("");
  SECTION_ORDER.forEach(name => {
    const id = idify(name);
    const raw = document.getElementById('out_' + id);
    if (raw) {
      raw.addEventListener('input', () => updateNatural(id));
      updateNatural(id);
    }
  });
}

function setOutValue(id, text) {
  const raw = document.getElementById('out_' + id);
  if (!raw) return;
  raw.value = text;
  updateNatural(id);
}

function updateNatural(id) {
  const raw = document.getElementById('out_' + id);
  const natural = document.getElementById('out_' + id + '_natural');
  if (!raw || !natural) return;
  natural.value = toNaturalLanguage(raw.value);
}

function toNaturalLanguage(text) {
  return normalizeNewlines(String(text || ''))
    .split('\n')
    .map(line => stripIconAndSemicolon(line).trim())
    .filter(Boolean)
    .map(sentence => {
      let clean = sentence.replace(/\s+/g, ' ').trim();
      if (!clean) return '';
      clean = clean.charAt(0).toUpperCase() + clean.slice(1);
      if (!/[.!?]$/.test(clean)) clean += '.';
      return clean;
    })
    .filter(Boolean)
    .join(' ');
}

function outTemplate(name){
  const id = idify(name);
  return `
  <div class="out" data-section="${id}">
    <header>
      <strong>${escapeHtml(name)}</strong>
      <span class="actions">
        <button onclick="speakOut('${id}', false)">üîä Speak</button>
        <button onclick="copyOut('${id}')">Copy (plain text)</button>
        <button onclick="clearOut('${id}')">Clear</button>
      </span>
    </header>
    <textarea id="out_${id}" placeholder="Items you add to ‚Äò${escapeHtml(name)}‚Äô will appear here‚Ä¶"></textarea>
    <div class="alt">
      <div class="alt-head">
        <strong>Natural language</strong>
        <span class="actions">
          <button onclick="speakOut('${id}', true)">üîä Speak</button>
          <button onclick="copyOutNatural('${id}')">Copy natural</button>
        </span>
      </div>
      <textarea id="out_${id}_natural" readonly placeholder="Natural language version appears here automatically."></textarea>
    </div>
  </div>`;
}

/* -------------------- Actions -------------------- */
els.srcSection.addEventListener('change', renderItemList);
els.filter.addEventListener('input', renderItemList);
els.reloadBtn.addEventListener('click', loadOptionsTxt);

els.selectAll.addEventListener('click', () => {
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = true);
});
els.clearAll.addEventListener('click', () => {
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
});

els.send.addEventListener('click', () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  if (!out) return;
  const selected = Array.from(els.items.querySelectorAll('input[type=checkbox]:checked'))
    .map(chk => chk.dataset.text);
  if (selected.length === 0) { alert('Select at least one item.'); return; }
  const lines = selected.map(t => formatLine(t));
  const existing = normalizeNewlines(out.value).trim();
  setOutValue(outId, [existing, ...lines].filter(Boolean).join('\n'));
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
  out.focus();
});

els.addNote.addEventListener('click', async () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  const note = prompt("Manual note to add to ‚Äú" + dest + "‚Äù:");
  if (!note) return;
  const line = formatLine(note);
  const existing = normalizeNewlines(out.value).trim();
  setOutValue(outId, [existing, line].filter(Boolean).join('\n'));
  out.focus();
});

els.removeDupes.addEventListener('click', () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  const seen = new Set();
  const cleaned = normalizeNewlines(out.value)
    .split('\n').map(s => s.trim()).filter(Boolean)
    .filter(s => {
      const key = stripIconAndSemicolon(s).toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key); return true;
    }).join('\n');
  setOutValue(outId, cleaned);
  out.focus();
});

/* -------------------- COPY (plain text, no %20) -------------------- */
function copyOut(id){
  const ta = document.getElementById('out_' + id);
  if (!ta) return;
  let text = normalizeNewlines(ta.value)
    .split('\n').map(s => s.trim()).filter(Boolean)
    // normalise any legacy lines (‚ÜòÔ∏è, missing ;) to the new format
    .map(s => `‚úÖ ${stripIconAndSemicolon(s)};`)
    .join('\n');
  text = text.replace(/%20/g, ' ').replace(/%0A/gi, '\n').replace(/\r\n/g, '\n');
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => { ta.value = text; updateNatural(id); ta.focus(); ta.select(); document.execCommand('copy'); flash(ta,'Copied ‚úì'); });
}

function copyOutNatural(id){
  const ta = document.getElementById('out_' + id + '_natural');
  if (!ta) return;
  const text = ta.value.trim();
  if (!text) { flash(ta, 'Nothing to copy'); return; }
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => {
      const wasReadOnly = ta.readOnly;
      ta.readOnly = false;
      ta.focus();
      ta.select();
      document.execCommand('copy');
      ta.readOnly = wasReadOnly;
      flash(ta,'Copied ‚úì');
    });
}

function clearOut(id){
  const ta = document.getElementById('out_' + id);
  if (ta) setOutValue(id, '');
}

function speakOut(id, natural=false){
  const ta = document.getElementById('out_' + id + (natural ? '_natural' : ''));
  if (!ta) return;
  const base = natural ? ta.value : normalizeNewlines(ta.value)
    .split('\n')
    .map(line => stripIconAndSemicolon(line).trim())
    .filter(Boolean)
    .join('\n');
  const text = natural ? base : toNaturalLanguage(base);
  speakText(text);
}

function speakText(text){
  const content = String(text || '').trim();
  if (!content) return;
  if (!('speechSynthesis' in window)) {
    alert('Text to speech is not supported in this browser.');
    return;
  }
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(content);
  window.speechSynthesis.speak(utterance);
}

/* -------------------- GPT SUMMARY -------------------- */
/* Collects all right-hand boxes as { Section: "text\n..." }, with ‚úÖ removed */
function collectDepotSections(stripIcons=true){
  const sections = {};
  SECTION_ORDER.forEach(name => {
    const id = 'out_' + idify(name);
    const ta = document.getElementById(id);
    if (!ta) return;
    const raw = normalizeNewlines(ta.value).trim();
    if (!raw) return;
    const lines = raw.split('\n').map(s => s.trim()).filter(Boolean)
      .map(s => stripIcons ? stripIconAndSemicolon(s) : s);
    if (lines.length) sections[name] = lines.join('\n');
  });
  return sections;
}

async function generateSummary(){
  const btn = els.genSummary;
  const box = els.summaryBox;
  const sections = collectDepotSections(true);
  if (Object.keys(sections).length === 0) {
    alert('Add some notes to the depot sections first.');
    return;
  }

  btn.disabled = true; setSummaryStatus('Summarising‚Ä¶'); box.placeholder = 'Generating summary‚Ä¶';

  const payload = {
    task: 'customer_summary',
    style: 'plain_english, concise, friendly, no jargon, UK spelling, reply as short sentences, no bullet points',
    instructions: 'Provide a clear explanation made up of 2-4 plain English sentences. Avoid bullet points, numbering, headings, colons, or lists. Keep the tone warm and reassuring.',
    max_words: CONFIG.MAX_WORDS,
    sections,
    mode: 'summary'
  };

  try {
    const res = await fetch(CONFIG.SUMMARY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('Bad response: ' + res.status);
    const data = await res.json();

    const summary = String(
      data.summary ?? data.text ?? data.result ?? data.output ?? ''
    ).trim();

    if (summary) {
      box.value = normalizeNewlines(summary);
      setSummaryStatus('Done ‚úì');
    } else {
      box.value = localFallbackSummary(sections);
      setSummaryStatus('Done (fallback) ‚úì');
    }
  } catch (err) {
    console.warn('Summary generation failed:', err);
    box.value = localFallbackSummary(sections);
    setSummaryStatus('Offline fallback used');
  } finally {
    btn.disabled = false;
  }
}

/* Simple offline fallback so the button still does something usable */
function localFallbackSummary(sections){
  const order = [
    'Overview of proposed work','Needs','Boiler and controls','Flue','Pipe',
    'System characteristics','Restrictions','Hazards','Delivery','Office','Notes'
  ];
  const prefixes = {
    'Overview of proposed work': 'The proposed work covers',
    'Needs': 'We noted that',
    'Boiler and controls': 'For the boiler and controls,',
    'Flue': 'Flue considerations include',
    'Pipe': 'Pipework points include',
    'System characteristics': 'System characteristics show',
    'Restrictions': 'Key restrictions are',
    'Hazards': 'Safety points include',
    'Delivery': 'Delivery arrangements involve',
    'Office': 'Office follow-up needs',
    'Notes': 'Additional notes mention'
  };
  const sentences = [];
  const seen = new Set();

  const toSentence = (label, bits) => {
    const body = bits.filter(Boolean).slice(0, 3).map(b => b.replace(/;$/, '').trim());
    if (!body.length) return '';
    const prefix = prefixes[label] || `Regarding ${label.toLowerCase()},`;
    const message = `${prefix} ${body.join(', ')}`.replace(/\s+/g, ' ').trim();
    if (!message) return '';
    const finalMessage = /[.!?]$/.test(message) ? message : `${message}.`;
    return finalMessage;
  };

  const pushSentence = (label, text) => {
    const bits = text.split('\n')
      .map(s => s.replace(/^[-‚Ä¢‚úÖ‚ÜòÔ∏è]\s*/, '').trim())
      .filter(Boolean)
      .filter(b => {
        const key = b.toLowerCase();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    const sentence = toSentence(label, bits);
    if (sentence) sentences.push(sentence);
  };

  const keys = Object.keys(sections);
  order.concat(keys.filter(k => !order.includes(k))).forEach(k => {
    if (sections[k]) pushSentence(k, sections[k]);
  });

  return sentences.slice(0, 5).join(' ');
}

/* Copy summary as plain text */
function copySummary(){
  const ta = els.summaryBox;
  let text = normalizeNewlines(ta.value).trim();
  text = text.replace(/%20/g, ' ').replace(/%0A/gi, '\n').replace(/\r\n/g, '\n');
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => { ta.focus(); ta.select(); document.execCommand('copy'); flash(ta,'Copied ‚úì'); });
}

/* Wire up summary buttons */
els.genSummary.addEventListener('click', generateSummary);
els.copySummary.addEventListener('click', copySummary);
if (els.speakSummary) {
  els.speakSummary.addEventListener('click', () => {
    const text = normalizeNewlines(els.summaryBox.value).split('\n').map(s => s.trim()).filter(Boolean).join(' ');
    speakText(text || els.summaryBox.placeholder || '');
  });
}

/* -------------------- Helpers -------------------- */
function idify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function htmlAttr(s){ return s.replace(/"/g,'&quot;'); }
function normalizeNewlines(s){ return String(s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n'); }

/* Normalise content by stripping any leading icon (‚úÖ or legacy ‚ÜòÔ∏è) and any trailing semicolon */
function stripIconAndSemicolon(s){
  return String(s || '')
    .replace(/^\s*(?:‚úÖ|‚ÜòÔ∏è)?\s*/,'') // remove either icon if present
    .replace(/\s*;?\s*$/,'')        // remove any trailing semicolon and surrounding space
    .trim();
}

/* Always format to: "‚úÖ <text>;" */
function formatLine(s){
  const clean = stripIconAndSemicolon(String(s || '').replace(/\s+/g,' '));
  return clean ? `‚úÖ ${clean};` : '';
}

function flash(el, msg){ const was = el.placeholder; el.placeholder = msg; setTimeout(()=>{ el.placeholder = was; }, 1200); }

/* -------------------- Kickoff -------------------- */
loadOptionsTxt();
</script>
<!-- üî• HOT WATER MODEL ADD-ON (FAST-SURVEY / DEPOT / QUOTE TOOL) -->
<!-- Paste anywhere inside <body>. Creates window.FastSurveyHotWater for global use. -->
<script type="module">
/* ============================================================
   HOT WATER MODEL SNAP-TO ‚Äî physics, cost & customer weighting
   v1.0 ‚Äî works in Fast-Survey / Depot / Quote Tool
   ============================================================ */
const CP_KWH_PER_LK = 0.001163; // specific heat of water in kWh/L¬∑K

const HW_PRESETS = {
  usage: {
    "Low (1‚Äì2 ppl)": { Vd:80, draws:12 },
    "Med (3‚Äì4 ppl)": { Vd:130, draws:18 },
    "High (5‚Äì6 ppl)":{ Vd:180, draws:24 },
  },
  mains: {
    "Winter":8, "Spring/Autumn":12, "Summer":16
  },
  layout: {
    "Central":0.35, "Typical":0.7, "Remote":1.2 // L waiting water per draw
  },
  system: {
    "Stored Gold (Worcester+Mixergy)":{
      type:"stored", standby:1.0, ctrl:0.95, Tret:48,
      comfort:92,future:95,maint:85
    },
    "Stored Standard":{
      type:"stored", standby:1.4, ctrl:1.0, Tret:52,
      comfort:88,future:80,maint:82
    },
    "Combi Standard":{
      type:"combi", start:0.01, scale:1.05, Tret:55,
      comfort:72,future:50,maint:70
    },
    "Combi Premium":{
      type:"combi", start:0.008, scale:1.0, Tret:52,
      comfort:78,future:55,maint:78
    }
  },
  price:{ gas:0.07, elec:0.22, water:0.0003 }, // ¬£/kWh, ¬£/L
  weight:{ energy:3,cost:5,comfort:4,future:4,maint:2 },
  Tuse:40
};

// --- helpers ---
function etaFromReturn(T){return T<=30?0.98:T>=55?0.88:0.98-0.004*(T-30);}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const invU=(val,best)=>clamp(100*(best/val),10,100);
const rnd=(n,d=2)=>Math.round(n*10**d)/10**d;

function energyCost(U,M,L,S){
  const Tu = HW_PRESETS.Tuse;
  const Vd = U.Vd;
  const Euse = Vd*CP_KWH_PER_LK*(Tu-M);
  const Vwait = L*U.draws;
  const Ewait = Vwait*CP_KWH_PER_LK*(Tu-M);
  const eta = etaFromReturn(S.Tret);
  let EkWh, pounds;
  if (S.type === "stored") {
    const Egas = ((Euse+Ewait)/eta)*S.ctrl;
    EkWh = Egas + S.standby;
    pounds = (EkWh*HW_PRESETS.price.gas)+(Vwait*HW_PRESETS.price.water);
  } else {
    const etaEff = eta/(S.scale || 1);
    const Eover = U.draws*(S.start || 0.01);
    EkWh = ((Euse+Ewait)/etaEff)+Eover;
    pounds = (EkWh*HW_PRESETS.price.gas)+(Vwait*HW_PRESETS.price.water);
  }
  return {
    raw:{kWh:EkWh,cost:pounds,wasteL:Vwait,eta},
    view:{kWh:rnd(EkWh,3),cost:rnd(pounds,2),wasteL:rnd(Vwait,1),eta:rnd(eta,3)}
  };
}

// --- core compute ---
function hwCompute({usage="Med (3‚Äì4 ppl)",mains="Spring/Autumn",layout="Central",system="Stored Gold (Worcester+Mixergy)"}={}){
  const U = HW_PRESETS.usage[usage] || HW_PRESETS.usage["Med (3‚Äì4 ppl)"];
  const M = HW_PRESETS.mains[mains];
  const L = HW_PRESETS.layout[layout];
  const S = HW_PRESETS.system[system] || HW_PRESETS.system["Stored Gold (Worcester+Mixergy)"];
  if (typeof M === "undefined" || typeof L === "undefined") {
    throw new Error("Unknown mains temperature or layout preset");
  }

  const base = energyCost(U,M,L,S);
  const gold = system === "Stored Gold (Worcester+Mixergy)"
    ? base
    : energyCost(U,M,L,HW_PRESETS.system["Stored Gold (Worcester+Mixergy)"]);
  const combi = system === "Combi Premium"
    ? base
    : energyCost(U,M,L,HW_PRESETS.system["Combi Premium"]);

  const bestkWh = Math.min(gold.raw.kWh, combi.raw.kWh);
  const bestCost = Math.min(gold.raw.cost, combi.raw.cost);
  const Ue = invU(base.raw.kWh, bestkWh);
  const Uc = invU(base.raw.cost, bestCost);
  const Up = clamp(S.comfort-(layout==="Central"?0:layout==="Typical"?6:12),10,100);
  const Uf = clamp(S.future,10,100);
  const Um = clamp(S.maint,10,100);
  const W = HW_PRESETS.weight;
  const score=(W.energy*Ue+W.cost*Uc+W.comfort*Up+W.future*Uf+W.maint*Um)/
              (W.energy+W.cost+W.comfort+W.future+W.maint);

  return {
    usage,mains,layout,system,
    kWh:base.view.kWh, cost:base.view.cost,
    wasteL:base.view.wasteL,
    utilities:{energy:Ue,cost:Uc,comfort:Up,future:Uf,maint:Um,score:rnd(score,0)},
    Œ∑:base.view.eta
  };
}

// --- quick render card ---
window.FastSurveyHotWater={
  compute:hwCompute,
  render:(div,opts={})=>{
    if(!div) return null;
    const r=hwCompute(opts);
    div.innerHTML=`<div class="hw-card">
      <strong>${r.system}</strong><br>
      ${r.usage} ‚Ä¢ ${r.mains} ‚Ä¢ ${r.layout}<hr>
      <b>${r.kWh}</b> kWh/day (¬£${r.cost}/day)<br>
      <small>‚âà${Math.round(r.kWh*365)} kWh/yr ‚Ä¢ ¬£${Math.round(r.cost*365)} /yr</small><br>
      Wasted water ${r.wasteL} L/day<br>
      <b>Customer score ${r.utilities.score}/100</b><br>
      <small>Œ∑ ${r.Œ∑}</small>
    </div>`;
    return r;
  }
};
window.FastSurveyHotWater.PRESETS = HW_PRESETS;
const css=document.createElement('style');
css.textContent=`.hw-card{border:1px solid #ccc;padding:10px;border-radius:8px;font:14px/1.4 -apple-system,Segoe UI,Roboto;}
.hw-card hr{border:none;border-top:1px solid #eee;margin:6px 0}`;
document.head.appendChild(css);

const fillSelect=(select, entries, preferred)=>{
  if(!select) return;
  const list=Array.from(entries || []);
  select.innerHTML=list.map(key=>`<option value="${key}">${key}</option>`).join('');
  if(preferred && list.includes(preferred)){
    select.value=preferred;
  } else if(list.length){
    select.value=list[0];
  }
};

const UTIL_LABELS={
  energy:'Energy',
  cost:'Running cost',
  comfort:'Comfort',
  future:'Future-ready',
  maint:'Maintenance'
};
const UTIL_ORDER=['energy','cost','comfort','future','maint'];

function renderRefinedCard(result, highlight){
  if(!result) return '';
  const chips=UTIL_ORDER.map(key=>{
    const val=result.utilities?.[key];
    if(typeof val==='undefined') return '';
    return `<span class="rw-chip"><strong>${Math.round(val)}</strong> ${UTIL_LABELS[key]}</span>`;
  }).filter(Boolean).join('');
  const annualKwh=Math.round((result.kWh||0)*365);
  const annualCost=Math.round((result.cost||0)*365);
  return `<article class="rw-card${highlight?' best':''}">
    <div class="rw-card-head">
      <strong>${escapeHtml(result.system)}</strong>
      <span class="rw-score">${result.utilities?.score ?? ''}/100</span>
    </div>
    <div class="rw-meta">${escapeHtml(result.usage)} ‚Ä¢ ${escapeHtml(result.mains)} mains ‚Ä¢ ${escapeHtml(result.layout)}</div>
    <dl class="rw-stats">
      <div><dt>Energy</dt><dd>${result.kWh.toFixed(2)} kWh/day</dd></div>
      <div><dt>Cost</dt><dd>¬£${result.cost.toFixed(2)}/day</dd></div>
      <div><dt>Water</dt><dd>${result.wasteL.toFixed(1)} L/day</dd></div>
      <div><dt>Annual</dt><dd>${annualKwh} kWh ¬∑ ¬£${annualCost}</dd></div>
    </dl>
    <div class="rw-chips">${chips}</div>
  </article>`;
}

function initHotWaterWidget(){
  const panel=document.querySelector('[data-hot-water-widget]');
  if(!panel) return;
  const usageSel=panel.querySelector('[data-hw-control="usage"]');
  const mainsSel=panel.querySelector('[data-hw-control="mains"]');
  const layoutSel=panel.querySelector('[data-hw-control="layout"]');
  const systemSel=panel.querySelector('[data-hw-control="system"]');
  const preview=panel.querySelector('[data-hw-preview]');
  const summary=panel.querySelector('[data-hw-summary]');

  fillSelect(usageSel, Object.keys(HW_PRESETS.usage), 'Med (3‚Äì4 ppl)');
  fillSelect(mainsSel, Object.keys(HW_PRESETS.mains), 'Spring/Autumn');
  fillSelect(layoutSel, Object.keys(HW_PRESETS.layout), 'Typical');
  fillSelect(systemSel, Object.keys(HW_PRESETS.system), 'Stored Gold (Worcester+Mixergy)');

  const describeDelta=(value, unit)=>{
    const amount=Math.abs(value).toFixed(2);
    if(Number.isNaN(value) || !isFinite(value) || amount==='0.00') return `similar ${unit}`;
    return value>0 ? `${amount} ${unit} more` : `${amount} ${unit} less`;
  };

  const update=()=>{
    const opts={
      usage:usageSel?.value,
      mains:mainsSel?.value,
      layout:layoutSel?.value,
      system:systemSel?.value
    };
    const result=window.FastSurveyHotWater.render(preview, opts);
    if(!result || !summary) return;
    const compareSystem=opts.system && opts.system.startsWith('Combi')
      ? 'Stored Gold (Worcester+Mixergy)'
      : 'Combi Premium';
    const alt=window.FastSurveyHotWater.compute({...opts, system:compareSystem});
    const costDelta=alt.cost - result.cost;
    const kwhDelta=alt.kWh - result.kWh;
    const costText=costDelta>0
      ? `${compareSystem} saves about ¬£${Math.abs(costDelta).toFixed(2)} per day versus this pick.`
      : costDelta<0
        ? `${compareSystem} costs about ¬£${Math.abs(costDelta).toFixed(2)} per day more than this pick.`
        : `${compareSystem} has a similar daily cost.`;
    const energyText=`Energy use is ${describeDelta(kwhDelta,'kWh/day')} compared with ${compareSystem}.`;
    summary.innerHTML=`<strong>${result.utilities.score}/100</strong> customer score ¬∑ ${result.kWh.toFixed(2)} kWh/day (¬£${result.cost.toFixed(2)}/day) ¬∑ ${result.wasteL.toFixed(1)} L waiting water/day.<br>${energyText} ${costText}`;
  };

  [usageSel,mainsSel,layoutSel,systemSel].forEach(sel=>{
    if(sel) sel.addEventListener('change',update);
  });

  update();
}

initHotWaterWidget();
function initRefinedWaterMiniApp(){
  const host=document.querySelector('[data-refined-water]');
  if(!host) return;
  const compute=window.FastSurveyHotWater?.compute;
  const presets=window.FastSurveyHotWater?.PRESETS;
  if(typeof compute!=='function' || !presets) return;

  const usageSel=host.querySelector('[data-rw-control="usage"]');
  const mainsSel=host.querySelector('[data-rw-control="mains"]');
  const layoutSel=host.querySelector('[data-rw-control="layout"]');
  const cards=host.querySelector('[data-rw-cards]');
  const summary=host.querySelector('[data-rw-summary]');

  const usageKeys=Object.keys(presets.usage);
  const mainsKeys=Object.keys(presets.mains);
  const layoutKeys=Object.keys(presets.layout);
  fillSelect(usageSel, usageKeys, 'Med (3‚Äì4 ppl)');
  fillSelect(mainsSel, mainsKeys, 'Spring/Autumn');
  fillSelect(layoutSel, layoutKeys, 'Typical');

  const systems=Object.keys(presets.system);

  const update=()=>{
    const base={
      usage:usageSel?.value || usageKeys[0],
      mains:mainsSel?.value || mainsKeys[0],
      layout:layoutSel?.value || layoutKeys[0]
    };
    const results=systems.map(system=>{
      try {
        return compute({...base, system});
      } catch(err){
        console.warn('Refined water model failed', system, err);
        return null;
      }
    }).filter(Boolean);

    if(cards){
      const best=results.reduce((acc, curr)=>{
        const score=curr?.utilities?.score ?? -Infinity;
        const bestScore=acc?.utilities?.score ?? -Infinity;
        return score>bestScore ? curr : acc;
      }, null);
      cards.innerHTML=results.map(res=>renderRefinedCard(res, best && res.system===best.system)).join('');
    }

    if(summary){
      if(!results.length){
        summary.textContent='Adjust the inputs to generate a comparison.';
        return;
      }
      const sorted=[...results].sort((a,b)=>{
        const as=a?.utilities?.score ?? -Infinity;
        const bs=b?.utilities?.score ?? -Infinity;
        return bs-as;
      });
      const best=sorted[0];
      const runner=sorted[1];
      if(!best){
        summary.textContent='Adjust the inputs to generate a comparison.';
        return;
      }
      let diffText='';
      if(runner){
        const pointGap=Math.round((best.utilities?.score ?? 0)-(runner.utilities?.score ?? 0));
        const costDelta=(runner.cost ?? 0)-(best.cost ?? 0);
        const costAbs=Math.abs(costDelta);
        const costText=costAbs<0.005
          ? 'a similar running cost'
          : `¬£${costAbs.toFixed(2)} ${costDelta>0?'more':'less'} per day`;
        const pointText=pointGap>0
          ? `${pointGap} points lower`
          : pointGap<0
            ? `${Math.abs(pointGap)} points higher`
            : 'matching score';
        diffText=` Next best is <strong>${escapeHtml(runner.system)}</strong> at ${runner.utilities.score}/100 (${pointText}) with ${costText}.`;
      }
      summary.innerHTML=`Top pick: <strong>${escapeHtml(best.system)}</strong> scores ${best.utilities.score}/100 ‚Äî ${best.kWh.toFixed(2)} kWh/day (¬£${best.cost.toFixed(2)}/day) and ${best.wasteL.toFixed(1)} L waiting water/day.${diffText}`;
    }
  };

  [usageSel,mainsSel,layoutSel].forEach(sel=>{
    if(sel) sel.addEventListener('change', update);
  });

  update();
}

initRefinedWaterMiniApp();
</script>
<!-- üî• END HOT WATER MODEL ADD-ON -->
</body>
</html>