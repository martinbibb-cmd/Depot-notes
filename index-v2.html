<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0d10" />
<link rel="manifest" href="manifest.webmanifest" />
<title>Depot Notes Picker ‚Äì Clean Copy</title>
<style>
  :root { --bg:#0b0d10; --panel:#151a1f; --ink:#e9eef5; --muted:#98a5b3; --accent:#4aa3ff; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:14px 16px;border-bottom:1px solid #1f2630;background:#0e1318;display:flex;gap:12px;align-items:center}
  h1{font-size:16px;margin:0 8px 0 0;font-weight:600}
  main{display:grid;grid-template-columns: 320px 1fr 420px;gap:14px;padding:14px;height:calc(100% - 58px);grid-auto-rows:minmax(0,auto)}
  .card{background:var(--panel);border:1px solid #1f2630;border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2630;font-size:14px;font-weight:600}
  .pad{padding:12px 14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,input,button,textarea{border-radius:10px;border:1px solid #2a3644;background:#0f141a;color:var(--ink);padding:8px 10px;font:inherit}
  button{background:#152233;border-color:#2d4156;cursor:pointer}
  button:hover{background:#1b2a3b}
  button.accent{background:var(--accent);border-color:#2a73cc;color:#081019}
  small{color:var(--muted)}
  .list{overflow:auto}
  ul.checks{list-style:none;margin:0;padding:0}
  ul.checks li{padding:8px 10px;border-bottom:1px solid #1f2630;display:flex;gap:8px}
  .split{display:grid;grid-template-columns: 1fr;gap:10px}
  .outbox{display:flex;flex-direction:column;gap:8px;height:100%;overflow:auto}
  .out{display:flex;flex-direction:column;gap:10px;border:1px solid #243041;border-radius:12px;padding:10px;background:#0e141a}
  .out header{display:flex;justify-content:space-between;align-items:center;background:transparent;border:0;padding:0}
  .out textarea{width:100%;min-height:120px;resize:vertical;background:#0a0f14;border:1px solid #1d2834;border-radius:8px;padding:8px;color:var(--ink);white-space:pre-wrap}
  .out .alt{display:flex;flex-direction:column;gap:6px}
  .out .alt-head{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
  .out .alt-head strong{color:var(--ink);font-size:13px}
  .out .alt textarea{background:#0b1016;color:var(--ink)}
  .out .actions{display:flex;gap:6px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
  .pill{padding:4px 8px;border:1px solid #2d3a49;border-radius:999px;background:#0c1117;color:#var(--muted);font-size:12px}
  .sticky{position:sticky;top:0;background:var(--panel);z-index:1}
  .full{grid-column:1 / -1} /* full-width card spanning all columns */
  .footrow{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  a.link{color:#b8d7ff;text-decoration:none}
  a.home-link{margin-left:auto;display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid #2d3644;background:transparent;color:var(--ink);font-weight:600;text-decoration:none}
  a.home-link:hover{background:#152233;border-color:#355074}
  /* Let child flex items actually shrink inside grid/flex parents */
  main, .card, .pad { min-height: 0; }

  /* Make ‚Äúsplit‚Äù columns stack and allow the list to take remaining height */
  .split { display: flex; flex-direction: column; gap: 10px; min-height: 0; }

  /* The checkbox list becomes a flex-grow area with its own scrollbar */
  .list {
    flex: 1;                /* take remaining space */
    min-height: 0;          /* allow shrinking */
    overflow: auto;         /* enable scrolling */
    -webkit-overflow-scrolling: touch; /* smooth iOS scrolling */
  }

  /* Optional: tiny right padding so the scrollbar doesn‚Äôt cover labels */
  ul.checks { padding-right: 6px; }

</style>
</head>
<body>
<header>
  <h1>Depot Notes Picker ‚Äî Clean Copy</h1>
  <span class="pill">Spaces/newlines are copied as plain text (no %20)</span>
  <a class="home-link" href="welcome.html">üè† Back to welcome</a>
</header>

<main>
  <!-- LEFT: Source & Filters -->
  <section class="card">
    <h2 class="sticky">Source & Filters</h2>
    <div class="pad split">
      <div class="row">
        <button id="reloadBtn">Reload Options.txt</button>
        <small id="loadStatus">Waiting to load‚Ä¶</small>
      </div>
      <label class="row" style="align-items:stretch;gap:8px">
        <span class="pill">Section</span>
        <select id="srcSection" style="flex:1"></select>
      </label>
      <label class="row" style="align-items:stretch;gap:8px">
        <span class="pill">Search</span>
        <input id="filter" placeholder="Type to filter‚Ä¶" />
      </label>
      <div class="list">
        <ul id="items" class="checks"></ul>
      </div>
      <div class="row">
        <button id="selectAll">Select visible</button>
        <button id="clearAll">Clear</button>
      </div>
    </div>
  </section>

  <!-- MIDDLE: Send selections -->
  <section class="card">
    <h2 class="sticky">Send selection to Depot section</h2>
    <div class="pad">
      <div class="row">
        <select id="destSection"></select>
        <button class="accent" id="send">‚ûï Add selected to section</button>
      </div>
      <small>Tip: You can add to any section. Each line will be prefixed with <strong>‚úÖ</strong> and end with a <strong>;</strong> automatically.</small>
      <hr style="border:0;border-top:1px solid #1f2630;margin:12px 0">
      <div class="grid2">
        <button id="addNote">Add manual note to chosen section</button>
        <button id="removeDupes">Clean duplicates in chosen section</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: Outputs -->
  <section class="card">
    <h2 class="sticky">Depot Sections ‚Äî Copy as Plain Text</h2>
    <div class="pad outbox" id="outputs"></div>
  </section>

  <!-- FULL-WIDTH: Customer Summary via GPT -->
  <section class="card full">
    <h2 class="sticky">Customer Summary (GPT)</h2>
    <div class="pad" style="display:flex;flex-direction:column;gap:10px">
      <div class="footrow">
        <div class="row" style="gap:8px">
          <button class="accent" id="genSummary">‚ú® Generate summary with GPT</button>
          <button id="copySummary">Copy (plain text)</button>
          <button id="speakSummary">üîä Speak</button>
        </div>
        <small class="muted" id="summaryStatus">Ready</small>
      </div>
      <textarea id="summaryBox" placeholder="Click ‚ÄúGenerate summary with GPT‚Äù to create a clean, customer-friendly summary."></textarea>
    </div>
  </section>
  
</main>

<!-- Copy Dock (floating overlay for Depot entry) -->
<style>
#copy-dock{position:fixed;left:8px;top:80px;width:min(28rem,36vw);max-width:90vw;background:#121212;color:#f1f1f1;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.45);z-index:99999;font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;user-select:none;-webkit-user-select:none;}
#copy-dock .cd-header{display:flex;align-items:center;gap:8px;padding:8px 8px 6px 8px;}
#copy-dock .cd-title{margin-left:auto;opacity:.8;}
#copy-dock .cd-grip{width:46px;height:20px;border-radius:10px;background:rgba(255,255,255,.12);position:relative;cursor:grab;}
#copy-dock .cd-grip::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:26px;height:3px;border-radius:2px;background:rgba(255,255,255,.5);}
#copy-dock .cd-body{padding:0 8px 8px 8px;}
#copy-dock #cd-text{width:100%;height:8rem;background:#1b1b1b;color:#eaeaea;border:1px solid #2a2a2a;border-radius:10px;padding:10px;resize:none;line-height:1.35;white-space:pre-wrap;user-select:text;-webkit-user-select:text;}
#copy-dock .cd-actions{display:flex;gap:8px;padding:0 8px 8px 8px;flex-wrap:wrap}
#copy-dock .cd-btn{padding:8px 10px;border:0;border-radius:10px;background:#2b2b2b;color:#f5f5f5;cursor:pointer;flex:1 1 auto;}
#copy-dock .cd-btn.primary{background:#0078d7;}
#copy-dock .cd-btn:active{transform:translateY(1px)}
#copy-dock .cd-collapse{width:36px;flex:0 0 auto}
#copy-dock .cd-footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:0 10px 10px 10px;opacity:.85;font-size:12px}
#copy-dock .cd-checkbox{display:flex;align-items:center;gap:6px}
#copy-dock.is-collapsed #cd-body,#copy-dock.is-collapsed .cd-actions,#copy-dock.is-collapsed .cd-footer{display:none;}
</style>

<div id="copy-dock" aria-live="polite">
  <div class="cd-header">
    <div class="cd-grip" title="Drag"></div>
    <div class="cd-title"><span id="cd-index">1</span>/<span id="cd-total">1</span></div>
    <button class="cd-btn cd-collapse" id="cd-collapse" title="Collapse">‚àí</button>
  </div>
  <div class="cd-body" id="cd-body"><textarea id="cd-text" readonly></textarea></div>
  <div class="cd-actions">
    <button class="cd-btn" id="cd-prev">Prev</button>
    <button class="cd-btn" id="cd-copy">Copy</button>
    <button class="cd-btn primary" id="cd-copynext">Copy & Next</button>
    <button class="cd-btn" id="cd-next">Next</button>
  </div>
  <div class="cd-footer">
    <label class="cd-checkbox"><input type="checkbox" id="cd-autonext" checked>Auto-advance after Copy</label>
    <div class="cd-hints">Shortcuts: [ = Prev, ] = Next, ‚Üµ = Copy&Next</div>
  </div>
</div>

<script>
(()=>{const d=document,g=d.getElementById('copy-dock'),t=d.getElementById('cd-text'),iE=d.getElementById('cd-index'),tE=d.getElementById('cd-total');
const bP=d.getElementById('cd-prev'),bN=d.getElementById('cd-next'),bC=d.getElementById('cd-copy'),bCN=d.getElementById('cd-copynext'),bCol=d.getElementById('cd-collapse'),auto=d.getElementById('cd-autonext');
let items=["Example 1; line A; line B;","Example 2; another line;","Example 3; ‚Ä¶"],i=0;
function r(){if(!items.length){t.value="";iE.textContent="0";tE.textContent="0";return;}t.value=items[i]||"";iE.textContent=(i+1);tE.textContent=items.length;}
function p(){if(!items.length)return;i=(i-1+items.length)%items.length;r();}
function n(){if(!items.length)return;i=(i+1)%items.length;r();}
async function c(){const x=t.value;try{await navigator.clipboard.writeText(x);u("#0078d7");if(auto.checked)n();}
catch(e){t.removeAttribute('readonly');t.select();d.execCommand('copy');t.setAttribute('readonly','');u("#28a745");if(auto.checked)n();}}
function u(col){const o=g.style.boxShadow;g.style.boxShadow=`0 0 0 3px ${col}66,0 12px 28px rgba(0,0,0,.45)`;setTimeout(()=>{g.style.boxShadow=o||"0 12px 28px rgba(0,0,0,.45)"},300);}
window.setCopyItems=a=>{items=Array.isArray(a)?a.filter(Boolean):[];i=0;r();};
bP.onclick=p;bN.onclick=n;bC.onclick=c;bCN.onclick=()=>c();bCol.onclick=()=>{g.classList.toggle('is-collapsed');bCol.textContent=g.classList.contains('is-collapsed')?'+':'‚àí';};
d.addEventListener('keydown',e=>{if(e.key=='[')p();else if(e.key==']')n();else if(e.key=='Enter'){e.preventDefault();c();}});
const grip=g.querySelector('.cd-grip');let drag=false,sx=0,sy=0,sl=0,st=0;
function s(x,y){drag=true;const r=g.getBoundingClientRect();sx=x;sy=y;sl=r.left;st=r.top;grip.style.cursor='grabbing';}
function o(x,y){if(!drag)return;const nl=Math.max(4,sl+(x-sx)),nt=Math.max(4,st+(y-sy));g.style.left=nl+'px';g.style.top=nt+'px';g.style.right='auto';}
function e(){drag=false;grip.style.cursor='';}
grip.onmousedown=e=>s(e.clientX,e.clientY);d.onmousemove=e=>o(e.clientX,e.clientY);d.onmouseup=e;
grip.ontouchstart=e=>{const t=e.touches[0];s(t.clientX,t.clientY);};d.ontouchmove=e=>{const t=e.touches[0];o(t.clientX,t.clientY);};d.ontouchend=e;
r();})();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch((err) => {
      console.error('Service worker registration failed:', err);
    });
  });
}
</script>
<script>
/* -------------------- GPT client setup --------------------
   Provide a global `openai` (or `window.openai`) with chat.completions.create.
   If unavailable, the UI falls back to a local rewrite of the notes.
--------------------------------------------------------------------- */

/* -------------------- Driven by Options.txt -------------------- */
let OPTIONS = {};        // { sectionTitle: [{code, label, note, line}] }
let SECTION_ORDER = [];  // preserves order seen in Options.txt

/* -------------------- UI refs -------------------- */
const els = {
  srcSection: document.getElementById('srcSection'),
  destSection: document.getElementById('destSection'),
  items: document.getElementById('items'),
  filter: document.getElementById('filter'),
  send: document.getElementById('send'),
  outputs: document.getElementById('outputs'),
  reloadBtn: document.getElementById('reloadBtn'),
  selectAll: document.getElementById('selectAll'),
  clearAll: document.getElementById('clearAll'),
  addNote: document.getElementById('addNote'),
  removeDupes: document.getElementById('removeDupes'),
  loadStatus: document.getElementById('loadStatus'),
  // summary
  genSummary: document.getElementById('genSummary'),
  copySummary: document.getElementById('copySummary'),
  speakSummary: document.getElementById('speakSummary'),
  summaryBox: document.getElementById('summaryBox'),
  summaryStatus: document.getElementById('summaryStatus'),
};
function setStatus(s){ els.loadStatus.textContent = s; }
function setSummaryStatus(s){ els.summaryStatus.textContent = s; }

/* -------------------- Load & parse Options.txt -------------------- */
async function loadOptionsTxt() {
  setStatus("Loading Options.txt‚Ä¶");
  OPTIONS = {}; SECTION_ORDER = [];
  try {
    const res = await fetch('./Options.txt', { cache: "no-store" });
    if (!res.ok) throw new Error("Options.txt not found");
    const txt = await res.text();
    parseOptions(txt);
    setStatus("Loaded Options.txt");
  } catch (err) {
    console.warn("Failed loading Options.txt ‚Äî using minimal fallback", err);
    const fallback = `
[Overview of proposed work]
OV01 | Overview | Example item
[Boiler and controls]
BL01 | Boiler | Example boiler item
[Notes]
NOTE | Example free text
`;
    parseOptions(fallback);
    setStatus("Fallback loaded (Options.txt missing)");
  }
  populateFromOptions();
}

function parseOptions(text) {
  let current = "General";
  ensureSection(current);
  text.split(/\r?\n/).forEach(raw => {
    const line = raw.trim();
    if (!line) return;
    const sectMatch = line.match(/^\[(.+)\]$/i);
    if (sectMatch) {
      current = sectMatch[1].trim();
      ensureSection(current);
      return;
    }
    let code="", body="";
    if (line.includes("|")) {
      const parts = line.split("|").map(s => s.trim());
      if (parts.length >= 2) {
        code = parts[0];
        body = parts.slice(1).join(" | ");
      } else {
        body = line;
      }
    } else {
      body = line;
    }
    const cleanBody = body.replace(/\s+/g, " ").trim();
    const labelText = (code ? `${code} ‚Äî ${cleanBody}` : cleanBody);
    OPTIONS[current].push({
      code,
      label: labelText,
      note: cleanBody,
      line
    });
  });
}

function ensureSection(title){
  if (!(title in OPTIONS)) {
    OPTIONS[title] = [];
    SECTION_ORDER.push(title);
  } else if (!SECTION_ORDER.includes(title)) {
    SECTION_ORDER.push(title);
  }
}

/* -------------------- Build UI from OPTIONS -------------------- */
function populateFromOptions() {
  els.srcSection.innerHTML = "";
  SECTION_ORDER.forEach(s => els.srcSection.add(new Option(s, s)));
  els.destSection.innerHTML = "";
  SECTION_ORDER.forEach(s => els.destSection.add(new Option(s, s)));
  syncDestToSource();
  renderOutputs();
  renderItemList();
}

function syncDestToSource() {
  const sourceValue = els.srcSection.value;
  if (!sourceValue) return;
  const hasMatch = Array.from(els.destSection.options).some(opt => opt.value === sourceValue);
  if (hasMatch) {
    els.destSection.value = sourceValue;
  }
}

function renderItemList() {
  const sect = els.srcSection.value || SECTION_ORDER[0];
  const query = (els.filter.value || '').toLowerCase();
  const list = OPTIONS[sect] || [];
  const filtered = list.filter(x => {
    if (!query) return true;
    const haystack = [x.label, x.code, x.note]
      .filter(Boolean)
      .join(" \u2022 ")
      .toLowerCase();
    return haystack.includes(query);
  });
  els.items.innerHTML = filtered.map((x, i) => `
    <li>
      <input type="checkbox" id="chk_${i}" data-text="${htmlAttr(x.note)}" data-code="${htmlAttr(x.code || '')}" />
      <label for="chk_${i}">${escapeHtml(x.label)}</label>
    </li>
  `).join("");
}

function renderOutputs() {
  els.outputs.innerHTML = SECTION_ORDER.map(name => outTemplate(name)).join("");
  SECTION_ORDER.forEach(name => {
    const id = idify(name);
    const raw = document.getElementById('out_' + id);
    if (raw) {
      raw.addEventListener('input', () => updateNatural(id));
      updateNatural(id);
    }
  });
}

function setOutValue(id, text) {
  const raw = document.getElementById('out_' + id);
  if (!raw) return;
  raw.value = text;
  updateNatural(id);
}

function updateNatural(id) {
  const raw = document.getElementById('out_' + id);
  const natural = document.getElementById('out_' + id + '_natural');
  if (!raw || !natural) return;
  natural.value = toNaturalLanguage(raw.value);
}

function toNaturalLanguage(text) {
  const lines = normalizeNewlines(String(text || ''))
    .split('\n')
    .map(line => stripIconAndSemicolon(line).replace(/^[-*‚Ä¢]+\s*/, '').trim())
    .filter(Boolean);

  if (lines.length === 0) return '';

  const context = {
    systemTypeSeen: false,
    systemTypeAlternatives: [],
    clauses: []
  };

  lines.forEach(line => {
    const plain = removeMarkdown(line);
    const { label, value } = splitLabelValue(plain);
    if (!label) {
      const clause = formatStandaloneClause(value);
      if (clause) context.clauses.push(clause);
      return;
    }
    const clause = formatLabelClause(label, value, context);
    if (clause) context.clauses.push(clause);
  });

  if (context.systemTypeAlternatives.length) {
    context.clauses.push(formatListClause(
      'Proposed upgrade options include',
      context.systemTypeAlternatives.map(v => ensureIndefiniteArticle(v))
    ));
  }

  const clauses = context.clauses
    .map(cleanClause)
    .filter(Boolean);

  if (!clauses.length) return '';

  return `${clauses.join('; ')}.`;
}

function splitLabelValue(line) {
  const parts = String(line || '')
    .split('|')
    .map(s => s.trim())
    .filter(Boolean);
  if (parts.length >= 2) {
    return { label: parts[0], value: parts.slice(1).join(' | ') };
  }
  return { label: '', value: parts[0] || '' };
}

function removeMarkdown(line) {
  return String(line || '')
    .replace(/[*_`~]+/g, '')
    .replace(/^#{1,6}\s*/, '')
    .trim();
}

function formatStandaloneClause(value) {
  const text = sentenceCase(cleanValue(value));
  return text;
}

function formatLabelClause(label, value, context) {
  const rawLabel = String(label || '').replace(/[:]/g, '').trim();
  const cleanedValue = cleanValue(value);
  if (!cleanedValue) return '';

  const lower = rawLabel.toLowerCase();

  switch (lower) {
    case 'system type': {
      if (!context.systemTypeSeen) {
        const last = context.clauses[context.clauses.length - 1];
        if (last && /^Existing system$/i.test(last)) {
          context.clauses.pop();
          context.systemTypeSeen = true;
          return `The existing system is ${cleanedValue}`;
        }
        if (last && /^Proposed system$/i.test(last)) {
          context.clauses.pop();
          context.systemTypeSeen = true;
          return `The proposed system will be ${ensureIndefiniteArticle(cleanedValue)}`;
        }
        if (last && /^New boiler$/i.test(last)) {
          context.clauses.pop();
          context.systemTypeSeen = true;
          return `The new boiler will be ${ensureIndefiniteArticle(cleanedValue)}`;
        }
        context.systemTypeSeen = true;
        return `The system type is ${cleanedValue}`;
      }
      context.systemTypeAlternatives.push(cleanedValue);
      return '';
    }
    case 'controls':
      return `Controls are ${cleanedValue}`;
    case 'hot water':
      return `Hot water is provided by ${ensureIndefiniteArticle(cleanedValue)}`;
    case 'configuration':
      return `Configuration is ${cleanedValue}`;
    case 'flue':
      return `Flue arrangement is ${cleanedValue}`;
    case 'gas supply':
      return `Gas supply is ${cleanedValue}`;
    case 'location':
      return `Location is ${cleanedValue}`;
    case 'need':
      return `Identified need: ${sentenceCase(cleanedValue)}`;
    default: {
      const subject = sentenceCase(rawLabel);
      const verb = chooseVerb(lower);
      return `${subject} ${verb} ${cleanedValue}`;
    }
  }
}

function formatListClause(prefix, values) {
  const items = values.map(cleanClause).filter(Boolean);
  if (!items.length) return '';
  if (items.length === 1) return `${prefix} ${items[0]}`;
  const last = items.pop();
  return `${prefix} ${items.join(', ')} or ${last}`;
}

function ensureIndefiniteArticle(value) {
  const text = cleanClause(value);
  if (!text) return '';
  if (/^(?:a|an|the)\b/i.test(text)) return text;
  if (/^[0-9]/.test(text)) return text;
  const article = /^[aeiou]/i.test(text) ? 'an' : 'a';
  return `${article} ${text}`;
}

function chooseVerb(labelLower) {
  if (/(?:controls|services|valves|radiators|circuits|zones|rooms|needs|options|notes|documents|measurements|risks|issues|vents|drains|windows|doors|supports|pipes|emitters|appliances)\b/.test(labelLower)) {
    return 'are';
  }
  return 'is';
}

function cleanValue(value) {
  return String(value || '')
    .replace(/[*_`~]+/g, '')
    .replace(/\s*\/\s*/g, ' and ')
    .replace(/\broom stat\b/gi, 'room thermostat')
    .replace(/\s+-\s+/g, ' ‚Äì ')
    .replace(/\s+/g, ' ')
    .replace(/\band and\b/gi, 'and')
    .trim();
}

function cleanClause(text) {
  return String(text || '')
    .replace(/\s+/g, ' ')
    .replace(/^[;,:\s]+/, '')
    .replace(/[;,:\s]+$/, '')
    .trim();
}

function sentenceCase(text) {
  const cleaned = cleanClause(text);
  if (!cleaned) return '';
  return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
}

function outTemplate(name){
  const id = idify(name);
  const sectionAttr = htmlAttr(name);
  return `
  <div class="out depot-section" data-section="${id}" data-section-title="${sectionAttr}">
    <header>
      <strong class="section-title">${escapeHtml(name)}</strong>
      <span class="actions">
        <button onclick="speakOut('${id}', false)">üîä Speak</button>
        <button onclick="copyOut('${id}')">Copy (plain text)</button>
        <button onclick="clearOut('${id}')">Clear</button>
      </span>
    </header>
    <textarea class="plain-text" id="out_${id}" placeholder="Items you add to ‚Äò${escapeHtml(name)}‚Äô will appear here‚Ä¶"></textarea>
    <div class="alt">
      <div class="alt-head">
        <strong>Natural language</strong>
        <span class="actions">
          <button onclick="speakOut('${id}', true)">üîä Speak</button>
          <button onclick="copyOutNatural('${id}')">Copy natural</button>
        </span>
      </div>
      <textarea id="out_${id}_natural" readonly placeholder="Natural language version appears here automatically."></textarea>
    </div>
  </div>`;
}

/* -------------------- Actions -------------------- */
els.srcSection.addEventListener('change', () => {
  syncDestToSource();
  renderItemList();
});
els.filter.addEventListener('input', renderItemList);
els.reloadBtn.addEventListener('click', loadOptionsTxt);

els.selectAll.addEventListener('click', () => {
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = true);
});
els.clearAll.addEventListener('click', () => {
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
});

els.send.addEventListener('click', () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  if (!out) return;
  const selected = Array.from(els.items.querySelectorAll('input[type=checkbox]:checked'))
    .map(chk => chk.dataset.text);
  if (selected.length === 0) { alert('Select at least one item.'); return; }
  const lines = selected.map(t => formatLine(t));
  const existing = normalizeNewlines(out.value).trim();
  setOutValue(outId, [existing, ...lines].filter(Boolean).join('\n'));
  els.items.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
  out.focus();
});

els.addNote.addEventListener('click', async () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  const note = prompt("Manual note to add to ‚Äú" + dest + "‚Äù:");
  if (!note) return;
  const line = formatLine(note);
  const existing = normalizeNewlines(out.value).trim();
  setOutValue(outId, [existing, line].filter(Boolean).join('\n'));
  out.focus();
});

els.removeDupes.addEventListener('click', () => {
  const dest = els.destSection.value;
  const outId = idify(dest);
  const out = document.getElementById('out_' + outId);
  const seen = new Set();
  const cleaned = normalizeNewlines(out.value)
    .split('\n').map(s => s.trim()).filter(Boolean)
    .filter(s => {
      const key = stripIconAndSemicolon(s).toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key); return true;
    }).join('\n');
  setOutValue(outId, cleaned);
  out.focus();
});

/* -------------------- COPY (plain text, no %20) -------------------- */
function copyOut(id){
  const ta = document.getElementById('out_' + id);
  if (!ta) return;
  let text = normalizeNewlines(ta.value)
    .split('\n').map(s => s.trim()).filter(Boolean)
    // normalise any legacy lines (‚ÜòÔ∏è, missing ;) to the new format
    .map(s => `‚úÖ ${stripIconAndSemicolon(s)};`)
    .join('\n');
  text = text.replace(/%20/g, ' ').replace(/%0A/gi, '\n').replace(/\r\n/g, '\n');
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => { ta.value = text; updateNatural(id); ta.focus(); ta.select(); document.execCommand('copy'); flash(ta,'Copied ‚úì'); });
}

function copyOutNatural(id){
  const ta = document.getElementById('out_' + id + '_natural');
  if (!ta) return;
  const text = ta.value.trim();
  if (!text) { flash(ta, 'Nothing to copy'); return; }
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => {
      const wasReadOnly = ta.readOnly;
      ta.readOnly = false;
      ta.focus();
      ta.select();
      document.execCommand('copy');
      ta.readOnly = wasReadOnly;
      flash(ta,'Copied ‚úì');
    });
}

function clearOut(id){
  const ta = document.getElementById('out_' + id);
  if (ta) setOutValue(id, '');
}

function speakOut(id, natural=false){
  const ta = document.getElementById('out_' + id + (natural ? '_natural' : ''));
  if (!ta) return;
  const base = natural ? ta.value : normalizeNewlines(ta.value)
    .split('\n')
    .map(line => stripIconAndSemicolon(line).trim())
    .filter(Boolean)
    .join('\n');
  const text = natural ? base : toNaturalLanguage(base);
  speakText(text);
}

function speakText(text){
  const content = String(text || '').trim();
  if (!content) return;
  if (!('speechSynthesis' in window)) {
    alert('Text to speech is not supported in this browser.');
    return;
  }
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(content);
  window.speechSynthesis.speak(utterance);
}

/* -------------------- GPT SUMMARY -------------------- */
const GPT_SECTION_SYSTEM_PROMPT = `
You are an expert British Gas heating adviser.
Rewrite each section's bullet points into short, clear, customer-friendly paragraphs.
Keep the tone professional, positive, and natural. Avoid repeating section titles.
Combine points fluidly ‚Äî no lists or semicolons.
`;
const GPT_MODEL = 'gpt-4o-mini';
const GPT_TEMPERATURE = 0.7;

function getOpenAIClient(){
  if (typeof openai !== 'undefined' && openai?.chat?.completions?.create) return openai;
  if (window.openai?.chat?.completions?.create) return window.openai;
  return null;
}

function cleanSummaryLines(text){
  return normalizeNewlines(String(text || ''))
    .split('\n')
    .map(line => stripIconAndSemicolon(line).replace(/^[-‚Ä¢]\s*/, '').trim())
    .filter(Boolean);
}

function linesToParagraph(lines){
  return lines
    .map(sentence => {
      let clean = sentence.replace(/\s+/g, ' ').trim();
      if (!clean) return '';
      clean = clean.charAt(0).toUpperCase() + clean.slice(1);
      if (!/[.!?]$/.test(clean)) clean += '.';
      return clean;
    })
    .filter(Boolean)
    .join(' ');
}

function collectSectionsForSummary(){
  const sections = [];
  SECTION_ORDER.forEach(name => {
    const id = 'out_' + idify(name);
    const ta = document.getElementById(id);
    if (!ta) return;
    const lines = cleanSummaryLines(ta.value);
    if (!lines.length) return;
    const plainText = lines.join('\n');
    const fallback = linesToParagraph(lines);
    if (!fallback) return;
    sections.push({ name, text: plainText, fallback });
  });
  return sections;
}

function localFallbackSummary(sections){
  return sections
    .map(section => section.fallback ? `${section.name}: ${section.fallback}` : '')
    .filter(Boolean)
    .join('\n\n');
}

async function summariseSectionsWithGPT(client, sections){
  if (!client?.chat?.completions?.create) {
    return { text: '', usedModel: false };
  }
  const paragraphs = [];
  let usedModel = false;
  for (const section of sections) {
    const prompt = `${section.name}:\n${section.text}`;
    try {
      const response = await client.chat.completions.create({
        model: GPT_MODEL,
        messages: [
          { role: 'system', content: GPT_SECTION_SYSTEM_PROMPT },
          { role: 'user', content: prompt }
        ],
        temperature: GPT_TEMPERATURE,
      });
      const summary = response?.choices?.[0]?.message?.content?.trim();
      const paragraph = summary || section.fallback;
      if (summary) usedModel = true;
      if (paragraph) {
        paragraphs.push(`${section.name}: ${paragraph}`);
      }
    } catch (error) {
      console.warn(`Error summarising ${section.name}:`, error);
      if (section.fallback) {
        paragraphs.push(`${section.name}: ${section.fallback}`);
      }
    }
  }
  return { text: paragraphs.join('\n\n').trim(), usedModel };
}

async function generateSummary(){
  const btn = els.genSummary;
  const box = els.summaryBox;
  const sections = collectSectionsForSummary();
  if (sections.length === 0) {
    alert('Add some notes to the depot sections first.');
    return;
  }

  btn.disabled = true;
  setSummaryStatus('Summarising‚Ä¶');
  box.placeholder = 'Generating summary‚Ä¶';

  const fallbackText = localFallbackSummary(sections);
  let summaryText = fallbackText;
  let usedModel = false;

  try {
    const client = getOpenAIClient();
    if (client) {
      const result = await summariseSectionsWithGPT(client, sections);
      if (result.text) {
        summaryText = result.text;
        usedModel = result.usedModel;
      }
    }
  } catch (err) {
    console.warn('Summary generation failed:', err);
  } finally {
    box.value = normalizeNewlines(summaryText);
    setSummaryStatus(usedModel ? 'Done ‚úì' : 'Done (fallback) ‚úì');
    btn.disabled = false;
  }
}

/* Copy summary as plain text */
function copySummary(){
  const ta = els.summaryBox;
  let text = normalizeNewlines(ta.value).trim();
  text = text.replace(/%20/g, ' ').replace(/%0A/gi, '\n').replace(/\r\n/g, '\n');
  navigator.clipboard.writeText(text)
    .then(() => flash(ta, 'Copied ‚úì'))
    .catch(() => { ta.focus(); ta.select(); document.execCommand('copy'); flash(ta,'Copied ‚úì'); });
}

/* Wire up summary buttons */
els.genSummary.addEventListener('click', generateSummary);
els.copySummary.addEventListener('click', copySummary);
if (els.speakSummary) {
  els.speakSummary.addEventListener('click', () => {
    const text = normalizeNewlines(els.summaryBox.value).split('\n').map(s => s.trim()).filter(Boolean).join(' ');
    speakText(text || els.summaryBox.placeholder || '');
  });
}

/* -------------------- Helpers -------------------- */
function idify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function htmlAttr(s){ return s.replace(/"/g,'&quot;'); }
function normalizeNewlines(s){ return String(s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n'); }

/* Normalise content by stripping any leading icon (‚úÖ or legacy ‚ÜòÔ∏è) and any trailing semicolon */
function stripIconAndSemicolon(s){
  return String(s || '')
    .replace(/^\s*(?:‚úÖ|‚ÜòÔ∏è)?\s*/,'') // remove either icon if present
    .replace(/\s*;?\s*$/,'')        // remove any trailing semicolon and surrounding space
    .trim();
}

/* Always format to: "‚úÖ <text>;" */
function formatLine(s){
  const clean = stripIconAndSemicolon(String(s || '').replace(/\s+/g,' '));
  return clean ? `‚úÖ ${clean};` : '';
}

function flash(el, msg){ const was = el.placeholder; el.placeholder = msg; setTimeout(()=>{ el.placeholder = was; }, 1200); }

/* -------------------- Kickoff -------------------- */
loadOptionsTxt();
</script>

</body>
</html>
